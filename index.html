<!DOCTYPE html>
<html lang="ja">
<head>
    <link rel="icon" href="data:,">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ³ãƒãƒ­ãƒ»ã‚¯ãƒªãƒƒã‚«ãƒ¼</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --accent: #f1c40f;
            --auto-color: #00d2d3;
            --skill-line: #9b59b6;
            --locked-color: #444;
            --max-gold: #f39c12;
            --total-color: #2ecc71;
            /* ãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ©ãƒ¼ */
            --mode-normal: #3498db;
            --mode-ritual: #9b59b6;
            --mode-fusion: #e74c3c;
            --mode-synchro: #00cec9; /* ã‚·ãƒ³ã‚¯ãƒ­è‰² */
            
            /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã‚«ãƒ©ãƒ¼ (åŸºæœ¬) */
            --rare-common: #ffffff;
            --rare-uncommon: #2ecc71;
            --rare-rare: #3498db;
            --rare-super: #f1c40f;
            --rare-ultra: #9b59b6;
            /* æ–°ãƒ¬ã‚¢ãƒªãƒ†ã‚£ */
            --rare-magic: #ff007f;
            --rare-epic: #00d2d3;
            --rare-legendary: #ff9f43;
            --rare-eternal: #fab1a0;

            /* è»¢ç”Ÿã‚«ãƒ©ãƒ¼ */
            --reinc-color: #e056fd;
            --reinc-bg: #2d0f38;
        }
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container { display: flex; gap: 20px; max-width: 1200px; width: 100%; position: relative; }
        .sidebar { width: 220px; display: flex; flex-direction: column; gap: 20px; }
        .panel { background: #1a1a1a; padding: 15px; border-radius: 10px; border: 1px solid #333; font-size: 0.8rem; }
        .panel h3 { margin: 0 0 10px 0; color: var(--accent); text-align: center; border-bottom: 1px solid var(--accent); }
        .panel table { width: 100%; border-collapse: collapse; }
        .panel td { padding: 5px 0; border-bottom: 1px solid #222; }
        .é…å½“ { text-align: right; color: #2ecc71; font-weight: bold; }
        #history-list { list-style: none; padding: 0; margin: 0; }
        #history-list li { padding: 4px 0; border-bottom: 1px solid #222; display: flex; justify-content: space-between; }
        .game-area { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .score-container { text-align: center; margin-bottom: 10px; }
        .score-label { font-size: 0.9rem; color: #888; margin-bottom: -5px; }
        #total-score-display { font-size: 1.5rem; color: var(--total-color); font-weight: bold; margin: 0; }
        #score-board { font-size: 3.5rem; color: var(--accent); font-weight: bold; margin: 0; text-shadow: 0 0 10px rgba(241, 196, 15, 0.3); }
        .multiplier-tag { background: var(--auto-color); color: #000; padding: 2px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; margin-bottom: 20px; }
        #game-fields { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; width: 100%; }
        .field { background: var(--panel-bg); padding: 15px; border-radius: 15px; display: flex; flex-direction: column; align-items: center; position: relative; border: 1px solid #333; }
        .timer-container { position: absolute; top: 10px; right: 10px; width: 35px; height: 35px; }
        .timer-svg { transform: rotate(-90deg); width: 35px; height: 35px; }
        .timer-progress { fill: none; stroke: var(--auto-color); stroke-width: 4; stroke-dasharray: 100; stroke-dashoffset: 100; }
        .timer-bg { fill: none; stroke: #333; stroke-width: 4; }
        .dice-row { display: flex; gap: 6px; margin: 10px 0; flex-wrap: wrap; justify-content: center; }
        
        .die { 
            width: 45px; height: 45px; background: white; border-radius: 8px; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 1.8rem; color: #333; box-shadow: 0 4px 0 #999; 
            transition: opacity 0.3s, transform 0.2s, color 0.3s, text-shadow 0.3s; 
            font-family: 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
            position: relative;
        }
        .die.is-number { font-size: 1.4rem; font-weight: bold; font-family: 'Arial', sans-serif; }

        .rarity-common { color: #333; }
        .rarity-uncommon { color: var(--rare-uncommon) !important; text-shadow: 0 0 2px rgba(46, 204, 113, 0.3); }
        .rarity-rare { color: var(--rare-rare) !important; text-shadow: 0 0 3px rgba(52, 152, 219, 0.4); }
        .rarity-super { color: var(--rare-super) !important; text-shadow: 0 0 5px rgba(241, 196, 15, 0.5); }
        .rarity-ultra { color: var(--rare-ultra) !important; text-shadow: 0 0 8px rgba(155, 89, 182, 0.6); }
        .rarity-magic { color: var(--rare-magic) !important; text-shadow: 0 0 10px var(--rare-magic); font-weight: bold; }
        .rarity-epic { color: var(--rare-epic) !important; text-shadow: 0 0 12px var(--rare-epic); font-weight: bold; }
        .rarity-legendary { color: var(--rare-legendary) !important; text-shadow: 0 0 15px var(--rare-legendary); font-weight: bold; border: 1px solid var(--rare-legendary); }
        .rarity-eternal { 
            color: #fff !important; 
            background: linear-gradient(135deg, #000, #333);
            text-shadow: 0 0 5px #fff, 0 0 10px #ff00de, 0 0 15px #00d2d3; 
            border: 2px solid #fff;
            animation: eternal-shine 2s infinite alternate;
        }
        @keyframes eternal-shine { from { box-shadow: 0 0 5px #fff; } to { box-shadow: 0 0 20px #fff; } }

        .die.unused { opacity: 0.25; transform: scale(0.85); box-shadow: none; border: none; animation: none; }
        .rolling { animation: shake 0.1s infinite; }
        .roll-btn { background: #e67e22; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .roll-btn:disabled { background: #444; cursor: not-allowed; }
        
        /* æ¢ç´¢ãƒ‘ãƒãƒ« */
        #expedition-panel { width: 100%; background: #222; border: 2px solid #555; border-radius: 15px; padding: 15px; margin-bottom: 20px; display: none; text-align: center; position: relative; transition: border-color 0.3s; }
        #expedition-panel.mode-normal { border-color: var(--mode-normal); }
        #expedition-panel.mode-ritual { border-color: var(--mode-ritual); }
        #expedition-panel.mode-fusion { border-color: var(--mode-fusion); }
        #expedition-panel.mode-synchro { border-color: var(--mode-synchro); }
        
        .exp-header { display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
        .exp-title { margin: 0; font-weight: bold; font-size: 1.2rem; }

        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒœã‚¿ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .mode-select-btn {
            padding: 8px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #222;
            color: #888;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
        }
        
        /* é¸æŠä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .mode-select-btn.active {
            color: white;
            font-weight: bold;
            border-color: white;
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* å„ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ */
        #btn-select-normal.active { background: var(--mode-normal); box-shadow: 0 0 8px var(--mode-normal); }
        #btn-select-ritual.active { background: var(--mode-ritual); box-shadow: 0 0 8px var(--mode-ritual); }
        #btn-select-fusion.active { background: var(--mode-fusion); box-shadow: 0 0 8px var(--mode-fusion); }
        #btn-select-synchro.active { background: var(--mode-synchro); box-shadow: 0 0 8px var(--mode-synchro); }

        .exp-status { display: flex; align-items: center; justify-content: center; gap: 20px; }
        .exp-btn { color: white; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background 0.3s; }
        .exp-btn:disabled { background: #444 !important; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #reward-modal, #pool-detail-modal, #upgrade-modal, #reinc-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; z-index: 3000; }
        #upgrade-modal, #reinc-modal { z-index: 1000; }
        #reward-modal { z-index: 2000; }
        #pool-detail-modal { z-index: 3000; } /* çµæœç”»é¢ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤º */
        #upgrade-modal, #reinc-modal { z-index: 1000; }

        .reward-card { background: #222; border: 2px solid #444; padding: 20px; border-radius: 15px; width: 140px; cursor: pointer; transition: 0.3s; margin: 10px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .reward-card:hover { border-color: var(--accent); transform: translateY(-5px); background: #333; }
        .reward-card.remove-mode:hover { border-color: #e74c3c; background: #2c0b0b; }
        .reward-card.fusion-mode:hover { border-color: var(--mode-fusion); background: #2c0b0b; }
        .reward-card.synchro-mode:hover { border-color: var(--mode-synchro); background: #0c3332; }

        .reward-card.selected { border-color: #2ecc71; background: #1b2e1b; transform: scale(0.95); opacity: 0.8; }
        .reward-card.selected.remove-mode { border-color: #e74c3c; background: #2c0b0b; }
        .reward-card.selected.fusion-mode { border-color: var(--mode-fusion); background: #3a1111; }
        .reward-card.selected.synchro-mode { border-color: var(--mode-synchro); background: #0c3332; }

        #shop-trigger { position: fixed; bottom: 20px; right: 20px; background: #9b59b6; width: 60px; height: 60px; border-radius: 50%; font-size: 1.5rem; border: none; cursor: pointer; color: white; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4); z-index: 100; }
        
        /* è»¢ç”Ÿãƒœã‚¿ãƒ³ */
        #reinc-btn {
            background: linear-gradient(135deg, #a723e7, #5f27cd);
            color: white; padding: 12px 10px; border: 1px solid #e056fd; border-radius: 10px;
            cursor: pointer; font-weight: bold; box-shadow: 0 0 10px rgba(224, 86, 253, 0.5);
            display: none; width: 100%; margin-bottom: 20px; font-size: 1rem; position: relative; z-index: 10;
        }
        .reinc-available { animation: pulse-reinc 2s infinite; }
        @keyframes pulse-reinc { 0% {box-shadow: 0 0 10px rgba(224, 86, 253, 0.5);} 50% {box-shadow: 0 0 20px rgba(224, 86, 253, 0.8);} 100% {box-shadow: 0 0 10px rgba(224, 86, 253, 0.5);} }

        #shop-badge {
            position: absolute;
            top: -5px; right: -5px;
            background: #e74c3c; color: white;
            width: 24px; height: 24px;
            border-radius: 50%;
            display: none;
            justify-content: center; align-items: center;
            font-weight: bold; font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            z-index: 101;
            border: 2px solid #fff;
        }
        
        .modal-content { 
            background: #1a1a1a; padding: 30px; border-radius: 20px; width: 850px; text-align: center; 
            border: 1px solid var(--skill-line); max-height: 90vh; overflow-y: auto; 
            position: relative;
        }
        
        .close-modal-btn {
            position: absolute; top: 20px; right: 20px;
            background: transparent; border: none; color: #666; 
            font-size: 2rem; cursor: pointer; line-height: 1; z-index: 10;
        }
        .close-modal-btn:hover { color: white; }

        .tree-container { position: relative; display: flex; flex-direction: column; align-items: center; gap: 40px; margin-top: 40px; padding: 20px; }
        .tree-row { display: flex; gap: 20px; position: relative; z-index: 2; justify-content: center; width: 100%; }
        .svg-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .skill-line { stroke: #333; stroke-width: 3; fill: none; transition: 0.3s; }
        .skill-line.active { stroke: var(--skill-line); }
        .skill-node { width: 75px; height: 75px; background: #111; border-radius: 18px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; cursor: pointer; border: 3px solid #333; transition: 0.3s; }
        .skill-node.available { border-color: #555; background: #222; }
        .skill-node.unlocked { border-color: var(--skill-line); background: #2d1b33; }
        .skill-node.is-max { border-color: var(--max-gold) !important; box-shadow: 0 0 10px rgba(243, 156, 18, 0.4); }
        .skill-node.locked { background: #111; border-color: #333; cursor: default; }
        .skill-node.locked .skill-icon, .skill-node.locked .lv-badge { opacity: 0.3; filter: grayscale(100%); }
        .skill-node.can-buy::after {
            content: "+"; position: absolute; top: -8px; right: -8px; background: #e74c3c; color: white; width: 22px; height: 22px;
            border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1.1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 10; animation: pulse-badge 1.5s infinite alternate; border: 2px solid #222;
        }
        @keyframes pulse-badge { from { transform: scale(1); } to { transform: scale(1.15); } }

        /* è»¢ç”Ÿç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .reinc-bg { background: var(--reinc-bg); border-color: var(--reinc-color); }
        .reinc-node.unlocked { border-color: var(--reinc-color); background: #401550; }
        .reinc-node.available { border-color: #7d3c98; background: #2d0f38; }
        .skill-line.reinc-line.active { stroke: var(--reinc-color); }

        .skill-icon { font-size: 1.8rem; z-index: 3; }
        .lv-badge { font-size: 0.6rem; font-weight: bold; color: #888; z-index: 3; }
        .skill-tooltip { visibility: hidden; width: 220px; background: #000; color: #fff; padding: 10px; position: absolute; bottom: 125%; border-radius: 8px; font-size: 0.8rem; opacity: 0; transition: 0.2s; z-index: 100; border: 1px solid #444; pointer-events: none; }
        .skill-node:hover .skill-tooltip { visibility: visible; opacity: 1; }
        
        .pool-detail-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 20px; }
        .pool-detail-item { background: #222; padding: 10px; border-radius: 8px; border: 1px solid #444; }

        #save-notice { position: fixed; bottom: 20px; left: 20px; color: #888; font-size: 0.8rem; opacity: 0; transition: opacity 0.5s; }
        #offline-notice { position: fixed; bottom: 60px; left: 20px; color: var(--accent); font-size: 0.8rem; opacity: 0; transition: opacity 1s; z-index: 1000; }
        

        #rp-display-panel {
            background: rgba(45, 15, 56, 0.8);
            border: 1px solid var(--reinc-color);
            padding: 10px; border-radius: 8px;
            margin-bottom: 15px; display: none;
            color: var(--reinc-color); font-weight: bold;
        }
        
        #reinc-view-mode-msg {
            color: #f39c12; font-size: 0.8rem; margin-bottom: 10px; display: none;
        }

        /* --- ãƒ—ãƒ¼ãƒ«è©³ç´°ã®ã‚«ãƒ¼ãƒ‰é¢¨ãƒ‡ã‚¶ã‚¤ãƒ³ --- */

		/* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å¤‰æ›´ */
		.pool-card-container {
		    display: flex;
		    flex-wrap: wrap;
		    gap: 10px;
		    justify-content: center;
		    padding: 10px;
		    max-height: 70vh; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã« */
		    overflow-y: auto;
		}

		/* ã‚«ãƒ¼ãƒ‰æœ¬ä½“ */
		.pool-card {
		    background-color: #f0f0f0; /* ç”»åƒã«åˆã‚ã›ãŸæ˜ã‚‹ã„èƒŒæ™¯ */
		    border: 1px solid #aaa;
		    border-radius: 4px;
		    width: 90px;  /* ã‚µã‚¤ã‚ºèª¿æ•´ */
		    height: 110px;
		    display: flex;
		    flex-direction: column;
		    align-items: center;
		    justify-content: center;
		    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
		    position: relative;
		    transition: transform 0.2s;
		}

		.pool-card:hover {
		    transform: translateY(-2px);
		    box-shadow: 0 4px 8px rgba(0,0,0,0.4);
		    z-index: 10;
		}

		/* ãƒ€ã‚¤ã‚¹è¡¨ç¤ºéƒ¨åˆ†ï¼ˆäºŒé‡æ é¢¨ï¼‰ */
		.pool-card-die-outer {
		    width: 60px;
		    height: 60px;
		    background: white;
		    border: 1px solid #ccc;
		    padding: 3px;
		    display: flex;
		    justify-content: center;
		    align-items: center;
		    margin-bottom: 5px;
		}

		.pool-card-die-inner {
		    width: 100%;
		    height: 100%;
		    border: 1px solid #eee; /* å†…å´ã®è–„ã„æ  */
		    display: flex;
		    justify-content: center;
		    align-items: center;
		    font-size: 2.2rem;
		    line-height: 1;
		    font-family: 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
		    color: #000; /* ãƒ€ã‚¤ã‚¹ã®ç›®ã¯é»’ï¼ˆç”»åƒã«æº–æ‹ ï¼‰ */
		}

		/* æ•°å­—ï¼ˆ7ä»¥ä¸Šï¼‰ã®å ´åˆã®ãƒ•ã‚©ãƒ³ãƒˆèª¿æ•´ */
		.pool-card-die-inner.is-number {
		    font-size: 1.5rem;
		    font-weight: bold;
		    font-family: 'Arial', sans-serif;
		}

		/* ä¸‹éƒ¨ã®ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ± */
		.pool-card-info {
		    font-size: 0.65rem;
		    text-align: center;
		    line-height: 1.3;
		    color: #333;
		    width: 100%;
		}

		.pool-card-rarity {
		    font-weight: bold;
		    white-space: nowrap;
		    overflow: hidden;
		    text-overflow: ellipsis;
		    padding: 0 2px;
		}

	/* --- ãƒã‚¤ã‚¹ã‚³ã‚¢æ¼”å‡º --- */

		/* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸Šã®ã‚¹ã‚³ã‚¢è¡¨ç¤ºï¼ˆé€šå¸¸æ™‚ï¼‰ */
		.msg-area {
		    font-size: 0.8rem;
		    font-weight: bold;
		    height: 1.2rem;
		    margin-bottom: 5px;
		    transition: color 0.3s;
		    text-align: center;
		}

		/* TOP5æ›´æ–°æ™‚ã®å¼·èª¿è¡¨ç¤ºï¼ˆé‡‘è‰²ï¼‹ç‚¹æ»…ï¼‹æ‹¡å¤§ï¼‰ */
		.high-score-highlight {
		    color: #f1c40f !important;
		    font-size: 1.1rem !important;
		    text-shadow: 0 0 5px #e67e22;
		    animation: pulseText 1s infinite alternate;
		}

		@keyframes pulseText {
		    from { transform: scale(1); text-shadow: 0 0 5px #e67e22; }
		    to { transform: scale(1.1); text-shadow: 0 0 15px #e74c3c; }
		}
        
		.rp-progress-container {
		    width: 80%;
		    height: 10px;
		    background: #111;
		    border: 1px solid #555;
		    border-radius: 5px;
		    margin: 10px auto;
		    position: relative;
		    overflow: hidden;
		}

		.rp-progress-bar {
		    height: 100%;
		    background: linear-gradient(90deg, #a723e7, #00d2d3);
		    width: 0%;
		    transition: width 0.5s ease-out;
		    box-shadow: 0 0 10px rgba(167, 35, 231, 0.7);
		}

		.rp-next-info {
		    font-size: 0.8rem;
		    color: #ccc;
		    margin-top: 5px;
		    text-shadow: 0 0 2px black;
		}

		:root {
		    /* ...æ—¢å­˜ã®å¤‰æ•°... */
		    --mode-xyz: #1e272e; /* ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºç”¨ã®é»’/ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
		    --oru-color: #ff3f34; /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¦ãƒ‹ãƒƒãƒˆã®è‰² */
		}

		/* ...æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«... */

		/* ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒœã‚¿ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆè¿½åŠ ï¼‰ */
		#btn-select-xyz.active { background: var(--mode-xyz); box-shadow: 0 0 8px #ffffff; border-color: #fff; }

		/* æ¢ç´¢ãƒ‘ãƒãƒ«ã®æ è‰²ï¼ˆè¿½åŠ ï¼‰ */
		#expedition-panel.mode-xyz { border-color: var(--mode-xyz); box-shadow: 0 0 15px rgba(0,0,0,0.8); }

		/* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚«ãƒ¼ãƒ‰ç”¨ï¼ˆè¿½åŠ ï¼‰ */
		.reward-card.xyz-mode:hover { border-color: #fff; background: #000; box-shadow: 0 0 10px var(--oru-color); }
		.reward-card.selected.xyz-mode { border-color: var(--oru-color); background: #000; }

		/* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¦ãƒ‹ãƒƒãƒˆè¡¨ç¤ºãƒ‘ãƒãƒ« */
		#oru-display-panel {
		    background: linear-gradient(135deg, #000, #485460);
		    border: 2px solid var(--oru-color);
		    padding: 10px; border-radius: 8px;
		    margin-bottom: 15px; display: none;
		    color: white; font-weight: bold;
		    text-align: center;
		    box-shadow: 0 0 10px rgba(255, 63, 52, 0.3);
		    position: relative;
		    overflow: hidden;
		}
		/* èƒŒæ™¯ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è£…é£¾ */
		#oru-display-panel::before {
		    content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
		    background: radial-gradient(circle, transparent 20%, #000 120%);
		    animation: galaxy-rotate 20s linear infinite; opacity: 0.5; pointer-events: none;
		}
		@keyframes galaxy-rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

		.synchro-pair-container {
		    border: 2px solid #555;
		    border-radius: 15px;
		    padding: 25px 20px 20px 20px; /* ä¸Šéƒ¨ã¯ãƒ©ãƒ™ãƒ«ç”¨ã«å°‘ã—ç©ºã‘ã‚‹ */
		    display: flex;
		    gap: 15px;
		    position: relative;
		    background: rgba(255, 255, 255, 0.05);
		    transition: all 0.2s;
		    cursor: pointer;
		    margin: 10px;
		    align-items: center;
		    justify-content: center;
		}

		.mode-xyz .synchro-pair-container.selected {
		    border-color: #fff;
		    box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
		    background: rgba(255, 255, 255, 0.1);
		}

		.synchro-pair-container:hover {
		    background: rgba(255, 255, 255, 0.1);
		    border-color: #888;
		    transform: translateY(-2px);
		}

		/* é¸æŠã•ã‚ŒãŸçŠ¶æ…‹ï¼ˆæ ãŒå…‰ã‚‹ï¼‰ */
		.synchro-pair-container.selected {
		    border-color: var(--mode-synchro);
		    background: rgba(0, 206, 201, 0.1);
		    box-shadow: 0 0 15px rgba(0, 206, 201, 0.3);
		}

		/* Pairãƒ©ãƒ™ãƒ« */
		.synchro-pair-label {
		    position: absolute;
		    top: -12px;
		    left: 50%;
		    transform: translateX(-50%);
		    background: var(--mode-synchro);
		    color: #000;
		    font-weight: bold;
		    font-size: 0.8rem;
		    padding: 2px 12px;
		    border-radius: 10px;
		    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
		    border: 2px solid #222;
		    z-index: 5;
		}

		/* ã‚·ãƒ³ã‚¯ãƒ­ãƒ¢ãƒ¼ãƒ‰ã®ã‚«ãƒ¼ãƒ‰ã¯ãƒãƒ¼ã‚¸ãƒ³ç­‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ å†…ã«åã‚ã‚‹ */
		.reward-card.synchro-mode {
		    margin: 0 !important;
		    transform: none !important; /* ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¯ã‚³ãƒ³ãƒ†ãƒŠå´ã«ä»»ã›ã‚‹ */
		}

		/* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚­ãƒ«ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
		#xyz-active-panel {
		    display: none; 
		    margin: 10px 0 20px 0; 
		    gap: 15px; 
		    justify-content: center;
		    width: 100%;
		}

		.xyz-skill-card {
		    background: linear-gradient(135deg, #1e272e, #000);
		    border: 1px solid #485460;
		    border-radius: 12px;
		    padding: 10px;
		    width: 160px;
		    cursor: pointer;
		    transition: all 0.2s;
		    text-align: center;
		    position: relative;
		    overflow: hidden;
		    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
		}

		.xyz-skill-card:hover:not(:disabled) {
		    border-color: #fff;
		    transform: translateY(-2px);
		    box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
		}

		.xyz-skill-card:active:not(:disabled) {
		    transform: scale(0.95);
		}

		.xyz-skill-card:disabled {
		    opacity: 0.5;
		    cursor: not-allowed;
		    filter: grayscale(1);
		}

		.xyz-skill-name {
		    font-weight: bold;
		    font-size: 0.85rem;
		    color: #fff;
		    margin-bottom: 4px;
		    display: block;
		}

		.xyz-skill-cost {
		    font-size: 0.75rem;
		    color: var(--oru-color);
		    font-weight: bold;
		    display: block;
		}

		/* ç™ºå‹•ä¸­ï¼ˆãƒãƒ•é©ç”¨ä¸­ï¼‰ã®æ¼”å‡º */
		.xyz-skill-card.active-buff {
		    border-color: #2ecc71;
		    box-shadow: 0 0 20px rgba(46, 204, 113, 0.4);
		    animation: skill-pulse 2s infinite;
		}

		/* ãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­ã®æ¼”å‡º */
		.xyz-skill-card.active-penalty {
		    border-color: #e74c3c;
		    box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
		}

		@keyframes skill-pulse {
		    0% { opacity: 1; }
		    50% { opacity: 0.8; }
		    100% { opacity: 1; }
		}

		/* ã‚¹ã‚­ãƒ«ãƒœã‚¿ãƒ³å†…ã®ã‚¿ã‚¤ãƒãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ */
		.xyz-timer-container {
		    width: 100%;
		    height: 4px;
		    background: rgba(255, 255, 255, 0.1);
		    margin-top: 8px;
		    border-radius: 2px;
		    overflow: hidden;
		    display: none; /* é€šå¸¸æ™‚ã¯éè¡¨ç¤º */
		}

		/* ã‚¿ã‚¤ãƒãƒ¼ãƒãƒ¼æœ¬ä½“ */
		.xyz-timer-bar {
		    height: 100%;
		    width: 0%;
		    transition: width 0.1s linear;
		}

		/* ç¨¼åƒä¸­ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º */
		.active-buff .xyz-timer-container,
		.active-penalty .xyz-timer-container {
		    display: block;
		}

		/* ãƒãƒ•ä¸­ï¼ˆç·‘ï¼‰ã¨ãƒšãƒŠãƒ«ãƒ†ã‚£ä¸­ï¼ˆèµ¤ï¼‰ã®è‰² */
		.active-buff .xyz-timer-bar { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
		.active-penalty .xyz-timer-bar { background: #e74c3c; box-shadow: 0 0 5px #e74c3c; }

		/* å½¹å¼·åŒ–ãƒ©ã‚¤ãƒ³ã‚’æƒãˆã‚‹ãŸã‚ã®å›ºå®šå¹…ã‚¹ãƒšãƒ¼ã‚µãƒ¼ */
		.yaku-indent {
		    width: 480px; 
		    flex-shrink: 0;
		}

		/* å‚ç›´æ–¹å‘ã®éš™é–“ã‚’è©°ã‚ã‚‹è¨­å®š */
		.tree-row.yaku-series {
		    margin-top: -15px; /* ä¸Šã®è¡Œã¨ã®è·é›¢ã‚’ç¸®ã‚ã‚‹ */
		}

    </style>
</head>
<body>

<div class="container">
    <div class="sidebar"><div class="panel">
            <h3>è¨­å®š</h3>
            <div style="display:flex; flex-direction:column; gap:5px; align-items:center;">
                <div style="display:flex; justify-content:space-between; width:100%; font-size:0.8rem;">
                    <span>SEéŸ³é‡</span>
                    <span id="vol-disp" style="color:var(--accent);">30%</span>
                </div>
                <input type="range" id="vol-slider" min="0" max="100" value="30" style="width:100%; cursor:pointer;" oninput="setVolume(this.value)">
            </div>
        </div>
        <button id="reinc-btn" onclick="openReincarnationModal()">âœ¦ è»¢ç”Ÿãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>

        <div class="panel">
            <h3>é…å½“è¡¨</h3>
            <table id="payout-table">
                <tr id="row-payout-a5" style="display:none;"><td>ã‚¢ãƒ©ã‚·ï¼•</td><td class="é…å½“" id="pay-a5">10ä¸‡*</td></tr>
                <tr id="row-payout-s5" style="display:none;"><td>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼•</td><td class="é…å½“" id="pay-s5">5ä¸‡*</td></tr>
                
                <tr id="row-payout-a4" style="display:none;"><td>ã‚¢ãƒ©ã‚·ï¼”</td><td class="é…å½“" id="pay-a4">2ä¸‡*</td></tr>
                <tr id="row-payout-s4" style="display:none;"><td>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼”</td><td class="é…å½“" id="pay-s4">1ä¸‡*</td></tr>
                
                <tr><td>ãƒ”ãƒ³ã‚¾ãƒ­</td><td class="é…å½“" id="pay-pin">1ä¸‡</td></tr>
                <tr><td>ã‚¢ãƒ©ã‚·</td><td class="é…å½“" id="pay-arashi">2000*</td></tr>
                <tr><td>ã‚·ã‚´ãƒ­</td><td class="é…å½“" id="pay-456">1000*</td></tr>
                
                <tr><td>é€šå¸¸ç›®</td><td class="é…å½“" id="pay-normal">ç›®Ã—50</td></tr>
                <tr><td>ç›®ãªã—</td><td class="é…å½“" id="pay-none">10</td></tr>
            </table>
        </div>
        <div class="panel" id="panel-history" style="display:none;">
            <h3>å®¶è¨ˆç°¿ (TOP5)</h3>
            <ul id="history-list"></ul>
            <div id="spm-container" style="margin-top: 10px; border-top: 1px solid #333; padding-top: 8px; text-align: center;">
                <div style="font-size: 0.65rem; color: #888;">åˆ†é–“å¹³å‡ç²å¾—ã‚¹ã‚³ã‚¢</div>
                <div id="spm-display" style="color: var(--total-color); font-weight: bold; font-size: 1.1rem;">0</div>
            </div>
        </div>
        <div class="panel">
            <h3>ãƒ—ãƒ¼ãƒ«æƒ…å ±</h3>
            <div id="pool-stats" style="font-size: 0.7rem; line-height: 1.4; margin-bottom: 10px;"></div>
            <button id="btn-pool-detail" style="display:none; width:100%; padding:5px; background:var(--skill-line); color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.7rem;" onclick="openPoolDetail()">è©³ç´°ã‚’ç¢ºèª</button>
        </div>
        <div style="text-align:center;">
            <button onclick="saveGame()" style="background:#444; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.7rem;">æ‰‹å‹•ã‚»ãƒ¼ãƒ–</button>
            <button onclick="resetGame()" style="background:#c0392b; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.7rem; margin-left:5px;">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div class="game-area">
        <div id="rp-display-panel">
            è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆ: <span id="rp-val">0</span> Pt (å€ç‡: x<span id="rp-mult">1.0</span>)
        </div>

		<div id="oru-display-panel">
		    <span style="position:relative; z-index:2;">
		        ğŸŒŒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¦ãƒ‹ãƒƒãƒˆ: <span id="oru-val" style="color:var(--oru-color); font-size:1.2rem;">0</span>
		    </span>
		</div>

        <div id="expedition-panel" class="mode-normal">
            <div class="exp-header">
                <h3 id="exp-title" class="exp-title" style="color:var(--mode-normal);">ğŸ§­ é€šå¸¸æ¢ç´¢</h3>
            </div>
            
            <div id="mode-selector" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px;">
                <button id="btn-select-normal" class="mode-select-btn" onclick="setExpeditionMode('normal')">é€šå¸¸</button>
                <button id="btn-select-ritual" class="mode-select-btn" onclick="setExpeditionMode('ritual')">å„€å¼</button>
                <button id="btn-select-fusion" class="mode-select-btn" onclick="setExpeditionMode('fusion')">èåˆ</button>
                <button id="btn-select-synchro" class="mode-select-btn" onclick="setExpeditionMode('synchro')">ã‚·ãƒ³ã‚¯ãƒ­</button>
                <button id="btn-select-xyz" class="mode-select-btn" onclick="setExpeditionMode('xyz')">ã‚¨ã‚¯ã‚·ãƒ¼ã‚º</button>
            </div>

            <div class="exp-status">
                <div style="position: relative; width: 60px; height: 60px;">
                    <svg class="timer-svg" viewBox="0 0 36 36" style="width: 60px; height: 60px;">
                        <circle class="timer-bg" cx="18" cy="18" r="16"></circle>
                        <circle id="exp-prog" class="timer-progress" cx="18" cy="18" r="16"></circle>
                    </svg>
                    <div id="exp-timer-text" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:0.7rem;">READY</div>
                </div>
                <div id="exp-info" style="text-align: left;">
                    <div id="exp-cost-display">ã‚³ã‚¹ãƒˆ: 1ä¸‡5000 pts</div>
                    <div id="exp-msg" style="font-size: 0.8rem; color: #aaa;">æ–°ãŸãªå‡ºç›®ã‚’æ±‚ã‚ã¦æ¢ç´¢ã—ã¾ã™</div>
                </div>
                <button id="exp-action-btn" class="exp-btn" style="background:var(--mode-normal)" onclick="handleExpedition()">æ¢ç´¢é–‹å§‹</button>
            </div>
        </div>

        <div id="xyz-active-panel">
		    <button id="btn-xyz-shift" class="xyz-skill-card" onclick="useXyzActive('shift')">
			    <span class="xyz-skill-name">â© ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºãƒ»ã‚·ãƒ•ãƒˆ</span>
			    <span id="cost-xyz-shift" class="xyz-skill-cost">--- ORU</span>
			    <div class="xyz-timer-container">
			        <div id="xyz-shift-bar" class="xyz-timer-bar"></div>
			    </div>
			</button>

		    
		    <button id="btn-xyz-import" class="xyz-skill-card" onclick="useXyzActive('import')">
		        <span class="xyz-skill-name">ğŸ“¥ ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
		        <span id="cost-xyz-import" class="xyz-skill-cost">--- ORU</span>
		    </button>
		</div>

        <div class="score-container">
            <p class="score-label">ç·ç²å¾—ã‚¹ã‚³ã‚¢</p>
            <p id="total-score-display">0</p>
            <p class="score-label" style="margin-top:10px;">æ‰€æŒã‚¹ã‚³ã‚¢</p>
            <p id="score-board">0</p>
        </div>
        <span class="multiplier-tag">å€ç‡: x<span id="mult-val">1.0</span></span>
        <div id="game-fields"></div>
    </div>
</div>

<div id="save-notice">Game Saved</div>
<div id="offline-notice">ãŠã‹ãˆã‚Šãªã•ã„ï¼ä¸åœ¨ä¸­ã®åç›Šã‚’ç²å¾—ã—ã¾ã—ãŸã€‚</div>

<div id="reward-modal">
        <div class="modal-content" style="width: 600px;">
        <button class="close-modal-btn" onclick="discardRewards()">Ã—</button>
        <h2 id="reward-title" style="color:var(--accent);">æ¢ç´¢ã‹ã‚‰å¸°é‚„ï¼</h2>
        <p id="reward-desc">æŒã¡å¸°ã‚‹å‡ºç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p><button onclick="openPoolDetail()" style="margin-bottom:15px; padding:5px 15px; background:var(--skill-line); color:white; border:none; border-radius:15px; cursor:pointer; font-size:0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
            ğŸ“‹ ç¾åœ¨ã®ãƒ—ãƒ¼ãƒ«ã‚’ç¢ºèª
        </button>
        <p id="reward-count-msg" style="color:var(--auto-color); font-weight:bold;"></p>
        <div style="display:flex; justify-content:center; gap:15px; flex-wrap:wrap;" id="reward-list"></div>
        
        <div id="fusion-action-area" style="display:none; margin-top:20px;">
            <button id="btn-do-fuse" onclick="executeFusion()" disabled style="background:var(--mode-fusion); border:none; color:white; padding:10px 30px; border-radius:20px; font-weight:bold; font-size:1.1rem; cursor:not-allowed; opacity:0.5;">èåˆã‚’å®Ÿè¡Œ</button>
        </div>
        
        <div id="synchro-action-area" style="display:none; margin-top:20px;">
            <button id="btn-do-synchro" onclick="executeSynchro()" disabled style="background:var(--mode-synchro); border:none; color:black; padding:10px 30px; border-radius:20px; font-weight:bold; font-size:1.1rem; cursor:not-allowed; opacity:0.5;">ã‚·ãƒ³ã‚¯ãƒ­ã‚’å®Ÿè¡Œ</button>
        </div>

		<div id="xyz-action-area" style="display:none; margin-top:20px;">
            <button id="btn-do-xyz" onclick="executeXyz()" disabled style="background:var(--mode-xyz); border:1px solid #fff; color:white; padding:10px 30px; border-radius:20px; font-weight:bold; font-size:1.1rem; cursor:not-allowed; opacity:0.5;">ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼</button>
        </div>

        <div id="reward-action-area" style="display:none; margin-top:20px;">
            <button id="btn-confirm-reward" onclick="confirmRewards()" style="background:var(--accent); border:none; color:black; padding:10px 30px; border-radius:20px; font-weight:bold; font-size:1.1rem; cursor:pointer;">æ±ºå®š</button>
        </div>
        <button id="reward-cancel-btn" onclick="discardRewards()" style="margin-top:20px; background:#444; border:none; color:white; padding:10px 20px; border-radius:5px; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<div id="pool-detail-modal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-content" style="width: 600px;">
        <button class="close-modal-btn" onclick="document.getElementById('pool-detail-modal').style.display='none'">Ã—</button>
        <h2 style="color:var(--skill-line);">ãƒ—ãƒ¼ãƒ«ã®è©³ç´°</h2>
        <div id="pool-detail-content" class="pool-detail-grid"></div>
        <button onclick="document.getElementById('pool-detail-modal').style.display='none'" style="margin-top:20px; background:#444; border:none; color:white; padding:10px 20px; border-radius:5px; cursor:pointer;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<button id="shop-trigger" onclick="toggleModal(true)">
    ğŸ“
    <span id="shop-badge"></span>
</button>

<div id="upgrade-modal" onclick="if(event.target===this) toggleModal(false)">
    <div class="modal-content">
        <button class="close-modal-btn" onclick="toggleModal(false)">Ã—</button>
        <h2 style="color:var(--skill-line); margin:0;">SKILL TREE</h2>
        <p style="color:var(--accent);">æ‰€æŒã‚¹ã‚³ã‚¢: <span id="modal-score">0</span> pts</p>
        
        <div class="tree-container" id="tree-root">
            <svg class="svg-overlay" id="tree-svg"></svg>
            
            <div class="tree-row" style="gap: 50px;">
                <div id="node-finger" class="skill-node available" onclick="buyUpgrade('finger')"><span class="skill-icon">â˜ï¸</span><span id="lv-finger" class="lv-badge"></span><div class="skill-tooltip" id="tip-finger"></div></div>
                
                <div id="node-platinum_finger" class="skill-node locked" onclick="buyUpgrade('platinum_finger')"><span class="skill-icon" style="color:#e5e4e2; text-shadow:0 0 5px white;">ğŸ’</span><span id="lv-platinum_finger" class="lv-badge"></span><div class="skill-tooltip" id="tip-platinum_finger"></div></div>
            </div>

			<div class="tree-row" style="gap: 80px;">
			    <div id="node-auto" class="skill-node locked" onclick="buyUpgrade('auto')"><span class="skill-icon" id="icon-auto">ğŸ¤–</span><span id="lv-auto" class="lv-badge"></span><div class="skill-tooltip" id="tip-auto"></div></div>
			    <div id="node-field" class="skill-node locked" onclick="buyUpgrade('field')"><span class="skill-icon" id="icon-field">ğŸ²</span><span id="lv-field" class="lv-badge"></span><div class="skill-tooltip" id="tip-field"></div></div>
			    <div id="node-potential" class="skill-node locked" onclick="buyUpgrade('potential')"><span class="skill-icon" id="icon-potential">ğŸ’</span><span id="lv-potential" class="lv-badge"></span><div class="skill-tooltip" id="tip-potential"></div></div>
			</div>


			<div class="tree-row" style="gap: 20px;">
			    <div id="node-expedition" class="skill-node locked" onclick="buyUpgrade('expedition')">
			        <span class="skill-icon" id="icon-expedition">ğŸ§­</span>
			        <span id="lv-expedition" class="lv-badge"></span>
			        <div class="skill-tooltip" id="tip-expedition"></div>
			    </div>

			    <div style="display:flex; gap:15px; width: 385px; flex-shrink: 0; justify-content: flex-end;">
			        <div id="node-history" class="skill-node locked" onclick="buyUpgrade('history')"><span class="skill-icon" id="icon-history">ğŸ“–</span><span id="lv-history" class="lv-badge"></span><div class="skill-tooltip" id="tip-history"></div></div>
			        <div id="node-speed" class="skill-node locked" onclick="buyUpgrade('speed')"><span class="skill-icon" id="icon-speed">âš¡</span><span id="lv-speed" class="lv-badge"></span><div class="skill-tooltip" id="tip-speed"></div></div>
			    </div>

			    <div id="node-yaku_none" class="skill-node locked" onclick="buyUpgrade('yaku_none')">
			        <span class="skill-icon" id="icon-yaku_none">â”</span>
			        <span id="lv-yaku_none" class="lv-badge"></span>
			        <div class="skill-tooltip" id="tip-yaku_none"></div>
			    </div>
			</div>



			<div class="tree-row yaku-series" style="gap: 15px;">
			    <div style="display:flex; gap:15px; width: 480px; flex-shrink: 0;">
			        <div id="node-ritual_unlock" class="skill-node locked" onclick="buyUpgrade('ritual_unlock')"><span class="skill-icon" id="icon-ritual_unlock">ğŸ”®</span><span id="lv-ritual_unlock" class="lv-badge"></span><div class="skill-tooltip" id="tip-ritual_unlock"></div></div>
			        <div id="node-exp_speed" class="skill-node locked" onclick="buyUpgrade('exp_speed')"><span class="skill-icon" id="icon-exp_speed">â©</span><span id="lv-exp_speed" class="lv-badge"></span><div class="skill-tooltip" id="tip-exp_speed"></div></div>
			        <div id="node-exp_amount" class="skill-node locked" onclick="buyUpgrade('exp_amount')"><span class="skill-icon" id="icon-exp_amount">ğŸ“¦</span><span id="lv-exp_amount" class="lv-badge"></span><div class="skill-tooltip" id="tip-exp_amount"></div></div>
			        <div id="node-digital_history" class="skill-node locked" onclick="buyUpgrade('digital_history')"><span class="skill-icon" id="icon-digital_history">ğŸ“±</span><span id="lv-digital_history" class="lv-badge"></span><div class="skill-tooltip" id="tip-digital_history"></div></div>
			        <div id="node-throw" class="skill-node locked" onclick="buyUpgrade('throw')"><span class="skill-icon" id="icon-throw">ğŸ¯</span><span id="lv-throw" class="lv-badge"></span><div class="skill-tooltip" id="tip-throw"></div></div>
			    </div>
			    <div id="node-yaku_normal" class="skill-node locked" onclick="buyUpgrade('yaku_normal')"><span class="skill-icon" id="icon-yaku_normal">âš‚</span><span id="lv-yaku_normal" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_normal"></div></div>
			</div>

			<div class="tree-row yaku-series" style="gap: 15px;">
			    <div style="display:flex; gap:15px; width: 480px; flex-shrink: 0;">
			        <div id="node-ritual_amount" class="skill-node locked" onclick="buyUpgrade('ritual_amount')"><span class="skill-icon" id="icon-ritual_amount">ğŸŒ‘</span><span id="lv-ritual_amount" class="lv-badge"></span><div class="skill-tooltip" id="tip-ritual_amount"></div></div>
			        <div id="node-simple_fusion" class="skill-node locked" onclick="buyUpgrade('simple_fusion')"><span class="skill-icon">ğŸœ</span><span id="lv-simple_fusion" class="lv-badge"></span><div class="skill-tooltip" id="tip-simple_fusion"></div></div>
			        <div id="node-urgent_tuning" class="skill-node locked" onclick="buyUpgrade('urgent_tuning')" style="display:none;"><span class="skill-icon" style="color:var(--mode-synchro);">âš¡</span><span id="lv-urgent_tuning" class="lv-badge"></span><div class="skill-tooltip" id="tip-urgent_tuning"></div></div>
			    </div>
			    <div id="node-yaku_456" class="skill-node locked" onclick="buyUpgrade('yaku_456')"><span class="skill-icon" id="icon-yaku_456">âœ¨</span><span id="lv-yaku_456" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_456"></div></div>
			</div>

			<div class="tree-row yaku-series" style="gap: 15px;">
			    <div style="display:flex; gap:15px; width: 480px; flex-shrink: 0;">
			        <div id="node-fusion_exp" class="skill-node locked" onclick="buyUpgrade('fusion_exp')" style="display:none;"><span class="skill-icon" style="color:var(--mode-fusion)">ğŸ”¥</span><span id="lv-fusion_exp" class="lv-badge"></span><div class="skill-tooltip" id="tip-fusion_exp"></div></div>
			        <div id="node-fusion_exp_amount" class="skill-node locked" onclick="buyUpgrade('fusion_exp_amount')" style="display:none;"><span class="skill-icon" style="color:var(--mode-fusion)">ğŸ“¦</span><span id="lv-fusion_exp_amount" class="lv-badge"></span><div class="skill-tooltip" id="tip-fusion_exp_amount"></div></div>
			    </div>
			    <div id="node-yaku_arashi" class="skill-node locked" onclick="buyUpgrade('yaku_arashi')"><span class="skill-icon" id="icon-yaku_arashi">ğŸŒ€</span><span id="lv-yaku_arashi" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_arashi"></div></div>
			</div>

			<div class="tree-row yaku-series" style="gap: 15px;">
			    <div style="display:flex; gap:15px; width: 480px; flex-shrink: 0;">
			        <div id="node-synchro_exp" class="skill-node locked" onclick="buyUpgrade('synchro_exp')" style="display:none;"><span class="skill-icon" style="color:var(--mode-synchro)">âš›ï¸</span><span id="lv-synchro_exp" class="lv-badge"></span><div class="skill-tooltip" id="tip-synchro_exp"></div></div>
			        <div id="node-tuning" class="skill-node locked" onclick="buyUpgrade('tuning')" style="display:none;"><span class="skill-icon">ğŸ»</span><span id="lv-tuning" class="lv-badge"></span><div class="skill-tooltip" id="tip-tuning"></div></div>
			        <div id="node-accel_synchro" class="skill-node locked" onclick="buyUpgrade('accel_synchro')" style="display:none;"><span class="skill-icon">ğŸï¸</span><span id="lv-accel_synchro" class="lv-badge"></span><div class="skill-tooltip" id="tip-accel_synchro"></div></div>
			    </div>
			    <div id="node-yaku_pin" class="skill-node locked" onclick="buyUpgrade('yaku_pin')"><span class="skill-icon" id="icon-yaku_pin">ğŸ”¥</span><span id="lv-yaku_pin" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_pin"></div></div>
			</div>

			<div class="tree-row yaku-series" style="gap: 15px;">
			    <div style="display:flex; gap:15px; width: 480px; flex-shrink: 0;">
			        <div id="node-xyz_exp" class="skill-node locked" onclick="buyUpgrade('xyz_exp')" style="display:none;"><span class="skill-icon" style="color:var(--mode-xyz); text-shadow:0 0 5px #fff;">âœ–ï¸</span><span id="lv-xyz_exp" class="lv-badge"></span><div class="skill-tooltip" id="tip-xyz_exp"></div></div>
			        <div id="node-rank_revolution" class="skill-node locked" onclick="buyUpgrade('rank_revolution')" style="display:none;"><span class="skill-icon" style="color:#f1c40f;">ğŸ’</span><span id="lv-rank_revolution" class="lv-badge"></span><div class="skill-tooltip" id="tip-rank_revolution"></div></div>
			    </div>
			</div>

			<div class="tree-row yaku-series" id="row-yaku-s4" style="display:none;">
			    <div class="yaku-indent"></div>
			    <div id="node-yaku_straight4" class="skill-node locked" onclick="buyUpgrade('yaku_straight4')"><span class="skill-icon">4ï¸âƒ£</span><span id="lv-yaku_straight4" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_straight4"></div></div>
			</div>

			<div class="tree-row yaku-series" id="row-yaku-a4" style="display:none;">
			    <div class="yaku-indent"></div>
			    <div id="node-yaku_arashi4" class="skill-node locked" onclick="buyUpgrade('yaku_arashi4')"><span class="skill-icon">ğŸŒªï¸</span><span id="lv-yaku_arashi4" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_arashi4"></div></div>
			</div>

			<div class="tree-row yaku-series" id="row-yaku-s5" style="display:none;">
			    <div class="yaku-indent"></div>
			    <div id="node-yaku_straight5" class="skill-node locked" onclick="buyUpgrade('yaku_straight5')"><span class="skill-icon">5ï¸âƒ£</span><span id="lv-yaku_straight5" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_straight5"></div></div>
			</div>

			<div class="tree-row yaku-series" id="row-yaku-a5" style="display:none;">
			    <div class="yaku-indent"></div>
			    <div id="node-yaku_arashi5" class="skill-node locked" onclick="buyUpgrade('yaku_arashi5')"><span class="skill-icon">ğŸŒˆ</span><span id="lv-yaku_arashi5" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_arashi5"></div></div>
			</div>


        </div>

        <button onclick="toggleModal(false)" style="margin-top:30px; width:100%; padding:12px; background:#333; border:none; color:white; border-radius:8px; cursor:pointer;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="reinc-modal" class="reinc-bg">
    <div class="modal-content reinc-bg">
        <h2 style="color:var(--reinc-color); margin:0;">REINCARNATION</h2>
        <p style="color:var(--reinc-color); font-weight:bold; font-size:1.2rem;">æ‰€æŒãƒã‚¤ãƒ³ãƒˆ: <span id="reinc-point-disp">0</span> Pt</p>
        
        <div id="reinc-action-area" style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #7d3c98;">
            <p>ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ã«åŸºã¥ãç²å¾—å¯èƒ½ãƒã‚¤ãƒ³ãƒˆ: <span id="pending-rp" style="color:white; font-weight:bold;">0</span></p>
            <p id="reinc-gain-msg" style="color:#e056fd; font-weight:bold;"></p>
            
            <div id="rp-progress-area" style="margin-bottom: 15px;">
                <div class="rp-progress-container">
                    <div id="rp-progress-bar" class="rp-progress-bar"></div>
                </div>
                <div id="rp-next-msg" class="rp-next-info">æ¬¡ã®ãƒã‚¤ãƒ³ãƒˆ(+1)ã¾ã§: ã‚ã¨ 0 ã‚¹ã‚³ã‚¢</div>
            </div>
            <div style="display:flex; justify-content:center; gap:10px;">
                <button id="do-reinc-btn" onclick="doReincarnation()" style="background:linear-gradient(135deg, #a723e7, #5f27cd); color:white; border:none; padding:10px 30px; border-radius:20px; font-weight:bold; font-size:1.1rem; cursor:pointer; margin-top:10px;">è»¢ç”Ÿã‚’å®Ÿè¡Œã™ã‚‹</button>
                <button onclick="toggleReincModal(false)" style="background:#555; color:white; border:none; padding:10px 20px; border-radius:20px; font-weight:bold; font-size:1rem; cursor:pointer; margin-top:10px;">é–‰ã˜ã‚‹</button>
            </div>
            <div style="font-size:0.7rem; color:#f39c12; margin-top:5px;">â€»å®Ÿè¡Œã™ã‚‹ã¨å³åº§ã«ã‚¹ã‚³ã‚¢ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</div>
        </div>

        <div id="reinc-finish-area" style="display:none; background:rgba(45, 15, 56, 0.8); padding:15px; border-radius:10px; margin-bottom:20px; border:2px solid #2ecc71;">
             <p id="reinc-gain-msg-2" style="color:#2ecc71; font-weight:bold; font-size:1.2rem; margin:0;">è»¢ç”Ÿå®Œäº†ï¼</p>
             <p style="font-size:0.9rem;">ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚<br>æº–å‚™ãŒã§ããŸã‚‰ä¸‹ã®ãƒœã‚¿ãƒ³ã§å‡ºç™ºã—ã¾ã—ã‚‡ã†ã€‚</p>
             <button onclick="finishReincarnation()" style="background:linear-gradient(135deg, #2ecc71, #27ae60); color:white; border:none; padding:15px 40px; border-radius:30px; font-weight:bold; font-size:1.3rem; cursor:pointer; margin-top:10px; box-shadow:0 0 15px rgba(46, 204, 113, 0.5);">æ–°ã—ã„ä¸–ç•Œã¸æ—…ç«‹ã¤</button>
        </div>

        <h3 style="color:var(--reinc-color); border-bottom:1px solid var(--reinc-color);">è»¢ç”Ÿã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</h3>
        <p id="reinc-view-mode-msg">â€»ãƒ©ãƒ³ã®é€”ä¸­ã®ãŸã‚ã€å†…å®¹ã®ç¢ºèªã®ã¿å¯èƒ½ã§ã™</p>
        
        <div class="tree-container" id="reinc-tree-root" style="margin-top:20px;">
            <svg class="svg-overlay" id="reinc-tree-svg"></svg>
            
            <div class="tree-row">
                <div id="rnode-wallet" class="skill-node reinc-node available" onclick="buyReincUpgrade('wallet')"><span class="skill-icon">ğŸ‘›</span><span id="rlv-wallet" class="lv-badge"></span><div class="skill-tooltip" id="rtip-wallet"></div></div>
            </div>
            
            <div class="tree-row" style="gap:50px;">
                <div id="rnode-greedy_exp" class="skill-node reinc-node locked" onclick="buyReincUpgrade('greedy_exp')"><span class="skill-icon">ğŸ¤©</span><span id="rlv-greedy_exp" class="lv-badge"></span><div class="skill-tooltip" id="rtip-greedy_exp"></div></div>
                <div id="rnode-greedy_rit" class="skill-node reinc-node locked" onclick="buyReincUpgrade('greedy_rit')"><span class="skill-icon">ğŸ˜ˆ</span><span id="rlv-greedy_rit" class="lv-badge"></span><div class="skill-tooltip" id="rtip-greedy_rit"></div></div>
            </div>

            <div class="tree-row">
                <div id="rnode-privatize" class="skill-node reinc-node locked" onclick="buyReincUpgrade('privatize')"><span class="skill-icon">ğŸ”¢</span><span id="rlv-privatize" class="lv-badge"></span><div class="skill-tooltip" id="rtip-privatize"></div></div>
            </div>

            <div class="tree-row">
                <div id="rnode-straight" class="skill-node reinc-node locked" onclick="buyReincUpgrade('straight')"><span class="skill-icon">ğŸ“</span><span id="rlv-straight" class="lv-badge"></span><div class="skill-tooltip" id="rtip-straight"></div></div>
            </div>

            <div class="tree-row" style="gap: 50px;">
                <div id="rnode-fusion_dim" class="skill-node reinc-node locked" onclick="buyReincUpgrade('fusion_dim')"><span class="skill-icon">ğŸŒŒ</span><span id="rlv-fusion_dim" class="lv-badge"></span><div class="skill-tooltip" id="rtip-fusion_dim"></div></div>
                <div id="rnode-fusion_limit" class="skill-node reinc-node locked" onclick="buyReincUpgrade('fusion_limit')"><span class="skill-icon">ğŸ§±</span><span id="rlv-fusion_limit" class="lv-badge"></span><div class="skill-tooltip" id="rtip-fusion_limit"></div></div>
                <div id="rnode-tuner" class="skill-node reinc-node locked" onclick="buyReincUpgrade('tuner')"><span class="skill-icon">ğŸ›ï¸</span><span id="rlv-tuner" class="lv-badge"></span><div class="skill-tooltip" id="rtip-tuner"></div></div>
            </div>

            <div class="tree-row" style="gap: 40px;">
                <div id="rnode-straight4" class="skill-node reinc-node locked" onclick="buyReincUpgrade('straight4')"><span class="skill-icon">4ï¸âƒ£</span><span id="rlv-straight4" class="lv-badge"></span><div class="skill-tooltip" id="rtip-straight4"></div></div>
                <div id="rnode-rare_magic" class="skill-node reinc-node locked" onclick="buyReincUpgrade('rare_magic')"><span class="skill-icon" style="color:var(--rare-magic)">M</span><span id="rlv-rare_magic" class="lv-badge"></span><div class="skill-tooltip" id="rtip-rare_magic"></div></div>
                <div id="rnode-synchro_dim" class="skill-node reinc-node locked" onclick="buyReincUpgrade('synchro_dim')"><span class="skill-icon" style="color:var(--mode-synchro)">âš›ï¸</span><span id="rlv-synchro_dim" class="lv-badge"></span><div class="skill-tooltip" id="rtip-synchro_dim"></div></div>
            </div>

            <div class="tree-row" style="gap: 40px;">
                <div id="rnode-arashi4" class="skill-node reinc-node locked" onclick="buyReincUpgrade('arashi4')"><span class="skill-icon">ğŸŒªï¸</span><span id="rlv-arashi4" class="lv-badge"></span><div class="skill-tooltip" id="rtip-arashi4"></div></div>
                <div id="rnode-rare_epic" class="skill-node reinc-node locked" onclick="buyReincUpgrade('rare_epic')"><span class="skill-icon" style="color:var(--rare-epic)">E</span><span id="rlv-rare_epic" class="lv-badge"></span><div class="skill-tooltip" id="rtip-rare_epic"></div></div>
                <div id="rnode-clear_mind" class="skill-node reinc-node locked" onclick="buyReincUpgrade('clear_mind')"><span class="skill-icon">âœ¨</span><span id="rlv-clear_mind" class="lv-badge"></span><div class="skill-tooltip" id="rtip-clear_mind"></div></div>
                <div id="rnode-adv_exp" class="skill-node reinc-node locked" onclick="buyReincUpgrade('adv_exp')"><span class="skill-icon">ğŸ’</span><span id="rlv-adv_exp" class="lv-badge"></span><div class="skill-tooltip" id="rtip-adv_exp"></div></div>
            </div>
            
            <div class="tree-row" style="gap: 40px;">
                <div id="rnode-straight5" class="skill-node reinc-node locked" onclick="buyReincUpgrade('straight5')"><span class="skill-icon">5ï¸âƒ£</span><span id="rlv-straight5" class="lv-badge"></span><div class="skill-tooltip" id="rtip-straight5"></div></div>
                <div id="rnode-rare_legend" class="skill-node reinc-node locked" onclick="buyReincUpgrade('rare_legend')"><span class="skill-icon" style="color:var(--rare-legendary)">L</span><span id="rlv-rare_legend" class="lv-badge"></span><div class="skill-tooltip" id="rtip-rare_legend"></div></div>
                <div id="rnode-top_clear_mind" class="skill-node reinc-node locked" onclick="buyReincUpgrade('top_clear_mind')"><span class="skill-icon">ğŸŒ </span><span id="rlv-top_clear_mind" class="lv-badge"></span><div class="skill-tooltip" id="rtip-top_clear_mind"></div></div>
                <div style="width: 75px; height: 75px; visibility: hidden;"></div>
            </div>

            <div class="tree-row" style="gap: 40px;">
                <div id="rnode-arashi5" class="skill-node reinc-node locked" onclick="buyReincUpgrade('arashi5')"><span class="skill-icon">ğŸŒˆ</span><span id="rlv-arashi5" class="lv-badge"></span><div class="skill-tooltip" id="rtip-arashi5"></div></div>
                <div id="rnode-rare_eternal" class="skill-node reinc-node locked" onclick="buyReincUpgrade('rare_eternal')"><span class="skill-icon" style="color:#fff; text-shadow:0 0 5px #fff;">âˆ</span><span id="rlv-rare_eternal" class="lv-badge"></span><div class="skill-tooltip" id="rtip-rare_eternal"></div></div>
                <div id="rnode-over_top_clear_mind" class="skill-node reinc-node locked" onclick="buyReincUpgrade('over_top_clear_mind')"><span class="skill-icon">ğŸŒŒ</span><span id="rlv-over_top_clear_mind" class="lv-badge"></span><div class="skill-tooltip" id="rtip-over_top_clear_mind"></div></div>
                <div id="rnode-adv_adv_exp" class="skill-node reinc-node locked" onclick="buyReincUpgrade('adv_adv_exp')"><span class="skill-icon">ğŸ’</span><span id="rlv-adv_adv_exp" class="lv-badge"></span><div class="skill-tooltip" id="rtip-adv_adv_exp"></div></div>
            </div>

			<div class="tree-row" style="gap: 40px; margin-top: 30px;">
			    <div id="rnode-xyz_dim" class="skill-node reinc-node locked" onclick="buyReincUpgrade('xyz_dim')">
			        <span class="skill-icon" style="color:#000; text-shadow:0 0 5px #fff; font-family:serif;">X</span>
			        <span id="rlv-xyz_dim" class="lv-badge"></span>
			        <div class="skill-tooltip" id="rtip-xyz_dim"></div>
			    </div>
			</div>

        </div>
    </div>
</div>



<div id="xyz-upgrade-modal" onclick="if(event.target===this) toggleXyzModal(false)" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; z-index: 1500;">
    <div class="modal-content" style="border-color: #fff; background: linear-gradient(180deg, #000, #1e272e);">
        <button class="close-modal-btn" onclick="toggleXyzModal(false)">Ã—</button>
        <h2 style="color:#fff; text-shadow: 0 0 10px var(--oru-color);">XYZ UPGRADE</h2>
        <p style="color:var(--oru-color);">æ‰€æŒãƒ¦ãƒ‹ãƒƒãƒˆ: <span id="modal-oru">0</span> ORU</p>
        
        <div class="tree-container" id="xyz-tree-root">
            <svg class="svg-overlay" id="xyz-tree-svg"></svg>
            
            <div class="tree-row">
                <div id="xnode-network" class="skill-node available" onclick="buyXyzUpgrade('network')"><span class="skill-icon">ğŸŒ</span><span id="xlv-network" class="lv-badge"></span><div class="skill-tooltip" id="xtip-network"></div></div>
            </div>

            <div class="tree-row" style="gap: 80px;">
                <div id="xnode-shift_unlock" class="skill-node locked" onclick="buyXyzUpgrade('shift_unlock')"><span class="skill-icon">â©</span><span id="xlv-shift_unlock" class="lv-badge"></span><div class="skill-tooltip" id="xtip-shift_unlock"></div></div>
                <div id="xnode-pack_uncommon" class="skill-node locked" onclick="buyXyzUpgrade('pack_uncommon')"><span class="skill-icon">ğŸŸ¢</span><span id="xlv-pack_uncommon" class="lv-badge"></span><div class="skill-tooltip" id="xtip-pack_uncommon"></div></div>
            </div>

            <div class="tree-row" style="gap: 80px;">
                <div id="xnode-import_unlock" class="skill-node locked" onclick="buyXyzUpgrade('import_unlock')"><span class="skill-icon">ğŸ“¥</span><span id="xlv-import_unlock" class="lv-badge"></span><div class="skill-tooltip" id="xtip-import_unlock"></div></div>
                <div id="xnode-pack_rare" class="skill-node locked" onclick="buyXyzUpgrade('pack_rare')"><span class="skill-icon">ğŸ”µ</span><span id="xlv-pack_rare" class="lv-badge"></span><div class="skill-tooltip" id="xtip-pack_rare"></div></div>
            </div>
        </div>
        <button onclick="toggleXyzModal(false)" style="margin-top:30px; width:100%; padding:12px; background:#333; border:none; color:white; border-radius:8px; cursor:pointer;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<button id="xyz-trigger" onclick="toggleXyzModal(true)" style="display:none; position: fixed; bottom: 20px; right: 90px; background: #000; border: 2px solid #fff; width: 60px; height: 60px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; color: white; box-shadow: 0 0 10px #fff; z-index: 100;">
    âœ–ï¸
</button>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
    let score = 0;
    let totalScore = 0;
    let multiplier = 1;
    let hasAutoRoll = false;
    let fieldCount = 1;
    let fieldTimers = [];
    let scoreHistory = [];
    let spmSamples = []; // è¿½åŠ ï¼š1ç§’ã”ã¨ã®ã‚¹ã‚³ã‚¢è¨˜éŒ²ç”¨
    let spmTimer = 0;    // è¿½åŠ ï¼š1ç§’ã‚«ã‚¦ãƒ³ãƒˆç”¨
    let dicePool = [];
    const AUTO_BASE_TIME = 6000;
    let isResetting = false;
    let isReincarnationPhase = false;

    let reincData = {
        points: 0,       
        maxReachedRP: 0, 
        upgrades: {}
    };
    const REINC_THRESHOLD = 10000000000; // 100å„„

    let expStatus = 'idle'; 
    let expMode = 'normal'; 
    let expTimeRemaining = 0;
    const EXP_DURATION_BASE = 180 * 1000; 
    let expNextCost = 15000;
    let ritualNextCost = 500000; 
    let fusionNextCost = 10000000; 
    let synchroNextCost = 100000000;
    let overlayUnits = 0;
    let xyzNextCost = 1000000000000;
    
    let currentRewards = []; 
    let rewardSelectCount = 1; 
    let reincTimer = null;

    let lastTickTime = Date.now();

    let currentSPM = 0; // ç¾åœ¨ã®åˆ†é–“ã‚¹ã‚³ã‚¢ã‚’ä¿æŒ
    let consecutiveNoTakeCount = 0;
    
    function formatTimeEst(minutes) {
        if (!isFinite(minutes) || minutes < 0) return "---";
        if (minutes === 0) return "0ç§’";
        
        // éå¸¸ã«é•·ã„å ´åˆ
        if (minutes > 525600) return "1å¹´ä»¥ä¸Š"; // ç°¡æ˜“ã‚­ãƒ£ãƒƒãƒ—

        const seconds = Math.floor(minutes * 60);
        if (seconds < 60) return seconds + "ç§’";
        
        const mins = Math.floor(minutes);
        if (mins < 60) return mins + "åˆ†";
        
        const hours = Math.floor(mins / 60);
        const remMins = mins % 60;
        if (hours < 24) return `${hours}æ™‚é–“${remMins}åˆ†`;
        
        const days = Math.floor(hours / 24);
        const remHours = hours % 24;
        return `${days}æ—¥${remHours}æ™‚é–“`;
    }

	// ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºãƒ»ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®çŠ¶æ…‹ï¼ˆè»¢ç”Ÿã§ãƒªã‚»ãƒƒãƒˆï¼‰
	let xyzUpgState = {
	    network: { lv: 0, max: 100, baseCost: 10, name: "ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", icon: "ğŸŒ", desc: "æœ€çµ‚ã‚¹ã‚³ã‚¢å€ç‡ +20%", req: null },
	    shift_unlock: { lv: 0, max: 1, baseCost: 10000, name: "ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºãƒ»ã‚·ãƒ•ãƒˆ", icon: "â©", desc: "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚­ãƒ«ã‚’è§£æ”¾", req: "network", reqLv: 1 },
	    pack_uncommon: { lv: 0, max: 5, costs: [1000, 2500, 5000, 10000, 30000], name: "ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³ãƒ»ãƒ‘ãƒƒã‚¯", icon: "ğŸŸ¢", desc: "æ¢ç´¢ã§ã‚³ãƒ¢ãƒ³ãŒå‡ºã«ãããªã‚‹", req: "network", reqLv: 1 },
	    import_unlock: { lv: 0, max: 1, baseCost: 200000, name: "ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ", icon: "ğŸ“¥", desc: "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚­ãƒ«ã‚’è§£æ”¾", req: "shift_unlock", reqLv: 1 },
	    pack_rare: { lv: 0, max: 5, costs: [10000, 25000, 50000, 100000, 300000], name: "ãƒ¬ã‚¢ãƒ»ãƒ‘ãƒƒã‚¯", icon: "ğŸ”µ", desc: "æ¢ç´¢ã§ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³ãŒå‡ºã«ãããªã‚‹", req: "pack_uncommon", reqLv: 5 }
	};

    

	// ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚­ãƒ«ã®ä½¿ç”¨å›æ•°ã¨ã‚¿ã‚¤ãƒãƒ¼
	let activeUsage = { shift: 0, import: 0 };
	let activeTimers = { shift: 0, shiftPenalty: 0 };

    // ãƒ¬ã‚¢ãƒªãƒ†ã‚£å®šç¾©ï¼ˆé †åºé‡è¦ï¼‰
    const RARITY_ORDER = ['common', 'uncommon', 'rare', 'super', 'ultra', 'magic', 'epic', 'legendary', 'eternal'];
    let RARITIES = {};

    const upgState = {
        finger: { lv: 0, max: 3, costs: [100, 1000, 3000], name: "é»„é‡‘ã®æŒ‡", icon: "â˜ï¸", desc: "ç²å¾—ã‚¹ã‚³ã‚¢+100%", req: null },
        platinum_finger: { lv: 0, max: 2000, costs: Array.from({length:2000}, (_,i)=>1000 * Math.pow(2, i)), name: "ç™½é‡‘ã®æŒ‡", icon: "ğŸ’", desc: "ç²å¾—ã‚¹ã‚³ã‚¢+10%<br>(ä¹—ç®—ãƒœãƒ¼ãƒŠã‚¹)", req: "finger", reqLv: 3 },
        
        auto: { lv: 0, max: 1, costs: [3000], name: "è‡ªå‹•ãƒ­ãƒ¼ãƒ«", icon: "ğŸ¤–", desc: "è‡ªå‹•ã§ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã‚‹", req: "finger" },
        field: { lv: 0, max: 9, costs: [2000, 5000, 10000, 30000, 70000, 150000, 300000, 500000, 1000000], name: "å ´ã‚’è¿½åŠ ", icon: "ğŸ²", desc: "å ´ã‚’å¢—ã‚„ã™", req: "finger" },
        expedition: { lv: 0, max: 1, costs: [15000], name: "é€šå¸¸æ¢ç´¢", icon: "ğŸ§­", desc: "å‡ºç›®æ¢ç´¢ã‚’è§£æ”¾", req: "auto" },
        history: { lv: 0, max: 1, costs: [100], name: "å®¶è¨ˆç°¿", icon: "ğŸ“–", desc: "é…å½“TOP5ã‚’è¡¨ç¤º", req: "auto" },
        speed: { lv: 0, max: 20, costs: Array.from({length:20}, (_,i)=>Math.floor(5000 * Math.pow(2.0, i))), name: "æ™‚é–“çŸ­ç¸®", icon: "âš¡", desc: "è‡ªå‹•é–“éš”-0.2s", req: "auto" },
        digital_history: { lv: 0, max: 1, costs: [300], name: "é›»å­å®¶è¨ˆç°¿", icon: "ğŸ“±", desc: "ãƒ—ãƒ¼ãƒ«ã®è©³ç´°ã‚’ç¢ºèªå¯èƒ½ã«ã™ã‚‹", req: ["history", "expedition"] },
        potential: { lv: 0, max: 2, costs: [50000, 50000000], name: "ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«", icon: "ğŸ’", desc: "ãƒ€ã‚¤ã‚¹æ•°+1", req: "field" },
        exp_speed: { lv: 0, max: 10, costs: Array.from({length:10}, (_,i)=>100000 * Math.pow(1.5, i)), name: "æ¢ç´¢çŸ­ç¸®", icon: "â©", desc: "æ¢ç´¢æ™‚é–“ -16ç§’", req: "expedition" },
        simple_fusion: { lv: 0, max: 1, costs: [10000000], name: "ç°¡æ˜“èåˆ", icon: "ğŸœ", desc: "æ¢ç´¢æ™‚é–“ã‚’åŠåˆ†ã«ã™ã‚‹", req: "exp_speed", reqLv: 1, reincReq: "fusion_dim" },
        urgent_tuning: {
            lv: 0, max: 1, 
            costs: [1000000000000], // 1å…†
            name: "ç·Šæ€¥åŒèª¿", 
            icon: "âš¡", 
            desc: "æ¢ç´¢æ™‚é–“ã‚’ã•ã‚‰ã«åŠåˆ†ã«ã™ã‚‹", 
            req: "simple_fusion", 
            reincReq: "synchro_dim" // ã‚·ãƒ³ã‚¯ãƒ­æ¬¡å…ƒè§£æ”¾æ¸ˆã¿ã®ã¿è¡¨ç¤º
        },
        exp_amount: { lv: 0, max: 3, costs: [1000000, 5000000, 20000000], name: "é€šå¸¸æ¢ç´¢å¼·åŒ–", icon: "ğŸ“¦", desc: "æ¢ç´¢ã®é¸æŠè‚¢+1", req: "expedition" },
        
        ritual_unlock: { lv: 0, max: 1, costs: [500000], name: "å„€å¼æ¢ç´¢", icon: "ğŸ”®", desc: "ãƒ—ãƒ¼ãƒ«å‰Šé™¤å¯èƒ½ãªå„€å¼ã‚’è§£æ”¾", req: "expedition" },
        ritual_amount: { lv: 0, max: 3, costs: [1000000, 5000000, 20000000], name: "å„€å¼æ¢ç´¢å¼·åŒ–", icon: "ğŸŒ‘", desc: "å„€å¼ã®é¸æŠè‚¢+1", req: "ritual_unlock" },

        fusion_exp: { lv: 0, max: 1, costs: [10000000], name: "èåˆæ¢ç´¢", icon: "ğŸ”¥", desc: "å‡ºç›®ã‚’èåˆã—å¼·åŒ–ã™ã‚‹æ¢ç´¢ã‚’è§£æ”¾", req: "ritual_amount", reincReq: "fusion_dim" },
        fusion_exp_amount: { lv: 0, max: 3, costs: [50000000, 5000000000, 500000000000], name: "èåˆæ¢ç´¢å¼·åŒ–", icon: "ğŸ“¦", desc: "èåˆå€™è£œã®é¸æŠè‚¢+1", req: "fusion_exp", reincReq: "fusion_dim" },

        synchro_exp: { lv: 0, max: 1, costs: [100000000], name: "ã‚·ãƒ³ã‚¯ãƒ­æ¢ç´¢", icon: "âš›ï¸", desc: "åŒã˜å‡ºç›®ã‚’ã‚·ãƒ³ã‚¯ãƒ­ã•ã›ã‚‹æ¢ç´¢ã‚’è§£æ”¾", req: "fusion_exp", reincReq: "synchro_dim" },
        tuning: { 
            lv: 0, max: 3, 
            costs: [1000000000, 10000000000, 100000000000], // 10å„„, 100å„„, 1000å„„
            name: "èª¿å¾‹", icon: "ğŸ»", 
            desc: "ã‚·ãƒ³ã‚¯ãƒ­æ¢ç´¢ã§æç¤ºã•ã‚Œã‚‹<br>é¸æŠè‚¢ãƒšã‚¢æ•° +1", 
            req: "synchro_exp", 
            reincReq: "synchro_dim" 
        },

        throw: { lv: 0, max: 5, costs: [100000, 1000000, 10000000, 100000000, 1000000000], name: "æŠ•æ“²æŠ€è¡“", icon: "ğŸ¯", desc: "æ¼”å‡ºçŸ­ç¸®", req: "speed" },

        yaku_none: { lv: 0, max: 2000, costs: Array.from({length:2000}, (_,i)=>2500 * Math.pow(4, i)), name: "ç›®ãªã—å¼·åŒ–", icon: "â•", desc: "ç›®ãªã—+400%", req: "auto" },
        yaku_normal: { lv: 0, max: 2000, costs: Array.from({length:2000}, (_,i)=>5000 * Math.pow(4, i)), name: "é€šå¸¸ç›®å¼·åŒ–", icon: "âš‚", desc: "é€šå¸¸ç›®+400%", req: "yaku_none" },
        yaku_456: { lv: 0, max: 2000, costs: Array.from({length:2000}, (_,i)=>10000 * Math.pow(4, i)), name: "ã‚·ã‚´ãƒ­å¼·åŒ–", icon: "âœ¨", desc: "ã‚·ã‚´ãƒ­+400%", req: "yaku_normal" },
        yaku_arashi: { lv: 0, max: 2000, costs: Array.from({length:2000}, (_,i)=>30000 * Math.pow(4, i)), name: "ã‚¢ãƒ©ã‚·å¼·åŒ–", icon: "ğŸŒ€", desc: "ã‚¢ãƒ©ã‚·+400%", req: "yaku_456" },
        yaku_pin: { lv: 0, max: 2000, costs: Array.from({length:2000}, (_,i)=>50000 * Math.pow(4, i)), name: "ãƒ”ãƒ³ã‚¾ãƒ­å¼·åŒ–", icon: "ğŸ”¥", desc: "ãƒ”ãƒ³ã‚¾ãƒ­+400%", req: "yaku_arashi" },

        yaku_straight4: { lv: 0, max: 2000, costs: Array.from({length:2000}, (_,i)=>100000 * Math.pow(4, i)), name: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ4å¼·åŒ–", icon: "4ï¸âƒ£", desc: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ4+400%", req: "yaku_pin", reincReq: "straight4" },
        yaku_arashi4: { lv: 0, max: 2000, costs: Array.from({length:2000}, (_,i)=>200000 * Math.pow(4, i)), name: "ã‚¢ãƒ©ã‚·4å¼·åŒ–", icon: "ğŸŒªï¸", desc: "ã‚¢ãƒ©ã‚·4+400%", req: "yaku_straight4", reincReq: "arashi4" },
        yaku_straight5: { lv: 0, max: 2000, costs: Array.from({length:2000}, (_,i)=>1000000 * Math.pow(4, i)), name: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ5å¼·åŒ–", icon: "5ï¸âƒ£", desc: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ5+400%", req: "yaku_arashi4", reincReq: "straight5" },
        yaku_arashi5: { lv: 0, max: 2000, costs: Array.from({length:2000}, (_,i)=>2000000 * Math.pow(4, i)), name: "ã‚¢ãƒ©ã‚·5å¼·åŒ–", icon: "ğŸŒˆ", desc: "ã‚¢ãƒ©ã‚·5+400%", req: "yaku_straight5", reincReq: "arashi5" },
		xyz_exp: { 
		    lv: 0, max: 1, 
		    costs: [1000000000000], 
		    name: "ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºæ¢ç´¢", icon: "âœ–ï¸", 
		    desc: "åŒã˜ãƒ¬ãƒ™ãƒ«ã®å‡ºç›®ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’æ§‹ç¯‰ã™ã‚‹", 
		    req: "synchro_exp", 
		    reincReq: "xyz_dim" 
		},

        rank_revolution: {
            lv: 0, max: 3,
            costs: [10000000000000, 100000000000000, 1000000000000000], // 10å…†, 100å…†, 1000å…†
            name: "ãƒ©ãƒ³ã‚¯ãƒ»ãƒ¬ãƒœãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³", 
            icon: "ğŸ’", 
            desc: "ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºæ¢ç´¢ã§æç¤ºã•ã‚Œã‚‹<br>é¸æŠè‚¢ãƒšã‚¢æ•° +1", 
            req: "xyz_exp", 
            reincReq: "xyz_dim" 
        },
        accel_synchro: {
            lv: 0, max: 1,
            costs: [50000000000], // 500å„„
            name: "ã‚¢ã‚¯ã‚»ãƒ«ã‚·ãƒ³ã‚¯ãƒ­",
            icon: "ğŸï¸",
            desc: "å‡ºç›®ã‚’æŒã¡å¸°ã‚‰ãªã‹ã£ãŸå ´åˆã€<br>æ¬¡å›ã®é€šå¸¸æ¢ç´¢ã®è³ªãŒå‘ä¸Šã™ã‚‹",
            req: "tuning",
            reqLv: 1,
            reincReq: "clear_mind"
        }

    };
    
    const reincUpgInfo = {
        wallet: { lv: 0, max: 100, costs: [1], name: "å‰ä¸–ã®è²¡å¸ƒ", icon: "ğŸ‘›", desc: "è»¢ç”Ÿç›´å¾Œã®ã‚¹ã‚³ã‚¢+10ä¸‡", req: null, fixedCost: true },
        greedy_exp: { lv: 0, max: 2, costs: [4, 12], name: "å¼·æ¬²ãªé å¾", icon: "ğŸ¤©", desc: "é€šå¸¸æ¢ç´¢ã§é¸ã¹ã‚‹æ•°+1", req: "wallet" },
        greedy_rit: { lv: 0, max: 2, costs: [4, 12], name: "å¼·æ¬²ãªå„€å¼", icon: "ğŸ˜ˆ", desc: "å„€å¼æ¢ç´¢ã§æ¶ˆã›ã‚‹æ•°+1", req: "wallet" },
        privatize: { lv: 0, max: 1, costs: [5], name: "æ•°å­—ã®ç§ç‰©åŒ–", icon: "ğŸ”¢", desc: "ã‚¢ãƒ©ã‚·ãƒ»ã‚·ã‚´ãƒ­è¨ˆç®—å¼å¤‰æ›´", req: ["greedy_exp", "greedy_rit"] },
        straight: { lv: 0, max: 1, costs: [6], name: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ", icon: "ğŸ“", desc: "é€£ç•ª(234,345ç­‰)ã‚’å½¹ã¨ã—ã¦æ‰±ã†", req: "privatize" },
        
        fusion_dim: { lv: 0, max: 1, costs: [10], name: "èåˆæ¬¡å…ƒ", icon: "ğŸŒŒ", desc: "æ¬¡å…ƒã®å£ãŒè–„ããªã‚‹...ï¼Ÿ", req: "straight" },
        fusion_limit: { lv: 0, max: 10, costs: [2], name: "è¶…èåˆ", icon: "ğŸ§±", desc: "èåˆã§ä½œã‚Œã‚‹å‡ºç›®ã®ä¸Šé™+3", req: "fusion_dim", fixedCost: true },
        
        tuner: { lv: 0, max: 1, costs: [10], name: "ãƒãƒ¥ãƒ¼ãƒŠãƒ¼", icon: "ğŸ›ï¸", desc: "ãƒ¬ãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’è§£æ”¾<br>Lv^2ã®è£œæ­£ãŒã‹ã‹ã‚‹", req: "fusion_limit", reqLv: 1 },
        
        // ä¿®æ­£: ã‚¢ãƒ‰ãƒãƒ³ã‚¹æ¢ç´¢ã®å‰æã‚’ã‚·ãƒ³ã‚¯ãƒ­æ¬¡å…ƒã«å¤‰æ›´
        adv_exp: { lv: 0, max: 1, costs: [5], name: "ã‚¢ãƒ‰ãƒãƒ³ã‚¹æ¢ç´¢", icon: "ğŸ’", desc: "é€šå¸¸æ¢ç´¢ã®å‡ºç›®Lv1-6<br>åˆæœŸã‚³ã‚¹ãƒˆ30ä¸‡", req: "synchro_dim" },
        synchro_dim: { lv: 0, max: 1, costs: [10], name: "ã‚·ãƒ³ã‚¯ãƒ­æ¬¡å…ƒ", icon: "âš›ï¸", desc: "æ¬¡å…ƒã®å£ãŒã•ã‚‰ã«è–„ããªã‚‹...ï¼Ÿ", req: "tuner" },
        
        // ä¿®æ­£: ä¸Šç´šã‚¢ãƒ‰ãƒãƒ³ã‚¹æ¢ç´¢ã®å‰æã‚’ã‚¢ãƒ‰ãƒãƒ³ã‚¹æ¢ç´¢ã¨ãƒˆãƒƒãƒ—ã‚¯ãƒªã‚¢ãƒã‚¤ãƒ³ãƒ‰ã«å¤‰æ›´
        adv_adv_exp: { lv: 0, max: 1, costs: [10], name: "ä¸Šç´šã‚¢ãƒ‰ãƒãƒ³ã‚¹æ¢ç´¢", icon: "ğŸ’", desc: "é€šå¸¸æ¢ç´¢ã®å‡ºç›®Lv5-8<br>åˆæœŸã‚³ã‚¹ãƒˆ30ä¸‡", req: ["adv_exp", "top_clear_mind"] },
        
        clear_mind: { lv: 0, max: 1, costs: [5], name: "ã‚¯ãƒªã‚¢ãƒ»ãƒã‚¤ãƒ³ãƒ‰", icon: "âœ¨", desc: "ãƒ¬ãƒ™ãƒ«ä¸Šé™è§£æ”¾(12â†’14)", req: "synchro_dim" },
        top_clear_mind: { lv: 0, max: 1, costs: [10], name: "ãƒˆãƒƒãƒ—ãƒ»ã‚¯ãƒªã‚¢ãƒ»ãƒã‚¤ãƒ³ãƒ‰", icon: "ğŸŒ ", desc: "ãƒ¬ãƒ™ãƒ«ä¸Šé™è§£æ”¾(14â†’17)", req: "clear_mind" },
        over_top_clear_mind: { lv: 0, max: 1, costs: [10], name: "ã‚ªãƒ¼ãƒãƒ¼ãƒˆãƒƒãƒ—ãƒ»ã‚¯ãƒªã‚¢ãƒ»ãƒã‚¤ãƒ³ãƒ‰", icon: "ğŸŒŒ", desc: "ãƒ¬ãƒ™ãƒ«ä¸Šé™è§£æ”¾(17â†’20)", req: "top_clear_mind" },

        straight4: { lv: 0, max: 1, costs: [5], name: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼”", icon: "4ï¸âƒ£", desc: "4ã¤ã®é€£ç•ªã§å½¹æˆç«‹<br>åˆè¨ˆ*10000", req: "fusion_dim" },
        arashi4: { lv: 0, max: 1, costs: [5], name: "ã‚¢ãƒ©ã‚·ï¼”", icon: "ğŸŒªï¸", desc: "4ã¤ã®åŒæ•°ã§å½¹æˆç«‹<br>åˆè¨ˆ*20000", req: "straight4" },
        
        straight5: { lv: 0, max: 1, costs: [10], name: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼•", icon: "5ï¸âƒ£", desc: "5ã¤ã®é€£ç•ªã§å½¹æˆç«‹<br>åˆè¨ˆ*50000", req: "arashi4" },
        arashi5: { lv: 0, max: 1, costs: [10], name: "ã‚¢ãƒ©ã‚·ï¼•", icon: "ğŸŒˆ", desc: "5ã¤ã®åŒæ•°ã§å½¹æˆç«‹<br>åˆè¨ˆ*100000", req: "straight5" }, 

        rare_magic: { lv: 0, max: 1, costs: [5], name: "ãƒ¬ã‚¢ãƒªãƒ†ã‚£ï¼šãƒã‚¸ãƒƒã‚¯", icon: "M", desc: "ãƒã‚¸ãƒƒã‚¯(x64)ã‚’è¿½åŠ ", req: "fusion_dim" },
        rare_epic: { lv: 0, max: 1, costs: [5], name: "ãƒ¬ã‚¢ãƒªãƒ†ã‚£ï¼šã‚¨ãƒ”ãƒƒã‚¯", icon: "E", desc: "ã‚¨ãƒ”ãƒƒã‚¯(x128)ã‚’è¿½åŠ ", req: "rare_magic" },
        rare_legend: { lv: 0, max: 1, costs: [10], name: "ãƒ¬ã‚¢ãƒªãƒ†ã‚£ï¼šãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼", icon: "L", desc: "ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼(x256)ã‚’è¿½åŠ ", req: "rare_epic" },
        rare_eternal: { lv: 0, max: 1, costs: [10], name: "ãƒ¬ã‚¢ãƒªãƒ†ã‚£ï¼šã‚¨ã‚¿ãƒ¼ãƒŠãƒ«", icon: "âˆ", desc: "ã‚¨ã‚¿ãƒ¼ãƒŠãƒ«(x512)ã‚’è¿½åŠ ", req: "rare_legend" },
        
		xyz_dim: { 
		    lv: 0, max: 1, 
		    costs: [10], 
		    name: "ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºæ¬¡å…ƒ", icon: "X", 
		    desc: "æ¬¡å…ƒã®å£ãŒé™ã‚Šãªãè–„ããªã‚‹<br>ç•°ãªã‚‹æ¬¡å…ƒã®æ‰‰ãŒé–‹ã‹ã‚Œã‚‹", 
		    req: ["arashi5", "rare_eternal", "over_top_clear_mind", "adv_adv_exp"] 
		}
    };

    // çµ„ã¿åˆã‚ã›ç”Ÿæˆ (nCk)
    function getCombinations(arr, k) {
        if (k === 1) return arr.map(e => [e]);
        const res = [];
        for (let i = 0; i <= arr.length - k; i++) {
            const head = arr[i];
            const tailCombos = getCombinations(arr.slice(i + 1), k - 1);
            tailCombos.forEach(c => res.push([head, ...c]));
        }
        return res;
    }

    const audioFiles = {
        roll: 'se_roll.mp3',
        start: 'se_start.mp3',
        ready: 'se_ready.mp3',
        record: 'se_record.mp3'
    };
    const sounds = {};
    let globalVolume = 0.3; // åˆæœŸéŸ³é‡30%

    // éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
    function playSound(key) {
        if (!sounds[key]) {
            sounds[key] = new Audio(audioFiles[key]);
            sounds[key].volume = globalVolume;
        }
        // é€£æ‰“å¯¾å¿œï¼šå†ç”Ÿä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
        sounds[key].currentTime = 0;
        sounds[key].play().catch(e => {
            // ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã‚„ãƒ•ã‚¡ã‚¤ãƒ«æ¬ æã§å†ç”Ÿã§ããªã„å ´åˆã¯ç„¡è¦–
            console.log("SE Play failed (File missing?):", e);
        });
    }

    // éŸ³é‡å¤‰æ›´é–¢æ•°
    function setVolume(val) {
        globalVolume = val / 100;
        document.getElementById('vol-disp').textContent = val + '%';
        for (let key in sounds) {
            if (sounds[key]) sounds[key].volume = globalVolume;
        }
    }

    function updateRarityDefinitions() {
        RARITIES = {
            common: { name: "ã‚³ãƒ¢ãƒ³", weight: 5000, mult: 1, color: "var(--rare-common)", class: "rarity-common" },
            uncommon: { name: "ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³", weight: 3500, mult: 4, color: "var(--rare-uncommon)", class: "rarity-uncommon" },
            rare: { name: "ãƒ¬ã‚¢", weight: 1000, mult: 8, color: "var(--rare-rare)", class: "rarity-rare" },
            super: { name: "ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¬ã‚¢", weight: 350, mult: 16, color: "var(--rare-super)", class: "rarity-super" },
            ultra: { name: "ã‚¦ãƒ«ãƒˆãƒ©ãƒ¬ã‚¢", weight: 150, mult: 32, color: "var(--rare-ultra)", class: "rarity-ultra" }
        };
        
        if (reincData && reincData.upgrades) {
            if (reincData.upgrades.rare_magic > 0) RARITIES.magic = { name: "ãƒã‚¸ãƒƒã‚¯", weight: 100, mult: 64, color: "var(--rare-magic)", class: "rarity-magic" };
            if (reincData.upgrades.rare_epic > 0) RARITIES.epic = { name: "ã‚¨ãƒ”ãƒƒã‚¯", weight: 50, mult: 128, color: "var(--rare-epic)", class: "rarity-epic" };
            if (reincData.upgrades.rare_legend > 0) RARITIES.legendary = { name: "ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼", weight: 25, mult: 256, color: "var(--rare-legendary)", class: "rarity-legendary" };
            if (reincData.upgrades.rare_eternal > 0) RARITIES.eternal = { name: "ã‚¨ã‚¿ãƒ¼ãƒŠãƒ«", weight: 10, mult: 512, color: "#fff", class: "rarity-eternal" };
        }
    }

    function formatScore(num) {
        if (num >= 1.0e+48) {
            return num.toExponential(2).replace("+", "");
        }

        if (num < 10000) return Math.floor(num).toLocaleString();
        
        const units = ["", "ä¸‡", "å„„", "å…†", "äº¬", "å“", "ğ¥±", "æº", "æ¾—", "æ­£", "è¼‰", "æ¥µ"];
        let unitIdx = 0, tempNum = num;
        
        while (tempNum >= 10000 && unitIdx < units.length - 1) { 
            tempNum /= 10000; 
            unitIdx++; 
        }
        
        return (Math.floor(tempNum * 100) / 100) + units[unitIdx];
    }

    // å€ç‡ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°ï¼ˆ1ä¸‡æœªæº€ã¯å°æ•°è¡¨ç¤ºã€1ä¸‡ä»¥ä¸Šã¯å˜ä½è¡¨ç¤ºï¼‰
    function formatMultiplier(num) {
        if (num < 10000) {
            // 1ä¸‡æœªæº€ã¯å°æ•°ç¬¬1ä½ã¾ã§è¡¨ç¤º (ä¾‹: 1.5, 9999.9)
            // parseFloatã‚’ä½¿ã£ã¦ "1.0" ã®ã‚ˆã†ãªä¸è¦ãªã‚¼ãƒ­ã‚’æ¶ˆã™
            return parseFloat(num.toFixed(1)).toLocaleString();
        }
        // 1ä¸‡ä»¥ä¸Šã¯ã‚¹ã‚³ã‚¢ã¨åŒã˜å˜ä½å‡¦ç†ï¼ˆformatScoreï¼‰ã‚’åˆ©ç”¨
        return formatScore(num);
    }

    const debugCode = ["KeyW", "KeyW", "KeyS", "KeyS", "KeyA", "KeyD", "KeyA", "KeyD", "KeyA", "KeyB"];
    let inputBuffer = [];
    window.addEventListener('keydown', (e) => {
        inputBuffer.push(e.code);
        if (inputBuffer.length > debugCode.length) inputBuffer.shift();
        
        // ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰ï¼ˆW W S S A D A D A Bï¼‰ãŒå…¥åŠ›ã•ã‚ŒãŸå ´åˆ
        if (JSON.stringify(inputBuffer) === JSON.stringify(debugCode)) {
            // ã‚¹ã‚³ã‚¢åŠ ç®—
            const val = prompt("ã€ãƒ‡ãƒãƒƒã‚°ã€‘ã‚¹ã‚³ã‚¢åŠ ç®—é‡ï¼ˆæ•°å€¤ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if (val && !isNaN(parseFloat(val))) { 
                score += parseFloat(val); 
                totalScore += parseFloat(val); 
            }
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¦ãƒ‹ãƒƒãƒˆåŠ ç®— (è¿½åŠ )
            const oruVal = prompt("ã€ãƒ‡ãƒãƒƒã‚°ã€‘ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¦ãƒ‹ãƒƒãƒˆåŠ ç®—é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if (oruVal && !isNaN(parseFloat(oruVal))) { 
                overlayUnits += parseFloat(oruVal); 
            }
            
            updateUI();
        }
        
        // æ¢ç´¢æ™‚é–“ã®çŸ­ç¸®ãƒ‡ãƒãƒƒã‚° (KeyT)
        if(e.code === "KeyT" && expStatus === 'running') expTimeRemaining = 100;
    });

	function saveGame() {
	    if (isResetting) return;
	    const saveObj = {
	        score, totalScore, multiplier,
	        expNextCost, ritualNextCost, fusionNextCost, synchroNextCost,
	        dicePool, upgLevels: {}, 
	        reincData, scoreHistory,
	        ver: 9.2,
	        overlayUnits,
	        xyzNextCost,
	        xyzUpgLevels: Object.fromEntries(Object.entries(xyzUpgState).map(([k, v]) => [k, v.lv])),
	        activeUsage,
	        // --- è¿½åŠ : ã‚¿ã‚¤ãƒãƒ¼ã®çŠ¶æ…‹ã‚’ä¿å­˜ ---
	        activeTimers, 
	        lastSaveTime: Date.now() 
	    };
	    for(let key in upgState) saveObj.upgLevels[key] = upgState[key].lv;
	    localStorage.setItem('chinchiro_clicker_save', JSON.stringify(saveObj));
	    
	    // é€šçŸ¥ï¼ˆã‚¹ã‚­ãƒ«ã®æ™‚ã¯é™ã‹ã«ä¿å­˜ã—ãŸã„å ´åˆã¯æ¡ä»¶åˆ†å²ã—ã¦ã‚‚è‰¯ã„ï¼‰
	    const notice = document.getElementById('save-notice');
	    if(notice) {
	        notice.style.opacity = 1; 
	        setTimeout(() => notice.style.opacity = 0, 2000);
	    }
	}   

	function loadGame() {
	    const saveStr = localStorage.getItem('chinchiro_clicker_save');
	    if (!saveStr) {
	        initNewGame();
	        return;
	    }
	    try {
	        const saveObj = JSON.parse(saveStr);
	        score = saveObj.score || 0;
	        totalScore = saveObj.totalScore || 0;
	        multiplier = saveObj.multiplier || 1;
	        expNextCost = saveObj.expNextCost || 15000;
	        ritualNextCost = saveObj.ritualNextCost || 500000;
	        fusionNextCost = saveObj.fusionNextCost || 10000000;
	        synchroNextCost = saveObj.synchroNextCost || 100000000;
	        overlayUnits = saveObj.overlayUnits || 0;
	        xyzNextCost = saveObj.xyzNextCost || 1000000000000; // åˆæœŸå€¤ã‚’ä¿è¨¼
	        lastTickTime = saveObj.lastSaveTime || Date.now();
	        
	        if (isNaN(score)) score = 0;
	        if (isNaN(totalScore)) totalScore = 0;
	        if (isNaN(multiplier)) multiplier = 1;

	        if (saveObj.scoreHistory) scoreHistory = saveObj.scoreHistory;

	        if(saveObj.dicePool && Array.isArray(saveObj.dicePool)) {
	             dicePool = saveObj.dicePool.filter(d => d !== null);
	             dicePool.forEach(d => {
	                 if (d.level === undefined) d.level = 1;
	             });
	        } else {
	             initNewGame();
	        }
	        
	        if (dicePool.length === 0) initNewGame();

	        if(saveObj.upgLevels) {
	            for(let key in upgState) {
	                if (saveObj.upgLevels[key] !== undefined && !isNaN(saveObj.upgLevels[key])) {
	                    upgState[key].lv = Math.min(saveObj.upgLevels[key], upgState[key].max);
	                } else {
	                    upgState[key].lv = 0;
	                }
	            }
	        }

	        if (saveObj.xyzUpgLevels) {
	            for (let key in xyzUpgState) {
	                if (saveObj.xyzUpgLevels[key] !== undefined) {
	                    xyzUpgState[key].lv = saveObj.xyzUpgLevels[key];
	                }
	            }
	        }

	        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¦NaNã‚’é˜²æ­¢
	        activeUsage = saveObj.activeUsage || { shift: 0, import: 0 };
	        activeTimers = saveObj.activeTimers || { shift: 0, shiftPenalty: 0 };
	        
	        if (saveObj.reincData) {
	            reincData = saveObj.reincData;
	            if (!reincData.upgrades) reincData.upgrades = {};
	            // å„ç¨®æ•°å€¤ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³...
	        }
	        
	        updateRarityDefinitions();

	    } catch(e) {
	        console.error("Save corrupted", e);
	        initNewGame();
	    }
	}
    
    function initNewGame() {
        dicePool = [];
        for(let v=1; v<=6; v++) for(let i=0; i<3; i++) dicePool.push({ val: v, rarity: 'common', level: 1 });
        
        if (reincData && reincData.upgrades && reincData.upgrades.wallet > 0) {
            const bonus = reincData.upgrades.wallet * 100000;
            score += bonus;
            totalScore += bonus;
        }
        updateRarityDefinitions();
    }
    
    function resetGame() {
        // ã¾ãšãƒªã‚»ãƒƒãƒˆã®æ„æ€ç¢ºèª
        if(!confirm("æœ¬å½“ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆè»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆã‚„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚‚å«ã‚ã€å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆå»ã•ã‚Œã¾ã™ï¼‰")) return;

        const TRILLION = 1000000000000; // 1å…†
        
        // --- å¤‰æ›´ç®‡æ‰€: æ¡ä»¶ã«ã€Œè»¢ç”ŸçµŒé¨“ã‚ã‚Š(maxReachedRP > 0)ã€ã‚’è¿½åŠ  ---
        if (totalScore >= TRILLION || reincData.maxReachedRP > 0) {
            // ãƒœãƒ¼ãƒŠã‚¹ã®é¸æŠè‚¢ã‚’æç¤º
            const wantBonus = confirm(`ã€ãƒœãƒ¼ãƒŠã‚¹ç¢ºèªã€‘\næ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™ï¼ˆã‚¹ã‚³ã‚¢1å…†è¶…ãˆ ã¾ãŸã¯ è»¢ç”ŸçµŒé¨“ã‚ã‚Šï¼‰\n\næ¬¡å›ã®ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«ã€Œ1å…†ã‚¹ã‚³ã‚¢ã€ã‚’æ‰€æŒã—ãŸçŠ¶æ…‹ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\n[OK] 1å…†ã‚¹ã‚³ã‚¢ã‚’æŒã£ã¦ãƒªã‚»ãƒƒãƒˆ\n[ã‚­ãƒ£ãƒ³ã‚»ãƒ«] 0ã‚¹ã‚³ã‚¢ã§å®Œå…¨ãƒªã‚»ãƒƒãƒˆ`);
            
            isResetting = true;
            localStorage.removeItem('chinchiro_clicker_save'); // ä¸€æ—¦æ¶ˆå»

            if (wantBonus) {
                // 1å…†ã‚¹ã‚³ã‚¢ã‚’æŒã£ãŸçŠ¶æ…‹ã®åˆæœŸã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                const bonusData = {
                    score: TRILLION,
                    totalScore: TRILLION,
                    ver: 9.3
                };
                localStorage.setItem('chinchiro_clicker_save', JSON.stringify(bonusData));
            }
            
            location.reload();
            return;
        }
        // -----------------------------------------------------------

        // é€šå¸¸ãƒªã‚»ãƒƒãƒˆï¼ˆæ¡ä»¶ã‚’æº€ãŸã•ãªã„å ´åˆï¼‰
        isResetting = true;
        localStorage.removeItem('chinchiro_clicker_save');
        location.reload();
    }

    function calcRP(currentTotalScore) {
        if (currentTotalScore < 1) return 0;
        // log10000(x) ã¯ Math.log10(x) / 4 ã¨ç­‰ä¾¡
        // å¼: (log10000(Score) * 20) - 30
        const log10000 = Math.log10(currentTotalScore) / 4;
        const val = (log10000 * 20) - 30;
        return Math.floor(Math.max(0, val));
    }

    function calcExpDuration() {
        let duration = Math.max(20000, EXP_DURATION_BASE - (upgState.exp_speed.lv * 16000));
        if (upgState.simple_fusion && upgState.simple_fusion.lv > 0) {
            duration /= 2;
        }
        if (upgState.urgent_tuning && upgState.urgent_tuning.lv > 0) {
            duration /= 2;
        }
        return duration;
    }

    function calcReqScoreForRP(rp) {
        return Math.pow(10, (rp + 30) / 5);
    }

    // --- ä¿®æ­£: è»¢ç”Ÿæƒ…å ±ã®æ›´æ–°ãƒ«ãƒ¼ãƒ—ç”¨é–¢æ•° (æ®‹ã‚Šæ™‚é–“è¡¨ç¤ºã‚’è¿½åŠ ) ---
    function updateReincInfo() {
        if (document.getElementById('reinc-modal').style.display === 'none') return;

        const potentialRP = calcRP(totalScore);
        const gain = Math.max(0, potentialRP - reincData.maxReachedRP);

        document.getElementById('reinc-point-disp').textContent = reincData.points;
        document.getElementById('pending-rp').textContent = potentialRP;
        
        const currentMaxRP = Math.max(potentialRP, reincData.maxReachedRP);
        const nextTargetRP = currentMaxRP + 1; 
        
        const currentLevelReq = calcReqScoreForRP(currentMaxRP);
        const nextLevelReq = calcReqScoreForRP(nextTargetRP);
        
        let progress = 0;
        if (totalScore >= currentLevelReq) {
            if (nextLevelReq > currentLevelReq) {
                progress = (totalScore - currentLevelReq) / (nextLevelReq - currentLevelReq) * 100;
            }
        }
        progress = Math.min(100, Math.max(0, progress));
        const remaining = nextLevelReq - totalScore;

        document.getElementById('rp-progress-bar').style.width = progress + '%';
        
        // --- è¿½åŠ : æ®‹ã‚Šæ™‚é–“ã®è¨ˆç®—ã¨è¡¨ç¤º ---
        let timeText = "";
        if (remaining > 0 && currentSPM > 0) {
            const minsNeeded = remaining / currentSPM;
            timeText = ` (ã‚ã¨ç´„ ${formatTimeEst(minsNeeded)})`;
        } else if (remaining > 0 && currentSPM <= 0) {
            timeText = " (è¨ˆæ¸¬ä¸­...)";
        }

        document.getElementById('rp-next-msg').textContent = 
            `æ¬¡ã®ãƒã‚¤ãƒ³ãƒˆ(${nextTargetRP} Pt)ã¾ã§: ã‚ã¨ ${formatScore(remaining)} ã‚¹ã‚³ã‚¢ (${Math.floor(progress)}%)${timeText}`;
        // ----------------------------------

        const btn = document.getElementById('do-reinc-btn');
        const msg = document.getElementById('reinc-gain-msg');
        
        if (totalScore >= REINC_THRESHOLD && gain > 0) {
            msg.textContent = `è»¢ç”Ÿã™ã‚‹ã¨ +${gain} Pt ç²å¾—ã§ãã¾ã™ï¼`;
            btn.disabled = false;
            btn.style.opacity = 1;
            btn.style.cursor = "pointer";
        } else {
            if (totalScore < REINC_THRESHOLD) {
                msg.textContent = "â€»è»¢ç”Ÿã«ã¯ã‚¹ã‚³ã‚¢100å„„ä»¥ä¸ŠãŒå¿…è¦ã§ã™";
            } else {
                msg.textContent = "â€»ç¾åœ¨ã®è¨˜éŒ²ã‚’æ›´æ–°ã™ã‚‹ã¨ãƒã‚¤ãƒ³ãƒˆãŒå¢—åŠ ã—ã¾ã™";
            }
            btn.disabled = true;
            btn.style.opacity = 0.5;
            btn.style.cursor = "not-allowed";
        }
    }

    function openReincarnationModal() {
        // è¡¨ç¤ºã‚¨ãƒªã‚¢ã®åˆæœŸåŒ–
        document.getElementById('reinc-action-area').style.display = 'block';
        document.getElementById('reinc-finish-area').style.display = 'none';

        const viewMsg = document.getElementById('reinc-view-mode-msg');
        if (!isReincarnationPhase) {
            viewMsg.style.display = 'block';
        } else {
            viewMsg.style.display = 'none';
        }
        
        updateReincUI(); // ãƒ„ãƒªãƒ¼æƒ…å ±ã®æ›´æ–°
        toggleReincModal(true);
        setTimeout(drawReincLines, 50);

        // â˜…ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®é–‹å§‹
        updateReincInfo(); // åˆå›å®Ÿè¡Œ
        if(reincTimer) clearInterval(reincTimer);
        reincTimer = setInterval(updateReincInfo, 100); // 0.1ç§’ã”ã¨ã«æ›´æ–°
    }

    function toggleReincModal(show) {
        document.getElementById('reinc-modal').style.display = show ? 'flex' : 'none';
        
        if (!show) {
            // â˜…ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹æ™‚ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
            if(reincTimer) {
                clearInterval(reincTimer);
                reincTimer = null;
            }
            if (isReincarnationPhase) {
                finishReincarnation(); 
            }
        }
    }

    function doReincarnation() {
        const potentialRP = calcRP(totalScore);
        const gain = Math.max(0, potentialRP - reincData.maxReachedRP);
        
        if (!confirm(`æœ¬å½“ã«è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿ\n+${gain} Pt ã‚’ç²å¾—ã—ã€ã‚¹ã‚³ã‚¢ç­‰ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚`)) return;
        
        // â˜…å®Ÿè¡Œæ™‚ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹ï¼ˆã‚¹ã‚³ã‚¢ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ãŸã‚ï¼‰
        if(reincTimer) {
            clearInterval(reincTimer);
            reincTimer = null;
        }

        reincData.points += gain;
        reincData.maxReachedRP = potentialRP;
        
        score = 0;
        totalScore = 0;
        multiplier = 1;
        expNextCost = 15000;
        overlayUnits = 0;
        xyzNextCost = 1000000000000;
        for (let k in xyzUpgState) xyzUpgState[k].lv = 0;
        activeUsage = { shift: 0, import: 0 };
        activeTimers = { shift: 0, shiftPenalty: 0 };
        if (reincData.upgrades.adv_exp > 0) expNextCost = 300000;

        ritualNextCost = 500000;
        fusionNextCost = 10000000;
        synchroNextCost = 100000000;
        xyzNextCost = 1000000000000;

        for(let k in upgState) upgState[k].lv = 0;
        hasAutoRoll = false;
        expStatus = 'idle';
        expTimeRemaining = 0;
        
        expMode = 'normal';
        currentRewards = [];
        rewardSelectCount = 0;
        
        initNewGame(); 
        
        document.getElementById('game-fields').innerHTML = '';
        fieldCount = 1;
        fieldTimers = [0];
        addField(0);
        document.getElementById('panel-history').style.display = 'none';
        document.getElementById('btn-pool-detail').style.display = 'none';
        
        document.getElementById('expedition-panel').style.display = 'none';
        
        isReincarnationPhase = true;
        document.getElementById('reinc-action-area').style.display = 'none';
        document.getElementById('reinc-finish-area').style.display = 'block';
        document.getElementById('reinc-gain-msg-2').textContent = `è»¢ç”Ÿå®Œäº†ï¼ +${gain} Pt`;
        
        document.getElementById('reinc-view-mode-msg').style.display = 'none';

        updateReincUI();
        updateUI();
        saveGame();
    }
    
    function finishReincarnation() {
        isReincarnationPhase = false;
        document.getElementById('reinc-modal').style.display = 'none';
        saveGame();
    }

    function buyReincUpgrade(type) {
        if (!isReincarnationPhase) return;

        const upg = reincUpgInfo[type];
        const reqs = Array.isArray(upg.req) ? upg.req : (upg.req ? [upg.req] : []);
        
        const reqLevel = upg.reqLv || 1;
        // å‰æãƒã‚§ãƒƒã‚¯ä¿®æ­£
        const unlocked = reqs.every(r => (reincData.upgrades[r] || 0) >= reqLevel);
        
        if (!unlocked) return;

        // ç¾åœ¨ãƒ¬ãƒ™ãƒ«å–å¾—ä¿®æ­£
        const currentLv = reincData.upgrades[type] || 0;
        if (currentLv >= upg.max) return;

        let cost = 0;
        if (upg.fixedCost) {
            cost = upg.costs[0];
        } else {
            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã« currentLv (0) ã‚’ä½¿ã†ã“ã¨ã§æ­£ã—ãã‚³ã‚¹ãƒˆã‚’å‚ç…§
            cost = upg.costs[currentLv];
        }

        if (reincData.points >= cost) {
            reincData.points -= cost;
            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‡¦ç†ä¿®æ­£
            reincData.upgrades[type] = currentLv + 1;
            
            if(type.startsWith('rare_')) updateRarityDefinitions();
            
            updateReincUI();
            
            if (type === 'wallet') {
                score += 100000;
                totalScore += 100000;
                updateUI();
            }
            if (type === 'adv_exp') {
                if(score === 0 && totalScore === 0) expNextCost = 300000;
            }
            saveGame();
        }
    }

    function updateReincUI() {
        document.getElementById('reinc-point-disp').textContent = reincData.points;
        
        for(let k in reincUpgInfo) {
            const u = reincUpgInfo[k];
            const n = document.getElementById('rnode-'+k);
            if(!n) continue;
            
            // ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—ï¼ˆundefinedã®å ´åˆã¯0ã¨ã—ã¦æ‰±ã†ï¼‰
            const currentLv = reincData.upgrades[k] || 0;

            const reqs = Array.isArray(u.req) ? u.req : (u.req ? [u.req] : []);
            
            const reqLevel = u.reqLv || 1;
            // å‰ææ¡ä»¶ãƒã‚§ãƒƒã‚¯ã§ã‚‚ || 0 ã‚’ä½¿ã£ã¦å®‰å…¨ã«åˆ¤å®š
            const open = reqs.length === 0 || reqs.every(r => (reincData.upgrades[r] || 0) >= reqLevel);
            
            const isMax = currentLv >= u.max;
            
            // ã‚³ã‚¹ãƒˆè¨ˆç®—ã« currentLv ã‚’ä½¿ç”¨
            let cost = u.fixedCost ? u.costs[0] : u.costs[currentLv];
            
            const canBuy = open && !isMax && reincData.points >= cost && isReincarnationPhase;
            
            n.className = `skill-node reinc-node ${open?(currentLv>0?'unlocked':'available'):'locked'} ${isMax?'is-max':''} ${canBuy?'can-buy':''}`;
            
            // ã“ã“ã§ currentLv ã‚’ä½¿ã†ã“ã¨ã§ "undefined" ã‚’å›é¿
            document.getElementById('rlv-'+k).textContent = `Lv ${currentLv}/${u.max}`;
            
            let tooltipHTML = `<strong>${u.name}</strong><br>${u.desc}<br>ã‚³ã‚¹ãƒˆ: ${isMax?'MAX':cost + ' Pt'}`;
            if (!open) {
                const reqNames = reqs.map(r => {
                    const rName = reincUpgInfo[r].name;
                    return u.reqLv ? `${rName} Lv${u.reqLv}` : rName;
                }).join(', ');
                tooltipHTML += `<br><span style="color:#e74c3c; font-size:0.7rem;">(å‰æ: ${reqNames})</span>`;
            }
            document.getElementById('rtip-'+k).innerHTML = tooltipHTML;
        }
        drawReincLines();
    }

    function drawReincLines() {
        try {
            const svg = document.getElementById('reinc-tree-svg');
            const rootEl = document.getElementById('reinc-tree-root');
            if (!svg || !rootEl) return;
            const root = rootEl.getBoundingClientRect();
            svg.innerHTML = '';
            
            const conn = [
                ['wallet','greedy_exp'], ['wallet','greedy_rit'],
                ['greedy_exp','privatize'], ['greedy_rit','privatize'],
                ['privatize','straight'], ['straight', 'fusion_dim'], ['fusion_dim', 'fusion_limit'], ['fusion_dim', 'tuner'],
                ['tuner', 'synchro_dim'],
                ['fusion_dim', 'straight4'], ['straight4', 'arashi4'],
                ['arashi4', 'straight5'], ['straight5', 'arashi5'], 
                ['fusion_dim', 'rare_magic'], ['rare_magic', 'rare_epic'],
                ['rare_epic', 'rare_legend'], ['rare_legend', 'rare_eternal'],
                // New Connections
                ['synchro_dim', 'adv_exp'], ['synchro_dim', 'clear_mind'],
                ['adv_exp', 'adv_adv_exp'], ['top_clear_mind', 'adv_adv_exp'],
                ['clear_mind', 'top_clear_mind'], ['top_clear_mind', 'over_top_clear_mind'],
                ['arashi5', 'xyz_dim'],
                ['rare_eternal', 'xyz_dim'],
                ['over_top_clear_mind', 'xyz_dim'],
                ['adv_adv_exp', 'xyz_dim']
            ];
            
            conn.forEach(([p,c])=>{
                const pe = document.getElementById('rnode-'+p), ce = document.getElementById('rnode-'+c);
                if(!pe || !ce) return;
                const pr = pe.getBoundingClientRect(), cr = ce.getBoundingClientRect();
                
                if (pr.width === 0 || cr.width === 0) return;

                const l = document.createElementNS("http://www.w3.org/2000/svg","line");
                l.setAttribute("x1", pr.left+pr.width/2-root.left);
                l.setAttribute("y1", pr.top+pr.height/2-root.top);
                l.setAttribute("x2", cr.left+cr.width/2-root.left);
                l.setAttribute("y2", cr.top+cr.height/2-root.top);
                
                const isActive = reincData.upgrades[p] > 0;
                l.className.baseVal = "skill-line reinc-line " + (isActive?'active':'');
                svg.appendChild(l);
            });
        } catch(e) {
            console.error("ReincLines Error", e);
        }
    }

    // --- ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ– ---

    function init() {
        loadGame();
        
        fieldCount = 1 + upgState.field.lv;

        const baseMult = 1 + upgState.finger.lv;
        const platinumMult = 1 + (upgState.platinum_finger ? (upgState.platinum_finger.lv * 0.1) : 0);
        multiplier = baseMult * platinumMult;

        if(upgState.auto.lv > 0) hasAutoRoll = true;
        
        fieldTimers = Array(fieldCount).fill(0);
        document.getElementById('game-fields').innerHTML = '';
        for(let i=0; i<fieldCount; i++) addField(i);
        
        if (scoreHistory.length > 0) {
            renderHistory();
        }

        if (upgState.history.lv > 0) document.getElementById('panel-history').style.display = 'block';
        if (upgState.digital_history.lv > 0) document.getElementById('btn-pool-detail').style.display = 'block';

        setInterval(tick, 100);
        setInterval(saveGame, 10000);
        window.addEventListener('beforeunload', saveGame);
        
        updateUI();
        setTimeout(drawLines, 200);
    }

	function tick() {
	    try {
	        const now = Date.now();
	        const dt = Math.max(0, now - lastTickTime);
	        lastTickTime = now;

        	spmTimer += dt;
	        if (spmTimer >= 1000) { // 1ç§’ã”ã¨ã«å®Ÿè¡Œ
	            spmTimer = 0;
	            spmSamples.push(totalScore); // ç¾åœ¨ã®ç·ç²å¾—ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜
	            
	            // 61ã‚µãƒ³ãƒ—ãƒ«ï¼ˆ60ç§’é–“ï¼‹é–‹å§‹ç‚¹ï¼‰ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
	            if (spmSamples.length > 61) {
	                spmSamples.shift();
	            }
	            
	            // å®¶è¨ˆç°¿ãŒè§£æ”¾ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿è¨ˆç®—ãƒ»è¡¨ç¤º
	            if (spmSamples.length >= 2) {
		            const latestScore = spmSamples[spmSamples.length - 1];
		            const oldestScore = spmSamples[0];
		            const diff = latestScore - oldestScore;
		            
		            // ã‚µãƒ³ãƒ—ãƒ«æ•°ã«å¿œã˜ãŸçµŒéæ™‚é–“ï¼ˆç§’ï¼‰
		            const secondsElapsed = spmSamples.length - 1;
		            
		            if (secondsElapsed > 0) {
		                // 1åˆ†é–“ï¼ˆ60ç§’ï¼‰ã‚ãŸã‚Šã®ç²å¾—é‡ã«æ›ç®—
		                currentSPM = (diff / secondsElapsed) * 60;
		            }

		            // å®¶è¨ˆç°¿ãŒè§£æ”¾ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ç”»é¢å·¦å´ã«è¡¨ç¤º
		            if (upgState.history.lv > 0) {
		                document.getElementById('spm-display').textContent = formatScore(currentSPM);
		            }
		        }
	        }

	        // â˜…ä¿®æ­£ï¼š0æœªæº€ã«ãªã‚‰ãªã„ã‚ˆã†ã«åˆ¶é™
	        if (activeTimers.shift > 0) activeTimers.shift = Math.max(0, activeTimers.shift - dt);
	        if (activeTimers.shiftPenalty > 0) activeTimers.shiftPenalty = Math.max(0, activeTimers.shiftPenalty - dt);
	        
	        const isOffline = dt > 5000;
	        let offlineActionCount = 0;

	        if (hasAutoRoll) {
	            const interval = Math.max(500, AUTO_BASE_TIME - (upgState.speed.lv * 200));
	            for (let i = 0; i < fieldCount; i++) {
	                const btn = document.getElementById(`b-${i}`);
	                
	                if (btn && !btn.disabled) {
	                    fieldTimers[i] = (fieldTimers[i] || 0) + dt;
	                    
	                    if (isOffline) {
	                        if (fieldTimers[i] >= interval) {
	                            let rolls = Math.floor(fieldTimers[i] / interval);
	                            if (rolls > 2000) rolls = 2000;
	                            for(let r=0; r<rolls; r++) instantRoll(i);
	                            offlineActionCount += rolls;
	                            fieldTimers[i] %= interval; 
	                        }
	                    } else {
	                        if (fieldTimers[i] >= interval) {
	                            fieldTimers[i] = 0; 
	                            playGame(i);        
	                        }
	                    }
	                }
	                const prog = document.getElementById(`prog-${i}`);
	                if (prog) prog.style.strokeDashoffset = 100 - (Math.min(fieldTimers[i], interval) / interval * 100);
	            }
	        }
	        
	        if (isOffline && offlineActionCount > 0) {
	             updateUI();
	             renderHistory();
	             const notice = document.getElementById('offline-notice');
	             notice.style.opacity = 1; 
	             setTimeout(() => notice.style.opacity = 0, 4000);
	        }

	        if (expStatus === 'running') {
	            expTimeRemaining -= dt;
	            const duration = calcExpDuration();
	            
	            if (expTimeRemaining <= 0) {
	                if (expStatus === 'running') playSound('ready');
	                expStatus = 'ready';
	                expTimeRemaining = 0;
	                const b = document.getElementById('exp-action-btn');
	                b.disabled = false; b.textContent = "å¸°é‚„ã™ã‚‹";
	                saveGame();
	            }
	            const p = document.getElementById('exp-prog');
	            p.style.strokeDashoffset = (Math.max(0, expTimeRemaining) / duration) * 100;
	            document.getElementById('exp-timer-text').textContent = Math.ceil(Math.max(0, expTimeRemaining)/1000) + "s";
	        }
	    } catch(e) {
	        console.error("Tick Error", e);
	    }
	}
    
    function instantRoll(id) {
        // å®‰å…¨ç­–: ãƒ—ãƒ¼ãƒ«ãŒç©ºãªã‚‰ç·Šæ€¥è£œå……
        if (dicePool.length === 0) initNewGame();

        const baseNum = 3; 
        const num = baseNum + upgState.potential.lv;

        // --- å¤‰æ›´ç®‡æ‰€ ---
        // é‡è¤‡ãªã—ã§ãƒ€ã‚¤ã‚¹ã‚’å¼•ã
        const res = drawDice(num);
        // ----------------

        processResult(res, id, true);
    }

    // --- æ¢ç´¢ãƒ­ã‚¸ãƒƒã‚¯ ---
    
    // --- å¤‰æ›´: ãƒˆã‚°ãƒ«æ©Ÿèƒ½ã§ã¯ãªãç›´æ¥æŒ‡å®šã«å¤‰æ›´ ---
    function setExpeditionMode(mode) {
        // æ¢ç´¢ä¸­ã¾ãŸã¯å®Œäº†å¾…ã¡ã®å ´åˆã¯åˆ‡ã‚Šæ›¿ãˆä¸å¯
        if (expStatus === 'running' || expStatus === 'ready') return;
        
        // æœªé–‹æ”¾ã®ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã¼ã†ã¨ã—ãŸå ´åˆã®ã‚¬ãƒ¼ãƒ‰ï¼ˆå¿µã®ãŸã‚ï¼‰
        if (mode === 'ritual' && upgState.ritual_unlock.lv <= 0) return;
        if (mode === 'fusion' && upgState.fusion_exp.lv <= 0) return;
        if (mode === 'synchro' && upgState.synchro_exp.lv <= 0) return;
        if (mode === 'xyz' && upgState.xyz_exp.lv <= 0) return;

        expMode = mode;
        updateUI();
    }

    function checkSynchroAvailability() {
        if (dicePool.length <= 10) return false;
        
        // åŒã˜å€¤ãŒ2ã¤ä»¥ä¸Šã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const counts = {};
        for (const d of dicePool) {
            if(!d) continue;
            counts[d.val] = (counts[d.val] || 0) + 1;
            if (counts[d.val] >= 2) return true;
        }
        return false;
    }

	function checkXyzAvailability() {
	    if (dicePool.length <= 10) return false;
	    
	    // åŒã˜ãƒ¬ãƒ™ãƒ«ãŒ2ã¤ä»¥ä¸Šã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
	    const counts = {};
	    for (const d of dicePool) {
	        if(!d) continue;
	        const lvl = d.level || 1;
	        counts[lvl] = (counts[lvl] || 0) + 1;
	        if (counts[lvl] >= 2) return true;
	    }
	    return false;
	}
    

	function handleExpedition() {
	    if (expStatus === 'idle') {
	        let cost = expNextCost;
	        if (expMode === 'ritual') cost = ritualNextCost;
	        if (expMode === 'fusion') cost = fusionNextCost;
	        if (expMode === 'synchro') cost = synchroNextCost;
	        if (expMode === 'xyz') cost = xyzNextCost; // â˜…è¿½åŠ ï¼šã‚¨ã‚¯ã‚·ãƒ¼ã‚ºã‚³ã‚¹ãƒˆã®åˆ¤å®š

	        if (expMode === 'ritual' && dicePool.length <= 10) return alert("ãƒ—ãƒ¼ãƒ«ãŒ10å€‹ä»¥ä¸‹ã®ãŸã‚ã€å„€å¼æ¢ç´¢ã‚’è¡Œãˆã¾ã›ã‚“ã€‚");
	        if (expMode === 'fusion' && dicePool.length <= 10) return alert("ãƒ—ãƒ¼ãƒ«ãŒ10å€‹ä»¥ä¸‹ã®ãŸã‚ã€èåˆæ¢ç´¢ã‚’è¡Œãˆã¾ã›ã‚“ã€‚");

	        if (expMode === 'synchro') {
	            if (dicePool.length <= 10) return alert("ãƒ—ãƒ¼ãƒ«ãŒ10å€‹ä»¥ä¸‹ã®ãŸã‚ã€ã‚·ãƒ³ã‚¯ãƒ­æ¢ç´¢ã‚’è¡Œãˆã¾ã›ã‚“ã€‚");
	            if (!checkSynchroAvailability()) return alert("åŒã˜æ•°å€¤ã®å‡ºç›®ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ã‚·ãƒ³ã‚¯ãƒ­æ¢ç´¢ã‚’è¡Œãˆã¾ã›ã‚“ã€‚");
	        }

	        if (expMode === 'xyz') {
	            if (dicePool.length <= 10) return alert("ãƒ—ãƒ¼ãƒ«ãŒ10å€‹ä»¥ä¸‹ã®ãŸã‚ã€ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºæ¢ç´¢ã‚’è¡Œãˆã¾ã›ã‚“ã€‚");
	            if (!checkXyzAvailability()) return alert("åŒã˜ãƒ¬ãƒ™ãƒ«ã®å‡ºç›®ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºæ¢ç´¢ã‚’è¡Œãˆã¾ã›ã‚“ã€‚");
	        }

	        if (score < cost) return alert("ã‚¹ã‚³ã‚¢ãŒè¶³ã‚Šã¾ã›ã‚“");
	        playSound('start');
	        score -= cost;
	        expStatus = 'running';
	        expTimeRemaining = calcExpDuration();

	        const b = document.getElementById('exp-action-btn');
	        b.disabled = true; b.textContent = "æ¢ç´¢ä¸­...";
	        updateUI();
	        saveGame();
	    } else if (expStatus === 'ready') {
	        showRewards();
	    }
	}

	function showRewards() {
	    const list = document.getElementById('reward-list');
	    list.innerHTML = '';
	    currentRewards = [];

	    document.getElementById('fusion-action-area').style.display = 'none';
	    document.getElementById('synchro-action-area').style.display = 'none';
	    document.getElementById('xyz-action-area').style.display = 'none';
	    const rewardActionArea = document.getElementById('reward-action-area');
	    if (rewardActionArea) rewardActionArea.style.display = 'none';

	    const title = document.getElementById('reward-title');
	    const desc = document.getElementById('reward-desc');

	    const sortRewardsFunc = (a, b) => {
	        const rA = RARITY_ORDER.indexOf(a.die.rarity);
	        const rB = RARITY_ORDER.indexOf(b.die.rarity);
	        if (rA !== rB) return rB - rA; 
	        const lA = a.die.level || 1;
	        const lB = b.die.level || 1;
	        if (lA !== lB) return lB - lA; 
	        return b.die.val - a.die.val; 
	    };

	    if (expMode === 'normal') {
	        title.textContent = "æ¢ç´¢ã‹ã‚‰å¸°é‚„ï¼";
	        title.style.color = "var(--accent)";
	        if (rewardActionArea) rewardActionArea.style.display = 'block';
	        
	        let bonusMsg = "";
	        let internalDrawMulti = 1;

	        // ã€ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆã€‘ã‚¢ã‚¯ã‚»ãƒ«ã‚·ãƒ³ã‚¯ãƒ­ã®å€ç‡è¨ˆç®—ãƒ­ã‚°
	        console.group("%cğŸ§­ é€šå¸¸æ¢ç´¢ æŠ½é¸ãƒ¬ãƒãƒ¼ãƒˆ", "color: #f1c40f; font-weight: bold; font-size: 1.2rem;");
	        console.log(`ç¾åœ¨ã®é€£ç¶šãƒ‘ã‚¹å›æ•°: ${consecutiveNoTakeCount}`);

	        if (upgState.accel_synchro.lv > 0 && consecutiveNoTakeCount > 0) {
	            internalDrawMulti = 1 + consecutiveNoTakeCount;
	            bonusMsg = `<br><span style='color:var(--mode-synchro); font-weight:bold;'>ã‚¢ã‚¯ã‚»ãƒ«ã‚·ãƒ³ã‚¯ãƒ­ç™ºå‹•ä¸­ï¼ (å†…éƒ¨æŠ½é¸è©¦è¡Œ ${internalDrawMulti}å€)</span>`;
	            console.log(`%cã‚¢ã‚¯ã‚»ãƒ«ã‚·ãƒ³ã‚¯ãƒ­é©ç”¨: å†…éƒ¨æŠ½é¸æ•°ã‚’ ${internalDrawMulti} å€ã«ãƒ–ãƒ¼ã‚¹ãƒˆã—ã¾ã™ã€‚`, "color: #00cec9; font-weight: bold;");
	        }

	        desc.innerHTML = `æŒã¡å¸°ã‚‹å‡ºç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚${bonusMsg}<br><span style='font-size:0.8rem; color:#aaa;'>â€»æ±ºå®šã™ã‚‹ã¨æ¬¡å›ã®æ¢ç´¢ã‚³ã‚¹ãƒˆãŒ2å€ã«ãªã‚Šã¾ã™</span>`;
	        
	        rewardSelectCount = 1 + (reincData.upgrades.greedy_exp || 0);
	        const choiceNum = 2 + upgState.exp_amount.lv + (reincData.upgrades.greedy_exp || 0);
	        
	        let tempPool = [];
	        const drawCount = choiceNum * internalDrawMulti;
	        console.log(`æç¤ºæ : ${choiceNum} / ç·æŠ½é¸è©¦è¡Œæ•°: ${drawCount}`);
	        
	        for(let i=0; i<drawCount; i++) {
	            tempPool.push({ die: genDie(), selected: false });
	        }

	        console.log("ã€1. å†…éƒ¨æŠ½é¸ãƒ»å…¨å€™è£œã€‘", tempPool.map(t => `[${t.die.rarity} Lv${t.die.level}]`));
	        tempPool.sort(sortRewardsFunc);
	        console.log("ã€2. ã‚½ãƒ¼ãƒˆå¾Œãƒ»é¸æŠœå€™è£œã€‘", tempPool.map(t => `[${t.die.rarity} Lv${t.die.level}]`));

	        currentRewards = tempPool.slice(0, choiceNum);
	        console.log("%cã€3. æœ€çµ‚æç¤ºï¼ˆæ±ºå®šï¼‰ã€‘:", "color: #2ecc71; font-weight: bold;", currentRewards.map(t => `${t.die.rarity}(Lv${t.die.level})`));
	        console.groupEnd();

	        currentRewards.forEach((item, i) => {
	            const card = createCard(item.die, false);
	            card.id = `reward-card-${i}`;
	            card.onclick = () => selectReward(i);
	            list.appendChild(card);
	        });
	        updateConfirmButtonState();

	    } else if (expMode === 'ritual') {
	        title.textContent = "å„€å¼ï¼";
	        title.style.color = "#9b59b6";
	        if (rewardActionArea) rewardActionArea.style.display = 'block';
	        desc.innerHTML = "æ¶ˆæ»…ã•ã›ã‚‹å‡ºç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
	        rewardSelectCount = 1 + (reincData.upgrades.greedy_rit || 0);
	        const count = 2 + upgState.ritual_amount.lv + (reincData.upgrades.greedy_rit || 0);
	        const indices = [];
	        while(indices.length < count && indices.length < dicePool.length) {
	            const r = Math.floor(Math.random() * dicePool.length);
	            if(!indices.includes(r)) indices.push(r);
	        }
	        indices.forEach(idx => {
	            currentRewards.push({ die: dicePool[idx], poolIndex: idx, selected: false });
	        });
	        currentRewards.sort(sortRewardsFunc);
	        currentRewards.forEach((item, i) => {
	            const card = createCard(item.die, true);
	            card.id = `reward-card-${i}`;
	            card.onclick = () => selectReward(i);
	            list.appendChild(card);
	        });
	        updateConfirmButtonState();
	    } else if (expMode === 'fusion') {
	        title.textContent = "èåˆï¼";
	        title.style.color = "var(--mode-fusion)";
	        desc.innerHTML = "èåˆã™ã‚‹å‡ºç›®ã‚’2ã¤é¸æŠã—ã¦ãã ã•ã„ã€‚";
	        rewardSelectCount = 2;
	        const count = 5 + upgState.fusion_exp_amount.lv;
	        const indices = [];
	        while(indices.length < count && indices.length < dicePool.length) {
	            const r = Math.floor(Math.random() * dicePool.length);
	            if(!indices.includes(r)) indices.push(r);
	        }
	        indices.forEach(idx => { currentRewards.push({ die: dicePool[idx], poolIndex: idx, selected: false }); });
	        currentRewards.sort(sortRewardsFunc);
	        currentRewards.forEach((item, i) => {
	            const card = createCard(item.die, false, 'fusion');
	            card.id = `reward-card-${i}`;
	            card.onclick = () => selectFusionReward(i);
	            list.appendChild(card);
	        });
	        document.getElementById('fusion-action-area').style.display = 'block';

	    } else if (expMode === 'synchro') {
	        title.textContent = "ã‚·ãƒ³ã‚¯ãƒ­ï¼";
	        title.style.color = "var(--mode-synchro)";
	        desc.innerHTML = "ã‚·ãƒ³ã‚¯ãƒ­ã•ã›ã‚‹ãƒšã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
	        rewardSelectCount = 1;
	        let groups = {};
	        dicePool.forEach((d, idx) => { if(d) { groups[d.val] = groups[d.val] || []; groups[d.val].push(idx); } });
	        let allPairs = [];
	        for (let val in groups) {
	            let indices = groups[val];
	            if (indices.length < 2) continue;
	            for (let i = 0; i < indices.length - 1; i++) {
	                for (let j = i + 1; j < indices.length; j++) { allPairs.push([indices[i], indices[j]]); }
	            }
	        }
	        allPairs.sort(() => Math.random() - 0.5);
	        const maxChoices = 2 + (upgState.tuning ? upgState.tuning.lv : 0);
	        let finalOptions = allPairs.slice(0, maxChoices);
	        finalOptions.forEach((pair, optionIdx) => {
	            const pairContainer = document.createElement('div');
	            pairContainer.className = 'synchro-pair-container';
	            pairContainer.onclick = () => selectSynchroPair(optionIdx);
				pair.forEach((poolIdx, iInPair) => { // ç¬¬2å¼•æ•°ã«è¿½åŠ 
				    const currentIndex = currentRewards.length;
				    currentRewards.push({ die: dicePool[poolIdx], poolIndex: poolIdx, selected: false, optionId: optionIdx });
				    const card = createCard(dicePool[poolIdx], false, 'synchro');
				    
				    // ã€é‡è¦ã€‘å„ã‚«ãƒ¼ãƒ‰ã«ä¸€æ„ã®IDã‚’ä»˜ä¸ã™ã‚‹
				    card.id = `reward-card-${currentIndex}`; 
				    
				    pairContainer.appendChild(card);
				});
	            list.appendChild(pairContainer);
	        });
	        document.getElementById('synchro-action-area').style.display = 'block';

	    } else if (expMode === 'xyz') {
	        title.textContent = "ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºï¼";
	        title.style.color = "var(--mode-xyz)";
	        rewardSelectCount = 1;
	        let groups = {};
	        dicePool.forEach((d, idx) => { if(d) { const l = d.level || 1; groups[l] = groups[l] || []; groups[l].push(idx); } });
	        let allPairs = [];
	        for (let l in groups) {
	            let indices = groups[l];
	            if (indices.length < 2) continue;
	            for (let i = 0; i < indices.length - 1; i++) {
	                for (let j = i + 1; j < indices.length; j++) { allPairs.push([indices[i], indices[j]]); }
	            }
	        }
	        allPairs.sort(() => Math.random() - 0.5);
	        const maxChoices = 2 + upgState.rank_revolution.lv;
	        let finalOptions = allPairs.slice(0, maxChoices);
	        finalOptions.forEach((pair, optionIdx) => {
	            const pairContainer = document.createElement('div');
	            pairContainer.className = 'synchro-pair-container';
	            pairContainer.onclick = () => selectXyzPair(optionIdx);
				pair.forEach((poolIdx, iInPair) => {
				    const currentIndex = currentRewards.length;
				    currentRewards.push({ die: dicePool[poolIdx], poolIndex: poolIdx, selected: false, optionId: optionIdx });
				    const card = createCard(dicePool[poolIdx], false, 'xyz');
				    
				    // ã€é‡è¦ã€‘å„ã‚«ãƒ¼ãƒ‰ã«ä¸€æ„ã®IDã‚’ä»˜ä¸ã™ã‚‹
				    card.id = `reward-card-${currentIndex}`; 
				    
				    pairContainer.appendChild(card);
				});
	            list.appendChild(pairContainer);
	        });
	        document.getElementById('xyz-action-area').style.display = 'block';
	    }

	    updateRewardCountMsg();
	    document.getElementById('reward-modal').style.display = 'flex';
	}

	// --- å ±é…¬æ±ºå®šæ™‚ã®ãƒªã‚»ãƒƒãƒˆå‡¦ç† ---
	function confirmRewards() {
	    const selectedItems = currentRewards.filter(r => r.selected);
	    if (selectedItems.length === 0) return;

	    if (expMode === 'normal') {
	        selectedItems.forEach(item => { dicePool.push(item.die); });
	        expNextCost *= 2;
	        // ã€ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆã€‘å‡ºç›®ã‚’å—ã‘å–ã£ãŸã‚‰ãƒ‘ã‚¹å›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
	        consecutiveNoTakeCount = 0; 
	        console.log("%cå‡ºç›®ã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚ã‚¢ã‚¯ã‚»ãƒ«ã‚·ãƒ³ã‚¯ãƒ­ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚", "color: #f39c12;");
	    } else if (expMode === 'ritual') {
	        selectedItems.forEach(item => { dicePool[item.poolIndex] = null; });
	        dicePool = dicePool.filter(d => d !== null);
	        ritualNextCost *= 2;
	    }

	    closeExpeditionModal(true);
	    saveGame();
	}
    
    function updateRewardCountMsg() {
        if(expMode === 'fusion' || expMode === 'xyz') {
            document.getElementById('reward-count-msg').textContent = `é¸æŠä¸­: ${2 - rewardSelectCount} / 2`;
        } else if (expMode === 'synchro') {
            // ã‚·ãƒ³ã‚¯ãƒ­ã®å ´åˆã¯ selectSynchroReward å†…ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ¶å¾¡ã—ã¦ã„ã‚‹ã®ã§ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„ã‹ã€åˆæœŸè¡¨ç¤º
            // document.getElementById('reward-count-msg').textContent = "ãƒšã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„";
        } else {
            document.getElementById('reward-count-msg').textContent = `æ®‹ã‚Šé¸æŠå¯èƒ½æ•°: ${rewardSelectCount}`;
        }
    }

    function selectXyzPair(optionId) {
        // å…¨ã¦ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        currentRewards.forEach(r => r.selected = false);
        document.querySelectorAll('.synchro-pair-container').forEach(el => el.classList.remove('selected'));
        document.querySelectorAll('.reward-card').forEach(el => el.classList.remove('selected'));

        // æŒ‡å®šã•ã‚ŒãŸãƒšã‚¢ã‚’é¸æŠ
        currentRewards.forEach((r, i) => {
            if (r.optionId === optionId) {
                r.selected = true;
                const card = document.getElementById(`reward-card-${i}`);
                if(card) card.classList.add('selected');
            }
        });

        const container = document.getElementById(`xyz-pair-${optionId}`);
        if(container) container.classList.add('selected');

        updateXyzButtonState();
    }

    function updateXyzButtonState() {
        const selectedCount = currentRewards.filter(r => r.selected).length;
        const btn = document.getElementById('btn-do-xyz');
        if(!btn) return;
        
        btn.disabled = (selectedCount !== 2);
        btn.style.opacity = (selectedCount !== 2) ? 0.5 : 1;
        btn.style.cursor = (selectedCount !== 2) ? 'not-allowed' : 'pointer';
    }

	function executeXyz() {
	    const selected = currentRewards.filter(r => r.selected);
	    if(selected.length !== 2) return;
	    
	    const d1 = selected[0].die;
	    const d2 = selected[1].die;

	    // å€ç‡è¨ˆç®—
	    let m1 = RARITIES[d1.rarity].mult;
	    let m2 = RARITIES[d2.rarity].mult;

	    // ãƒãƒ¥ãƒ¼ãƒŠãƒ¼è£œæ­£ãŒã‚ã‚Œã°åŠ å‘³ã™ã‚‹
	    if (reincData.upgrades.tuner > 0) {
	        m1 *= ((d1.level||1) * (d1.level||1));
	        m2 *= ((d2.level||1) * (d2.level||1));
	    }

	    const gainedORU = m1 + m2;
	    overlayUnits += gainedORU;

	    // ãƒ—ãƒ¼ãƒ«ã‹ã‚‰å‰Šé™¤
	    dicePool[selected[0].poolIndex] = null;
	    dicePool[selected[1].poolIndex] = null;
	    
	    // æ¬¡å›ã‚³ã‚¹ãƒˆå¢—åŠ 
	    xyzNextCost *= 2;
	    
	    alert(`ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹ç¯‰ï¼\n${gainedORU} ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¦ãƒ‹ãƒƒãƒˆ ã‚’ç²å¾—ã—ã¾ã—ãŸï¼\n(åˆè¨ˆ: ${formatScore(overlayUnits)})`);
	    
	    dicePool = dicePool.filter(d => d !== null);
	    document.getElementById('reward-modal').style.display = 'none';
	    
	    closeExpeditionModal(true);
	    saveGame();
	}

    function createCard(d, isRemove, specialMode) {
        const card = document.createElement('div'); 
        let className = 'reward-card';
        if(isRemove) className += ' remove-mode';
        if(specialMode === 'fusion') className += ' fusion-mode';
        if(specialMode === 'synchro') className += ' synchro-mode';
        if(specialMode === 'xyz') className += ' xyz-mode';
        card.className = className;
        
        const dieContent = getDieContent(d.val);
        const dieClass = typeof d.val === 'number' && d.val > 6 ? 'die is-number' : 'die';
        
        let faceColor = RARITIES[d.rarity].color;
        if (d.rarity === 'common') {
            faceColor = '#333333'; 
        }

        const dLvl = d.level || 1;
        let lvlInfo = "";
        
        // --- å¤‰æ›´: å€ç‡è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
        let totalMult = RARITIES[d.rarity].mult;
        
        if (reincData && reincData.upgrades && reincData.upgrades.tuner > 0) {
            // ãƒãƒ¥ãƒ¼ãƒŠãƒ¼æœ‰åŠ¹æ™‚ã¯ãƒ¬ãƒ™ãƒ«ã®2ä¹—ã‚’æ›ã‘ã‚‹
            const lvlBonus = dLvl * dLvl;
            totalMult *= lvlBonus;
            
            lvlInfo = `<div style="font-size:0.8rem; color:var(--max-gold); font-weight:bold;">Lv.${dLvl}</div>`;
        }
        // ---------------------------

        card.innerHTML = `
            <div class="${dieClass}" style="width:60px; height:60px; font-size:2rem; color:${faceColor}; border:1px solid #ccc;">${dieContent}</div>
            <div style="color:${RARITIES[d.rarity].color}; font-size:0.7rem; font-weight:bold;">${RARITIES[d.rarity].name}</div>
            ${lvlInfo}
            <div style="font-size:0.6rem; color:#888;">å€ç‡: x${formatMultiplier(totalMult)}</div>
            <div style="font-size:0.6rem; color:#aaa;">${d.val > 6 ? 'Value: '+d.val : ''}</div>
        `;
        return card;
    }
    
    function getDieContent(val) {
        if(val <= 6) return ["","âš€","âš","âš‚","âšƒ","âš„","âš…"][val];
        return val;
    }

	function selectReward(index) {
	    const item = currentRewards[index];
	    const el = document.getElementById(`reward-card-${index}`);

	    if (item.selected) {
	        // ã™ã§ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è§£é™¤
	        item.selected = false;
	        el.classList.remove('selected');
	        rewardSelectCount++;
	    } else {
	        // æœªé¸æŠã®å ´åˆã¯é¸æŠï¼ˆä¸Šé™ãƒã‚§ãƒƒã‚¯ã‚ã‚Šï¼‰
	        if (rewardSelectCount <= 0) return; 
	        item.selected = true;
	        el.classList.add('selected');
	        rewardSelectCount--;
	    }

	    updateRewardCountMsg();
	    updateConfirmButtonState(); // æ±ºå®šãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
	}

	function confirmRewards() {
        const selectedItems = currentRewards.filter(r => r.selected);
        if (selectedItems.length === 0) return;

        if (expMode === 'normal') {
            selectedItems.forEach(item => {
                dicePool.push(item.die);
            });
            expNextCost *= 2;
            // --- è¿½åŠ ï¼šå‡ºç›®ã‚’å—ã‘å–ã£ãŸã‚‰ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ ---
            consecutiveNoTakeCount = 0; 
        } else if (expMode === 'ritual') {
	        // é¸æŠã•ã‚ŒãŸã‚‚ã®ã‚’ãƒ—ãƒ¼ãƒ«ã‹ã‚‰å‰Šé™¤
	        selectedItems.forEach(item => {
	            dicePool[item.poolIndex] = null;
	        });
	        dicePool = dicePool.filter(d => d !== null); // nullã‚’æƒé™¤
	        ritualNextCost *= 2;
	    }

	    closeExpeditionModal(true);
	    saveGame();
	}

	function discardRewards() {
	    if (expMode === 'normal') {
	        const selectedCount = currentRewards.filter(r => r.selected).length;
	        // ã€ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆã€‘ä½•ã‚‚é¸ã°ãšã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆãƒ‘ã‚¹ï¼‰ã—ãŸå ´åˆã®ã¿ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
	        if (selectedCount === 0) {
	            consecutiveNoTakeCount++;
	            console.log(`%cæ¢ç´¢ã‚’ãƒ‘ã‚¹ã—ã¾ã—ãŸã€‚ç¾åœ¨ã®é€£ç¶šãƒ‘ã‚¹å›æ•°: ${consecutiveNoTakeCount}`, "color: #00cec9;");
	        }
	    }
	    
	    if (expMode === 'ritual') {
	        dicePool = dicePool.filter(d => d !== null);
	    }

	    closeExpeditionModal(false);
	}

	// æ±ºå®šãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°
	function updateConfirmButtonState() {
	    const btn = document.getElementById('btn-confirm-reward');
	    const selectedCount = currentRewards.filter(r => r.selected).length;
	    
	    if (selectedCount > 0) {
	        btn.disabled = false;
	        btn.style.opacity = 1;
	        btn.style.cursor = 'pointer';
	    } else {
	        btn.disabled = true;
	        btn.style.opacity = 0.5;
	        btn.style.cursor = 'not-allowed';
	    }
	}
    
    function selectFusionReward(index) {
        const item = currentRewards[index];
        const el = document.getElementById(`reward-card-${index}`);
        
        if (item.selected) {
            item.selected = false;
            el.classList.remove('selected');
            rewardSelectCount++;
        } else {
            if (rewardSelectCount <= 0) return; 
            item.selected = true;
            el.classList.add('selected');
            rewardSelectCount--;
        }
        
        updateRewardCountMsg();
        
        document.getElementById('btn-do-fuse').disabled = (rewardSelectCount !== 0);
        document.getElementById('btn-do-fuse').style.opacity = (rewardSelectCount !== 0) ? 0.5 : 1;
        document.getElementById('btn-do-fuse').style.cursor = (rewardSelectCount !== 0) ? 'not-allowed' : 'pointer';
    }

    function selectSynchroPair(optionId) {
        // 1. å…¨ã¦ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        currentRewards.forEach(r => r.selected = false);
        
        // DOMã®è¦‹ãŸç›®ãƒªã‚»ãƒƒãƒˆ
        document.querySelectorAll('.synchro-pair-container').forEach(el => el.classList.remove('selected'));
        document.querySelectorAll('.reward-card').forEach(el => el.classList.remove('selected'));

        // 2. æŒ‡å®šã•ã‚ŒãŸãƒšã‚¢ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
        let pairCardsIndices = [];
        currentRewards.forEach((r, i) => {
            if (r.optionId === optionId) {
                r.selected = true;
                pairCardsIndices.push(i);
            }
        });

        // 3. è¦‹ãŸç›®ã‚’æ›´æ–° (ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ)
        const container = document.getElementById(`synchro-pair-${optionId}`);
        if(container) container.classList.add('selected');
        
        // ã‚«ãƒ¼ãƒ‰è‡ªä½“ã‚‚å…‰ã‚‰ã›ãŸã„å ´åˆ
        pairCardsIndices.forEach(idx => {
            const card = document.getElementById(`reward-card-${idx}`);
            if(card) card.classList.add('selected');
        });

        // 4. ãƒœã‚¿ãƒ³æ›´æ–°
        updateSynchroButtonState();
    }

    function updateSynchroButtonState() {
        // 2æšé¸æŠã•ã‚Œã¦ã„ã‚Œã°OK
        const selectedCount = currentRewards.filter(r => r.selected).length;
        const btn = document.getElementById('btn-do-synchro');
        const msg = document.getElementById('reward-count-msg');

        if (selectedCount === 2) {
            btn.disabled = false;
            btn.style.opacity = 1;
            btn.style.cursor = 'pointer';
            msg.textContent = "å®Ÿè¡Œå¯èƒ½ã§ã™";
            msg.style.color = "var(--mode-synchro)";
        } else {
            btn.disabled = true;
            btn.style.opacity = 0.5;
            btn.style.cursor = 'not-allowed';
            msg.textContent = "ãƒšã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„";
            msg.style.color = "#888"; // ã‚°ãƒ¬ãƒ¼ã«æˆ»ã™
        }
    }
    
    function executeFusion() {
        const selected = currentRewards.filter(r => r.selected);
        if(selected.length !== 2) return;
        
        const d1 = selected[0].die;
        const d2 = selected[1].die;
        
        const limit = 20 + ((reincData.upgrades.fusion_limit || 0) * 3);
        let newVal = d1.val + d2.val;
        if(newVal > limit) newVal = limit;
        
        // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®æ±ºå®š
        let newRarityKey = 'common';
        const r1Idx = RARITY_ORDER.indexOf(d1.rarity);
        const r2Idx = RARITY_ORDER.indexOf(d2.rarity);
        
        if (r1Idx > r2Idx) {
            newRarityKey = d1.rarity;
        } else if (r2Idx > r1Idx) {
            newRarityKey = d2.rarity;
        } else {
            const nextIdx = r1Idx + 1;
            if (nextIdx < RARITY_ORDER.length) {
                const nextKey = RARITY_ORDER[nextIdx];
                if (RARITIES[nextKey]) {
                    newRarityKey = nextKey;
                } else {
                    newRarityKey = d1.rarity; 
                }
            } else {
                newRarityKey = d1.rarity; 
            }
        }

        const lvl1 = d1.level || 1;
        const lvl2 = d2.level || 1;
        const newLevel = Math.max(lvl1, lvl2);
        
        const newDie = { val: newVal, rarity: newRarityKey, level: newLevel };
        
        dicePool[selected[0].poolIndex] = null;
        dicePool[selected[1].poolIndex] = null;
        
        dicePool.push(newDie);
        
        fusionNextCost *= 2;
        
        let lvlMsg = (reincData.upgrades.tuner > 0) ? `\nãƒ¬ãƒ™ãƒ«: ${newLevel}` : "";
        alert(`èåˆæˆåŠŸï¼\nå€¤: ${newVal} (ä¸Šé™${limit})\nãƒ¬ã‚¢ãƒªãƒ†ã‚£: ${RARITIES[newRarityKey].name}${lvlMsg}`);
        
        dicePool = dicePool.filter(d => d !== null);
        document.getElementById('reward-modal').style.display = 'none';
        closeExpeditionModal(true);
        saveGame();
    }

    function executeSynchro() {
        const selected = currentRewards.filter(r => r.selected);
        if(selected.length !== 2) return;
        
        const d1 = selected[0].die;
        const d2 = selected[1].die;
        
        // å€¤ã¯å¤‰ã‚ã‚‰ãªã„
        let newVal = d1.val;

        // ãƒ¬ãƒ™ãƒ«ã¯åˆç®—
        const lvl1 = d1.level || 1;
        const lvl2 = d2.level || 1;
        let newLevel = lvl1 + lvl2;

        // ãƒ¬ãƒ™ãƒ«ã‚­ãƒ£ãƒƒãƒ—è¨ˆç®— (åˆæœŸ12, ã‚¯ãƒªã‚¢ãƒã‚¤ãƒ³ãƒ‰ç­‰ã§è§£æ”¾)
        let cap = 12;
        if (reincData.upgrades.over_top_clear_mind > 0) cap = 20;
        else if (reincData.upgrades.top_clear_mind > 0) cap = 17;
        else if (reincData.upgrades.clear_mind > 0) cap = 14;

        if (newLevel > cap) newLevel = cap;

        // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã¯é«˜ã„æ–¹ã«æƒã†
        let newRarityKey = 'common';
        const r1Idx = RARITY_ORDER.indexOf(d1.rarity);
        const r2Idx = RARITY_ORDER.indexOf(d2.rarity);
        if (r1Idx >= r2Idx) {
            newRarityKey = d1.rarity;
        } else {
            newRarityKey = d2.rarity;
        }

        const newDie = { val: newVal, rarity: newRarityKey, level: newLevel };
        
        dicePool[selected[0].poolIndex] = null;
        dicePool[selected[1].poolIndex] = null;
        dicePool.push(newDie);
        
        synchroNextCost *= 2;
        
        alert(`ã‚·ãƒ³ã‚¯ãƒ­æˆåŠŸï¼\nå€¤: ${newVal}\nãƒ¬ã‚¢ãƒªãƒ†ã‚£: ${RARITIES[newRarityKey].name}\nãƒ¬ãƒ™ãƒ«: ${newLevel} (Max:${cap})`);
        
        dicePool = dicePool.filter(d => d !== null);
        document.getElementById('reward-modal').style.display = 'none';
        closeExpeditionModal(true);
        saveGame();
    }

    function closeExpeditionModal(acted) {
        document.getElementById('reward-modal').style.display = 'none';
        expStatus = 'idle';
        expTimeRemaining = 0;
        
        const b = document.getElementById('exp-action-btn');
        b.disabled = false;
        b.textContent = "æ¢ç´¢é–‹å§‹";
        
        const p = document.getElementById('exp-prog');
        p.style.strokeDashoffset = 100;
        document.getElementById('exp-timer-text').textContent = "READY";
        
        let actionName = "";
        if (expMode === 'normal') actionName = acted ? "åŠ ãˆã¾ã—ãŸï¼" : "æŒã¡å¸°ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        else if (expMode === 'ritual') actionName = acted ? "æ¶ˆæ»…ã•ã›ã¾ã—ãŸ..." : "å„€å¼ã‚’ä¸­æ–­ã—ã¾ã—ãŸã€‚";
        else if (expMode === 'fusion') actionName = acted ? "èåˆã—ã¾ã—ãŸï¼" : "èåˆã—ã¾ã›ã‚“ã§ã—ãŸã€‚";
        else if (expMode === 'synchro') actionName = acted ? "ã‚·ãƒ³ã‚¯ãƒ­ã—ã¾ã—ãŸï¼" : "ã‚·ãƒ³ã‚¯ãƒ­ã—ã¾ã›ã‚“ã§ã—ãŸã€‚";
        else if (expMode === 'xyz') actionName = acted ? "ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºã—ã¾ã—ãŸï¼" : "ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºã—ã¾ã›ã‚“ã§ã—ãŸã€‚"; 
        
        document.getElementById('exp-msg').textContent = acted || !acted ? `çµæœ: ${actionName}` : "";
        
        updateUI();
    }

    function genDie() {
        const v = Math.floor(Math.random()*6)+1;
	    updateRarityDefinitions(); // å®šç¾©ã‚’æœ€æ–°ã«
	    
	    // é‡ã¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦èª¿æ•´
	    let currentWeights = JSON.parse(JSON.stringify(RARITIES));
	    
	    if (xyzUpgState.pack_uncommon.lv > 0) {
	        currentWeights.common.weight = Math.max(0, currentWeights.common.weight - (xyzUpgState.pack_uncommon.lv * 1000));
	    }
	    if (xyzUpgState.pack_rare.lv > 0) {
	        currentWeights.uncommon.weight = Math.max(0, currentWeights.uncommon.weight - (xyzUpgState.pack_rare.lv * 1000));
	    }

	    const weightsArr = Object.entries(currentWeights);
	    const totalWeight = weightsArr.reduce((a,b)=>a+b[1].weight, 0);
	    
	    let rKey = 'common';
	    let rRand = Math.random() * totalWeight;
	    for(let [k, d] of weightsArr) { 
	        if(rRand < d.weight) { rKey = k; break; } 
	        rRand -= d.weight; 
	    }

        // ãƒ¬ãƒ™ãƒ«æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯
        let lvl = 1;
        if (reincData && reincData.upgrades && reincData.upgrades.tuner > 0) {
            let minLvl = 1;
            let maxLvl = 4;
            
            // ä¸Šç´šã‚¢ãƒ‰ãƒãƒ³ã‚¹æ¢ç´¢ãŒæœ‰åŠ¹ãªã‚‰ãƒ¬ãƒ™ãƒ«5-8
            if (reincData.upgrades.adv_adv_exp > 0) {
                minLvl = 5;
                maxLvl = 8;
            } 
            // ã‚¢ãƒ‰ãƒãƒ³ã‚¹æ¢ç´¢ãŒæœ‰åŠ¹ãªã‚‰ãƒ¬ãƒ™ãƒ«1-6
            else if (reincData.upgrades.adv_exp > 0) {
                maxLvl = 6;
            }
            
            lvl = Math.floor(Math.random() * (maxLvl - minLvl + 1)) + minLvl;
        }

        return {val:v, rarity:rKey, level: lvl};
    }

    function drawDice(count) {
        // nullã‚’é™¤å¤–ã—ãŸæœ‰åŠ¹ãªãƒ—ãƒ¼ãƒ«ã‚’ä½œæˆ
        const validPool = dicePool.filter(d => d !== null);

        // ãƒ—ãƒ¼ãƒ«ã®ä¸­èº«ãŒè¦æ±‚æ•°ã‚ˆã‚Šå°‘ãªã„å ´åˆ
        if (validPool.length < count) {
            // ã‚ã‚‹ã ã‘å…¨éƒ¨å‡ºã™
            const res = [...validPool];
            // ãã‚Œã§ã‚‚è¶³ã‚Šãªã„åˆ†ã¯ã€Œã‚³ãƒ¢ãƒ³1ã€ã§åŸ‹ã‚ã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼é˜²æ­¢ï¼‰
            while (res.length < count) {
                res.push({ val: 1, rarity: 'common', level: 1 });
            }
            return res;
        }

        // ãƒ—ãƒ¼ãƒ«ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å…ˆé ­ã‹ã‚‰countå€‹å–å¾—ï¼ˆFisher-Yates Shuffleï¼‰
        const shuffled = [...validPool];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        
        return shuffled.slice(0, count);
    }

    // --- ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ ---
    function buyUpgrade(type) {
        const upg = upgState[type];
        const reqs = Array.isArray(upg.req) ? upg.req : (upg.req ? [upg.req] : []);
        
        if (upg.reincReq && (reincData.upgrades[upg.reincReq] || 0) <= 0) return;

        const canBuy = reqs.every(r => {
             const reqLvl = upg.reqLv || 1; // æŒ‡å®šãŒãªã‘ã‚Œã°Lv1
             return upgState[r].lv >= reqLvl;
        });

        if (reqs.length > 0 && !canBuy) return;

        if (score >= upg.costs[upg.lv] && upg.lv < upg.max) {
            score -= upg.costs[upg.lv];
            upg.lv++;
            
            if (type === 'finger' || type === 'platinum_finger') {
                const baseMult = 1 + upgState.finger.lv;
                const platMult = 1 + (upgState.platinum_finger.lv * 0.1);
                multiplier = baseMult * platMult;
            }

            if (type === 'auto') { hasAutoRoll = true; document.querySelectorAll('.timer-container').forEach(e => e.style.display='block'); }
            if (type === 'field' || type === 'potential') {
                fieldCount = 1 + upgState.field.lv;
                document.getElementById('game-fields').innerHTML = '';
                for(let i=0; i<fieldCount; i++) addField(i);
            }
            if (type === 'history') document.getElementById('panel-history').style.display = 'block';
            if (type === 'digital_history') document.getElementById('btn-pool-detail').style.display = 'block';
            
            if (type === 'exp_speed' && expStatus === 'running') {
                expTimeRemaining -= 16000;
            }
            if (type === 'simple_fusion' && expStatus === 'running') {
                expTimeRemaining /= 2;
            }
            if (type === 'urgent_tuning' && expStatus === 'running') {
                expTimeRemaining /= 2;
            }

            saveGame();
            updateUI(); drawLines();
        }
    }

    function addField(id) {
        const div = document.createElement('div');
        div.className = 'field';
        const num = 3 + upgState.potential.lv;
        let dHtml = ''; for(let i=0; i<num; i++) dHtml += `<div class="die" id="d-${id}-${i}">?</div>`;
        
        div.innerHTML = `<div class="timer-container" style="display:${hasAutoRoll?'block':'none'}"><svg class="timer-svg" viewBox="0 0 36 36"><circle class="timer-bg" cx="18" cy="18" r="16"></circle><circle id="prog-${id}" class="timer-progress" cx="18" cy="18" r="16"></circle></svg></div><div id="m-${id}" class="msg-area"></div><div class="dice-row">${dHtml}</div><button class="roll-btn" id="b-${id}" onclick="playSound('roll'); playGame(${id})">ãƒ­ãƒ¼ãƒ«</button>`;

        document.getElementById('game-fields').appendChild(div);
    }

    function playGame(idString) {
        const id = typeof idString === 'string' ? parseInt(idString.split('-')[1]) : idString;
        const btn = document.getElementById(`b-${id}`); if(!btn || btn.disabled) return;
        btn.disabled = true;
        const num = 3 + upgState.potential.lv;
        let c = 0, wait = Math.max(2, 10 - upgState.throw.lv);
        const iv = setInterval(() => {
            for(let i=0; i<num; i++) {
                const d = document.getElementById(`d-${id}-${i}`);
                if(d) {
                    d.textContent = ["âš€","âš","âš‚","âšƒ","âš„","âš…"][Math.floor(Math.random()*6)];
                    d.className = "die rolling";
                }
            }
            if(++c > wait) {
                clearInterval(iv);
                
                // å®‰å…¨ç­–: ãƒ—ãƒ¼ãƒ«ãŒç©ºãªã‚‰ç·Šæ€¥è£œå……
                if (dicePool.length === 0) initNewGame();

                // --- å¤‰æ›´ç®‡æ‰€ ---
                // é‡è¤‡ãªã—ã§ãƒ€ã‚¤ã‚¹ã‚’å¼•ã
                const res = drawDice(num);
                // ----------------

                res.forEach((d, i) => {
                    const el = document.getElementById(`d-${id}-${i}`);
                    if(el) {
                        el.textContent = getDieContent(d.val);
                        el.className = "die " + (RARITIES[d.rarity].class || "");
                        if(d.val > 6) el.classList.add('is-number');
                    }
                });
                processResult(res, id, false); 
                btn.disabled = false;
            }
        }, 100);
    }

	function processResult(dice, id, isSilent) {
	    let best = { val: -1, yaku: "ç›®ãªã—", base: 10, idx: [0, 1, 2], b: 1 };
	    const diceWithIdx = dice.map((d, i) => ({ ...d, origIdx: i }));

	    // 5æšå½¹ãƒã‚§ãƒƒã‚¯
	    if (dice.length >= 5 && (reincData.upgrades.straight5 > 0 || reincData.upgrades.arashi5 > 0)) {
	        const combos = getCombinations(diceWithIdx, 5);
	        for (let c of combos) {
	            const [base, yaku, scoreVal] = calcScore(c.map(d => d.val));
	            if (yaku === "ä¸æˆç«‹") continue;

	            let rarityMult = c.reduce((acc, d) => acc * RARITIES[d.rarity].mult, 1);
	            let levelMult = 1;
	            if (reincData.upgrades.tuner > 0) levelMult = c.reduce((acc, d) => acc * (d.level * d.level), 1);

	            let totalVal = scoreVal * rarityMult * levelMult;
	            if (totalVal > best.val) {
	                best = { val: totalVal, yaku: yaku, base: base, b: rarityMult * levelMult, idx: c.map(d => d.origIdx) };
	            }
	        }
	    }

	    // 4æšå½¹ãƒã‚§ãƒƒã‚¯
	    if (dice.length >= 4 && (reincData.upgrades.straight4 > 0 || reincData.upgrades.arashi4 > 0)) {
	        const combos = getCombinations(diceWithIdx, 4);
	        for (let c of combos) {
	            const [base, yaku, scoreVal] = calcScore(c.map(d => d.val));
	            if (yaku === "ä¸æˆç«‹") continue;

	            let rarityMult = c.reduce((acc, d) => acc * RARITIES[d.rarity].mult, 1);
	            let levelMult = 1;
	            if (reincData.upgrades.tuner > 0) levelMult = c.reduce((acc, d) => acc * (d.level * d.level), 1);

	            let totalVal = scoreVal * rarityMult * levelMult;
	            if (totalVal > best.val) {
	                best = { val: totalVal, yaku: yaku, base: base, b: rarityMult * levelMult, idx: c.map(d => d.origIdx) };
	            }
	        }
	    }

	    // 3æšå½¹ãƒã‚§ãƒƒã‚¯
	    const combos = getCombinations(diceWithIdx, 3);
	    for (let c of combos) {
	        const [base, yaku, scoreVal] = calcScore(c.map(d => d.val));
	        let rarityMult = 1;
	        let levelMult = 1;

	        // ç›®ãªã—ãƒ»ä¸æˆç«‹ãƒ»ãƒ’ãƒ•ãƒŸã®å ´åˆã¯ãƒ¬ã‚¢ãƒªãƒ†ã‚£å€ç‡ã‚’é©ç”¨ã—ãªã„
	        if (yaku !== "ç›®ãªã—" && yaku !== "ä¸æˆç«‹" && yaku !== "ãƒ’ãƒ•ãƒŸ") {
	            rarityMult = c.reduce((acc, d) => acc * RARITIES[d.rarity].mult, 1);
	            if (reincData.upgrades.tuner > 0) levelMult = c.reduce((acc, d) => acc * (d.level * d.level), 1);
	        }

	        let totalVal = scoreVal * rarityMult * levelMult;
	        if (totalVal > best.val) {
	            best = { val: totalVal, yaku: yaku, base: base, b: rarityMult * levelMult, idx: c.map(d => d.origIdx) };
	        }
	    }

	    // æœ€çµ‚çš„ãªå½¹ãŒã€Œç›®ãªã—ã€ã®å ´åˆã€ãƒ¬ã‚¢ãƒªãƒ†ã‚£å€ç‡ã‚’å¼·åˆ¶çš„ã«1ã«ã™ã‚‹ï¼ˆæ•‘æ¸ˆæªç½®ï¼‰
	    if (best.yaku === "ç›®ãªã—" || best.yaku === "ä¸æˆç«‹") {
	        best.b = 1;
	    }

	    if (!isSilent) {
	        for (let i = 0; i < dice.length; i++) {
	            const dieEl = document.getElementById(`d-${id}-${i}`);
	            if (dieEl) {
	                if (!best.idx.includes(i)) dieEl.classList.add('unused');
	                else dieEl.classList.remove('unused');
	            }
	        }
	    }

	    const reincMult = Math.max(1, reincData.maxReachedRP * 0.2);
	    let xyzPassiveMult = 1 + (xyzUpgState.network.lv * 0.2);
	    let activeBuff = 1;
	    let bonusText = "";

	    if (activeTimers.shift > 0) {
	        activeBuff = 3;
	        bonusText = " (ã‚·ãƒ•ãƒˆä¸­)";
	    } else if (activeTimers.shiftPenalty > 0) {
	        activeBuff = 0.1;
	        bonusText = " (ä½ä¸‹ä¸­)";
	    }

	    const gain = best.base * multiplier * best.b * reincMult * xyzPassiveMult * activeBuff;

	    score += gain;
	    totalScore += gain;

	    let isNewRecord = false;
	    if (upgState.history.lv > 0 && gain > 0) {
	        const minHistory = scoreHistory.length < 5 ? 0 : scoreHistory[scoreHistory.length - 1].p;
	        if (gain > minHistory) {
	            isNewRecord = true;
	            if (!isSilent) playSound('record');
	            scoreHistory.push({ n: best.yaku + bonusText, p: gain });
	            scoreHistory.sort((a, b) => b.p - a.p);
	            scoreHistory = scoreHistory.slice(0, 5);
	            if (!isSilent) renderHistory();
	        }
	    }

	    if (!isSilent) {
	        const msgEl = document.getElementById(`m-${id}`);
	        if (msgEl) {
	            msgEl.textContent = `${best.yaku}${bonusText} (+${formatScore(gain)})`;
	            if (isNewRecord) {
	                msgEl.classList.add('high-score-highlight');
	                setTimeout(() => msgEl.classList.remove('high-score-highlight'), 2000);
	            } else {
	                msgEl.classList.remove('high-score-highlight');
	            }
	        }
	        updateUI();
	    }
	}
    
    function renderHistory() {
        document.getElementById('history-list').innerHTML = scoreHistory.map(h=>`<li><span>${h.n}</span><b>${formatScore(h.p)}</b></li>`).join('');
    }

    function calcScore(d) {
        const vals = [...d].sort((x,y)=>x-y); 
        const len = vals.length;
        const sum = vals.reduce((a,c)=>a+c, 0);
        
        const m = [
            1, 
            upgState.yaku_none.lv, 
            upgState.yaku_normal.lv, 
            upgState.yaku_456.lv, 
            upgState.yaku_arashi.lv, 
            upgState.yaku_pin.lv,
            upgState.yaku_straight4.lv, 
            upgState.yaku_arashi4.lv,   
            upgState.yaku_straight5.lv, 
            upgState.yaku_arashi5.lv    
        ].map(l => 1+(l*4));

        // 5æšå½¹
        if (len === 5) {
            if (reincData.upgrades.arashi5 > 0 && vals[0] === vals[4]) {
                // 1ã®ã‚¢ãƒ©ã‚·5ã¯ç‰¹åˆ¥é«˜é…å½“ (åˆè¨ˆ*20ä¸‡ = 100ä¸‡)
                if (vals[0] === 1) return [sum*200000*m[9], "ã‚¢ãƒ©ã‚·ï¼•", sum*200000];
                return [sum*100000*m[9], "ã‚¢ãƒ©ã‚·ï¼•", sum*100000];
            }
            if (reincData.upgrades.straight5 > 0 && isStraight(vals)) return [sum*50000*m[8], "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼•", sum*50000];
            return [0, "ä¸æˆç«‹", 0];
        }

        // 4æšå½¹
        if (len === 4) {
            if (reincData.upgrades.arashi4 > 0 && vals[0] === vals[3]) {
                // 1ã®ã‚¢ãƒ©ã‚·4ã¯ãƒ”ãƒ³ã‚¾ãƒ­(10ä¸‡)ã‚’è¶…ãˆã‚‹ã‚ˆã†ã«å¼·åŒ– (åˆè¨ˆ*5ä¸‡ = 20ä¸‡)
                if (vals[0] === 1) return [sum*50000*m[7], "ã‚¢ãƒ©ã‚·ï¼”", sum*50000];
                return [sum*20000*m[7], "ã‚¢ãƒ©ã‚·ï¼”", sum*20000];
            }
            if (reincData.upgrades.straight4 > 0 && isStraight(vals)) return [sum*10000*m[6], "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼”", sum*10000];
            return [0, "ä¸æˆç«‹", 0];
        }

        const [a,b,c] = vals;
        
        if (a===1 && b===1 && c===1) return [10000*m[5], "ãƒ”ãƒ³ã‚¾ãƒ­", 100000];
        
        if (a===b && b===c) {
            if (reincData.upgrades.privatize > 0) {
                const baseVal = (a+b+c) * 200;
                return [baseVal * m[4], "ã‚¢ãƒ©ã‚·", baseVal];
            }
            return [2000*m[4], "ã‚¢ãƒ©ã‚·", 2000+a];
        }

        if (a===1 && b===2 && c===3) return [0, "ãƒ’ãƒ•ãƒŸ", -1];

        if (a===4 && b===5 && c===6) {
             if (reincData.upgrades.privatize > 0) {
                const sum = 15;
                const baseVal = sum * 100;
                return [baseVal * m[3], "ã‚·ã‚´ãƒ­", baseVal];
            }
            return [1000*m[3], "ã‚·ã‚´ãƒ­", 1000];
        }

        if (reincData.upgrades.straight > 0 && reincData.upgrades.privatize > 0) {
            if (isStraight(d)) {
                const baseVal = (a+b+c) * 100; 
                return [baseVal * m[3], "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ", baseVal];
            }
        }

        if (a===b) return [c*50*m[2], c+"ã®ç›®", c*50];
        if (b===c) return [a*50*m[2], a+"ã®ç›®", a*50];
        if (a===c) return [b*50*m[2], b+"ã®ç›®", b*50];
        return [10*m[1], "ç›®ãªã—", 10];
    }

    function isStraight(arr) {
        for(let i=0; i<arr.length-1; i++) {
            if (arr[i+1] !== arr[i]+1) return false;
        }
        return true;
    }

    function openPoolDetail() {
        const container = document.getElementById('pool-detail-content');
        container.innerHTML = '';
        
        // ã‚¯ãƒ©ã‚¹åã‚’å¤‰æ›´ã—ã¦æ–°ã—ã„CSSã‚’é©ç”¨
        container.className = 'pool-card-container';

        // 1. nullã‚’é™¤å¤–ã—ã€ã‚½ãƒ¼ãƒˆï¼ˆå€¤æ˜‡é † -> ãƒ¬ã‚¢ãƒªãƒ†ã‚£æ˜‡é † -> ãƒ¬ãƒ™ãƒ«é™é †ï¼‰
        let validDice = dicePool.filter(d => d !== null);
        
        validDice.sort((a, b) => {
            // å€¤ã§ã‚½ãƒ¼ãƒˆ
            if (a.val !== b.val) return a.val - b.val;
            
            // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã§ã‚½ãƒ¼ãƒˆ
            const rOrder = RARITY_ORDER;
            const rA = rOrder.indexOf(a.rarity);
            const rB = rOrder.indexOf(b.rarity);
            if (rA !== rB) return rA - rB;
            
            // ãƒ¬ãƒ™ãƒ«ã§ã‚½ãƒ¼ãƒˆï¼ˆé«˜ã„é †ï¼‰
            return (b.level || 1) - (a.level || 1);
        });

        // 2. ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
        validDice.forEach(d => {
            const card = document.createElement('div');
            card.className = 'pool-card';

            // ãƒ€ã‚¤ã‚¹ã®è¦‹ãŸç›®ï¼ˆ7ä»¥ä¸Šã¯æ•°å­—ã€ãã‚Œä»¥å¤–ã¯ã‚µã‚¤ã‚³ãƒ­æ–‡å­—ï¼‰
            const content = getDieContent(d.val);
            const isNumber = d.val > 6;
            
            // ãƒ¬ã‚¢ãƒªãƒ†ã‚£æƒ…å ±ã®å–å¾—
            const rInfo = RARITIES[d.rarity];
            
            // ã‚³ãƒ¢ãƒ³ãªã‚‰é»’ã€ãã‚Œä»¥å¤–ãªã‚‰ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã‚«ãƒ©ãƒ¼ã‚’ä½¿ã†
            let dieColor = (d.rarity === 'common') ? '#333' : rInfo.color;
            
            const lvl = d.level || 1;

            // --- è¿½åŠ : å€ç‡è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
            let totalMult = rInfo.mult;
            if (reincData && reincData.upgrades && reincData.upgrades.tuner > 0) {
                 totalMult *= (lvl * lvl);
            }
            // ---------------------------

            card.innerHTML = `
                <div class="pool-card-die-outer">
                    <div class="pool-card-die-inner ${isNumber ? 'is-number' : ''}" style="color: ${dieColor};">
                        ${content}
                    </div>
                </div>
                <div class="pool-card-info">
                    <div class="pool-card-rarity" style="color:${rInfo.color}; text-shadow: 0 0 1px rgba(0,0,0,0.1);">
                        ${rInfo.name}
                    </div>
                    <div style="font-weight:bold;">Lv${lvl}</div>
                    <div style="font-size:0.6rem; color:#666;">x${formatMultiplier(totalMult)}</div>
                </div>
            `;
            container.appendChild(card);
        });

        document.getElementById('pool-detail-modal').style.display = 'flex';
    }

    function updateUI() {
        // --- 1. åŸºæœ¬çš„ãªã‚¹ã‚³ã‚¢è¡¨ç¤º ---
        document.getElementById('score-board').textContent = formatScore(score);
        document.getElementById('total-score-display').textContent = formatScore(totalScore);
        document.getElementById('modal-score').textContent = formatScore(score);
        
        // è»¢ç”Ÿå€ç‡ã®ç®—å‡º
        const reincMult = Math.max(1, reincData.maxReachedRP * 0.2);

        // --- 2. è»¢ç”Ÿãƒ‘ãƒãƒ«ã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¦ãƒ‹ãƒƒãƒˆ(ORU)ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºåˆ¶å¾¡ ---
        const rpPanel = document.getElementById('rp-display-panel');
        if (reincData.maxReachedRP > 0) {
            rpPanel.style.display = 'block';
            document.getElementById('rp-val').textContent = reincData.points;
            document.getElementById('rp-mult').textContent = formatMultiplier(reincMult);
        }
        
        const hasXyzExp = upgState.xyz_exp.lv > 0;
        const oruPanel = document.getElementById('oru-display-panel');
        if (overlayUnits > 0 || hasXyzExp) {
            oruPanel.style.display = 'block';
            document.getElementById('oru-val').textContent = formatScore(overlayUnits);
        } else {
            oruPanel.style.display = 'none';
        }       

        // --- 3. è»¢ç”Ÿãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ç®¡ç† ---
        const reincBtn = document.getElementById('reinc-btn');
        const currentRP = calcRP(totalScore);
        const gain = Math.max(0, currentRP - reincData.maxReachedRP);

        if (totalScore >= REINC_THRESHOLD && gain > 0) {
            reincBtn.style.display = 'block';
            reincBtn.textContent = "âœ¦ è»¢ç”Ÿå¯èƒ½";
            reincBtn.classList.add('reinc-available');
        } else if (reincData.maxReachedRP > 0) {
            reincBtn.style.display = 'block';
            reincBtn.textContent = "âœ¦ è»¢ç”Ÿãƒ¡ãƒ‹ãƒ¥ãƒ¼";
            reincBtn.classList.remove('reinc-available');
        } else {
            reincBtn.style.display = 'none';
        }

        // --- 4. æ¢ç´¢ãƒ‘ãƒãƒ«ã¨ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒœã‚¿ãƒ³ã®æ›´æ–° ---
        const expPanel = document.getElementById('expedition-panel');
        expPanel.style.display = upgState.expedition.lv > 0 ? 'block' : 'none';
        
        const btnNormal = document.getElementById('btn-select-normal');
        const btnRitual = document.getElementById('btn-select-ritual');
        const btnFusion = document.getElementById('btn-select-fusion');
        const btnSynchro = document.getElementById('btn-select-synchro');
        const btnXyz = document.getElementById('btn-select-xyz');

        btnNormal.style.display = 'block';
        btnRitual.style.display = upgState.ritual_unlock.lv > 0 ? 'block' : 'none';
        btnFusion.style.display = upgState.fusion_exp.lv > 0 ? 'block' : 'none';
        btnSynchro.style.display = upgState.synchro_exp.lv > 0 ? 'block' : 'none';
        btnXyz.style.display = hasXyzExp ? 'block' : 'none';

        [btnNormal, btnRitual, btnFusion, btnSynchro, btnXyz].forEach(b => b.classList.remove('active'));
        if (expMode === 'normal') btnNormal.classList.add('active');
        if (expMode === 'ritual') btnRitual.classList.add('active');
        if (expMode === 'fusion') btnFusion.classList.add('active');
        if (expMode === 'synchro') btnSynchro.classList.add('active');
        if (expMode === 'xyz') btnXyz.classList.add('active');

        const title = document.getElementById('exp-title');
        const costDisp = document.getElementById('exp-cost-display');

        if (expMode === 'normal') {
            expPanel.className = 'mode-normal'; title.textContent = "ğŸ§­ é€šå¸¸æ¢ç´¢"; title.style.color = "var(--mode-normal)";
            costDisp.textContent = "ã‚³ã‚¹ãƒˆ: " + formatScore(expNextCost) + " pts";
        } else if (expMode === 'ritual') {
            expPanel.className = 'mode-ritual'; title.textContent = "ğŸ”® å„€å¼æ¢ç´¢"; title.style.color = "var(--mode-ritual)";
            costDisp.textContent = "ã‚³ã‚¹ãƒˆ: " + formatScore(ritualNextCost) + " pts";
        } else if (expMode === 'fusion') {
            expPanel.className = 'mode-fusion'; title.textContent = "ğŸ”¥ èåˆæ¢ç´¢"; title.style.color = "var(--mode-fusion)";
            costDisp.textContent = "ã‚³ã‚¹ãƒˆ: " + formatScore(fusionNextCost) + " pts";
        } else if (expMode === 'synchro') {
            expPanel.className = 'mode-synchro'; title.textContent = "âš›ï¸ ã‚·ãƒ³ã‚¯ãƒ­æ¢ç´¢"; title.style.color = "var(--mode-synchro)";
            costDisp.textContent = "ã‚³ã‚¹ãƒˆ: " + formatScore(synchroNextCost) + " pts";
        } else if (expMode === 'xyz') {
            expPanel.className = 'mode-xyz'; title.textContent = "âœ–ï¸ ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºæ¢ç´¢"; title.style.color = "#fff";
            costDisp.textContent = "ã‚³ã‚¹ãƒˆ: " + formatScore(xyzNextCost) + " pts";
        }

        // --- 5. å½¹å¼·åŒ–ã®è¡Œï¼ˆRowï¼‰ã¨é…å½“è¡¨ã®è¡¨ç¤ºåˆ¶å¾¡ ---
        // ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ4
        const hasS4 = (reincData.upgrades.straight4 > 0);
        const rowS4 = document.getElementById('row-yaku-s4');
        if (rowS4) rowS4.style.display = hasS4 ? 'flex' : 'none';
        const payS4 = document.getElementById('row-payout-s4');
        if (payS4) payS4.style.display = hasS4 ? 'table-row' : 'none';

        // ã‚¢ãƒ©ã‚·4
        const hasA4 = (reincData.upgrades.arashi4 > 0);
        const rowA4 = document.getElementById('row-yaku-a4');
        if (rowA4) rowA4.style.display = hasA4 ? 'flex' : 'none';
        const payA4 = document.getElementById('row-payout-a4');
        if (payA4) payA4.style.display = hasA4 ? 'table-row' : 'none';

		// 5æšå½¹ã®è¡¨ç¤ºåˆ¶å¾¡
		const payS5 = document.getElementById('row-payout-s5');
		if (payS5) payS5.style.display = (reincData.upgrades.straight5 > 0) ? 'table-row' : 'none';
		const payA5 = document.getElementById('row-payout-a5');
		if (payA5) payA5.style.display = (reincData.upgrades.arashi5 > 0) ? 'table-row' : 'none';

		// è¡Œè‡ªä½“ã®è¡¨ç¤ºåˆ¶å¾¡ã‚’å€‹åˆ¥ã«è¨­å®š
		const rowS5 = document.getElementById('row-yaku-s5');
		if (rowS5) rowS5.style.display = (reincData.upgrades.straight5 > 0) ? 'flex' : 'none';
		const rowA5 = document.getElementById('row-yaku-a5');
		if (rowA5) rowA5.style.display = (reincData.upgrades.arashi5 > 0) ? 'flex' : 'none';


        // --- 6. ãƒ—ãƒ¼ãƒ«çµ±è¨ˆã¨ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºãƒ»ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚­ãƒ«ã®æ›´æ–° ---
        const counts = {}; dicePool.forEach(d => { if (d && d.rarity) counts[d.rarity] = (counts[d.rarity] || 0) + 1; });
        document.getElementById('pool-stats').innerHTML = Object.entries(RARITIES).map(([k,v])=>`<span style="color:${v.color}">${v.name}: ${counts[k]||0}</span>`).join('<br>');

        const activePanel = document.getElementById('xyz-active-panel');
        const btnShift = document.getElementById('btn-xyz-shift');
        const btnImport = document.getElementById('btn-xyz-import');

        if (hasXyzExp && (xyzUpgState.shift_unlock.lv > 0 || xyzUpgState.import_unlock.lv > 0)) {
            activePanel.style.display = 'flex';
            if (xyzUpgState.shift_unlock.lv > 0) {
                btnShift.style.display = 'block';
                document.getElementById('cost-xyz-shift').textContent = formatScore(10000 * Math.pow(2, activeUsage.shift)) + " ORU";
                const isBuff = activeTimers.shift > 0;
                const isPenalty = activeTimers.shiftPenalty > 0;
                btnShift.classList.toggle('active-buff', isBuff);
                btnShift.classList.toggle('active-penalty', isPenalty);
                const bar = document.getElementById('xyz-shift-bar');
                if (isBuff) bar.style.width = Math.max(0, (activeTimers.shift / 180000) * 100) + "%";
                else if (isPenalty) bar.style.width = Math.max(0, (activeTimers.shiftPenalty / 60000) * 100) + "%";
                else bar.style.width = "0%";
            } else { btnShift.style.display = 'none'; }

            if (xyzUpgState.import_unlock.lv > 0) {
                btnImport.style.display = 'block';
                document.getElementById('cost-xyz-import').textContent = formatScore(200000 * Math.pow(2, activeUsage.import)) + " ORU";
            } else { btnImport.style.display = 'none'; }
        } else { activePanel.style.display = 'none'; }

        // --- 7. å€ç‡è¨ˆç®—ã¸ã®åæ˜  (ãƒ‘ãƒƒã‚·ãƒ– + ã‚¢ã‚¯ãƒ†ã‚£ãƒ–) ---
        let xyzPassiveMult = 1 + (xyzUpgState.network.lv * 0.2);
        let activeBuff = 1;
        if (activeTimers.shift > 0) activeBuff = 3;
        else if (activeTimers.shiftPenalty > 0) activeBuff = 0.1;

        document.getElementById('mult-val').textContent = formatMultiplier(multiplier * reincMult * xyzPassiveMult * activeBuff);

        // --- 8. é€šå¸¸ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ã®ãƒãƒ¼ãƒ‰æ›´æ–°ã¨èª¬æ˜æ–‡åæ˜  ---
        let upgradeCount = 0;
        for(let k in upgState) {
            const u = upgState[k], n = document.getElementById('node-'+k);
            if (!n) continue;
            
            // è»¢ç”Ÿæ¡ä»¶ã®ãƒã‚§ãƒƒã‚¯
            if (u.reincReq && (reincData.upgrades[u.reincReq] || 0) <= 0) { 
                n.style.display = 'none'; continue; 
            } else { 
                n.style.display = 'flex'; 
            }

            const reqs = Array.isArray(u.req) ? u.req : (u.req ? [u.req] : []);
            const open = reqs.length === 0 || reqs.every(r => upgState[r].lv > 0);
            const canBuy = open && u.lv < u.max && score >= u.costs[u.lv];
            if (canBuy) upgradeCount++;
            
            n.className = `skill-node ${open?(u.lv>0?'unlocked':'available'):'locked'} ${u.lv>=u.max?'is-max':''} ${canBuy?'can-buy':''}`;
            document.getElementById('lv-'+k).textContent = `Lv ${u.lv}/${u.max}`;

            let tooltipHTML = `<strong>${u.name}</strong><br>${u.desc}<br>ã‚³ã‚¹ãƒˆ: ${u.lv>=u.max?'MAX':formatScore(u.costs[u.lv])} pts`;
            if (!open) {
                const reqNames = reqs.map(r => upgState[r].name).join(', ');
                tooltipHTML += `<br><span style="color:#e74c3c; font-size:0.7rem;">(å‰æ: ${reqNames})</span>`;
            }
            const tipEl = document.getElementById('tip-'+k);
            if(tipEl) tipEl.innerHTML = tooltipHTML;
        }
        
        // --- 9. è£œåŠ©UIè¦ç´ ã®è¡¨ç¤º ---
        const badge = document.getElementById('shop-badge');
        if (upgradeCount > 0) { badge.style.display = 'flex'; badge.textContent = upgradeCount; } else { badge.style.display = 'none'; }
        document.getElementById('xyz-trigger').style.display = hasXyzExp ? 'block' : 'none';
    }

    function toggleModal(s) { document.getElementById('upgrade-modal').style.display = s?'flex':'none'; if(s) { updateUI(); setTimeout(drawLines, 50); } }

    function drawLines() {
        try {
            const svg = document.getElementById('tree-svg');
            const rootEl = document.getElementById('tree-root');
            if (!svg || !rootEl) return;
            const root = rootEl.getBoundingClientRect();
            svg.innerHTML = '';
            
            const conn = [
                ['finger','auto'], ['finger','field'],
                ['finger', 'platinum_finger'],            
                ['auto','expedition'], ['auto','history'], ['auto','speed'], ['auto','yaku_none'],
                ['field','potential'],                            
                ['speed','throw'],                                
                ['expedition','digital_history'], ['expedition', 'exp_speed'], ['expedition', 'exp_amount'], ['expedition', 'ritual_unlock'],
                ['exp_speed', 'simple_fusion'],
                ['simple_fusion', 'urgent_tuning'],
                ['history','digital_history'],
                ['ritual_unlock', 'ritual_amount'], ['ritual_amount', 'fusion_exp'],
                ['fusion_exp', 'fusion_exp_amount'], ['fusion_exp', 'synchro_exp'],
                ['yaku_none','yaku_normal'], ['yaku_normal','yaku_456'],
                ['yaku_456','yaku_arashi'], ['yaku_arashi','yaku_pin'],
                ['yaku_pin', 'yaku_straight4'], ['yaku_straight4', 'yaku_arashi4'],
                ['yaku_arashi4', 'yaku_straight5'], ['yaku_straight5', 'yaku_arashi5'],['tuning', 'accel_synchro'],
                ['synchro_exp', 'xyz_exp'],['synchro_exp', 'tuning'],['xyz_exp', 'rank_revolution']
            ];
            
            conn.forEach(([p,c])=>{
                const pe = document.getElementById('node-'+p), ce = document.getElementById('node-'+c);
                if(!pe || !ce || pe.style.display === 'none' || ce.style.display === 'none') return;
                const pr = pe.getBoundingClientRect(), cr = ce.getBoundingClientRect();
                
                // åº§æ¨™ãŒå–å¾—ã§ãã¦ã„ãªã„å ´åˆã‚¹ã‚­ãƒƒãƒ—
                if (pr.width === 0 || cr.width === 0) return;

                const l = document.createElementNS("http://www.w3.org/2000/svg","line");
                l.setAttribute("x1", pr.left+pr.width/2-root.left);
                l.setAttribute("y1", pr.top+pr.height/2-root.top);
                l.setAttribute("x2", cr.left+cr.width/2-root.left);
                l.setAttribute("y2", cr.top+cr.height/2-root.top);
                l.className.baseVal = "skill-line " + (upgState[p].lv>0?'active':'');
                svg.appendChild(l);
            });
        } catch(e) {
            console.error("Lines Error", e);
        }
    }

	function toggleXyzModal(show) {
	    document.getElementById('xyz-upgrade-modal').style.display = show ? 'flex' : 'none';
	    if(show) {
	        updateXyzUI();
	        setTimeout(drawXyzLines, 50);
	    }
	}

	function buyXyzUpgrade(type) {
	    const upg = xyzUpgState[type];
	    const reqLevel = upg.reqLv || 1;
	    const unlocked = !upg.req || (xyzUpgState[upg.req].lv >= reqLevel);

	    if (!unlocked || upg.lv >= upg.max) return;

	    let cost = upg.costs ? upg.costs[upg.lv] : Math.floor(upg.baseCost * Math.pow(1.5, upg.lv));
	    
	    if (overlayUnits >= cost) {
	        overlayUnits -= cost;
	        upg.lv++;
	        playSound('record');
	        updateXyzUI();
	        updateUI();
	        drawXyzLines();
	    }
	}

	function updateXyzUI() {
	    document.getElementById('modal-oru').textContent = formatScore(overlayUnits);
	    
	    for(let k in xyzUpgState) {
	        const u = xyzUpgState[k];
	        const n = document.getElementById('xnode-'+k);
	        if(!n) continue;
	        
	        const open = !u.req || (xyzUpgState[u.req].lv >= (u.reqLv || 1));
	        const cost = u.costs ? u.costs[u.lv] : Math.floor(u.baseCost * Math.pow(1.5, u.lv));
	        const canBuy = open && u.lv < u.max && overlayUnits >= cost;
	        
	        n.className = `skill-node ${open?(u.lv>0?'unlocked':'available'):'locked'} ${u.lv>=u.max?'is-max':''} ${canBuy?'can-buy':''}`;
	        document.getElementById('xlv-'+k).textContent = `Lv ${u.lv}/${u.max}`;
	        
	        let tooltipHTML = `<strong>${u.name}</strong><br>${u.desc}<br>ã‚³ã‚¹ãƒˆ: ${u.lv>=u.max?'MAX':formatScore(cost)} ORU`;
	        document.getElementById('xtip-'+k).innerHTML = tooltipHTML;
	    }
	}

	function drawXyzLines() {
	    const svg = document.getElementById('xyz-tree-svg');
	    const rootEl = document.getElementById('xyz-tree-root');
	    if (!svg || !rootEl) return;
	    const root = rootEl.getBoundingClientRect();
	    svg.innerHTML = '';
	    
	    const conn = [
	        ['network','shift_unlock'], ['network','pack_uncommon'],
	        ['shift_unlock','import_unlock'], ['pack_uncommon','pack_rare']
	    ];
	    
	    conn.forEach(([p,c])=>{
	        const pe = document.getElementById('xnode-'+p), ce = document.getElementById('xnode-'+c);
	        if(!pe || !ce) return;
	        const pr = pe.getBoundingClientRect(), cr = ce.getBoundingClientRect();
	        const l = document.createElementNS("http://www.w3.org/2000/svg","line");
	        l.setAttribute("x1", pr.left+pr.width/2-root.left);
	        l.setAttribute("y1", pr.top+pr.height/2-root.top);
	        l.setAttribute("x2", cr.left+cr.width/2-root.left);
	        l.setAttribute("y2", cr.top+cr.height/2-root.top);
	        l.className.baseVal = "skill-line " + (xyzUpgState[p].lv>0?'active':'');
	        svg.appendChild(l);
	    });
	}

	function useXyzActive(type) {
	    let cost = 0;
	    if (type === 'shift') {
	        cost = 10000 * Math.pow(2, activeUsage.shift);
	    } else if (type === 'import') {
	        cost = 200000 * Math.pow(2, activeUsage.import);
	    }

	    if (overlayUnits < cost) return alert("ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¦ãƒ‹ãƒƒãƒˆãŒè¶³ã‚Šã¾ã›ã‚“");
	    
	    if (!confirm(`ã‚³ã‚¹ãƒˆ ${formatScore(cost)} ORU ã‚’æ¶ˆè²»ã—ã¦ç™ºå‹•ã—ã¾ã™ã‹ï¼Ÿ\n(30%ã®ç¢ºç‡ã§å¤±æ•—ã—ã¾ã™)`)) return;

	    overlayUnits -= cost;
	    activeUsage[type]++;
	    
	    const isSuccess = Math.random() > 0.3;
	    
	    if (type === 'shift') {
	        if (isSuccess) {
	            alert("ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºãƒ»ã‚·ãƒ•ãƒˆæˆåŠŸï¼\n3åˆ†é–“ã€æœ€çµ‚å€ç‡ãŒ3å€ã«ãªã‚Šã¾ã™ã€‚");
	            activeTimers.shift = 180 * 1000;
	            activeTimers.shiftPenalty = 0;
	        } else {
	            alert("ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºãƒ»ã‚·ãƒ•ãƒˆå¤±æ•—ï¼\n1åˆ†é–“ã€æœ€çµ‚å€ç‡ãŒ1/10ã«ãªã‚Šã¾ã™ã€‚");
	            activeTimers.shiftPenalty = 60 * 1000;
	            activeTimers.shift = 0;
	        }
	    } else if (type === 'import') {
	        if (isSuccess) {
	            const gain = score * 0.3;
	            alert(`ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸï¼\n${formatScore(gain)} ã‚¹ã‚³ã‚¢ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`);
	            score += gain;
	            totalScore += gain;
	        } else {
	            // â˜…ä¿®æ­£ï¼šå®Œå…¨ã«0ã«ã›ãšã€100ptsã¾ãŸã¯ç¾åœ¨ã®1%ã‚’æ®‹ã™ï¼ˆè©°ã¿é˜²æ­¢ï¼‰
	            alert("ã‚¨ã‚¯ã‚·ãƒ¼ã‚ºãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼\næ‰€æŒã‚¹ã‚³ã‚¢ã®ã»ã¨ã‚“ã©ã‚’å¤±ã„ã¾ã—ãŸã€‚");
	            score = Math.max(100, score * 0.01);
	        }
	    }
	    saveGame();
	    updateUI();
	}

    init();


    
</script>
</body>
</html>