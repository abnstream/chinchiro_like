<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280">
    <title>ãƒãƒ³ãƒãƒ­ãƒ»ã‚¤ãƒ³ãƒ•ãƒ¬</title>
    <style>
        :root {
            --bg-color: #1a472a;
            --panel-bg: rgba(0, 0, 0, 0.6);
            --text-main: #ffffff;
            --accent-gold: #f1c40f;
            --accent-red: #e74c3c;
            --btn-blue: #3498db;
            --btn-green: #2ecc71;
            --dice-bg: #ecf0f1;
            
            --rarity-common: #ffffff;
            --rarity-uncommon: #2ecc71;
            --rarity-rare: #00d2ff;
            --rarity-sr: #ffd700;
            --rarity-legendary: #9b59b6;

            --stat-ticket-bg: rgba(241, 196, 15, 0.2);
            --stat-ticket-border: var(--accent-gold);
            --stat-luck-bg: rgba(155, 89, 182, 0.2);
            --stat-luck-border: #9b59b6;
            --stat-luck-text: #d2b4de;
            --stat-rate-bg: rgba(231, 76, 60, 0.2);
            --stat-rate-border: #e74c3c;
            --stat-rate-text: #ec7063;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        .game-wrapper {
            display: grid;
            grid-template-columns: 360px 1fr 320px;
            grid-template-rows: auto 1fr;
            gap: 20px;
            width: 95%;
            max-width: 1400px;
            height: 90vh;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ */
        .header-area {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent-gold);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        h1 { margin: 0; color: var(--accent-gold); font-size: 2rem; }
        .stage-info { font-size: 1.5rem; font-weight: bold; }
        
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .btn-toggle-format {
            background: rgba(255,255,255,0.2);
            font-size: 0.9rem; padding: 5px 15px;
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
        }
        .btn-toggle-format:hover { background: rgba(255,255,255,0.3); }

        /* å·¦ã‚µã‚¤ãƒ‰ï¼šãƒ«ãƒ¼ãƒ«è¡¨ */
        .left-panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }
        .rule-card h3 {
            margin-top: 0;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 5px;
            color: var(--accent-gold);
            font-size: 1.1rem;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 8px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(0,0,0,0.3); }
        
        .prob-col { font-family: monospace; color: #fff; font-weight: bold; }
        .prob-high { color: var(--btn-green); }
        .prob-low { color: var(--accent-red); }
        
        .val-up { color: #2ecc71; font-weight: bold; animation: pulse 1s infinite; }
        .val-gain { color: #2ecc71; font-weight: bold; animation: pop 0.3s ease-out; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* ä¸­å¤®ï¼šãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ« */
        .main-panel {
            position: relative;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            overflow: hidden;
        }

        /* ã‚²ãƒ¼ãƒ ãƒ“ãƒ¥ãƒ¼ */
        .game-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
        }
        .game-view.hidden { display: none; }

        .pool-container {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(0,0,0,0.4);
            padding: 15px 40px;
            border-radius: 50px;
            border: 2px solid rgba(255,255,255,0.1);
            max-width: 90%;
            word-break: break-all; 
        }
        .pool-label { font-size: 0.9rem; opacity: 0.8; }
        .pool-value { font-size: 2.2rem; font-weight: bold; color: var(--accent-gold); line-height: 1.2; }

        .dice-area {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            height: 120px;
        }
        .die {
            width: 100px;
            height: 100px;
            background: var(--dice-bg);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: #333;
            box-shadow: 0 8px 0 #bdc3c7;
            font-weight: bold;
            position: relative;
        }
        .die[data-value="1"] { color: #c0392b; }

        /* ãƒ­ã‚°ã‚¨ãƒªã‚¢ */
        .message-area {
            min-height: 90px;
            height: auto;
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 90%;
        }
        .main-msg { font-size: 2rem; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); line-height: 1.2; word-break: break-all; }
        .sub-msg { font-size: 1.1rem; opacity: 0.9; margin-bottom: 5px; word-break: break-all; }
        
        .effect-log { 
            font-size: 0.85rem; 
            margin-top: 5px;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
        }
        .log-tag {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 3px 10px;
            border-radius: 15px;
            color: #fff;
            animation: fadeIn 0.3s ease-out;
            white-space: nowrap;
        }
        .log-luck { border-color: #9b59b6; color: #d2b4de; background: rgba(155, 89, 182, 0.2); }
        .log-ticket { border-color: #2ecc71; color: #a3e4d7; background: rgba(46, 204, 113, 0.2); }
        .log-buff { border-color: #f39c12; color: #f9e79f; background: rgba(243, 156, 18, 0.2); }
        .log-rate { border-color: #e74c3c; color: #ec7063; background: rgba(231, 76, 60, 0.2); }
        .log-bad  { border-color: #7f8c8d; color: #95a5a6; background: rgba(0,0,0,0.5); }
        .log-hifumi { border-color: #e74c3c; color: #e74c3c; background: rgba(231, 76, 60, 0.1); font-weight: bold; }
        .log-arashi { border-color: #3498db; color: #3498db; background: rgba(52, 152, 219, 0.1); font-weight: bold; }
        .log-shigoro { border-color: #e67e22; color: #e67e22; background: rgba(230, 126, 34, 0.1); font-weight: bold; }
        .log-pinzoro { border-color: #f1c40f; color: #f1c40f; background: rgba(241, 196, 15, 0.15); font-weight: bold; box-shadow: 0 0 5px rgba(241, 196, 15, 0.3); }

        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            min-height: 70px;
        }

        button {
            border: none;
            border-radius: 50px;
            cursor: pointer;
            color: #fff;
            font-weight: bold;
            transition: transform 0.1s, box-shadow 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.1;
        }
        button:active { transform: translateY(4px); box-shadow: none !important; }
        button:disabled { background: #7f8c8d !important; color: #bdc3c7 !important; box-shadow: none !important; cursor: not-allowed; }

        .btn-roll {
            background: var(--accent-gold);
            color: #333;
            padding: 15px 50px;
            font-size: 1.5rem;
            box-shadow: 0 6px 0 #d35400;
            min-width: 180px;
        }
        .btn-roll:active { box-shadow: 0 2px 0 #d35400 !important; }

        .btn-shop {
            background: var(--btn-blue);
            padding: 15px 30px;
            font-size: 1.1rem;
            box-shadow: 0 6px 0 #2980b9;
        }
        .btn-shop:active { box-shadow: 0 2px 0 #2980b9 !important; }

        .btn-clear {
            background: var(--btn-green);
            padding: 10px 30px;
            font-size: 1rem;
            box-shadow: 0 6px 0 #27ae60;
            display: none;
        }
        .btn-clear:active { box-shadow: 0 2px 0 #27ae60 !important; }
        .btn-clear.visible { display: flex; animation: bounceIn 0.5s; }
        .clear-sub { font-size: 0.8rem; opacity: 0.9; }

        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        .hidden-el { display: none !important; }

        /* ã‚·ãƒ§ãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ */
        .shop-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            display: none;
        }
        .shop-view.active { display: flex; }

        .shop-header {
            font-size: 2rem;
            color: var(--accent-gold);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--accent-gold);
            width: 100%;
            text-align: center;
        }

        .shop-shelves {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            margin-bottom: 20px;
            flex-grow: 1;
        }

        .shop-item {
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            text-align: center;
            transition: transform 0.2s;
            position: relative;
        }
        .shop-item:hover { transform: translateY(-2px); background: rgba(255,255,255,0.1); }
        .shop-item.sold-out { opacity: 0.5; pointer-events: none; background: rgba(0,0,0,0.5); }

        .rarity-common { border-color: var(--rarity-common); } .rarity-common .item-name { color: var(--rarity-common); }
        .rarity-uncommon { border-color: var(--rarity-uncommon); } .rarity-uncommon .item-name { color: var(--rarity-uncommon); }
        .rarity-rare { border-color: var(--rarity-rare); } .rarity-rare .item-name { color: var(--rarity-rare); }
        .rarity-sr { border-color: var(--rarity-sr); } .rarity-sr .item-name { color: var(--rarity-sr); }
        .rarity-legendary { border-color: var(--rarity-legendary); } .rarity-legendary .item-name { color: var(--rarity-legendary); }

        .item-name { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; }
        .item-desc { font-size: 0.8rem; height: 3.6em; display: flex; align-items: center; justify-content: center; line-height: 1.3; }
        .item-price { margin-top: 10px; font-weight: bold; color: #fff; }

        .btn-buy {
            background: #fff;
            color: #333;
            border: none;
            padding: 5px 20px;
            border-radius: 20px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: none;
        }
        .btn-buy:hover { background: #ddd; }

        .shop-controls {
            display: flex;
            gap: 20px;
            margin-top: auto;
        }
        .btn-reroll {
            background: var(--accent-red);
            padding: 10px 30px;
            font-size: 1rem;
            box-shadow: 0 4px 0 #c0392b;
        }
        .btn-back {
            background: #95a5a6;
            color: #333;
            padding: 10px 30px;
            font-size: 1rem;
            box-shadow: 0 4px 0 #7f8c8d;
        }

        /* ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ */
        .prestige-view {
            width: 100%; height: 100%;
            display: none;
            flex-direction: column; align-items: center; padding: 20px;
            box-sizing: border-box;
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.9), rgba(0, 0, 0, 0.9));
        }
        .prestige-view.active { display: flex; }
        
        .prestige-header {
            font-size: 2.5rem; color: var(--accent-gold); margin-bottom: 10px;
            text-shadow: 0 0 10px var(--accent-gold);
        }
        .prestige-sub { font-size: 1rem; margin-bottom: 30px; color: #bdc3c7; }

        .prestige-container {
            display: flex; gap: 20px; width: 100%; justify-content: center;
            flex-wrap: wrap; margin-bottom: 30px;
        }
        .prestige-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--accent-gold);
            border-radius: 15px; padding: 20px;
            width: 200px; text-align: center; cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            display: flex; flex-direction: column; justify-content: center; height: 200px;
        }
        .prestige-card:hover { transform: scale(1.05); background: rgba(241, 196, 15, 0.15); }
        .p-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        .p-desc { font-size: 1rem; line-height: 1.4; font-weight: bold; }

        /* å³ã‚µã‚¤ãƒ‰ */
        .right-panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow: hidden; 
            min-height: 0;
        }
        .score-box {
            text-align: center;
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            word-break: break-all;
            overflow-wrap: anywhere;
        }
        .score-label { display: block; font-size: 0.8rem; opacity: 0.8; margin-bottom: 3px; }
        .score-num { font-size: 1.6rem; font-weight: bold; line-height: 1.1; }
        .target-num { color: #f39c12; }
        
        .stat-row { display: flex; gap: 10px; }
        .stat-item { flex: 1; min-width: 0; } /* min-width:0 ã§Flexå†…ç¸®å°ã‚’è¨±å¯ */
        .stat-item .score-num { font-size: 1.1rem; } /* ã‚¤ãƒ³ãƒ•ãƒ¬å¯¾å¿œã§ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºç¸®å° */

        .ticket-box { background: var(--stat-ticket-bg); border: 1px solid var(--stat-ticket-border); color: var(--stat-ticket-border); }
        .luck-box { background: var(--stat-luck-bg); border: 1px solid var(--stat-luck-border); color: var(--stat-luck-text); }
        .rate-box { background: var(--stat-rate-bg); border: 1px solid var(--stat-rate-border); color: var(--stat-rate-text); }

        .round-info { text-align: center; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; }

        .inventory-section {
            flex-grow: 1;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto; 
            min-height: 0;
        }
        .inventory-header {
            font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between;
        }
        .inventory-list { display: flex; flex-direction: column; gap: 8px; }
        .inv-item {
            padding: 8px; border-radius: 5px; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; cursor: help;
            border-left: 4px solid;
            background: rgba(255,255,255,0.1);
        }
        /* å£²å´ãƒœã‚¿ãƒ³ */
        .btn-inv-sell {
            background: #c0392b;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.8rem;
            cursor: pointer;
            box-shadow: 0 2px 0 #96281b;
            font-weight: bold;
        }
        .btn-inv-sell:active { transform: translateY(2px); box-shadow: none; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes shock {
            0% { transform: scale(1); background-color: rgba(231, 76, 60, 0); }
            10% { transform: scale(1.1); background-color: rgba(231, 76, 60, 0.5); }
            100% { transform: scale(1); background-color: rgba(231, 76, 60, 0); }
        }
        .shock-effect { animation: shock 0.6s ease-out; }
        .hifumi-text { color: var(--accent-red); font-size: 3rem; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center;
            visibility: hidden; opacity: 0; transition: 0.3s; z-index: 999;
        }
        .modal-overlay.show { visibility: visible; opacity: 1; }
        .modal-box {
            background: #fff; color: #333; padding: 40px;
            border-radius: 20px; text-align: center; width: 600px;
            max-width: 90vw;
            word-break: keep-all;
        }
        .modal-btn {
            background: #27ae60; color: #fff; border: none;
            padding: 15px 40px; font-size: 1.2rem; border-radius: 10px;
            cursor: pointer; margin-top: 20px;
            box-shadow: 0 4px 0 #219150;
        }
    </style>
</head>
<body>

<div class="game-wrapper">
    <div class="header-area">
        <h1>ğŸ² ãƒãƒ³ãƒãƒ­ãƒ»ã‚¤ãƒ³ãƒ•ãƒ¬</h1>
        <div class="header-controls">
            <div class="stage-info">STAGE <span id="ui-stage">1</span></div>
            <button class="btn-toggle-format" onclick="window.game.toggleNotation()">è¡¨è¨˜åˆ‡æ›¿</button>
        </div>
    </div>

    <div class="left-panel">
        <div class="rule-card">
            <h3>ğŸ§® å‡ºç›®ç‚¹ / ç¢ºç‡</h3>
            <table id="table-faces">
                </table>
        </div>
        <div class="rule-card">
            <h3>ğŸ† å½¹å€ç‡ (ä¹—ç®—)</h3>
            <table id="table-yaku">
                </table>
        </div>
    </div>

    <div class="main-panel" id="main-panel">
        
        <div class="game-view" id="game-view">
            <div class="pool-container" id="pool-box">
                <div class="pool-label">ROUND POOL</div>
                <div>
                    <span class="pool-value" id="ui-pool">0</span>
                    <span style="font-size:1.5rem">pt</span>
                </div>
            </div>

            <div class="dice-area" id="dice-container">
                <div class="die">?</div>
                <div class="die">?</div>
                <div class="die">?</div>
            </div>

            <div class="message-area">
                <div class="main-msg" id="msg-main">GAME START</div>
                <div class="sub-msg" id="msg-sub">ROLLãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é–‹å§‹</div>
                <div class="effect-log" id="msg-log"></div>
            </div>

            <div class="action-buttons">
                <button class="btn-roll" id="btn-roll" onclick="window.game.roll()">ROLL</button>
                <button class="btn-clear" id="btn-clear" onclick="window.game.stageWin()">
                    STAGE CLEAR
                    <span class="clear-sub" id="clear-sub">(+2 ğŸ«)</span>
                </button>
                <button class="btn-shop" id="btn-shop" onclick="window.game.openShop()">SHOP</button>
            </div>
        </div>

        <div class="shop-view" id="shop-view">
            <div class="shop-header">ITEM SHOP</div>
            <div class="shop-shelves" id="shop-shelves">
                </div>
            <div class="shop-controls">
                <button class="btn-reroll" id="btn-reroll" onclick="window.game.rerollShop()">å†å…¥è· (Cost: 1)</button>
                <button class="btn-back" onclick="window.game.closeShop()">æˆ»ã‚‹</button>
            </div>
        </div>

        <div class="prestige-view" id="prestige-view">
            <div class="prestige-header">âœ¨ PRESTIGE âœ¨</div>
            <div class="prestige-sub">æ¬¡ã‚¹ãƒ†ãƒ¼ã‚¸ã¸ã®æ°¸ç¶šå¼·åŒ–ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            <div class="prestige-container" id="prestige-container">
            </div>
            <button class="btn-reroll" id="btn-prestige-reroll" onclick="window.game.rerollPrestige()">é¸æŠè‚¢å¤‰æ›´ (Cost: 1)</button>
        </div>

    </div>

    <div class="right-panel">
        <div class="score-section">
            <div class="score-box">
                <span class="score-label">TARGET SCORE</span>
                <div class="score-num target-num" id="ui-target">1,500</div>
            </div>
            <div class="score-box">
                <span class="score-label">TOTAL SCORE</span>
                <div class="score-num" id="ui-total">0</div>
            </div>
            
            <div class="stat-row">
                <div class="score-box ticket-box stat-item">
                    <span class="score-label">TICKETS</span>
                    <div class="score-num" id="ui-tickets">4</div>
                </div>
                <div class="score-box luck-box stat-item">
                    <span class="score-label">LUCK</span>
                    <div class="score-num" id="ui-luck">100</div>
                </div>
                <div class="score-box rate-box stat-item">
                    <span class="score-label">RATE</span>
                    <div class="score-num" id="ui-rate">x1.0</div>
                </div>
            </div>
        </div>

        <div class="round-info">
            <div>ROUND: <span id="ui-round">1</span> / 3</div>
            <div>ROLL: <span id="ui-roll">7</span> / 7</div>
        </div>

        <div class="inventory-section">
            <div class="inventory-header">
                <span>INVENTORY</span>
                <span id="ui-inv-count">0/7</span>
            </div>
            <div class="inventory-list" id="ui-inventory">
                <div style="opacity:0.5; text-align:center; padding:10px;">Empty</div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal">
    <div class="modal-box">
        <h2 id="modal-title">TITLE</h2>
        <p id="modal-msg">Message</p>
        <button class="modal-btn" onclick="window.game.nextPhase()">NEXT</button>
    </div>
</div>

<script>
// --- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ---
window.onerror = function(msg, url, line, col, error) {
    alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + msg + "\nè¡Œ: " + line + ":" + col);
    return false;
};

// --- æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ---
const JP_UNITS = ['', 'ä¸‡', 'å„„', 'å…†', 'äº¬', 'å“', 'ğ¥±', 'ç©£', 'æº', 'æ¾—', 'æ­£', 'è¼‰', 'æ¥µ', 'æ’æ²³æ²™', 'é˜¿åƒ§ç¥‡', 'é‚£ç”±å¤š', 'ä¸å¯æ€è­°', 'ç„¡é‡å¤§æ•°'];
const MURYO_LIMIT = 10n ** 68n; 
const INITIAL_ROLL_COUNT = 7;

// --- å®šæ•°å®šç¾© ---

const RARITY = {
    COMMON:    { id: 'common',    name: 'ã‚³ãƒ¢ãƒ³',       color: 'var(--rarity-common)',    price: 1,  weight: 60 },
    UNCOMMON:  { id: 'uncommon',  name: 'ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³',     color: 'var(--rarity-uncommon)',  price: 2,  weight: 30 },
    RARE:      { id: 'rare',      name: 'ãƒ¬ã‚¢',        color: 'var(--rarity-rare)',      price: 4,  weight: 7 },
    SR:        { id: 'sr',        name: 'ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¬ã‚¢',   color: 'var(--rarity-sr)',        price: 8,  weight: 2.5 },
    LEGENDARY: { id: 'legendary', name: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼', color: 'var(--rarity-legendary)', price: 16, weight: 0.5 }
};

const CONST_BASE_MULTIPLIERS = {
    'pinzoro': 500n, 'arashi': 100n, '456': 20n, 'meari': 5n, 'menashi': 1n, 'hifumi': 0n
};

const ITEM_DATA = [];

// é‡‘ã®ã€‡ã€‡
const GOLD_PROBS = [0.50, 0.45, 0.40, 0.35, 0.30, 0.25];
['å£±','å¼','å‚','è‚†','ä¼','é™¸'].forEach((kanji, idx) => {
    const face = idx + 1;
    const prob = GOLD_PROBS[idx];
    ITEM_DATA.push({
        id: `gold_${face}`,
        name: `é‡‘ã®${kanji}`,
        rarity: 'common',
        desc: `${kanji}ã®ç›®ãŒå‡ºãŸæ™‚ã€${Math.floor(prob*100)}%ã®ç¢ºç‡ã§ã€${kanji}ã®å‡ºç›®ç‚¹ãŒç¾åœ¨ã®2å€ã«ãªã‚‹`,
        price: RARITY.COMMON.price,
        effectType: 'gold_mul',
        targetFace: face,
        prob: prob
    });
});

// è¦šé†’ã®ã€‡ã€‡
const AWAKENING_PROBS = [0.20, 0.17, 0.14, 0.11, 0.08, 0.05];
['å£±','å¼','å‚','è‚†','ä¼','é™¸'].forEach((kanji, idx) => {
    const face = idx + 1;
    const prob = AWAKENING_PROBS[idx];
    ITEM_DATA.push({
        id: `awakening_${face}`,
        name: `è¦šé†’ã®${kanji}`,
        rarity: 'uncommon',
        desc: `${kanji}ã®ç›®ãŒå‡ºãŸæ™‚ã€${Math.floor(prob*100)}%ã®ç¢ºç‡ã§ã€æˆç«‹ã—ãŸå½¹ã®å€ç‡ãŒç¾åœ¨ã®2å€ã«ãªã‚‹`,
        price: RARITY.UNCOMMON.price,
        effectType: 'awakening_mul',
        targetFace: face,
        prob: prob
    });
});

// å¹¸ç¦ã®ã€‡ã€‡
const HAPPY_PROBS = [0.50, 0.46, 0.42, 0.38, 0.34, 0.30];
['å£±','å¼','å‚','è‚†','ä¼','é™¸'].forEach((kanji, idx) => {
    const face = idx + 1;
    const prob = HAPPY_PROBS[idx];
    ITEM_DATA.push({
        id: `happy_${face}`,
        name: `å¹¸ç¦ã®${kanji}`,
        rarity: 'uncommon',
        desc: `${kanji}ã®ç›®ãŒå‡ºãŸæ™‚ã€${Math.floor(prob*100)}%ã®ç¢ºç‡ã§ãƒã‚±ãƒƒãƒˆã‚’1æšç²å¾—ã™ã‚‹`,
        price: RARITY.UNCOMMON.price,
        effectType: 'happy',
        targetFace: face,
        prob: prob
    });
});

// LUCKç³»
ITEM_DATA.push({ id: 'luck_1', name: 'æ˜Ÿã®æ¬ ç‰‡', rarity: 'common', desc: 'å¹¸é‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ50ä¸Šæ˜‡ã™ã‚‹', price: 1, effectType: 'luck_static', value: 50 });
ITEM_DATA.push({ id: 'luck_2', name: 'æœˆå…‰ã®æŒ‡è¼ª', rarity: 'uncommon', desc: 'å¹¸é‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ125ä¸Šæ˜‡ã™ã‚‹', price: 2, effectType: 'luck_static', value: 125 }); 
ITEM_DATA.push({ id: 'luck_3', name: 'å¤ªé™½ã®ã‚¿ãƒªã‚¹ãƒãƒ³', rarity: 'rare', desc: 'å¹¸é‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ300ä¸Šæ˜‡ã™ã‚‹', price: 4, effectType: 'luck_static', value: 300 }); 
ITEM_DATA.push({ id: 'luck_4', name: 'é‹å‘½ã®æ­¯è»Š', rarity: 'sr', desc: 'å¹¸é‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ750ä¸Šæ˜‡ã™ã‚‹', price: 8, effectType: 'luck_static', value: 750 }); 
ITEM_DATA.push({ id: 'luck_5', name: 'å¥‡è·¡ã®è–æ¯', rarity: 'legendary', desc: 'å¹¸é‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ2000ä¸Šæ˜‡ã™ã‚‹', price: 16, effectType: 'luck_static', value: 2000 }); 

ITEM_DATA.push({ id: 'luck_cond_menashi', name: 'æ³¥æ²¼ã‹ã‚‰ã®å…‰', rarity: 'common', desc: 'ç›®ãªã—ãŒ2å›é€£ç¶šã§ç™ºç”Ÿã—ãŸæ™‚ã€æ¬¡ã®ãƒ­ãƒ¼ãƒ«ã§å¹¸é‹ãŒä¸€æ™‚çš„ã«+300ã•ã‚Œã‚‹', price: 1, effectType: 'luck_cond_menashi', value: 300 }); 
ITEM_DATA.push({ id: 'luck_chance_50', name: 'ã‚³ã‚¤ãƒ³ã®è¡¨è£', rarity: 'common', desc: 'ãƒ­ãƒ¼ãƒ«é–‹å§‹æ™‚ã€50%ã®ç¢ºç‡ã§ãã®ãƒ­ãƒ¼ãƒ«ä¸­ã®å¹¸é‹ãŒ+250ã•ã‚Œã‚‹', price: 1, effectType: 'luck_chance', prob: 0.5, value: 250 }); 
ITEM_DATA.push({ id: 'luck_chance_25', name: 'å››åˆ†ã®ä¸€ã®è³­ã‘', rarity: 'common', desc: 'ãƒ­ãƒ¼ãƒ«é–‹å§‹æ™‚ã€25%ã®ç¢ºç‡ã§ãã®ãƒ­ãƒ¼ãƒ«ä¸­ã®å¹¸é‹ãŒ+500ã•ã‚Œã‚‹', price: 1, effectType: 'luck_chance', prob: 0.25, value: 500 }); 

ITEM_DATA.push({ id: 'inv_expand', name: 'é­”æ³•ã®é„', rarity: 'uncommon', desc: 'ã‚¢ã‚¤ãƒ†ãƒ ã®æœ€å¤§æ‰€æŒæ•°ãŒ2ã¤å¢—åŠ ã™ã‚‹', price: 2, effectType: 'inv_expand', value: 2 });
ITEM_DATA.push({ id: 'buff_streak_win', name: 'æ˜‡ã‚Šé¾ã®åƒ', rarity: 'uncommon', desc: 'ã€Œç›®ã‚ã‚Šã€ä»¥ä¸Šã®å½¹ãŒ3é€£ç¶šã§ç¶šã„ãŸæ™‚ã€å…¨ã¦ã®å½¹ã®å€ç‡ãŒç¾åœ¨ã®2å€ã«ãªã‚‹', price: 2, effectType: 'buff_streak_win' });

// ç‰¹æ®ŠåŠ¹æœ
ITEM_DATA.push({ id: 'rate_ticket', name: 'ãƒã‚±ãƒƒãƒˆãƒ»ã‚¿ãƒƒã‚¯ã‚¹', rarity: 'uncommon', desc: 'æ‰€æŒã—ã¦ã„ã‚‹ãƒã‚±ãƒƒãƒˆ10æšã”ã¨ã«ã€ã‚¹ã‚³ã‚¢è¨ˆç®—æ™‚ã®å…¨ä½“å€ç‡ãŒ+1.0åŠ ç®—ã•ã‚Œã‚‹', price: 2, effectType: 'rate_ticket', value: 1.0 });
ITEM_DATA.push({ id: 'ticket_interest', name: 'åˆ©å­', rarity: 'uncommon', desc: 'ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢æ™‚ã€æ‰€æŒãƒã‚±ãƒƒãƒˆ5æšã«ã¤ã+1æšã®ãƒã‚±ãƒƒãƒˆã‚’è¿½åŠ ã§ç²å¾—ã™ã‚‹', price: 2, effectType: 'ticket_interest', value: 1 });
ITEM_DATA.push({ id: 'rate_streak', name: 'ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹', rarity: 'common', desc: 'ã€Œç›®ã‚ã‚Šã€ä»¥ä¸Šã®å½¹ãŒç¶šãé™ã‚Šã€é€£å‹æ•°ã«å¿œã˜ã¦å…¨ä½“å€ç‡ãŒ+0.2ãšã¤åŠ ç®—ã•ã‚Œã‚‹ï¼ˆç›®ãªã—ãƒ»ãƒ’ãƒ•ãƒŸã§ãƒªã‚»ãƒƒãƒˆï¼‰', price: 1, effectType: 'rate_streak', value: 0.2 });
ITEM_DATA.push({ id: 'roll_add', name: 'ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«', rarity: 'common', desc: 'ãƒ­ãƒ¼ãƒ«ã‚’è¡Œã£ãŸéš›ã€15%ã®ç¢ºç‡ã§ãƒ­ãƒ¼ãƒ«å›æ•°ãŒ1å›åˆ†å›å¾©ã™ã‚‹', price: 1, effectType: 'roll_add', prob: 0.15 });
ITEM_DATA.push({ id: 'prob_boost', name: 'å¹¸é‹ã®ã‚¯ãƒ­ãƒ¼ãƒãƒ¼', rarity: 'common', desc: 'ç¢ºç‡ã§ç™ºå‹•ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã®åˆ¤å®šæˆåŠŸç‡ãŒ2å€ã«ãªã‚‹', price: 1, effectType: 'prob_boost' });

// æ¥µæ„ãƒ»å‘ªç¸›
ITEM_DATA.push({ id: 'score_odd_2x', name: 'å¥‡æ•°ã®æ¥µæ„', rarity: 'common', desc: '3ã¤ã®ãƒ€ã‚¤ã‚¹ã®åˆè¨ˆãŒå¥‡æ•°ã®å ´åˆã€ãã®ãƒ­ãƒ¼ãƒ«ã®å…¨ä½“å€ç‡ãŒ2å€ã«ãªã‚‹', price: 1, effectType: 'score_sum_odd', value: 2 });
ITEM_DATA.push({ id: 'score_even_2x', name: 'å¶æ•°ã®æ¥µæ„', rarity: 'common', desc: '3ã¤ã®ãƒ€ã‚¤ã‚¹ã®åˆè¨ˆãŒå¶æ•°ã®å ´åˆã€ãã®ãƒ­ãƒ¼ãƒ«ã®å…¨ä½“å€ç‡ãŒ2å€ã«ãªã‚‹', price: 1, effectType: 'score_sum_even', value: 2 });
ITEM_DATA.push({ id: 'score_odd_focus', name: 'å¥‡æ•°ã®å‘ªç¸›', rarity: 'uncommon', desc: '3ã¤ã®ãƒ€ã‚¤ã‚¹ã®åˆè¨ˆãŒå¥‡æ•°ãªã‚‰å…¨ä½“å€ç‡4å€ã€å¶æ•°ãªã‚‰0.5å€ã«ãªã‚‹', price: 2, effectType: 'score_sum_focus_odd' });
ITEM_DATA.push({ id: 'score_even_focus', name: 'å¶æ•°ã®å‘ªç¸›', rarity: 'uncommon', desc: '3ã¤ã®ãƒ€ã‚¤ã‚¹ã®åˆè¨ˆãŒå¶æ•°ãªã‚‰å…¨ä½“å€ç‡4å€ã€å¥‡æ•°ãªã‚‰0.5å€ã«ãªã‚‹', price: 2, effectType: 'score_sum_focus_even' });

// ãƒ’ãƒ•ãƒŸç³»
ITEM_DATA.push({ id: 'hifumi_act_roll', name: 'é€†å¢ƒã®ç³§', rarity: 'uncommon', desc: 'å½¹ã€Œãƒ’ãƒ•ãƒŸã€ãŒæˆç«‹ã—ãŸæ™‚ã€ãƒ­ãƒ¼ãƒ«å›æ•°ãŒ3å›åˆ†å›å¾©ã™ã‚‹ï¼ˆ1ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã¤ã3å›ã¾ã§ç™ºå‹•ï¼‰', price: 2, effectType: 'hifumi_act_roll' });
ITEM_DATA.push({ id: 'hifumi_act_pin', name: 'èµ·æ­»å›ç”Ÿ', rarity: 'uncommon', desc: 'å½¹ã€Œãƒ’ãƒ•ãƒŸã€ãŒæˆç«‹ã—ãŸæ™‚ã€æ¬¡å›ã®ãƒ­ãƒ¼ãƒ«çµæœãŒç¢ºå®šã§ã€Œãƒ”ãƒ³ã‚¾ãƒ­ã€ã«ãªã‚‹', price: 2, effectType: 'hifumi_act_pin' });
ITEM_DATA.push({ id: 'hifumi_guard', name: 'èº«ä»£ã‚ã‚Šã®äººå½¢', rarity: 'uncommon', desc: 'å½¹ã€Œãƒ’ãƒ•ãƒŸã€ãŒæˆç«‹ã—ãŸéš›ã«ç™ºç”Ÿã™ã‚‹ã€ãƒ—ãƒ¼ãƒ«ã‚¹ã‚³ã‚¢æ²¡åã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹', price: 2, effectType: 'hifumi_guard' });
ITEM_DATA.push({ id: 'hifumi_buff_rate', name: 'ç‹‚æˆ¦å£«ã®é­‚', rarity: 'rare', desc: 'å½¹ã€Œãƒ’ãƒ•ãƒŸã€ãŒæˆç«‹ã—ãŸæ™‚ã€ãã®ãƒ©ã‚¦ãƒ³ãƒ‰ãŒçµ‚äº†ã™ã‚‹ã¾ã§å…¨ä½“å€ç‡ã‚’2å€ã«ã™ã‚‹', price: 4, effectType: 'hifumi_mul_rate' });
ITEM_DATA.push({ id: 'hifumi_buff_face', name: 'æ··æ²Œã®åŠ›', rarity: 'rare', desc: 'å½¹ã€Œãƒ’ãƒ•ãƒŸã€ãŒæˆç«‹ã—ãŸæ™‚ã€å…¨ã¦ã®ã‚µã‚¤ã‚³ãƒ­ã®å‡ºç›®ç‚¹ãŒæ°¸ç¶šçš„ã«4å€ã«ãªã‚‹', price: 4, effectType: 'hifumi_buff_face' });
ITEM_DATA.push({ id: 'hifumi_gain_ticket', name: 'ä¿é™ºé‡‘', rarity: 'rare', desc: 'å½¹ã€Œãƒ’ãƒ•ãƒŸã€ãŒæˆç«‹ã—ãŸæ™‚ã€æ‰€æŒãƒã‚±ãƒƒãƒˆ5æšã«ã¤ã1æšã®ãƒã‚±ãƒƒãƒˆã‚’ç²å¾—ã™ã‚‹', price: 4, effectType: 'hifumi_ticket_pct' });
ITEM_DATA.push({ id: 'start_fixed_hifumi', name: 'ç ´æ»…ã®å¥‘ç´„æ›¸', rarity: 'sr', desc: 'å¹¸é‹ã§ã®åˆ¤å®šæ™‚ã€ãƒ’ãƒ•ãƒŸãŒå‡ºã¦ã„ãŸã‚‰ä»–ã®å½¹ã‚ˆã‚Šå„ªå…ˆã—ã¦ãƒ’ãƒ•ãƒŸã‚’é¸æŠã™ã‚‹ï¼ˆ1ãƒ©ã‚¦ãƒ³ãƒ‰3å›ã¾ã§ï¼‰', price: 8, effectType: 'hifumi_priority' });

// ã‚¢ãƒ©ã‚·ç³»
ITEM_DATA.push({ id: 'arashi_act_roll', name: 'ç–¾é¢¨ã®ãƒ–ãƒ¼ãƒ„', rarity: 'uncommon', desc: 'å½¹ã€Œã‚¢ãƒ©ã‚·ã€ãŒæˆç«‹ã—ãŸæ™‚ã€ãƒ­ãƒ¼ãƒ«å›æ•°ãŒ1å›åˆ†å›å¾©ã™ã‚‹ï¼ˆ1ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã¤ã5å›ã¾ã§ç™ºå‹•ï¼‰', price: 2, effectType: 'arashi_act_roll' });
ITEM_DATA.push({ id: 'arashi_luck_next', name: 'é›·é³´ã®æŒ‡è¼ª', rarity: 'uncommon', desc: 'å½¹ã€Œã‚¢ãƒ©ã‚·ã€ãŒæˆç«‹ã—ãŸæ™‚ã€æ¬¡ã®ãƒ­ãƒ¼ãƒ«ã®å¹¸é‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ+200ã•ã‚Œã‚‹', price: 2, effectType: 'arashi_luck_next' });
ITEM_DATA.push({ id: 'arashi_mul_rate', name: 'æš´é¢¨ã®ç‹å† ', rarity: 'rare', desc: 'å½¹ã€Œã‚¢ãƒ©ã‚·ã€ãŒæˆç«‹ã—ãŸæ™‚ã€ãã®ãƒ©ã‚¦ãƒ³ãƒ‰ãŒçµ‚äº†ã™ã‚‹ã¾ã§å…¨ä½“å€ç‡ã‚’1.5å€ã«ã™ã‚‹', price: 4, effectType: 'arashi_mul_rate' });
ITEM_DATA.push({ id: 'arashi_buff_face', name: 'å¤©åœ°é³´å‹•', rarity: 'rare', desc: 'å½¹ã€Œã‚¢ãƒ©ã‚·ã€ãŒæˆç«‹ã—ãŸæ™‚ã€å…¨ã¦ã®ã‚µã‚¤ã‚³ãƒ­ã®å‡ºç›®ç‚¹ãŒæ°¸ç¶šçš„ã«1.5å€ã«ãªã‚‹', price: 4, effectType: 'arashi_buff_face' });
ITEM_DATA.push({ id: 'arashi_gain_ticket', name: 'æµ·è³Šã®å®ç®±', rarity: 'rare', desc: 'å½¹ã€Œã‚¢ãƒ©ã‚·ã€ãŒæˆç«‹ã—ãŸæ™‚ã€ãƒã‚±ãƒƒãƒˆã‚’20æšç²å¾—ã™ã‚‹', price: 4, effectType: 'arashi_gain_ticket' });

// ã‚·ã‚´ãƒ­ç³»
ITEM_DATA.push({ id: 'shigoro_act_roll', name: 'ç–¾èµ°ã®ç¿¼', rarity: 'uncommon', desc: 'å½¹ã€Œã‚·ã‚´ãƒ­ã€ãŒæˆç«‹ã—ãŸæ™‚ã€ãƒ­ãƒ¼ãƒ«å›æ•°ãŒ1å›åˆ†å›å¾©ã™ã‚‹ï¼ˆ1ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã¤ã4å›ã¾ã§ç™ºå‹•ï¼‰', price: 2, effectType: 'shigoro_act_roll' });
ITEM_DATA.push({ id: 'shigoro_luck_next', name: 'æ˜Ÿç©ºã®å°ã', rarity: 'uncommon', desc: 'å½¹ã€Œã‚·ã‚´ãƒ­ã€ãŒæˆç«‹ã—ãŸæ™‚ã€æ¬¡ã®ãƒ­ãƒ¼ãƒ«ã®å¹¸é‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ+150ã•ã‚Œã‚‹', price: 2, effectType: 'shigoro_luck_next' });
ITEM_DATA.push({ id: 'shigoro_mul_rate', name: 'çƒˆç«ã®ç‹å† ', rarity: 'rare', desc: 'å½¹ã€Œã‚·ã‚´ãƒ­ã€ãŒæˆç«‹ã—ãŸæ™‚ã€ãã®ãƒ©ã‚¦ãƒ³ãƒ‰ãŒçµ‚äº†ã™ã‚‹ã¾ã§å…¨ä½“å€ç‡ã‚’1.5å€ã«ã™ã‚‹', price: 4, effectType: 'shigoro_mul_rate' });
ITEM_DATA.push({ id: 'shigoro_buff_face', name: 'å¤§åœ°é³´å‹•', rarity: 'rare', desc: 'å½¹ã€Œã‚·ã‚´ãƒ­ã€ãŒæˆç«‹ã—ãŸæ™‚ã€å…¨ã¦ã®ã‚µã‚¤ã‚³ãƒ­ã®å‡ºç›®ç‚¹ãŒæ°¸ç¶šçš„ã«1.5å€ã«ãªã‚‹', price: 4, effectType: 'shigoro_buff_face' });
ITEM_DATA.push({ id: 'shigoro_gain_ticket', name: 'ç›—è³Šã®é‡‘è²¨', rarity: 'rare', desc: 'å½¹ã€Œã‚·ã‚´ãƒ­ã€ãŒæˆç«‹ã—ãŸæ™‚ã€ãƒã‚±ãƒƒãƒˆã‚’15æšç²å¾—ã™ã‚‹', price: 4, effectType: 'shigoro_gain_ticket' });

// ãƒ”ãƒ³ã‚¾ãƒ­ç³» (æ–°è¦)
ITEM_DATA.push({ id: 'pinzoro_act_roll', name: 'å¤©å¸ã®å‡±æ—‹', rarity: 'rare', desc: 'å½¹ã€Œãƒ”ãƒ³ã‚¾ãƒ­ã€ãŒæˆç«‹ã—ãŸæ™‚ã€ãƒ­ãƒ¼ãƒ«å›æ•°ãŒ2å›åˆ†å›å¾©ã™ã‚‹ï¼ˆ1ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã¤ã3å›ã¾ã§ç™ºå‹•ï¼‰', price: 4, effectType: 'pinzoro_act_roll' });
ITEM_DATA.push({ id: 'pinzoro_luck_next', name: 'å¤©é‹ã®æŒ‡è¼ª', rarity: 'rare', desc: 'å½¹ã€Œãƒ”ãƒ³ã‚¾ãƒ­ã€ãŒæˆç«‹ã—ãŸæ™‚ã€æ¬¡ã®ãƒ­ãƒ¼ãƒ«ã®å¹¸é‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ+250ã•ã‚Œã‚‹', price: 4, effectType: 'pinzoro_luck_next' });
ITEM_DATA.push({ id: 'pinzoro_mul_rate', name: 'è¦‡ç‹ã®å† ', rarity: 'sr', desc: 'å½¹ã€Œãƒ”ãƒ³ã‚¾ãƒ­ã€ãŒæˆç«‹ã—ãŸæ™‚ã€ãã®ãƒ©ã‚¦ãƒ³ãƒ‰ãŒçµ‚äº†ã™ã‚‹ã¾ã§å…¨ä½“å€ç‡ã‚’2å€ã«ã™ã‚‹', price: 8, effectType: 'pinzoro_mul_rate' });
ITEM_DATA.push({ id: 'pinzoro_buff_face', name: 'å¤©åœ°å‰µé€ ', rarity: 'sr', desc: 'å½¹ã€Œãƒ”ãƒ³ã‚¾ãƒ­ã€ãŒæˆç«‹ã—ãŸæ™‚ã€å…¨ã¦ã®ã‚µã‚¤ã‚³ãƒ­ã®å‡ºç›®ç‚¹ãŒæ°¸ç¶šçš„ã«2å€ã«ãªã‚‹', price: 8, effectType: 'pinzoro_buff_face' });
ITEM_DATA.push({ id: 'pinzoro_gain_ticket', name: 'ç‹ã®è²¡å®', rarity: 'sr', desc: 'å½¹ã€Œãƒ”ãƒ³ã‚¾ãƒ­ã€ãŒæˆç«‹ã—ãŸæ™‚ã€ãƒã‚±ãƒƒãƒˆã‚’30æšç²å¾—ã™ã‚‹', price: 8, effectType: 'pinzoro_gain_ticket' });


// ãƒªãƒ­ãƒ¼ãƒ«ç³»
ITEM_DATA.push({ id: 'reroll_c_1', name: 'å•†äººã®ä¼šå“¡è¨¼', rarity: 'common', desc: 'æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ãŒé–‹å§‹ã•ã‚Œã‚‹ãŸã³ã€ã‚·ãƒ§ãƒƒãƒ—ã®ç„¡æ–™å†å…¥è·å›æ•°ãŒ2å›åˆ†è¿½åŠ ã•ã‚Œã‚‹', price: 1, effectType: 'reroll_stage', value: 2 });
ITEM_DATA.push({ id: 'reroll_r_1', name: 'è²´æ—ã®ç´¹ä»‹çŠ¶', rarity: 'rare', desc: 'å„ãƒ©ã‚¦ãƒ³ãƒ‰ãŒçµ‚äº†ã™ã‚‹ãŸã³ã€ã‚·ãƒ§ãƒƒãƒ—ã®ç„¡æ–™å†å…¥è·å›æ•°ãŒ1å›åˆ†è¿½åŠ ã•ã‚Œã‚‹', price: 4, effectType: 'reroll_round', value: 1 });
ITEM_DATA.push({ id: 'rate_reroll', name: 'æº–å‚™ä¸‡ç«¯', rarity: 'uncommon', desc: 'æ‰€æŒã—ã¦ã„ã‚‹ãƒªãƒ­ãƒ¼ãƒ«ç„¡æ–™å›æ•°1å›ã«ã¤ãã€å…¨ä½“å€ç‡ã«+1.0å€ã‚’åŠ ç®—ã™ã‚‹', price: 2, effectType: 'rate_reroll', value: 1.0 });

// ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ã‚ªãƒ—ã‚·ãƒ§ãƒ³
const PRESTIGE_OPTIONS = [
    { type: 'weight', target: 1, text: 'å£±ã®ç›®ã®å‡ºã‚‹ç¢ºç‡ã®é‡ã¿ãŒ+3æ°¸ç¶šçš„ã«å¢—åŠ ã™ã‚‹', icon: 'âš€' },
    { type: 'weight', target: 2, text: 'å¼ã®ç›®ã®å‡ºã‚‹ç¢ºç‡ã®é‡ã¿ãŒ+3æ°¸ç¶šçš„ã«å¢—åŠ ã™ã‚‹', icon: 'âš' },
    { type: 'weight', target: 3, text: 'å‚ã®ç›®ã®å‡ºã‚‹ç¢ºç‡ã®é‡ã¿ãŒ+3æ°¸ç¶šçš„ã«å¢—åŠ ã™ã‚‹', icon: 'âš‚' },
    { type: 'weight', target: 4, text: 'è‚†ã®ç›®ã®å‡ºã‚‹ç¢ºç‡ã®é‡ã¿ãŒ+3æ°¸ç¶šçš„ã«å¢—åŠ ã™ã‚‹', icon: 'âšƒ' },
    { type: 'weight', target: 5, text: 'ä¼ã®ç›®ã®å‡ºã‚‹ç¢ºç‡ã®é‡ã¿ãŒ+3æ°¸ç¶šçš„ã«å¢—åŠ ã™ã‚‹', icon: 'âš„' },
    { type: 'weight', target: 6, text: 'é™¸ã®ç›®ã®å‡ºã‚‹ç¢ºç‡ã®é‡ã¿ãŒ+3æ°¸ç¶šçš„ã«å¢—åŠ ã™ã‚‹', icon: 'âš…' },
    { type: 'weight_group', targets: [1, 2, 3], val: -1, text: '1, 2, 3ã®ç›®ã®å‡ºã‚‹ç¢ºç‡ã®é‡ã¿ãŒ-1æ°¸ç¶šçš„ã«æ¸›å°‘ã™ã‚‹', icon: 'ğŸ”»' },
    { type: 'weight_group', targets: [4, 5, 6], val: -1, text: '4, 5, 6ã®ç›®ã®å‡ºã‚‹ç¢ºç‡ã®é‡ã¿ãŒ-1æ°¸ç¶šçš„ã«æ¸›å°‘ã™ã‚‹', icon: 'ğŸ”½' },
    { type: 'multi', target: 'pinzoro', text: 'å½¹ã€Œãƒ”ãƒ³ã‚¾ãƒ­ã€ã®ç¾åœ¨ã®å€ç‡ãŒ5å€ã«ãªã‚‹ï¼ˆåŸºç¤ç‚¹æ›´æ–°ï¼‰', icon: 'ğŸ‘‘' },
    { type: 'multi', target: 'arashi', text: 'å½¹ã€Œã‚¢ãƒ©ã‚·ã€ã®ç¾åœ¨ã®å€ç‡ãŒ5å€ã«ãªã‚‹ï¼ˆåŸºç¤ç‚¹æ›´æ–°ï¼‰', icon: 'ğŸŒ€' },
    { type: 'multi', target: '456', text: 'å½¹ã€Œã‚·ã‚´ãƒ­ã€ã®ç¾åœ¨ã®å€ç‡ãŒ5å€ã«ãªã‚‹ï¼ˆåŸºç¤ç‚¹æ›´æ–°ï¼‰', icon: 'ğŸ”¥' },
    { type: 'multi', target: 'meari', text: 'å½¹ã€Œç›®ã‚ã‚Šã€ã®ç¾åœ¨ã®å€ç‡ãŒ5å€ã«ãªã‚‹ï¼ˆåŸºç¤ç‚¹æ›´æ–°ï¼‰', icon: 'ğŸ‘€' },
    { type: 'multi', target: 'menashi', text: 'å½¹ã€Œç›®ãªã—ã€ã®ç¾åœ¨ã®å€ç‡ãŒ5å€ã«ãªã‚‹ï¼ˆåŸºç¤ç‚¹æ›´æ–°ï¼‰', icon: 'â˜ ï¸' },
    { type: 'ticket', val: 5, text: 'ãƒã‚±ãƒƒãƒˆã‚’5æšç²å¾—ã™ã‚‹', icon: 'ğŸ«' },
    { type: 'inv_max', text: 'ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã®æœ€å¤§æ•°ãŒæ°¸ç¶šçš„ã«1ã¤å¢—åŠ ã™ã‚‹', icon: 'ğŸ’' }
];

function formatBigInt(val) {
    if (val === 0n) return "0";
    let isNeg = false;
    if (val < 0n) { isNeg = true; val = -val; }

    let muryoPower = 0;
    let currentVal = val;
    if (currentVal >= MURYO_LIMIT) {
        while (currentVal >= MURYO_LIMIT) {
            currentVal /= MURYO_LIMIT;
            muryoPower++;
        }
    }
    let suffix = "";
    if (muryoPower > 0) {
        suffix = "<" + Array(muryoPower).fill("ç„¡é‡å¤§æ•°").join("ãƒ»") + ">";
    }

    let str = currentVal.toString();
    let len = str.length;
    let unitIndex = Math.floor((len - 1) / 4);
    
    let topLen = (len % 4 === 0) ? 4 : len % 4;
    let topNumStr = str.substring(0, topLen);
    let result = topNumStr + JP_UNITS[unitIndex];

    if (unitIndex > 0) {
        let secondBlockStr = str.substring(topLen, topLen + 4);
        if (secondBlockStr.length > 0) {
            let secondVal = parseInt(secondBlockStr);
            if (secondVal > 0) {
                result += secondVal + JP_UNITS[unitIndex - 1];
            }
        }
    }
    return (isNeg ? "-" : "") + result + suffix;
}

class Game {
    constructor() {
        this.diceChars = ['?', 'âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'];
        this.stage = 1;
        this.round = 1;
        this.rollCount = INITIAL_ROLL_COUNT;
        this.pool = 0n;
        this.totalScore = 0n;
        this.targetScore = 1500n;
        
        this.diceWeights = [0, 5, 5, 5, 5, 5, 5];
        this.faceValues = [0n, 1n, 2n, 3n, 4n, 5n, 6n]; 
        this.baseMultipliers = { ...CONST_BASE_MULTIPLIERS };
        this.yakuMultipliers = { ...this.baseMultipliers };

        this.tickets = 4;
        this.freeRerolls = 0; 
        this.baseLuck = 50;
        this.currentLuck = 50;
        this.globalMultiplier = 1.0; 
        this.inventory = [];
        this.shopItems = []; 
        this.rerollCost = 1;
        this.maxInventory = 7;
        
        this.isScientific = false; // è¡¨è¨˜ãƒ¢ãƒ¼ãƒ‰

        this.streakMenashi = 0;
        this.streakWin = 0;
        this.tempLuckBoost = 0;
        
        this.tempRateBoost = 0.0; // åŠ ç®—ãƒãƒ•
        this.roundMultiplierBoost = 1.0; // ä¹—ç®—ãƒãƒ•
        
        this.hifumiTriggerCount = 0; 
        this.hifumiPriorityCount = 0; 
        this.arashiRollCount = 0; 
        this.shigoroRollCount = 0;
        this.pinzoroRollCount = 0; // ãƒ”ãƒ³ã‚¾ãƒ­ç”¨

        this.nextRollFixedDice = null; 
        this.forcedDice = null; 
        this.roundExecCount = 0; 
        
        this.prestigeState = {
            weights: [0, 0, 0, 0, 0, 0, 0], 
            extraInv: 0
        };
        this.prestigeRerollCost = 1;
        this.currentPrestigeOptions = [];

        this.isShopOpen = false;
        this.roundGains = { faces: [0n,0n,0n,0n,0n,0n,0n], yakus: {} };

        // UI init
        try {
            this.ui = {
                stage: document.getElementById('ui-stage'),
                round: document.getElementById('ui-round'),
                roll: document.getElementById('ui-roll'),
                pool: document.getElementById('ui-pool'),
                target: document.getElementById('ui-target'),
                total: document.getElementById('ui-total'),
                tickets: document.getElementById('ui-tickets'),
                luck: document.getElementById('ui-luck'),
                rate: document.getElementById('ui-rate'), 
                invList: document.getElementById('ui-inventory'),
                invCount: document.getElementById('ui-inv-count'),
                diceCont: document.getElementById('dice-container'),
                msgMain: document.getElementById('msg-main'),
                msgSub: document.getElementById('msg-sub'),
                msgLog: document.getElementById('msg-log'),
                btnRoll: document.getElementById('btn-roll'),
                btnShop: document.getElementById('btn-shop'),
                btnClear: document.getElementById('btn-clear'),
                clearSub: document.getElementById('clear-sub'),
                mainPanel: document.getElementById('main-panel'),
                gameView: document.getElementById('game-view'),
                shopView: document.getElementById('shop-view'),
                shopShelves: document.getElementById('shop-shelves'),
                btnReroll: document.getElementById('btn-reroll'),
                prestigeView: document.getElementById('prestige-view'),
                prestigeCont: document.getElementById('prestige-container'),
                btnPrestigeReroll: document.getElementById('btn-prestige-reroll'),
                modal: document.getElementById('modal'),
                mTitle: document.getElementById('modal-title'),
                mMsg: document.getElementById('modal-msg'),
                tableFaces: document.getElementById('table-faces'),
                tableYaku: document.getElementById('table-yaku')
            };
            this.initStage();
        } catch(e) {
            console.error(e);
            alert("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + e.message);
        }
    }

    toggleNotation() {
        this.isScientific = !this.isScientific;
        this.updateUI();
        this.updateTables();
    }

    formatVal(val) {
        if (this.isScientific) {
            if (val === 0n) return "0";
            let str = val.toString();
            if (str.length <= 6) return str;
            let exponent = str.length - 1;
            let mantissa = str.substring(0, 4); 
            return mantissa.charAt(0) + "." + mantissa.substring(1) + "e+" + exponent;
        } else {
            return formatBigInt(val);
        }
    }

    initStage() {
        this.round = 1;
        this.pool = 0n;
        this.rollCount = INITIAL_ROLL_COUNT;
        this.roundExecCount = 0;
        
        // Target = 1500 * 4 ^ (çµŒéã‚¹ãƒ†ãƒ¼ã‚¸æ•° * çµŒéã‚¹ãƒ†ãƒ¼ã‚¸æ•°)
        const elapsedStages = this.stage - 1;
        const exponent = BigInt(elapsedStages * elapsedStages);
        this.targetScore = 1500n * (4n ** exponent);

        this.nextRollFixedDice = null;
        this.tempRateBoost = 0.0;
        this.roundMultiplierBoost = 1.0;
        this.hifumiTriggerCount = 0;
        this.hifumiPriorityCount = 0;
        this.arashiRollCount = 0;
        this.shigoroRollCount = 0;
        this.pinzoroRollCount = 0;

        this.inventory.forEach(item => {
            if (item.effectType === 'reroll_stage') {
                this.freeRerolls += item.value;
            }
        });

        this.yakuMultipliers = { ...this.baseMultipliers };

        this.recalcStats();
        this.rerollCost = 1;
        this.generateShopItems();

        this.updateUI();
        this.updateTables();
        this.updateClearButton();
        
        this.ui.msgMain.textContent = `STAGE ${this.stage}`;
        this.ui.msgMain.classList.remove('hifumi-text');
        this.ui.msgSub.textContent = `ç›®æ¨™: ${this.formatVal(this.targetScore)}pt`;
        this.ui.btnShop.classList.remove('hidden-el');
        this.ui.btnShop.disabled = false;
        this.ui.btnRoll.disabled = false;
        
        this.ui.msgLog.innerHTML = "";

        if (this.stage === 1) {
            this.openShop();
        } else {
            this.closeShop();
        }
    }

    clearLogs() { this.ui.msgLog.innerHTML = ""; }
    addLog(text, type) {
        const span = document.createElement('span');
        span.className = `log-tag ${type || ''}`;
        span.textContent = text;
        this.ui.msgLog.appendChild(span);
    }
    checkProb(baseProb) {
        let prob = baseProb;
        const hasBoost = this.inventory.some(i => i.effectType === 'prob_boost');
        if (hasBoost) prob *= 2;
        return Math.random() < prob;
    }

    recalcStats() {
        let w = [0, 5, 5, 5, 5, 5, 5];
        
        for(let i=1; i<=6; i++) {
            w[i] += this.prestigeState.weights[i];
        }
        for(let i=1; i<=6; i++) if(w[i] < 0) w[i] = 0;
        this.diceWeights = w;

        let l = 50;
        this.inventory.forEach(item => {
            if (item.effectType === 'luck_static') l += item.value;
        });
        this.baseLuck = l;
        this.currentLuck = l; 

        let maxInv = 7 + this.prestigeState.extraInv; 
        this.inventory.forEach(item => {
            if (item.effectType === 'inv_expand') maxInv += item.value;
        });
        this.maxInventory = maxInv;

        let rate = 1.0;
        this.inventory.forEach(item => {
            if (item.effectType === 'rate_ticket') {
                rate += Math.floor(this.tickets / 10) * item.value;
            }
            if (item.effectType === 'rate_streak') {
                rate += this.streakWin * item.value;
            }
            if (item.effectType === 'rate_reroll') {
                rate += this.freeRerolls * item.value;
            }
        });
        rate += this.tempRateBoost; 
        rate *= this.roundMultiplierBoost;

        this.globalMultiplier = rate;
        this.updateTables();
    }

    roll() {
        if (this.rollCount <= 0) return;
        this.resetGains();
        this.recalcStats();
        this.updateTables();
        this.clearLogs();

        this.forcedDice = null;
        
        if (this.nextRollFixedDice) {
            this.forcedDice = [...this.nextRollFixedDice];
            this.nextRollFixedDice = null;
            this.addLog(`ğŸ”¥ç¢ºå®šæ¼”å‡º`, 'log-buff');
        }

        this.roundExecCount++;

        let rollLuck = this.baseLuck + this.tempLuckBoost;
        this.tempLuckBoost = 0; 
        this.inventory.forEach(item => {
            if (item.effectType === 'luck_chance') {
                if (this.checkProb(item.prob)) { 
                    rollLuck += item.value;
                    this.addLog(`âœ¨${item.name}`, 'log-luck');
                }
            }
        });
        this.currentLuck = rollLuck;

        this.ui.btnRoll.disabled = true;
        this.ui.btnShop.classList.add('hidden-el');
        this.ui.btnClear.classList.remove('visible'); 
        document.getElementById('pool-box').classList.remove('shock-effect');

        let count = 0;
        const interval = setInterval(() => {
            const dummyDice = [this.rand(), this.rand(), this.rand()];
            this.renderDice(dummyDice);
            count++;
            if (count > 8) {
                clearInterval(interval);
                this.resolveRoll();
            }
        }, 60);
    }

    resetGains() { this.roundGains = { faces: [0n,0n,0n,0n,0n,0n,0n], yakus: {} }; }
    rand() { return Math.floor(Math.random()*6)+1; }
    
    getWeightedRandom() {
        const total = this.diceWeights.reduce((a, b) => a + b, 0);
        if (total <= 0) return Math.floor(Math.random()*6)+1;
        let r = Math.random() * total;
        for (let i = 1; i <= 6; i++) {
            if (r < this.diceWeights[i]) return i;
            r -= this.diceWeights[i];
        }
        return 6;
    }

    resolveRoll() {
        let dice, res;
        let rollAttempts = [];
        
        if (this.forcedDice) {
            dice = this.forcedDice;
            res = this.calc(dice);
            rollAttempts.push({ dice, res });
            this.forcedDice = null;
        } else {
            let activeLuck = this.currentLuck;
            do {
                let d = [this.getWeightedRandom(), this.getWeightedRandom(), this.getWeightedRandom()];
                let r = this.calc(d);
                rollAttempts.push({ dice: d, res: r });
                if (Math.random() * 100 < activeLuck) {
                    activeLuck /= 2;
                } else {
                    break;
                }
            } while (true);
        }

        let picked = null;
        const ruinContract = this.inventory.find(i => i.effectType === 'hifumi_priority');
        if (ruinContract && this.hifumiPriorityCount < 3) {
            const hifumiRoll = rollAttempts.find(a => a.res.isHifumi);
            if (hifumiRoll) {
                picked = hifumiRoll;
                this.hifumiPriorityCount++;
                this.addLog(`ğŸ“œ${ruinContract.name}`, 'log-hifumi');
            }
        }

        if (!picked) {
            const YAKU_RANK = {
                'pinzoro': 5,
                'arashi': 4,
                '456': 3,
                'meari': 2,
                'menashi': 1,
                'hifumi': 0
            };

            rollAttempts.sort((a, b) => {
                const rankA = YAKU_RANK[a.res.yakuKey] || 0;
                const rankB = YAKU_RANK[b.res.yakuKey] || 0;
                
                if (rankB !== rankA) {
                    return rankB - rankA; 
                }
                
                if (b.res.score > a.res.score) return 1;
                if (b.res.score < a.res.score) return -1;
                return 0;
            });
            picked = rollAttempts[0];
        }
        
        dice = picked.dice;
        res = picked.res;

        const luckTriggerCount = rollAttempts.length - 1;
        if (luckTriggerCount > 0) this.addLog(`LUCKç™ºå‹• x${luckTriggerCount}`, 'log-luck');

        if (res.yakuKey === 'menashi') {
            this.streakMenashi++;
            this.streakWin = 0;
        } else if (res.yakuKey !== 'hifumi') { 
            this.streakWin++;
            this.streakMenashi = 0;
        } else {
            this.streakMenashi = 0;
            this.streakWin = 0;
        }

        this.inventory.forEach(item => {
            if (item.effectType === 'luck_cond_menashi') {
                if (this.streakMenashi >= 2) this.tempLuckBoost += item.value;
            }
        });

        if (this.streakWin >= 3) {
            let dragonFired = false;
            this.inventory.forEach(item => {
                if (item.effectType === 'buff_streak_win') {
                    for(let key in this.baseMultipliers) {
                        const added = this.baseMultipliers[key]; 
                        this.baseMultipliers[key] *= 2n;
                        this.yakuMultipliers[key] *= 2n;
                        this.roundGains.yakus[key] = (this.roundGains.yakus[key] || 0n) + added;
                    }
                    dragonFired = true;
                    this.addLog(`ğŸ²${item.name}`, 'log-buff');
                }
            });
            if(dragonFired) {
                this.recalcStats();
                res = this.calc(dice);
            }
        }

        this.renderDice(dice);
        this.checkPreCalcEffects(dice);
        
        this.ui.msgMain.classList.remove('hifumi-text');
        
        if (res.isHifumi) {
            this.ui.msgMain.textContent = "ãƒ’ãƒ•ãƒŸï¼ï¼ï¼";
            this.ui.msgMain.classList.add('hifumi-text');
            const guardItem = this.inventory.find(i => i.effectType === 'hifumi_guard');
            if (guardItem) {
                this.addLog(`ğŸ›¡ï¸${guardItem.name}`, 'log-buff');
                this.ui.msgSub.innerHTML = "<span style='color:#2ecc71'>ãƒšãƒŠãƒ«ãƒ†ã‚£ç„¡åŠ¹åŒ–ï¼</span>";
            } else {
                this.pool = 0n;
                this.ui.msgSub.innerHTML = "<span style='color:#e74c3c; font-weight:bold;'>ãƒšãƒŠãƒ«ãƒ†ã‚£ç™ºå‹•ï¼ãƒ—ãƒ¼ãƒ«æ²¡åï¼</span>";
                document.getElementById('pool-box').classList.add('shock-effect');
            }
            this.triggerHifumiEffects();
        } else {
            this.pool += res.score;
            this.ui.msgMain.textContent = res.yakuName;
            this.ui.msgSub.textContent = `å‡ºç›®(${this.formatVal(res.sum)}) Ã— å€ç‡(${this.formatVal(res.mul)}) = +${this.formatVal(res.score)}pt`;
            this.checkPostCalcEffects(dice, res.yakuKey);
        }

        if (res.yakuKey === 'arashi') {
            this.triggerArashiEffects();
        }
        if (res.yakuKey === '456') {
            this.triggerShigoroEffects();
        }
        if (res.yakuKey === 'pinzoro') {
            this.triggerPinzoroEffects();
        }

        this.rollCount--;
        this.inventory.forEach(item => {
            if (item.effectType === 'roll_add') {
                if (this.checkProb(item.prob)) {
                    this.rollCount++;
                    this.addLog(`ğŸµ${item.name}`, 'log-luck');
                }
            }
        });

        this.currentLuck = this.baseLuck; 
        this.updateUI();
        this.updateTables();

        if (this.rollCount <= 0) {
            this.ui.btnRoll.disabled = true;
            setTimeout(() => this.endRound(), 1500);
        } else {
            this.ui.btnRoll.disabled = false;
        }
    }

    triggerArashiEffects() {
        let recalcNeeded = false;
        this.inventory.forEach(item => {
            if (item.effectType === 'arashi_act_roll') {
                if (this.arashiRollCount < 5) {
                    this.rollCount += 1;
                    this.arashiRollCount++;
                    this.addLog(`ğŸ’¨${item.name}(+1 Roll)`, 'log-arashi');
                } else {
                    this.addLog(`(ä¸Šé™)${item.name}`, 'log-bad');
                }
            }
            if (item.effectType === 'arashi_luck_next') {
                this.tempLuckBoost += 200;
                this.addLog(`âš¡${item.name}`, 'log-luck');
            }
            if (item.effectType === 'arashi_mul_rate') {
                this.roundMultiplierBoost *= 1.5;
                this.addLog(`ğŸŒªï¸${item.name}`, 'log-rate');
                recalcNeeded = true;
            }
            if (item.effectType === 'arashi_buff_face') {
                for(let i=1; i<=6; i++) {
                    const gain = (this.faceValues[i] * 5n) / 10n; // +0.5x
                    this.faceValues[i] = (this.faceValues[i] * 15n) / 10n;
                    this.roundGains.faces[i] += gain;
                }
                this.addLog(`ğŸŒ‹${item.name}`, 'log-buff');
            }
            if (item.effectType === 'arashi_gain_ticket') {
                this.tickets += 20;
                this.addLog(`ğŸ´â€â˜ ï¸${item.name}`, 'log-ticket');
            }
        });
        if (recalcNeeded) this.recalcStats();
    }

    triggerShigoroEffects() {
        let recalcNeeded = false;
        this.inventory.forEach(item => {
            if (item.effectType === 'shigoro_act_roll') {
                if (this.shigoroRollCount < 4) {
                    this.rollCount += 1;
                    this.shigoroRollCount++;
                    this.addLog(`ğŸ¦…${item.name}(+1 Roll)`, 'log-shigoro');
                } else {
                    this.addLog(`(ä¸Šé™)${item.name}`, 'log-bad');
                }
            }
            if (item.effectType === 'shigoro_luck_next') {
                this.tempLuckBoost += 150;
                this.addLog(`ğŸŒ ${item.name}`, 'log-luck');
            }
            if (item.effectType === 'shigoro_mul_rate') {
                this.roundMultiplierBoost *= 1.5;
                this.addLog(`ğŸ”¥${item.name}`, 'log-rate');
                recalcNeeded = true;
            }
            if (item.effectType === 'shigoro_buff_face') {
                for(let i=1; i<=6; i++) {
                    const gain = (this.faceValues[i] * 5n) / 10n; // +0.5x
                    this.faceValues[i] = (this.faceValues[i] * 15n) / 10n;
                    this.roundGains.faces[i] += gain;
                }
                this.addLog(`ğŸŒ${item.name}`, 'log-buff');
            }
            if (item.effectType === 'shigoro_gain_ticket') {
                this.tickets += 15;
                this.addLog(`ğŸ’°${item.name}`, 'log-ticket');
            }
        });
        if (recalcNeeded) this.recalcStats();
    }

    triggerPinzoroEffects() {
        let recalcNeeded = false;
        this.inventory.forEach(item => {
            if (item.effectType === 'pinzoro_act_roll') {
                if (this.pinzoroRollCount < 3) {
                    this.rollCount += 2;
                    this.pinzoroRollCount++;
                    this.addLog(`ğŸ‘‘${item.name}(+2 Roll)`, 'log-pinzoro');
                } else {
                    this.addLog(`(ä¸Šé™)${item.name}`, 'log-bad');
                }
            }
            if (item.effectType === 'pinzoro_luck_next') {
                this.tempLuckBoost += 250;
                this.addLog(`âœ¨${item.name}`, 'log-luck');
            }
            if (item.effectType === 'pinzoro_mul_rate') {
                this.roundMultiplierBoost *= 2.0;
                this.addLog(`âš”ï¸${item.name}`, 'log-rate');
                recalcNeeded = true;
            }
            if (item.effectType === 'pinzoro_buff_face') {
                for(let i=1; i<=6; i++) {
                    const gain = this.faceValues[i]; // +1.0x (total 2x)
                    this.faceValues[i] *= 2n;
                    this.roundGains.faces[i] += gain;
                }
                this.addLog(`ğŸª${item.name}`, 'log-buff');
            }
            if (item.effectType === 'pinzoro_gain_ticket') {
                this.tickets += 30;
                this.addLog(`ğŸ’${item.name}`, 'log-ticket');
            }
        });
        if (recalcNeeded) this.recalcStats();
    }

    triggerHifumiEffects() {
        let recalcNeeded = false;
        this.inventory.forEach(item => {
            if (item.effectType === 'hifumi_act_roll') {
                if (this.hifumiTriggerCount < 3) {
                    this.rollCount += 3;
                    this.hifumiTriggerCount++;
                    this.addLog(`ğŸ¥–${item.name}(+3 Roll)`, 'log-buff');
                } else {
                    this.addLog(`(ä¸Šé™)${item.name}`, 'log-bad');
                }
            }
            if (item.effectType === 'hifumi_act_pin') {
                this.nextRollFixedDice = [1, 1, 1];
                this.addLog(`âš”ï¸${item.name}`, 'log-buff');
            }
            if (item.effectType === 'hifumi_mul_rate') {
                this.roundMultiplierBoost *= 2.0;
                this.addLog(`ğŸ˜¡${item.name}`, 'log-rate');
                recalcNeeded = true;
            }
            if (item.effectType === 'hifumi_buff_face') {
                for(let i=1; i<=6; i++) {
                    const gain = this.faceValues[i] * 3n; 
                    this.faceValues[i] *= 4n;
                    this.roundGains.faces[i] += gain;
                }
                this.addLog(`ğŸŒ€${item.name}`, 'log-buff');
            }
            if (item.effectType === 'hifumi_ticket_pct') {
                const gain = Math.floor(this.tickets / 5);
                if (gain > 0) {
                    this.tickets += gain;
                    this.addLog(`ğŸ’°${item.name}(+${gain})`, 'log-ticket');
                }
            }
        });
        if (recalcNeeded) this.recalcStats();
    }

    calc(dice) {
        const sorted = [...dice].sort((a,b)=>a-b);
        let sum = 0n;
        dice.forEach(d => {
            let val = this.faceValues[d];
            sum += val;
        });

        const diceSumTotal = dice.reduce((a,c) => a+c, 0);
        const isSumOdd = (diceSumTotal % 2 !== 0);
        
        let tempRateMul = 1.0;
        
        this.inventory.forEach(item => {
            if (item.effectType === 'score_sum_odd' && isSumOdd) tempRateMul *= item.value;
            if (item.effectType === 'score_sum_even' && !isSumOdd) tempRateMul *= item.value;
            if (item.effectType === 'score_sum_focus_odd') {
                if (isSumOdd) tempRateMul *= 4.0; else tempRateMul *= 0.5;
            }
            if (item.effectType === 'score_sum_focus_even') {
                if (!isSumOdd) tempRateMul *= 4.0; else tempRateMul *= 0.5;
            }
        });
        
        let yakuKey = 'menashi';
        let yakuName = "ç›®ãªã—";
        let isHifumi = false;
        if (sorted[0]===1 && sorted[1]===1 && sorted[2]===1) { yakuKey='pinzoro'; yakuName="ãƒ”ãƒ³ã‚¾ãƒ­"; }
        else if (sorted[0]===sorted[1] && sorted[1]===sorted[2]) { yakuKey='arashi'; yakuName="ã‚¢ãƒ©ã‚·"; }
        else if (sorted[0]===4 && sorted[1]===5 && sorted[2]===6) { yakuKey='456'; yakuName="ã‚·ã‚´ãƒ­"; }
        else if (sorted[0]===1 && sorted[1]===2 && sorted[2]===3) { yakuKey='hifumi'; yakuName="ãƒ’ãƒ•ãƒŸ"; isHifumi=true; }
        else if (sorted[0]===sorted[1] || sorted[1]===sorted[2] || sorted[0]===sorted[2]) { yakuKey='meari'; yakuName="ç›®ã‚ã‚Š"; }

        let mul = this.yakuMultipliers[yakuKey]; 
        
        const effectiveGlobalRate = this.globalMultiplier * tempRateMul;
        let globalRateInt = BigInt(Math.round(effectiveGlobalRate * 100));
        
        const finalScore = (sum * mul * globalRateInt) / 100n;
        return { sum, mul, score: finalScore, yakuName, yakuKey, isHifumi };
    }

    checkPreCalcEffects(dice) {
        this.inventory.forEach(item => {
            if (item.effectType === 'happy') {
                const count = dice.filter(d => d === item.targetFace).length;
                for(let i=0; i<count; i++) {
                    if (Math.random() < item.prob) { 
                        this.tickets++;
                        this.addLog(`ğŸ«${item.name}`, 'log-ticket');
                    }
                }
            }
        });
    }

    checkPostCalcEffects(dice, yakuKey) {
        let changed = false;
        this.inventory.forEach(item => {
            if (item.effectType === 'gold_mul') {
                const count = dice.filter(d => d === item.targetFace).length;
                for(let i=0; i<count; i++) {
                    if (this.checkProb(item.prob)) { 
                        const face = item.targetFace;
                        const added = this.faceValues[face]; 
                        this.faceValues[face] *= 2n;
                        this.roundGains.faces[face] += added;
                        this.addLog(`ğŸ’ª${item.name}(x2)`, 'log-buff');
                        changed = true;
                    }
                }
            }
            if (item.effectType === 'awakening_mul') {
                const count = dice.filter(d => d === item.targetFace).length;
                for(let i=0; i<count; i++) {
                    if (this.checkProb(item.prob)) { 
                        const current = this.baseMultipliers[yakuKey];
                        if (current > 0n) {
                            this.baseMultipliers[yakuKey] *= 2n;
                            this.yakuMultipliers[yakuKey] *= 2n;
                            this.roundGains.yakus[yakuKey] = (this.roundGains.yakus[yakuKey] || 0n) + current;
                            this.addLog(`âš¡${item.name}(x2)`, 'log-buff');
                            changed = true;
                        }
                    }
                }
            }
        });
        if(changed) this.recalcStats();
    }

    endRound() {
        this.totalScore += this.pool;
        const earned = this.pool;
        this.pool = 0n;
        this.tempRateBoost = 0;
        this.roundMultiplierBoost = 1.0; 
        this.hifumiTriggerCount = 0;
        this.hifumiPriorityCount = 0; 
        this.arashiRollCount = 0; 
        this.shigoroRollCount = 0;
        this.pinzoroRollCount = 0;
        
        this.inventory.forEach(item => {
            if (item.effectType === 'reroll_round') {
                this.freeRerolls += item.value;
            }
        });
        this.ui.btnClear.classList.remove('visible'); 
        this.ui.msgMain.textContent = "ROUND FINISH";
        this.ui.msgMain.classList.remove('hifumi-text');
        this.ui.msgSub.textContent = `ç²å¾—: ${this.formatVal(earned)}pt / åˆè¨ˆ: ${this.formatVal(this.totalScore)}pt`;
        document.getElementById('pool-box').classList.remove('shock-effect');
        this.updateUI();
        this.round++;
        this.rollCount = INITIAL_ROLL_COUNT;
        this.roundExecCount = 0; 
        
        if (this.round > 3) {
            setTimeout(() => this.checkStageClear(), 1500);
        } else {
            setTimeout(() => {
                this.ui.msgMain.textContent = `ROUND ${this.round}`;
                this.ui.msgSub.textContent = "ã‚·ãƒ§ãƒƒãƒ—åˆ©ç”¨å¯èƒ½";
                this.ui.btnRoll.disabled = false;
                this.ui.btnShop.classList.remove('hidden-el');
                this.ui.btnShop.disabled = false;
                this.clearLogs(); 
                this.yakuMultipliers = { ...this.baseMultipliers };
                this.roundGains.yakus = {}; 
                this.recalcStats(); 
                this.updateUI();
                this.updateClearButton(); 
            }, 1500);
        }
    }

    calculateReward() {
        let roundsLeft = Math.max(0, 4 - this.round);
        let bonus = 0;
        this.inventory.forEach(item => {
            if (item.effectType === 'ticket_interest') {
                bonus += Math.floor(this.tickets / 5) * item.value;
            }
        });
        return 2 + (roundsLeft * 2) + bonus;
    }

    updateClearButton() {
        if (this.totalScore >= this.targetScore && this.round <= 3) {
            const reward = this.calculateReward();
            this.ui.clearSub.textContent = `(+${reward} ğŸ«)`;
            this.ui.btnClear.classList.add('visible');
        } else {
            this.ui.btnClear.classList.remove('visible');
        }
    }

    stageWin() {
        const reward = this.calculateReward();
        const roundsLeft = Math.max(0, 4 - this.round);
        this.tickets += reward;
        const paid = this.targetScore;
        this.totalScore -= this.targetScore;
        this.updateUI();
        this.showModal("STAGE CLEAR! ğŸ‰", 
            `ç›®æ¨™ã‚¹ã‚³ã‚¢é”æˆï¼<br>
             æ”¯æ‰•ã„: -${this.formatVal(paid)}pt<br>
             æ®‹ã‚Šã‚¹ã‚³ã‚¢: ${this.formatVal(this.totalScore)}pt<br>
             <div style="margin-top:10px; font-size:0.9em; background:#eee; padding:10px; border-radius:5px; color:#333;">
                ç²å¾—: ${reward}æš<br>
                (åŸºæœ¬2 + æ®‹R${roundsLeft}x2 + ã‚¢ã‚¤ãƒ†ãƒ ç­‰)
             </div>`, 
            true);
    }

    checkStageClear() {
        if (this.totalScore >= this.targetScore) {
            const reward = this.calculateReward(); 
            this.tickets += reward;
            const paid = this.targetScore;
            this.totalScore -= this.targetScore;
            this.updateUI();
            this.showModal("STAGE CLEAR! ğŸ‰", 
            `ç›®æ¨™ã‚¹ã‚³ã‚¢é”æˆï¼<br>
             æ”¯æ‰•ã„: -${this.formatVal(paid)}pt<br>
             æ®‹ã‚Šã‚¹ã‚³ã‚¢: ${this.formatVal(this.totalScore)}pt<br>
             <div style="margin-top:10px; font-size:0.9em; background:#eee; padding:10px; border-radius:5px; color:#333;">
                ç²å¾—: ${reward}æš
             </div>`, 
            true);
        } else {
            this.showModal("GAME OVER", `SCORE: ${this.formatVal(this.totalScore)}<br>ç›®æ¨™(${this.formatVal(this.targetScore)})ã«å±Šã‹ãš...`, false);
        }
    }

    updateTables() {
        let htmlFaces = `<tr><th>å‡ºç›®</th><th>ç‚¹æ•°</th><th>ç¢ºç‡</th></tr>`;
        const totalWeight = this.diceWeights.reduce((a,b)=>a+b,0);
        for(let i=1; i<=6; i++) {
            const w = this.diceWeights[i];
            const prob = totalWeight > 0 ? (w / totalWeight) : 0;
            const standardProb = 1/6;
            const val = this.faceValues[i];
            const gain = this.roundGains.faces[i];
            const gainHtml = gain > 0n ? `<span class="val-gain">(+${this.formatVal(gain)})</span>` : '';
            let probClass = 'prob-col';
            if (Math.abs(prob - standardProb) < 0.0001) {} 
            else if (prob > standardProb) { probClass += ' prob-high'; } 
            else { probClass += ' prob-low'; }
            htmlFaces += `<tr>
                <td>${i}</td>
                <td>${this.formatVal(val)}ç‚¹ ${gainHtml}</td>
                <td class="${probClass}">${(prob*100).toFixed(1)}%</td>
            </tr>`;
        }
        this.ui.tableFaces.innerHTML = htmlFaces;

        // --- 2. å½¹ç¢ºç‡ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
        const probs = { 'pinzoro': 0, 'arashi': 0, '456': 0, 'hifumi': 0, 'meari': 0, 'menashi': 0 };
        
        if (totalWeight > 0) {
            for (let i = 1; i <= 6; i++) {
                for (let j = 1; j <= 6; j++) {
                    for (let k = 1; k <= 6; k++) {
                        const p = (this.diceWeights[i] / totalWeight) * (this.diceWeights[j] / totalWeight) * (this.diceWeights[k] / totalWeight);
                        
                        const sorted = [i, j, k].sort((a, b) => a - b);
                        if (sorted[0] === 1 && sorted[1] === 1 && sorted[2] === 1) probs['pinzoro'] += p;
                        else if (sorted[0] === sorted[1] && sorted[1] === sorted[2]) probs['arashi'] += p;
                        else if (sorted[0] === 4 && sorted[1] === 5 && sorted[2] === 6) probs['456'] += p;
                        else if (sorted[0] === 1 && sorted[1] === 2 && sorted[2] === 3) probs['hifumi'] += p;
                        else if (sorted[0] === sorted[1] || sorted[1] === sorted[2] || sorted[0] === sorted[2]) probs['meari'] += p;
                        else probs['menashi'] += p;
                    }
                }
            }
        }

        // --- 3. å½¹å€ç‡ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–° ---
        let htmlYaku = `<tr><th>å½¹å</th><th>å€ç‡</th><th>ç¢ºç‡</th></tr>`;
        const yakus = [
            {k:'pinzoro', n:'ãƒ”ãƒ³ã‚¾ãƒ­'}, 
            {k:'arashi', n:'ã‚¢ãƒ©ã‚·'}, 
            {k:'456', n:'ã‚·ã‚´ãƒ­'}, 
            {k:'meari', n:'ç›®ã‚ã‚Š'}, 
            {k:'menashi', n:'ç›®ãªã—'},
            {k:'hifumi', n:'ãƒ’ãƒ•ãƒŸ'} // ä¸€ç•ªä¸‹ã«ç§»å‹•ã—ã¾ã—ãŸ
        ];
        
        yakus.forEach(y => {
            let curr = this.yakuMultipliers[y.k];
            if (curr === undefined) curr = 0n; 

            const gain = this.roundGains.yakus[y.k] || 0n;
            const gainHtml = gain > 0n ? `<span class="val-gain">(+${this.formatVal(gain)})</span>` : '';
            
            const probVal = probs[y.k] * 100;
            let probStr = probVal.toFixed(1) + '%';
            
            let probClass = 'prob-col';
            if (y.k === 'hifumi' && probVal > 0) probClass = 'prob-low'; 
            if (y.k === 'pinzoro' && probVal > 1) probClass = 'prob-high'; 

            htmlYaku += `<tr>
                <td>${y.n}</td>
                <td>x${this.formatVal(curr)} ${gainHtml}</td>
                <td class="${probClass}">${probStr}</td>
            </tr>`;
        });
        this.ui.tableYaku.innerHTML = htmlYaku;
    }

    renderDice(dice) {
        this.ui.diceCont.innerHTML = '';
        dice.forEach(v => {
            const d = document.createElement('div');
            d.className = 'die';
            d.textContent = this.diceChars[v];
            if (v === 1) d.dataset.value = "1";
            this.ui.diceCont.appendChild(d);
        });
    }

    updateUI() {
        this.ui.stage.textContent = this.stage;
        this.ui.round.textContent = Math.min(this.round, 3);
        this.ui.roll.textContent = Math.max(0, this.rollCount);
        this.ui.pool.textContent = this.formatVal(this.pool);
        this.ui.target.textContent = this.formatVal(this.targetScore);
        this.ui.total.textContent = this.formatVal(this.totalScore);
        this.ui.tickets.textContent = this.tickets;
        this.ui.luck.textContent = this.currentLuck; 
        this.ui.rate.textContent = 'x' + this.globalMultiplier.toFixed(1);

        this.ui.invCount.textContent = `${this.inventory.length}/${this.maxInventory}`;
        this.ui.invList.innerHTML = '';
        if (this.inventory.length === 0) {
            this.ui.invList.innerHTML = '<div style="opacity:0.5; text-align:center; padding:10px;">Empty</div>';
        } else {
            this.inventory.forEach(item => {
                const div = document.createElement('div');
                div.className = `inv-item inv-${item.rarity}`;
                div.innerHTML = `<span>${item.name}</span>`;
                div.title = item.desc;
                
                let actionHtml = '';
                if (this.isShopOpen) {
                    const sellPrice = Math.floor(item.price / 2);
                    actionHtml = `<button class="btn-inv-sell" onclick="window.game.sellItem(${this.inventory.indexOf(item)})">å£²å´(${sellPrice})</button>`;
                }
                div.innerHTML += actionHtml;
                this.ui.invList.appendChild(div);
            });
        }
    }

    openShop() {
        this.ui.gameView.classList.add('hidden');
        this.ui.shopView.classList.add('active');
        this.isShopOpen = true;
        this.updateUI();
        this.updateShopUI();
    }

    closeShop() {
        this.ui.shopView.classList.remove('active');
        this.ui.gameView.classList.remove('hidden');
        this.isShopOpen = false;
        this.updateUI();
    }

    generateShopItems() {
        this.shopItems = [];
        const ownedIds = this.inventory.map(i => i.id);
        let candidates = ITEM_DATA.filter(it => !ownedIds.includes(it.id));
        for(let i=0; i<4; i++) {
            if (candidates.length === 0) {
                this.shopItems.push(null);
                continue;
            }
            const weightedCandidates = candidates.map(it => {
                const rInfo = Object.values(RARITY).find(r => r.id === it.rarity);
                return { item: it, weight: rInfo.weight };
            });
            const totalWeight = weightedCandidates.reduce((sum, c) => sum + c.weight, 0);
            let r = Math.random() * totalWeight;
            let selected = null;
            for (let c of weightedCandidates) {
                if (r < c.weight) {
                    selected = c.item;
                    break;
                }
                r -= c.weight;
            }
            if (!selected) selected = weightedCandidates[weightedCandidates.length - 1].item;
            this.shopItems.push({ item: selected, sold: false });
            candidates = candidates.filter(c => c.id !== selected.id);
        }
        this.updateShopUI();
    }

    rerollShop() {
        if (this.stage === 1 && this.round === 1 && this.rollCount === INITIAL_ROLL_COUNT) {
            this.generateShopItems();
            return;
        }
        if (this.freeRerolls > 0) {
            this.freeRerolls--;
            this.generateShopItems();
            this.updateUI(); 
        } else if (this.tickets >= this.rerollCost) {
            this.tickets -= this.rerollCost;
            this.rerollCost *= 2;
            this.generateShopItems();
            this.updateUI();
        }
    }

    buyItem(shopIndex) {
        const slot = this.shopItems[shopIndex];
        if (!slot || slot.sold) return;
        if (this.inventory.length >= this.maxInventory) {
            alert("ã‚¢ã‚¤ãƒ†ãƒ ãŒã„ã£ã±ã„ã§ã™ï¼");
            return;
        }
        if (this.tickets >= slot.item.price) {
            this.tickets -= slot.item.price;
            this.inventory.push(slot.item);
            slot.sold = true;
            this.inventory.forEach(invItem => {
                if (invItem.effectType === 'reroll_buy_chance') {
                    if (this.checkProb(invItem.prob)) {
                        this.freeRerolls += invItem.value;
                    }
                }
            });
            this.recalcStats(); 
            this.updateUI();
            this.updateShopUI();
        } else {
            alert("ãƒã‚±ãƒƒãƒˆãŒè¶³ã‚Šã¾ã›ã‚“");
        }
    }
    
    sellItem(index) {
        const item = this.inventory[index];
        const sellPrice = Math.floor(item.price / 2);
        if(confirm(`${item.name} ã‚’ãƒã‚±ãƒƒãƒˆ ${sellPrice} æšã§å£²å´ã—ã¾ã™ã‹ï¼Ÿ`)) {
            this.tickets += sellPrice;
            this.inventory.splice(index, 1);
            this.recalcStats();
            this.updateUI();
            this.updateShopUI();
        }
    }

    updateShopUI() {
        this.ui.shopShelves.innerHTML = '';
        for(let i=0; i<4; i++) {
            const slot = this.shopItems[i];
            const div = document.createElement('div');
            if (slot) {
                const item = slot.item;
                div.className = `shop-item rarity-${item.rarity} ${slot.sold ? 'sold-out' : ''}`;
                div.innerHTML = `
                    <div class="item-name">${item.name}</div>
                    <div class="item-desc">${item.desc}</div>
                    <div class="item-price">ä¾¡æ ¼: ${item.price}æš</div>
                    <button class="btn-buy" onclick="window.game.buyItem(${i})">
                        ${slot.sold ? 'SOLD' : 'è³¼å…¥'}
                    </button>
                `;
            } else {
                div.className = 'shop-item sold-out';
                div.innerHTML = `<div class="item-name">Empty</div><div class="item-desc">åœ¨åº«ãªã—</div>`;
            }
            this.ui.shopShelves.appendChild(div);
        }
        const btn = this.ui.btnReroll;
        
        if (this.stage === 1 && this.round === 1 && this.rollCount === INITIAL_ROLL_COUNT) {
            btn.textContent = `å†å…¥è· (ç„¡æ–™: ã‚¹ã‚¿ãƒ¼ãƒˆãƒœãƒ¼ãƒŠã‚¹)`;
            btn.style.background = '#2ecc71'; 
            btn.style.boxShadow = '0 4px 0 #27ae60';
            btn.disabled = false;
        } else if (this.freeRerolls > 0) {
            btn.textContent = `å†å…¥è· (ç„¡æ–™: ${this.freeRerolls}å›)`;
            btn.style.background = '#2ecc71'; 
            btn.style.boxShadow = '0 4px 0 #27ae60';
            btn.disabled = false;
        } else {
            btn.textContent = `å†å…¥è· (Cost: ${this.rerollCost})`;
            btn.style.background = ''; 
            btn.style.boxShadow = '';
            btn.disabled = (this.tickets < this.rerollCost);
        }
    }

    showModal(title, msg, isClear) {
        this.ui.mTitle.textContent = title;
        this.ui.mMsg.innerHTML = msg;
        this.ui.modal.classList.add('show');
        this.ui.modal.dataset.isClear = isClear;
    }

    nextPhase() {
        this.ui.modal.classList.remove('show');
        const isClear = this.ui.modal.dataset.isClear === "true";
        if (isClear) {
            this.openPrestige();
        } else {
            this.stage = 1;
            this.totalScore = 0n;
            this.inventory = [];
            this.tickets = 4;
            this.freeRerolls = 0; 
            this.streakMenashi = 0; 
            this.streakWin = 0;
            this.faceValues = [0n,1n,2n,3n,4n,5n,6n];
            this.baseMultipliers = { ...CONST_BASE_MULTIPLIERS };
            this.yakuMultipliers = { ...this.baseMultipliers };
            this.prestigeState.weights = [0,0,0,0,0,0,0];
            this.prestigeState.extraInv = 0;
            this.initStage();
        }
    }

    openPrestige() {
        this.ui.gameView.classList.add('hidden');
        this.ui.shopView.classList.remove('active');
        this.ui.prestigeView.classList.add('active');
        this.prestigeRerollCost = 1;
        this.generatePrestigeOptions();
    }

    generatePrestigeOptions() {
        this.ui.prestigeCont.innerHTML = '';
        this.ui.btnPrestigeReroll.textContent = `é¸æŠè‚¢å¤‰æ›´ (Cost: ${this.prestigeRerollCost})`;
        this.ui.btnPrestigeReroll.disabled = (this.tickets < this.prestigeRerollCost);
        this.currentPrestigeOptions = [];
        let pool = [...PRESTIGE_OPTIONS];
        for(let i=0; i<3; i++) {
            if(pool.length === 0) break;
            const idx = Math.floor(Math.random() * pool.length);
            const opt = pool[idx];
            pool.splice(idx, 1);
            this.currentPrestigeOptions.push(opt);
            const div = document.createElement('div');
            div.className = 'prestige-card';
            div.innerHTML = `
                <div class="p-icon">${opt.icon}</div>
                <div class="p-desc">${opt.text}</div>
            `;
            div.onclick = () => this.selectPrestige(i);
            this.ui.prestigeCont.appendChild(div);
        }
    }

    rerollPrestige() {
        if(this.tickets >= this.prestigeRerollCost) {
            this.tickets -= this.prestigeRerollCost;
            this.prestigeRerollCost *= 2;
            this.updateUI();
            this.generatePrestigeOptions();
        }
    }

    selectPrestige(index) {
        const opt = this.currentPrestigeOptions[index];
        if (opt.type === 'weight') {
            this.prestigeState.weights[opt.target] += 3;
        } else if (opt.type === 'weight_group') { // New logic
            opt.targets.forEach(t => {
                this.prestigeState.weights[t] += opt.val;
            });
        } else if (opt.type === 'multi') {
            this.baseMultipliers[opt.target] *= 5n; // ã‚¤ãƒ³ãƒ•ãƒ¬å¯¾å¿œ x5
        } else if (opt.type === 'ticket') {
            this.tickets += opt.val;
        } else if (opt.type === 'inv_max') {
            this.prestigeState.extraInv += 1;
        }
        this.ui.prestigeView.classList.remove('active');
        this.ui.gameView.classList.remove('hidden');
        this.stage++;
        this.initStage();
    }
}

// èµ·å‹•å‡¦ç†ã®å®‰å…¨åŒ–
window.addEventListener('DOMContentLoaded', () => {
    try {
        window.game = new Game();
    } catch(e) {
        console.error("Critical Init Error:", e);
        alert("ã‚²ãƒ¼ãƒ ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + e.message);
    }
});
</script>
</body>
</html>