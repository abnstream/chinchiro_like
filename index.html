<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ³ãƒãƒ­ãƒ»ã‚¯ãƒªãƒƒã‚«ãƒ¼</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --accent: #f1c40f;
            --auto-color: #00d2d3;
            --skill-line: #9b59b6;
            --locked-color: #444;
            --max-gold: #f39c12;
            --total-color: #2ecc71;
            /* ãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ©ãƒ¼ */
            --mode-normal: #3498db;
            --mode-ritual: #9b59b6;
            --mode-fusion: #e74c3c;
            
            /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã‚«ãƒ©ãƒ¼ (åŸºæœ¬) */
            --rare-common: #ffffff;
            --rare-uncommon: #2ecc71;
            --rare-rare: #3498db;
            --rare-super: #f1c40f;
            --rare-ultra: #9b59b6;
            /* æ–°ãƒ¬ã‚¢ãƒªãƒ†ã‚£ */
            --rare-magic: #ff007f;
            --rare-epic: #00d2d3;
            --rare-legendary: #ff9f43;
            --rare-eternal: #fab1a0;

            /* è»¢ç”Ÿã‚«ãƒ©ãƒ¼ */
            --reinc-color: #e056fd;
            --reinc-bg: #2d0f38;
        }
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container { display: flex; gap: 20px; max-width: 1200px; width: 100%; position: relative; }
        .sidebar { width: 220px; display: flex; flex-direction: column; gap: 20px; }
        .panel { background: #1a1a1a; padding: 15px; border-radius: 10px; border: 1px solid #333; font-size: 0.8rem; }
        .panel h3 { margin: 0 0 10px 0; color: var(--accent); text-align: center; border-bottom: 1px solid var(--accent); }
        .panel table { width: 100%; border-collapse: collapse; }
        .panel td { padding: 5px 0; border-bottom: 1px solid #222; }
        .é…å½“ { text-align: right; color: #2ecc71; font-weight: bold; }
        #history-list { list-style: none; padding: 0; margin: 0; }
        #history-list li { padding: 4px 0; border-bottom: 1px solid #222; display: flex; justify-content: space-between; }
        .game-area { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .score-container { text-align: center; margin-bottom: 10px; }
        .score-label { font-size: 0.9rem; color: #888; margin-bottom: -5px; }
        #total-score-display { font-size: 1.5rem; color: var(--total-color); font-weight: bold; margin: 0; }
        #score-board { font-size: 3.5rem; color: var(--accent); font-weight: bold; margin: 0; text-shadow: 0 0 10px rgba(241, 196, 15, 0.3); }
        .multiplier-tag { background: var(--auto-color); color: #000; padding: 2px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; margin-bottom: 20px; }
        #game-fields { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; width: 100%; }
        .field { background: var(--panel-bg); padding: 15px; border-radius: 15px; display: flex; flex-direction: column; align-items: center; position: relative; border: 1px solid #333; }
        .timer-container { position: absolute; top: 10px; right: 10px; width: 35px; height: 35px; }
        .timer-svg { transform: rotate(-90deg); width: 35px; height: 35px; }
        .timer-progress { fill: none; stroke: var(--auto-color); stroke-width: 4; stroke-dasharray: 100; stroke-dashoffset: 100; }
        .timer-bg { fill: none; stroke: #333; stroke-width: 4; }
        .dice-row { display: flex; gap: 6px; margin: 10px 0; flex-wrap: wrap; justify-content: center; }
        
        .die { 
            width: 45px; height: 45px; background: white; border-radius: 8px; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 1.8rem; color: #333; box-shadow: 0 4px 0 #999; 
            transition: opacity 0.3s, transform 0.2s, color 0.3s, text-shadow 0.3s; 
            font-family: 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
        }
        .die.is-number { font-size: 1.4rem; font-weight: bold; font-family: 'Arial', sans-serif; }

        .rarity-common { color: #333; }
        .rarity-uncommon { color: var(--rare-uncommon) !important; text-shadow: 0 0 2px rgba(46, 204, 113, 0.3); }
        .rarity-rare { color: var(--rare-rare) !important; text-shadow: 0 0 3px rgba(52, 152, 219, 0.4); }
        .rarity-super { color: var(--rare-super) !important; text-shadow: 0 0 5px rgba(241, 196, 15, 0.5); }
        .rarity-ultra { color: var(--rare-ultra) !important; text-shadow: 0 0 8px rgba(155, 89, 182, 0.6); }
        .rarity-magic { color: var(--rare-magic) !important; text-shadow: 0 0 10px var(--rare-magic); font-weight: bold; }
        .rarity-epic { color: var(--rare-epic) !important; text-shadow: 0 0 12px var(--rare-epic); font-weight: bold; }
        .rarity-legendary { color: var(--rare-legendary) !important; text-shadow: 0 0 15px var(--rare-legendary); font-weight: bold; border: 1px solid var(--rare-legendary); }
        .rarity-eternal { 
            color: #fff !important; 
            background: linear-gradient(135deg, #000, #333);
            text-shadow: 0 0 5px #fff, 0 0 10px #ff00de, 0 0 15px #00d2d3; 
            border: 2px solid #fff;
            animation: eternal-shine 2s infinite alternate;
        }
        @keyframes eternal-shine { from { box-shadow: 0 0 5px #fff; } to { box-shadow: 0 0 20px #fff; } }

        .die.unused { opacity: 0.25; transform: scale(0.85); box-shadow: none; border: none; animation: none; }
        .rolling { animation: shake 0.1s infinite; }
        .roll-btn { background: #e67e22; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .roll-btn:disabled { background: #444; cursor: not-allowed; }
        
        /* æ¢ç´¢ãƒ‘ãƒãƒ« */
        #expedition-panel { width: 100%; background: #222; border: 2px solid #555; border-radius: 15px; padding: 15px; margin-bottom: 20px; display: none; text-align: center; position: relative; transition: border-color 0.3s; }
        #expedition-panel.mode-normal { border-color: var(--mode-normal); }
        #expedition-panel.mode-ritual { border-color: var(--mode-ritual); }
        #expedition-panel.mode-fusion { border-color: var(--mode-fusion); }
        
        .exp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .exp-title { margin: 0; font-weight: bold; font-size: 1.2rem; }
        .exp-toggle-btn { background: #333; border: 1px solid #555; color: #aaa; padding: 4px 10px; border-radius: 5px; cursor: pointer; font-size: 0.7rem; }
        .exp-toggle-btn:hover { background: #444; color: white; }

        .exp-status { display: flex; align-items: center; justify-content: center; gap: 20px; }
        .exp-btn { color: white; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background 0.3s; }
        .exp-btn:disabled { background: #444 !important; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #reward-modal, #pool-detail-modal, #upgrade-modal, #reinc-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; z-index: 2000; }
        #upgrade-modal, #reinc-modal { z-index: 1000; }

        .reward-card { background: #222; border: 2px solid #444; padding: 20px; border-radius: 15px; width: 140px; cursor: pointer; transition: 0.3s; margin: 10px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .reward-card:hover { border-color: var(--accent); transform: translateY(-5px); background: #333; }
        .reward-card.remove-mode:hover { border-color: #e74c3c; background: #2c0b0b; }
        .reward-card.fusion-mode:hover { border-color: var(--mode-fusion); background: #2c0b0b; }
        .reward-card.selected { border-color: #2ecc71; background: #1b2e1b; transform: scale(0.95); opacity: 0.8; }
        .reward-card.selected.remove-mode { border-color: #e74c3c; background: #2c0b0b; }
        .reward-card.selected.fusion-mode { border-color: var(--mode-fusion); background: #3a1111; }

        #shop-trigger { position: fixed; bottom: 20px; right: 20px; background: #9b59b6; width: 60px; height: 60px; border-radius: 50%; font-size: 1.5rem; border: none; cursor: pointer; color: white; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4); z-index: 100; }
        
        /* è»¢ç”Ÿãƒœã‚¿ãƒ³ */
        #reinc-btn {
            background: linear-gradient(135deg, #a723e7, #5f27cd);
            color: white; padding: 12px 10px; border: 1px solid #e056fd; border-radius: 10px;
            cursor: pointer; font-weight: bold; box-shadow: 0 0 10px rgba(224, 86, 253, 0.5);
            display: none; width: 100%; margin-bottom: 20px; font-size: 1rem; position: relative; z-index: 10;
        }
        .reinc-available { animation: pulse-reinc 2s infinite; }
        @keyframes pulse-reinc { 0% {box-shadow: 0 0 10px rgba(224, 86, 253, 0.5);} 50% {box-shadow: 0 0 20px rgba(224, 86, 253, 0.8);} 100% {box-shadow: 0 0 10px rgba(224, 86, 253, 0.5);} }

        #shop-badge {
            position: absolute;
            top: -5px; right: -5px;
            background: #e74c3c; color: white;
            width: 24px; height: 24px;
            border-radius: 50%;
            display: none;
            justify-content: center; align-items: center;
            font-weight: bold; font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            z-index: 101;
            border: 2px solid #fff;
        }
        
        .modal-content { 
            background: #1a1a1a; padding: 30px; border-radius: 20px; width: 850px; text-align: center; 
            border: 1px solid var(--skill-line); max-height: 90vh; overflow-y: auto; 
            position: relative;
        }
        
        .close-modal-btn {
            position: absolute; top: 20px; right: 20px;
            background: transparent; border: none; color: #666; 
            font-size: 2rem; cursor: pointer; line-height: 1; z-index: 10;
        }
        .close-modal-btn:hover { color: white; }

        .tree-container { position: relative; display: flex; flex-direction: column; align-items: center; gap: 40px; margin-top: 40px; padding: 20px; }
        .tree-row { display: flex; gap: 20px; position: relative; z-index: 2; justify-content: center; width: 100%; }
        .svg-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .skill-line { stroke: #333; stroke-width: 3; fill: none; transition: 0.3s; }
        .skill-line.active { stroke: var(--skill-line); }
        .skill-node { width: 75px; height: 75px; background: #111; border-radius: 18px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; cursor: pointer; border: 3px solid #333; transition: 0.3s; }
        .skill-node.available { border-color: #555; background: #222; }
        .skill-node.unlocked { border-color: var(--skill-line); background: #2d1b33; }
        .skill-node.is-max { border-color: var(--max-gold) !important; box-shadow: 0 0 10px rgba(243, 156, 18, 0.4); }
        .skill-node.locked { background: #111; border-color: #333; cursor: default; }
        .skill-node.locked .skill-icon, .skill-node.locked .lv-badge { opacity: 0.3; filter: grayscale(100%); }
        .skill-node.can-buy::after {
            content: "+"; position: absolute; top: -8px; right: -8px; background: #e74c3c; color: white; width: 22px; height: 22px;
            border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1.1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 10; animation: pulse-badge 1.5s infinite alternate; border: 2px solid #222;
        }
        @keyframes pulse-badge { from { transform: scale(1); } to { transform: scale(1.15); } }

        /* è»¢ç”Ÿç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .reinc-bg { background: var(--reinc-bg); border-color: var(--reinc-color); }
        .reinc-node.unlocked { border-color: var(--reinc-color); background: #401550; }
        .reinc-node.available { border-color: #7d3c98; background: #2d0f38; }
        .skill-line.reinc-line.active { stroke: var(--reinc-color); }

        .skill-icon { font-size: 1.8rem; z-index: 3; }
        .lv-badge { font-size: 0.6rem; font-weight: bold; color: #888; z-index: 3; }
        .skill-tooltip { visibility: hidden; width: 220px; background: #000; color: #fff; padding: 10px; position: absolute; bottom: 125%; border-radius: 8px; font-size: 0.8rem; opacity: 0; transition: 0.2s; z-index: 100; border: 1px solid #444; pointer-events: none; }
        .skill-node:hover .skill-tooltip { visibility: visible; opacity: 1; }
        
        .pool-detail-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 20px; }
        .pool-detail-item { background: #222; padding: 10px; border-radius: 8px; border: 1px solid #444; }

        #save-notice { position: fixed; bottom: 20px; left: 20px; color: #888; font-size: 0.8rem; opacity: 0; transition: opacity 0.5s; }
        #offline-notice { position: fixed; bottom: 60px; left: 20px; color: var(--accent); font-size: 0.8rem; opacity: 0; transition: opacity 1s; z-index: 1000; }
        
        #rp-display-panel {
            background: rgba(45, 15, 56, 0.8);
            border: 1px solid var(--reinc-color);
            padding: 10px; border-radius: 8px;
            margin-bottom: 15px; display: none;
            color: var(--reinc-color); font-weight: bold;
        }
        
        #reinc-view-mode-msg {
            color: #f39c12; font-size: 0.8rem; margin-bottom: 10px; display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <button id="reinc-btn" onclick="openReincarnationModal()">âœ¦ è»¢ç”Ÿãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>

        <div class="panel">
            <h3>é…å½“è¡¨</h3>
            <table id="payout-table">
                <tr><td>ãƒ”ãƒ³ã‚¾ãƒ­</td><td class="é…å½“">1ä¸‡</td></tr>
                <tr><td>ã‚¢ãƒ©ã‚·</td><td class="é…å½“">2000*</td></tr>
                <tr><td>ã‚·ã‚´ãƒ­</td><td class="é…å½“">1000*</td></tr>
                <tr id="row-payout-s4" style="display:none;"><td>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼”</td><td class="é…å½“">1ä¸‡*</td></tr>
                <tr id="row-payout-a4" style="display:none;"><td>ã‚¢ãƒ©ã‚·ï¼”</td><td class="é…å½“">2ä¸‡*</td></tr>
                <tr id="row-payout-s5" style="display:none;"><td>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼•</td><td class="é…å½“">5ä¸‡*</td></tr>
                <tr id="row-payout-a5" style="display:none;"><td>ã‚¢ãƒ©ã‚·ï¼•</td><td class="é…å½“">10ä¸‡*</td></tr>
                <tr><td>é€šå¸¸ç›®</td><td class="é…å½“">ç›®Ã—50</td></tr>
                <tr><td>ç›®ãªã—</td><td class="é…å½“">10</td></tr>
            </table>
            <div style="font-size:0.6rem; color:#888; margin-top:5px;">*å¼·åŒ–ã«ã‚ˆã‚Šå¤‰å‹•</div>
        </div>
        <div class="panel" id="panel-history" style="display:none;">
            <h3>å®¶è¨ˆç°¿ (TOP5)</h3>
            <ul id="history-list"></ul>
        </div>
        <div class="panel">
            <h3>ãƒ—ãƒ¼ãƒ«æƒ…å ±</h3>
            <div id="pool-stats" style="font-size: 0.7rem; line-height: 1.4; margin-bottom: 10px;"></div>
            <button id="btn-pool-detail" style="display:none; width:100%; padding:5px; background:var(--skill-line); color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.7rem;" onclick="openPoolDetail()">è©³ç´°ã‚’ç¢ºèª</button>
        </div>
        <div style="text-align:center;">
            <button onclick="saveGame()" style="background:#444; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.7rem;">æ‰‹å‹•ã‚»ãƒ¼ãƒ–</button>
            <button onclick="resetGame()" style="background:#c0392b; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.7rem; margin-left:5px;">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div class="game-area">
        <div id="rp-display-panel">
            è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆ: <span id="rp-val">0</span> Pt (å€ç‡: x<span id="rp-mult">1.0</span>)
        </div>

        <div id="expedition-panel" class="mode-normal">
            <div class="exp-header">
                <h3 id="exp-title" class="exp-title" style="color:var(--mode-normal);">ğŸ§­ é€šå¸¸æ¢ç´¢</h3>
                <button id="btn-mode-toggle" class="exp-toggle-btn" style="display:none;" onclick="toggleExpeditionMode()">ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
            </div>
            <div class="exp-status">
                <div style="position: relative; width: 60px; height: 60px;">
                    <svg class="timer-svg" viewBox="0 0 36 36" style="width: 60px; height: 60px;">
                        <circle class="timer-bg" cx="18" cy="18" r="16"></circle>
                        <circle id="exp-prog" class="timer-progress" cx="18" cy="18" r="16"></circle>
                    </svg>
                    <div id="exp-timer-text" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:0.7rem;">READY</div>
                </div>
                <div id="exp-info" style="text-align: left;">
                    <div id="exp-cost-display">ã‚³ã‚¹ãƒˆ: 1ä¸‡5000 pts</div>
                    <div id="exp-msg" style="font-size: 0.8rem; color: #aaa;">æ–°ãŸãªå‡ºç›®ã‚’æ±‚ã‚ã¦æ¢ç´¢ã—ã¾ã™</div>
                </div>
                <button id="exp-action-btn" class="exp-btn" style="background:var(--mode-normal)" onclick="handleExpedition()">æ¢ç´¢é–‹å§‹</button>
            </div>
        </div>

        <div class="score-container">
            <p class="score-label">ç·ç²å¾—ã‚¹ã‚³ã‚¢</p>
            <p id="total-score-display">0</p>
            <p class="score-label" style="margin-top:10px;">æ‰€æŒã‚¹ã‚³ã‚¢</p>
            <p id="score-board">0</p>
        </div>
        <span class="multiplier-tag">å€ç‡: x<span id="mult-val">1.0</span></span>
        <div id="game-fields"></div>
    </div>
</div>

<div id="save-notice">Game Saved</div>
<div id="offline-notice">ãŠã‹ãˆã‚Šãªã•ã„ï¼ä¸åœ¨ä¸­ã®åç›Šã‚’ç²å¾—ã—ã¾ã—ãŸã€‚</div>

<div id="reward-modal" onclick="if(event.target===this) discardRewards()">
    <div class="modal-content" style="width: 600px;">
        <button class="close-modal-btn" onclick="discardRewards()">Ã—</button>
        <h2 id="reward-title" style="color:var(--accent);">æ¢ç´¢ã‹ã‚‰å¸°é‚„ï¼</h2>
        <p id="reward-desc">æŒã¡å¸°ã‚‹å‡ºç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
        <p id="reward-count-msg" style="color:var(--auto-color); font-weight:bold;"></p>
        <div style="display:flex; justify-content:center; gap:15px; flex-wrap:wrap;" id="reward-list"></div>
        <div id="fusion-action-area" style="display:none; margin-top:20px;">
            <button id="btn-do-fuse" onclick="executeFusion()" disabled style="background:var(--mode-fusion); border:none; color:white; padding:10px 30px; border-radius:20px; font-weight:bold; font-size:1.1rem; cursor:not-allowed; opacity:0.5;">èåˆã‚’å®Ÿè¡Œ</button>
        </div>
        <button id="reward-cancel-btn" onclick="discardRewards()" style="margin-top:20px; background:#444; border:none; color:white; padding:10px 20px; border-radius:5px; cursor:pointer;">çµ‚äº†</button>
    </div>
</div>

<div id="pool-detail-modal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-content" style="width: 600px;">
        <button class="close-modal-btn" onclick="document.getElementById('pool-detail-modal').style.display='none'">Ã—</button>
        <h2 style="color:var(--skill-line);">ãƒ—ãƒ¼ãƒ«ã®è©³ç´°</h2>
        <div id="pool-detail-content" class="pool-detail-grid"></div>
        <button onclick="document.getElementById('pool-detail-modal').style.display='none'" style="margin-top:20px; background:#444; border:none; color:white; padding:10px 20px; border-radius:5px; cursor:pointer;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<button id="shop-trigger" onclick="toggleModal(true)">
    ğŸ“
    <span id="shop-badge"></span>
</button>

<div id="upgrade-modal" onclick="if(event.target===this) toggleModal(false)">
    <div class="modal-content">
        <button class="close-modal-btn" onclick="toggleModal(false)">Ã—</button>
        <h2 style="color:var(--skill-line); margin:0;">SKILL TREE</h2>
        <p style="color:var(--accent);">æ‰€æŒã‚¹ã‚³ã‚¢: <span id="modal-score">0</span> pts</p>
        
        <div class="tree-container" id="tree-root">
            <svg class="svg-overlay" id="tree-svg"></svg>
            
            <div class="tree-row">
                <div id="node-finger" class="skill-node available" onclick="buyUpgrade('finger')"><span class="skill-icon">â˜ï¸</span><span id="lv-finger" class="lv-badge"></span><div class="skill-tooltip" id="tip-finger"></div></div>
            </div>

            <div class="tree-row" style="gap: 120px;">
                <div id="node-auto" class="skill-node locked" onclick="buyUpgrade('auto')"><span class="skill-icon" id="icon-auto">ğŸ¤–</span><span id="lv-auto" class="lv-badge"></span><div class="skill-tooltip" id="tip-auto"></div></div>
                <div id="node-field" class="skill-node locked" onclick="buyUpgrade('field')"><span class="skill-icon" id="icon-field">ğŸ²</span><span id="lv-field" class="lv-badge"></span><div class="skill-tooltip" id="tip-field"></div></div>
            </div>

            <div class="tree-row" style="gap: 20px;">
                <div style="display:flex; gap:20px; margin-right: 60px;">
                    <div id="node-expedition" class="skill-node locked" onclick="buyUpgrade('expedition')"><span class="skill-icon" id="icon-expedition">ğŸ§­</span><span id="lv-expedition" class="lv-badge"></span><div class="skill-tooltip" id="tip-expedition"></div></div>
                    <div id="node-history" class="skill-node locked" onclick="buyUpgrade('history')"><span class="skill-icon" id="icon-history">ğŸ“–</span><span id="lv-history" class="lv-badge"></span><div class="skill-tooltip" id="tip-history"></div></div>
                    <div id="node-speed" class="skill-node locked" onclick="buyUpgrade('speed')"><span class="skill-icon" id="icon-speed">âš¡</span><span id="lv-speed" class="lv-badge"></span><div class="skill-tooltip" id="tip-speed"></div></div>
                    <div id="node-yaku_none" class="skill-node locked" onclick="buyUpgrade('yaku_none')"><span class="skill-icon" id="icon-yaku_none">â”</span><span id="lv-yaku_none" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_none"></div></div>
                </div>

                <div id="node-potential" class="skill-node locked" onclick="buyUpgrade('potential')"><span class="skill-icon" id="icon-potential">ğŸ’</span><span id="lv-potential" class="lv-badge"></span><div class="skill-tooltip" id="tip-potential"></div></div>
            </div>

            <div class="tree-row" style="gap: 15px; justify-content: flex-start; padding-left: 20px;">
                <div id="node-ritual_unlock" class="skill-node locked" onclick="buyUpgrade('ritual_unlock')"><span class="skill-icon" id="icon-ritual_unlock">ğŸ”®</span><span id="lv-ritual_unlock" class="lv-badge"></span><div class="skill-tooltip" id="tip-ritual_unlock"></div></div>
                
                <div id="node-exp_speed" class="skill-node locked" onclick="buyUpgrade('exp_speed')"><span class="skill-icon" id="icon-exp_speed">â©</span><span id="lv-exp_speed" class="lv-badge"></span><div class="skill-tooltip" id="tip-exp_speed"></div></div>

                <div id="node-exp_amount" class="skill-node locked" onclick="buyUpgrade('exp_amount')"><span class="skill-icon" id="icon-exp_amount">ğŸ“¦</span><span id="lv-exp_amount" class="lv-badge"></span><div class="skill-tooltip" id="tip-exp_amount"></div></div>

                <div id="node-digital_history" class="skill-node locked" onclick="buyUpgrade('digital_history')"><span class="skill-icon" id="icon-digital_history">ğŸ“±</span><span id="lv-digital_history" class="lv-badge"></span><div class="skill-tooltip" id="tip-digital_history"></div></div>

                <div id="node-throw" class="skill-node locked" onclick="buyUpgrade('throw')"><span class="skill-icon" id="icon-throw">ğŸ¯</span><span id="lv-throw" class="lv-badge"></span><div class="skill-tooltip" id="tip-throw"></div></div>

                <div id="node-yaku_normal" class="skill-node locked" onclick="buyUpgrade('yaku_normal')"><span class="skill-icon" id="icon-yaku_normal">âš‚</span><span id="lv-yaku_normal" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_normal"></div></div>
            </div>

            <div class="tree-row" style="gap: 15px; justify-content: flex-start; padding-left: 20px;">
                <div id="node-ritual_amount" class="skill-node locked" onclick="buyUpgrade('ritual_amount')"><span class="skill-icon" id="icon-ritual_amount">ğŸŒ‘</span><span id="lv-ritual_amount" class="lv-badge"></span><div class="skill-tooltip" id="tip-ritual_amount"></div></div>
                
                <div style="width: 360px;"></div>
                
                <div id="node-yaku_456" class="skill-node locked" onclick="buyUpgrade('yaku_456')"><span class="skill-icon" id="icon-yaku_456">âœ¨</span><span id="lv-yaku_456" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_456"></div></div>
            </div>

            <div class="tree-row" style="gap: 15px; justify-content: flex-start; padding-left: 20px;">
                <div id="node-fusion_exp" class="skill-node locked" onclick="buyUpgrade('fusion_exp')" style="display:none;"><span class="skill-icon" style="color:var(--mode-fusion)">ğŸ”¥</span><span id="lv-fusion_exp" class="lv-badge"></span><div class="skill-tooltip" id="tip-fusion_exp"></div></div>
                <div id="node-fusion_exp_amount" class="skill-node locked" onclick="buyUpgrade('fusion_exp_amount')" style="display:none;"><span class="skill-icon" style="color:var(--mode-fusion)">ğŸ“¦</span><span id="lv-fusion_exp_amount" class="lv-badge"></span><div class="skill-tooltip" id="tip-fusion_exp_amount"></div></div>

                <div style="width: 290px;"></div>
                <div id="node-yaku_arashi" class="skill-node locked" onclick="buyUpgrade('yaku_arashi')"><span class="skill-icon" id="icon-yaku_arashi">ğŸŒ€</span><span id="lv-yaku_arashi" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_arashi"></div></div>
            </div>

            <div class="tree-row" style="gap: 15px; justify-content: flex-start; padding-left: 20px;">
                <div style="width: 450px;"></div>
                <div id="node-yaku_pin" class="skill-node locked" onclick="buyUpgrade('yaku_pin')"><span class="skill-icon" id="icon-yaku_pin">ğŸ”¥</span><span id="lv-yaku_pin" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_pin"></div></div>
            </div>

            <div class="tree-row" id="row-yaku-s4" style="gap: 15px; justify-content: flex-start; padding-left: 20px; display:none;">
                <div style="width: 450px;"></div>
                <div id="node-yaku_straight4" class="skill-node locked" onclick="buyUpgrade('yaku_straight4')"><span class="skill-icon">4ï¸âƒ£</span><span id="lv-yaku_straight4" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_straight4"></div></div>
            </div>

            <div class="tree-row" id="row-yaku-a4" style="gap: 15px; justify-content: flex-start; padding-left: 20px; display:none;">
                <div style="width: 450px;"></div>
                <div id="node-yaku_arashi4" class="skill-node locked" onclick="buyUpgrade('yaku_arashi4')"><span class="skill-icon">ğŸŒªï¸</span><span id="lv-yaku_arashi4" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_arashi4"></div></div>
            </div>

            <div class="tree-row" id="row-yaku-5" style="gap: 30px; justify-content: flex-start; padding-left: 20px; display:none;">
                <div style="width: 420px;"></div>
                <div id="node-yaku_straight5" class="skill-node locked" onclick="buyUpgrade('yaku_straight5')"><span class="skill-icon">5ï¸âƒ£</span><span id="lv-yaku_straight5" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_straight5"></div></div>
                <div id="node-yaku_arashi5" class="skill-node locked" onclick="buyUpgrade('yaku_arashi5')"><span class="skill-icon">ğŸŒˆ</span><span id="lv-yaku_arashi5" class="lv-badge"></span><div class="skill-tooltip" id="tip-yaku_arashi5"></div></div>
            </div>
        </div>

        <button onclick="toggleModal(false)" style="margin-top:30px; width:100%; padding:12px; background:#333; border:none; color:white; border-radius:8px; cursor:pointer;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="reinc-modal" class="reinc-bg">
    <div class="modal-content reinc-bg">
        <h2 style="color:var(--reinc-color); margin:0;">REINCARNATION</h2>
        <p style="color:var(--reinc-color); font-weight:bold; font-size:1.2rem;">æ‰€æŒãƒã‚¤ãƒ³ãƒˆ: <span id="reinc-point-disp">0</span> Pt</p>
        
        <div id="reinc-action-area" style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #7d3c98;">
            <p>ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ã«åŸºã¥ãç²å¾—å¯èƒ½ãƒã‚¤ãƒ³ãƒˆ: <span id="pending-rp" style="color:white; font-weight:bold;">0</span></p>
            <p style="font-size:0.8rem; color:#aaa;">(å¼: (log10(Score)*20)-180)</p>
            <p id="reinc-gain-msg" style="color:#e056fd; font-weight:bold;"></p>
            <div style="display:flex; justify-content:center; gap:10px;">
                <button id="do-reinc-btn" onclick="doReincarnation()" style="background:linear-gradient(135deg, #a723e7, #5f27cd); color:white; border:none; padding:10px 30px; border-radius:20px; font-weight:bold; font-size:1.1rem; cursor:pointer; margin-top:10px;">è»¢ç”Ÿã‚’å®Ÿè¡Œã™ã‚‹</button>
                <button onclick="toggleReincModal(false)" style="background:#555; color:white; border:none; padding:10px 20px; border-radius:20px; font-weight:bold; font-size:1rem; cursor:pointer; margin-top:10px;">é–‰ã˜ã‚‹</button>
            </div>
            <div style="font-size:0.7rem; color:#f39c12; margin-top:5px;">â€»å®Ÿè¡Œã™ã‚‹ã¨å³åº§ã«ã‚¹ã‚³ã‚¢ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</div>
        </div>

        <div id="reinc-finish-area" style="display:none; background:rgba(45, 15, 56, 0.8); padding:15px; border-radius:10px; margin-bottom:20px; border:2px solid #2ecc71;">
             <p id="reinc-gain-msg-2" style="color:#2ecc71; font-weight:bold; font-size:1.2rem; margin:0;">è»¢ç”Ÿå®Œäº†ï¼</p>
             <p style="font-size:0.9rem;">ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚<br>æº–å‚™ãŒã§ããŸã‚‰ä¸‹ã®ãƒœã‚¿ãƒ³ã§å‡ºç™ºã—ã¾ã—ã‚‡ã†ã€‚</p>
             <button onclick="finishReincarnation()" style="background:linear-gradient(135deg, #2ecc71, #27ae60); color:white; border:none; padding:15px 40px; border-radius:30px; font-weight:bold; font-size:1.3rem; cursor:pointer; margin-top:10px; box-shadow:0 0 15px rgba(46, 204, 113, 0.5);">æ–°ã—ã„ä¸–ç•Œã¸æ—…ç«‹ã¤</button>
        </div>

        <h3 style="color:var(--reinc-color); border-bottom:1px solid var(--reinc-color);">è»¢ç”Ÿã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</h3>
        <p id="reinc-view-mode-msg">â€»ãƒ©ãƒ³ã®é€”ä¸­ã®ãŸã‚ã€å†…å®¹ã®ç¢ºèªã®ã¿å¯èƒ½ã§ã™</p>
        
        <div class="tree-container" id="reinc-tree-root" style="margin-top:20px;">
            <svg class="svg-overlay" id="reinc-tree-svg"></svg>
            
            <div class="tree-row">
                <div id="rnode-wallet" class="skill-node reinc-node available" onclick="buyReincUpgrade('wallet')"><span class="skill-icon">ğŸ‘›</span><span id="rlv-wallet" class="lv-badge"></span><div class="skill-tooltip" id="rtip-wallet"></div></div>
            </div>
            
            <div class="tree-row" style="gap:50px;">
                <div id="rnode-greedy_exp" class="skill-node reinc-node locked" onclick="buyReincUpgrade('greedy_exp')"><span class="skill-icon">ğŸ¤©</span><span id="rlv-greedy_exp" class="lv-badge"></span><div class="skill-tooltip" id="rtip-greedy_exp"></div></div>
                <div id="rnode-greedy_rit" class="skill-node reinc-node locked" onclick="buyReincUpgrade('greedy_rit')"><span class="skill-icon">ğŸ˜ˆ</span><span id="rlv-greedy_rit" class="lv-badge"></span><div class="skill-tooltip" id="rtip-greedy_rit"></div></div>
            </div>

            <div class="tree-row">
                <div id="rnode-privatize" class="skill-node reinc-node locked" onclick="buyReincUpgrade('privatize')"><span class="skill-icon">ğŸ”¢</span><span id="rlv-privatize" class="lv-badge"></span><div class="skill-tooltip" id="rtip-privatize"></div></div>
            </div>

            <div class="tree-row">
                <div id="rnode-straight" class="skill-node reinc-node locked" onclick="buyReincUpgrade('straight')"><span class="skill-icon">ğŸ“</span><span id="rlv-straight" class="lv-badge"></span><div class="skill-tooltip" id="rtip-straight"></div></div>
            </div>

            <div class="tree-row">
                <div id="rnode-fusion_dim" class="skill-node reinc-node locked" onclick="buyReincUpgrade('fusion_dim')"><span class="skill-icon">ğŸŒŒ</span><span id="rlv-fusion_dim" class="lv-badge"></span><div class="skill-tooltip" id="rtip-fusion_dim"></div></div>
                <div id="rnode-fusion_limit" class="skill-node reinc-node locked" onclick="buyReincUpgrade('fusion_limit')"><span class="skill-icon">ğŸ§±</span><span id="rlv-fusion_limit" class="lv-badge"></span><div class="skill-tooltip" id="rtip-fusion_limit"></div></div>
            </div>

            <div class="tree-row" style="gap:150px;">
                <div id="rnode-straight4" class="skill-node reinc-node locked" onclick="buyReincUpgrade('straight4')"><span class="skill-icon">4ï¸âƒ£</span><span id="rlv-straight4" class="lv-badge"></span><div class="skill-tooltip" id="rtip-straight4"></div></div>
                <div id="rnode-rare_magic" class="skill-node reinc-node locked" onclick="buyReincUpgrade('rare_magic')"><span class="skill-icon" style="color:var(--rare-magic)">M</span><span id="rlv-rare_magic" class="lv-badge"></span><div class="skill-tooltip" id="rtip-rare_magic"></div></div>
            </div>

            <div class="tree-row" style="gap:150px;">
                <div id="rnode-arashi4" class="skill-node reinc-node locked" onclick="buyReincUpgrade('arashi4')"><span class="skill-icon">ğŸŒªï¸</span><span id="rlv-arashi4" class="lv-badge"></span><div class="skill-tooltip" id="rtip-arashi4"></div></div>
                <div id="rnode-rare_epic" class="skill-node reinc-node locked" onclick="buyReincUpgrade('rare_epic')"><span class="skill-icon" style="color:var(--rare-epic)">E</span><span id="rlv-rare_epic" class="lv-badge"></span><div class="skill-tooltip" id="rtip-rare_epic"></div></div>
            </div>

            <div class="tree-row" style="gap:150px;">
                <div id="rnode-straight5" class="skill-node reinc-node locked" onclick="buyReincUpgrade('straight5')"><span class="skill-icon">5ï¸âƒ£</span><span id="rlv-straight5" class="lv-badge"></span><div class="skill-tooltip" id="rtip-straight5"></div></div>
                <div id="rnode-rare_legend" class="skill-node reinc-node locked" onclick="buyReincUpgrade('rare_legend')"><span class="skill-icon" style="color:var(--rare-legendary)">L</span><span id="rlv-rare_legend" class="lv-badge"></span><div class="skill-tooltip" id="rtip-rare_legend"></div></div>
            </div>

            <div class="tree-row" style="gap:150px;">
                <div id="rnode-arashi5" class="skill-node reinc-node locked" onclick="buyReincUpgrade('arashi5')"><span class="skill-icon">ğŸŒˆ</span><span id="rlv-arashi5" class="lv-badge"></span><div class="skill-tooltip" id="rtip-arashi5"></div></div>
                <div id="rnode-rare_eternal" class="skill-node reinc-node locked" onclick="buyReincUpgrade('rare_eternal')"><span class="skill-icon" style="color:#fff; text-shadow:0 0 5px #fff;">âˆ</span><span id="rlv-rare_eternal" class="lv-badge"></span><div class="skill-tooltip" id="rtip-rare_eternal"></div></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
    let score = 0;
    let totalScore = 0;
    let multiplier = 1;
    let hasAutoRoll = false;
    let fieldCount = 1;
    let fieldTimers = [];
    let scoreHistory = [];
    let dicePool = [];
    const AUTO_BASE_TIME = 6000;
    let isResetting = false;
    let isReincarnationPhase = false;

    let reincData = {
        points: 0,       
        maxReachedRP: 0, 
        upgrades: {}
    };
    const REINC_THRESHOLD = 10000000000; // 100å„„

    let expStatus = 'idle'; 
    let expMode = 'normal'; 
    let expTimeRemaining = 0;
    const EXP_DURATION_BASE = 180 * 1000; 
    let expNextCost = 15000;
    let ritualNextCost = 500000; 
    let fusionNextCost = 10000000; // èåˆæ¢ç´¢åˆæœŸã‚³ã‚¹ãƒˆ
    
    let currentRewards = []; 
    let rewardSelectCount = 1; 

    let lastTickTime = Date.now();

    // ãƒ¬ã‚¢ãƒªãƒ†ã‚£å®šç¾©ï¼ˆé †åºé‡è¦ï¼‰
    const RARITY_ORDER = ['common', 'uncommon', 'rare', 'super', 'ultra', 'magic', 'epic', 'legendary', 'eternal'];
    let RARITIES = {};

    const upgState = {
        finger: { lv: 0, max: 3, costs: [100, 1000, 3000], name: "é»„é‡‘ã®æŒ‡", icon: "â˜ï¸", desc: "ç²å¾—ã‚¹ã‚³ã‚¢+100%", req: null },
        auto: { lv: 0, max: 1, costs: [3000], name: "è‡ªå‹•ãƒ­ãƒ¼ãƒ«", icon: "ğŸ¤–", desc: "è‡ªå‹•ã§ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã‚‹", req: "finger" },
        field: { lv: 0, max: 9, costs: [2000, 5000, 10000, 30000, 70000, 150000, 300000, 500000, 1000000], name: "å ´ã‚’è¿½åŠ ", icon: "ğŸ²", desc: "å ´ã‚’å¢—ã‚„ã™", req: "finger" },
        expedition: { lv: 0, max: 1, costs: [15000], name: "é€šå¸¸æ¢ç´¢", icon: "ğŸ§­", desc: "å‡ºç›®æ¢ç´¢ã‚’è§£æ”¾", req: "auto" },
        history: { lv: 0, max: 1, costs: [100], name: "å®¶è¨ˆç°¿", icon: "ğŸ“–", desc: "é…å½“TOP5ã‚’è¡¨ç¤º", req: "auto" },
        speed: { lv: 0, max: 20, costs: Array.from({length:20}, (_,i)=>Math.floor(5000 * Math.pow(2.0, i))), name: "æ™‚é–“çŸ­ç¸®", icon: "âš¡", desc: "è‡ªå‹•é–“éš”-0.2s", req: "auto" },
        digital_history: { lv: 0, max: 1, costs: [300], name: "é›»å­å®¶è¨ˆç°¿", icon: "ğŸ“±", desc: "ãƒ—ãƒ¼ãƒ«ã®è©³ç´°ã‚’ç¢ºèªå¯èƒ½ã«ã™ã‚‹", req: ["history", "expedition"] },
        potential: { lv: 0, max: 2, costs: [50000, 50000000], name: "ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«", icon: "ğŸ’", desc: "ãƒ€ã‚¤ã‚¹æ•°+1", req: "field" },
        exp_speed: { lv: 0, max: 10, costs: Array.from({length:10}, (_,i)=>100000 * Math.pow(1.5, i)), name: "æ¢ç´¢çŸ­ç¸®", icon: "â©", desc: "æ¢ç´¢æ™‚é–“ -16ç§’", req: "expedition" },
        exp_amount: { lv: 0, max: 3, costs: [1000000, 5000000, 20000000], name: "é€šå¸¸æ¢ç´¢å¼·åŒ–", icon: "ğŸ“¦", desc: "æ¢ç´¢ã®é¸æŠè‚¢+1", req: "expedition" },
        
        ritual_unlock: { lv: 0, max: 1, costs: [500000], name: "å„€å¼æ¢ç´¢", icon: "ğŸ”®", desc: "ãƒ—ãƒ¼ãƒ«å‰Šé™¤å¯èƒ½ãªå„€å¼ã‚’è§£æ”¾", req: "expedition" },
        ritual_amount: { lv: 0, max: 3, costs: [1000000, 5000000, 20000000], name: "å„€å¼æ¢ç´¢å¼·åŒ–", icon: "ğŸŒ‘", desc: "å„€å¼ã®é¸æŠè‚¢+1", req: "ritual_unlock" },

        fusion_exp: { lv: 0, max: 1, costs: [10000000], name: "èåˆæ¢ç´¢", icon: "ğŸ”¥", desc: "å‡ºç›®ã‚’èåˆã—å¼·åŒ–ã™ã‚‹æ¢ç´¢ã‚’è§£æ”¾", req: "ritual_amount", reincReq: "fusion_dim" },
        fusion_exp_amount: { lv: 0, max: 3, costs: [50000000, 5000000000, 500000000000], name: "èåˆæ¢ç´¢å¼·åŒ–", icon: "ğŸ“¦", desc: "èåˆå€™è£œã®é¸æŠè‚¢+1", req: "fusion_exp", reincReq: "fusion_dim" },

        throw: { lv: 0, max: 5, costs: [100000, 1000000, 10000000, 100000000, 1000000000], name: "æŠ•æ“²æŠ€è¡“", icon: "ğŸ¯", desc: "æ¼”å‡ºçŸ­ç¸®", req: "speed" },
        yaku_none: { lv: 0, max: 10, costs: Array.from({length:10}, (_,i)=>2500 * Math.pow(4, i)), name: "ç›®ãªã—å¼·åŒ–", icon: "â•", desc: "ç›®ãªã—+400%", req: "auto" },
        yaku_normal: { lv: 0, max: 10, costs: Array.from({length:10}, (_,i)=>5000 * Math.pow(4, i)), name: "é€šå¸¸ç›®å¼·åŒ–", icon: "âš‚", desc: "é€šå¸¸ç›®+400%", req: "yaku_none" },
        yaku_456: { lv: 0, max: 10, costs: Array.from({length:10}, (_,i)=>10000 * Math.pow(4, i)), name: "ã‚·ã‚´ãƒ­å¼·åŒ–", icon: "âœ¨", desc: "ã‚·ã‚´ãƒ­+400%", req: "yaku_normal" },
        yaku_arashi: { lv: 0, max: 10, costs: Array.from({length:10}, (_,i)=>10000 * Math.pow(4, i)), name: "ã‚¢ãƒ©ã‚·å¼·åŒ–", icon: "ğŸŒ€", desc: "ã‚¢ãƒ©ã‚·+400%", req: "yaku_456" },
        yaku_pin: { lv: 0, max: 10, costs: Array.from({length:10}, (_,i)=>10000 * Math.pow(4, i)), name: "ãƒ”ãƒ³ã‚¾ãƒ­å¼·åŒ–", icon: "ğŸ”¥", desc: "ãƒ”ãƒ³ã‚¾ãƒ­+400%", req: "yaku_arashi" },

        yaku_straight4: { lv: 0, max: 10, costs: Array.from({length:10}, (_,i)=>100000 * Math.pow(2, i)), name: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ4å¼·åŒ–", icon: "4ï¸âƒ£", desc: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ4+400%", req: "yaku_pin", reincReq: "straight4" },
        yaku_arashi4: { lv: 0, max: 10, costs: Array.from({length:10}, (_,i)=>200000 * Math.pow(2, i)), name: "ã‚¢ãƒ©ã‚·4å¼·åŒ–", icon: "ğŸŒªï¸", desc: "ã‚¢ãƒ©ã‚·4+400%", req: "yaku_straight4", reincReq: "arashi4" },
        yaku_straight5: { lv: 0, max: 10, costs: Array.from({length:10}, (_,i)=>1000000 * Math.pow(2, i)), name: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ5å¼·åŒ–", icon: "5ï¸âƒ£", desc: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ5+400%", req: "yaku_arashi4", reincReq: "straight5" },
        yaku_arashi5: { lv: 0, max: 10, costs: Array.from({length:10}, (_,i)=>2000000 * Math.pow(2, i)), name: "ã‚¢ãƒ©ã‚·5å¼·åŒ–", icon: "ğŸŒˆ", desc: "ã‚¢ãƒ©ã‚·5+400%", req: "yaku_arashi4", reincReq: "arashi5" }
    };
    
    const reincUpgInfo = {
        wallet: { lv: 0, max: 20, costs: [1], name: "å‰ä¸–ã®è²¡å¸ƒ", icon: "ğŸ‘›", desc: "è»¢ç”Ÿç›´å¾Œã®ã‚¹ã‚³ã‚¢+10ä¸‡", req: null, fixedCost: true },
        greedy_exp: { lv: 0, max: 2, costs: [4, 12], name: "å¼·æ¬²ãªé å¾", icon: "ğŸ¤©", desc: "é€šå¸¸æ¢ç´¢ã§é¸ã¹ã‚‹æ•°+1", req: "wallet" },
        greedy_rit: { lv: 0, max: 2, costs: [4, 12], name: "å¼·æ¬²ãªå„€å¼", icon: "ğŸ˜ˆ", desc: "å„€å¼æ¢ç´¢ã§æ¶ˆã›ã‚‹æ•°+1", req: "wallet" },
        privatize: { lv: 0, max: 1, costs: [5], name: "æ•°å­—ã®ç§ç‰©åŒ–", icon: "ğŸ”¢", desc: "ã‚¢ãƒ©ã‚·ãƒ»ã‚·ã‚´ãƒ­è¨ˆç®—å¼å¤‰æ›´", req: ["greedy_exp", "greedy_rit"] },
        straight: { lv: 0, max: 1, costs: [6], name: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ", icon: "ğŸ“", desc: "é€£ç•ª(234,345ç­‰)ã‚’å½¹ã¨ã—ã¦æ‰±ã†", req: "privatize" },
        
        fusion_dim: { lv: 0, max: 1, costs: [10], name: "èåˆæ¬¡å…ƒ", icon: "ğŸŒŒ", desc: "ï¼ˆæœªå®Ÿè£…ï¼‰æ¬¡å…ƒã®å£ãŒè–„ããªã‚‹...ï¼Ÿ", req: "straight" },
        fusion_limit: { lv: 0, max: 10, costs: [2], name: "èåˆä¸Šé™", icon: "ğŸ§±", desc: "èåˆå‡ºç›®ã®ä¸Šé™+3", req: "fusion_dim", fixedCost: true },
        
        straight4: { lv: 0, max: 1, costs: [5], name: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼”", icon: "4ï¸âƒ£", desc: "4ã¤ã®é€£ç•ªã§å½¹æˆç«‹<br>åˆè¨ˆ*10000", req: "fusion_dim" },
        arashi4: { lv: 0, max: 1, costs: [5], name: "ã‚¢ãƒ©ã‚·ï¼”", icon: "ğŸŒªï¸", desc: "4ã¤ã®åŒæ•°ã§å½¹æˆç«‹<br>åˆè¨ˆ*20000", req: "straight4" },
        
        straight5: { lv: 0, max: 1, costs: [10], name: "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼•", icon: "5ï¸âƒ£", desc: "5ã¤ã®é€£ç•ªã§å½¹æˆç«‹<br>åˆè¨ˆ*50000", req: "arashi4" },
        arashi5: { lv: 0, max: 1, costs: [10], name: "ã‚¢ãƒ©ã‚·ï¼•", icon: "ğŸŒˆ", desc: "5ã¤ã®åŒæ•°ã§å½¹æˆç«‹<br>åˆè¨ˆ*100000", req: "straight5" }, 

        rare_magic: { lv: 0, max: 1, costs: [5], name: "ãƒ¬ã‚¢ãƒªãƒ†ã‚£ï¼šãƒã‚¸ãƒƒã‚¯", icon: "M", desc: "ãƒã‚¸ãƒƒã‚¯(x64)ã‚’è¿½åŠ ", req: "fusion_dim" },
        rare_epic: { lv: 0, max: 1, costs: [5], name: "ãƒ¬ã‚¢ãƒªãƒ†ã‚£ï¼šã‚¨ãƒ”ãƒƒã‚¯", icon: "E", desc: "ã‚¨ãƒ”ãƒƒã‚¯(x128)ã‚’è¿½åŠ ", req: "rare_magic" },
        rare_legend: { lv: 0, max: 1, costs: [10], name: "ãƒ¬ã‚¢ãƒªãƒ†ã‚£ï¼šãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼", icon: "L", desc: "ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼(x256)ã‚’è¿½åŠ ", req: "rare_epic" },
        rare_eternal: { lv: 0, max: 1, costs: [10], name: "ãƒ¬ã‚¢ãƒªãƒ†ã‚£ï¼šã‚¨ã‚¿ãƒ¼ãƒŠãƒ«", icon: "âˆ", desc: "ã‚¨ã‚¿ãƒ¼ãƒŠãƒ«(x512)ã‚’è¿½åŠ ", req: "rare_legend" }
    };

    function updateRarityDefinitions() {
        RARITIES = {
            common: { name: "ã‚³ãƒ¢ãƒ³", weight: 5000, mult: 1, color: "var(--rare-common)", class: "rarity-common" },
            uncommon: { name: "ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³", weight: 3500, mult: 4, color: "var(--rare-uncommon)", class: "rarity-uncommon" },
            rare: { name: "ãƒ¬ã‚¢", weight: 1000, mult: 8, color: "var(--rare-rare)", class: "rarity-rare" },
            super: { name: "ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¬ã‚¢", weight: 350, mult: 16, color: "var(--rare-super)", class: "rarity-super" },
            ultra: { name: "ã‚¦ãƒ«ãƒˆãƒ©ãƒ¬ã‚¢", weight: 150, mult: 32, color: "var(--rare-ultra)", class: "rarity-ultra" }
        };
        
        if (reincData && reincData.upgrades) {
            if (reincData.upgrades.rare_magic > 0) RARITIES.magic = { name: "ãƒã‚¸ãƒƒã‚¯", weight: 100, mult: 64, color: "var(--rare-magic)", class: "rarity-magic" };
            if (reincData.upgrades.rare_epic > 0) RARITIES.epic = { name: "ã‚¨ãƒ”ãƒƒã‚¯", weight: 50, mult: 128, color: "var(--rare-epic)", class: "rarity-epic" };
            if (reincData.upgrades.rare_legend > 0) RARITIES.legendary = { name: "ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼", weight: 25, mult: 256, color: "var(--rare-legendary)", class: "rarity-legendary" };
            if (reincData.upgrades.rare_eternal > 0) RARITIES.eternal = { name: "ã‚¨ã‚¿ãƒ¼ãƒŠãƒ«", weight: 10, mult: 512, color: "#fff", class: "rarity-eternal" };
        }
    }

    function formatScore(num) {
        if (num < 10000) return Math.floor(num).toLocaleString();
        const units = ["", "ä¸‡", "å„„", "å…†", "äº¬", "å“", "ğ¥±", "æº", "æ¾—", "æ­£", "è¼‰", "æ¥µ"];
        let unitIdx = 0, tempNum = num;
        while (tempNum >= 10000 && unitIdx < units.length - 1) { tempNum /= 10000; unitIdx++; }
        return (Math.floor(tempNum * 100) / 100) + units[unitIdx];
    }

    const debugCode = ["KeyW", "KeyW", "KeyS", "KeyS", "KeyA", "KeyD", "KeyA", "KeyD", "KeyA", "KeyB"];
    let inputBuffer = [];
    window.addEventListener('keydown', (e) => {
        inputBuffer.push(e.code);
        if (inputBuffer.length > debugCode.length) inputBuffer.shift();
        if (JSON.stringify(inputBuffer) === JSON.stringify(debugCode)) {
            const val = prompt("ã€ãƒ‡ãƒãƒƒã‚°ã€‘ã‚¹ã‚³ã‚¢åŠ ç®—");
            if (val) { score += parseFloat(val); totalScore += parseFloat(val); updateUI(); }
        }
        if(e.code === "KeyT" && expStatus === 'running') expTimeRemaining = 100;
    });

    function saveGame() {
        if (isResetting) return;
        const saveObj = {
            score, totalScore, multiplier,
            expNextCost, ritualNextCost, fusionNextCost,
            dicePool, upgLevels: {}, 
            reincData, scoreHistory,
            ver: 6.8,
            lastSaveTime: Date.now() 
        };
        for(let key in upgState) saveObj.upgLevels[key] = upgState[key].lv;
        localStorage.setItem('chinchiro_clicker_save', JSON.stringify(saveObj));
        const notice = document.getElementById('save-notice');
        notice.style.opacity = 1; setTimeout(() => notice.style.opacity = 0, 2000);
    }

    function loadGame() {
        const saveStr = localStorage.getItem('chinchiro_clicker_save');
        if (!saveStr) {
            initNewGame();
            return;
        }
        try {
            const saveObj = JSON.parse(saveStr);
            score = saveObj.score || 0;
            totalScore = saveObj.totalScore || 0;
            multiplier = saveObj.multiplier || 1;
            expNextCost = saveObj.expNextCost || 15000;
            ritualNextCost = saveObj.ritualNextCost || 500000;
            fusionNextCost = saveObj.fusionNextCost || 10000000;
            lastTickTime = saveObj.lastSaveTime || Date.now();
            
            if (saveObj.scoreHistory) scoreHistory = saveObj.scoreHistory;

            if(saveObj.dicePool && Array.isArray(saveObj.dicePool)) {
                 dicePool = saveObj.dicePool.filter(d => d !== null); // ä¸æ­£ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
            } else {
                 initNewGame();
            }
            
            if (dicePool.length === 0) initNewGame();

            if(saveObj.upgLevels) {
                for(let key in upgState) {
                    if (saveObj.upgLevels[key] !== undefined) upgState[key].lv = Math.min(saveObj.upgLevels[key], upgState[key].max);
                }
            }
            
            if (saveObj.reincData) {
                reincData = saveObj.reincData;
                if (!reincData.upgrades) reincData.upgrades = {};
                
                if (reincData.points === undefined || isNaN(reincData.points)) {
                    reincData.points = reincData.totalRP || 0;
                }
                
                if (reincData.maxReachedRP === undefined || isNaN(reincData.maxReachedRP)) {
                    reincData.maxReachedRP = reincData.maxRP || reincData.totalRP || 0;
                    if (reincData.maxReachedRP < reincData.points) reincData.maxReachedRP = reincData.points;
                }
                
                for (let k in reincUpgInfo) {
                    if (reincData.upgrades[k] === undefined) reincData.upgrades[k] = 0;
                }
            } else {
                reincData = { points:0, maxReachedRP:0, upgrades:{} };
                for (let k in reincUpgInfo) reincData.upgrades[k] = 0;
            }
            
            updateRarityDefinitions();

        } catch(e) {
            console.error("Save corrupted", e);
            initNewGame();
        }
    }
    
    function initNewGame() {
        dicePool = [];
        for(let v=1; v<=6; v++) for(let i=0; i<3; i++) dicePool.push({ val: v, rarity: 'common' });
        
        if (reincData && reincData.upgrades && reincData.upgrades.wallet > 0) {
            const bonus = reincData.upgrades.wallet * 100000;
            score += bonus;
            totalScore += bonus;
        }
        updateRarityDefinitions();
    }
    
    function resetGame() {
        if(!confirm("æœ¬å½“ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆè»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆã‚‚æ¶ˆãˆã¾ã™ï¼‰")) return;
        isResetting = true;
        localStorage.removeItem('chinchiro_clicker_save');
        location.reload();
    }

    function calcRP(currentTotalScore) {
        if (currentTotalScore < 100) return 0;
        const val = (Math.log10(currentTotalScore) * 20) - 180;
        return Math.floor(Math.max(0, val));
    }

    function openReincarnationModal() {
        const potentialRP = calcRP(totalScore);
        const gain = Math.max(0, potentialRP - reincData.maxReachedRP);
        
        document.getElementById('reinc-point-disp').textContent = reincData.points;
        document.getElementById('pending-rp').textContent = potentialRP;
        
        document.getElementById('reinc-action-area').style.display = 'block';
        document.getElementById('reinc-finish-area').style.display = 'none';

        const btn = document.getElementById('do-reinc-btn');
        const msg = document.getElementById('reinc-gain-msg');
        const viewMsg = document.getElementById('reinc-view-mode-msg');
        
        if (totalScore >= REINC_THRESHOLD && gain > 0) {
            msg.textContent = `è»¢ç”Ÿã™ã‚‹ã¨ +${gain} Pt ç²å¾—ã§ãã¾ã™ï¼`;
            btn.disabled = false;
            btn.style.opacity = 1;
            btn.style.cursor = "pointer";
        } else {
            msg.textContent = "â€»è»¢ç”Ÿã«ã¯ã‚¹ã‚³ã‚¢100å„„ä»¥ä¸Šã€ã‹ã¤æœ€é«˜è¨˜éŒ²ã®æ›´æ–°ãŒå¿…è¦ã§ã™";
            btn.disabled = true;
            btn.style.opacity = 0.5;
            btn.style.cursor = "not-allowed";
        }

        if (!isReincarnationPhase) {
            viewMsg.style.display = 'block';
        } else {
            viewMsg.style.display = 'none';
        }
        
        updateReincUI();
        toggleReincModal(true);
        setTimeout(drawReincLines, 50);
    }

    function toggleReincModal(show) {
        document.getElementById('reinc-modal').style.display = show ? 'flex' : 'none';
        if (!show && isReincarnationPhase) {
            finishReincarnation(); 
        }
    }

    function doReincarnation() {
        const potentialRP = calcRP(totalScore);
        const gain = Math.max(0, potentialRP - reincData.maxReachedRP);
        
        if (!confirm(`æœ¬å½“ã«è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿ\n+${gain} Pt ã‚’ç²å¾—ã—ã€ã‚¹ã‚³ã‚¢ç­‰ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚`)) return;
        
        reincData.points += gain;
        reincData.maxReachedRP = potentialRP;
        
        score = 0;
        totalScore = 0;
        multiplier = 1;
        expNextCost = 15000;
        ritualNextCost = 500000;
        fusionNextCost = 10000000;
        for(let k in upgState) upgState[k].lv = 0;
        hasAutoRoll = false;
        expStatus = 'idle';
        expTimeRemaining = 0;
        
        // ä¿®æ­£: ãƒ¢ãƒ¼ãƒ‰ã®ãƒªã‚»ãƒƒãƒˆã‚’æ˜ç¤ºçš„ã«è¡Œã†
        expMode = 'normal';
        currentRewards = [];
        rewardSelectCount = 0;
        
        initNewGame(); 
        
        document.getElementById('game-fields').innerHTML = '';
        fieldCount = 1;
        fieldTimers = [0];
        addField(0);
        document.getElementById('panel-history').style.display = 'none';
        document.getElementById('btn-pool-detail').style.display = 'none';
        document.getElementById('btn-mode-toggle').style.display = 'none';
        document.getElementById('expedition-panel').style.display = 'none';
        
        isReincarnationPhase = true;
        document.getElementById('reinc-action-area').style.display = 'none';
        document.getElementById('reinc-finish-area').style.display = 'block';
        document.getElementById('reinc-gain-msg-2').textContent = `è»¢ç”Ÿå®Œäº†ï¼ +${gain} Pt`;
        
        document.getElementById('reinc-view-mode-msg').style.display = 'none';

        updateReincUI();
        updateUI();
        saveGame();
    }
    
    function finishReincarnation() {
        isReincarnationPhase = false;
        document.getElementById('reinc-modal').style.display = 'none';
        saveGame();
    }

    function buyReincUpgrade(type) {
        if (!isReincarnationPhase) return;

        const upg = reincUpgInfo[type];
        const reqs = Array.isArray(upg.req) ? upg.req : (upg.req ? [upg.req] : []);
        const unlocked = reqs.every(r => reincData.upgrades[r] > 0);
        
        if (!unlocked) return;
        if (reincData.upgrades[type] >= upg.max) return;

        let cost = 0;
        if (upg.fixedCost) {
            cost = upg.costs[0];
        } else {
            cost = upg.costs[reincData.upgrades[type]];
        }

        if (reincData.points >= cost) {
            reincData.points -= cost;
            reincData.upgrades[type]++;
            
            if(type.startsWith('rare_')) updateRarityDefinitions();
            
            updateReincUI();
            
            if (type === 'wallet') {
                score += 100000;
                totalScore += 100000;
                updateUI();
            }
            saveGame();
        }
    }

    function updateReincUI() {
        document.getElementById('reinc-point-disp').textContent = reincData.points;
        
        for(let k in reincUpgInfo) {
            const u = reincUpgInfo[k];
            const n = document.getElementById('rnode-'+k);
            if(!n) continue;
            
            const reqs = Array.isArray(u.req) ? u.req : (u.req ? [u.req] : []);
            const open = reqs.length === 0 || reqs.every(r => reincData.upgrades[r] > 0);
            const isMax = reincData.upgrades[k] >= u.max;
            
            let cost = u.fixedCost ? u.costs[0] : u.costs[reincData.upgrades[k]];
            
            const canBuy = open && !isMax && reincData.points >= cost && isReincarnationPhase;
            
            n.className = `skill-node reinc-node ${open?(reincData.upgrades[k]>0?'unlocked':'available'):'locked'} ${isMax?'is-max':''} ${canBuy?'can-buy':''}`;
            document.getElementById('rlv-'+k).textContent = `Lv ${reincData.upgrades[k]}/${u.max}`;
            
            let tooltipHTML = `<strong>${u.name}</strong><br>${u.desc}<br>ã‚³ã‚¹ãƒˆ: ${isMax?'MAX':cost + ' Pt'}`;
            if (!open) {
                const reqNames = reqs.map(r => reincUpgInfo[r].name).join(', ');
                tooltipHTML += `<br><span style="color:#e74c3c; font-size:0.7rem;">(å‰æ: ${reqNames})</span>`;
            }
            document.getElementById('rtip-'+k).innerHTML = tooltipHTML;
        }
        drawReincLines();
    }

    function drawReincLines() {
        try {
            const svg = document.getElementById('reinc-tree-svg');
            const rootEl = document.getElementById('reinc-tree-root');
            if (!svg || !rootEl) return;
            const root = rootEl.getBoundingClientRect();
            svg.innerHTML = '';
            
            const conn = [
                ['wallet','greedy_exp'], ['wallet','greedy_rit'],
                ['greedy_exp','privatize'], ['greedy_rit','privatize'],
                ['privatize','straight'], ['straight', 'fusion_dim'], ['fusion_dim', 'fusion_limit'],
                ['fusion_dim', 'straight4'], ['straight4', 'arashi4'],
                ['arashi4', 'straight5'], ['straight5', 'arashi5'], 
                ['fusion_dim', 'rare_magic'], ['rare_magic', 'rare_epic'],
                ['rare_epic', 'rare_legend'], ['rare_legend', 'rare_eternal']
            ];
            
            conn.forEach(([p,c])=>{
                const pe = document.getElementById('rnode-'+p), ce = document.getElementById('rnode-'+c);
                if(!pe || !ce) return;
                const pr = pe.getBoundingClientRect(), cr = ce.getBoundingClientRect();
                
                // åº§æ¨™ãŒå–å¾—ã§ãã¦ã„ãªã„å ´åˆã‚¹ã‚­ãƒƒãƒ—
                if (pr.width === 0 || cr.width === 0) return;

                const l = document.createElementNS("http://www.w3.org/2000/svg","line");
                l.setAttribute("x1", pr.left+pr.width/2-root.left);
                l.setAttribute("y1", pr.top+pr.height/2-root.top);
                l.setAttribute("x2", cr.left+cr.width/2-root.left);
                l.setAttribute("y2", cr.top+cr.height/2-root.top);
                
                const isActive = reincData.upgrades[p] > 0;
                l.className.baseVal = "skill-line reinc-line " + (isActive?'active':'');
                svg.appendChild(l);
            });
        } catch(e) {
            console.error("ReincLines Error", e);
        }
    }

    // --- ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ– ---

    function init() {
        loadGame();
        
        if(upgState.finger.lv > 0) multiplier = 1 + upgState.finger.lv;
        if(upgState.auto.lv > 0) hasAutoRoll = true;
        fieldCount = 1 + upgState.field.lv;
        
        fieldTimers = Array(fieldCount).fill(0);
        document.getElementById('game-fields').innerHTML = '';
        for(let i=0; i<fieldCount; i++) addField(i);
        
        if (scoreHistory.length > 0) {
            renderHistory();
        }

        if (upgState.history.lv > 0) document.getElementById('panel-history').style.display = 'block';
        if (upgState.digital_history.lv > 0) document.getElementById('btn-pool-detail').style.display = 'block';

        setInterval(tick, 100);
        setInterval(saveGame, 10000);
        window.addEventListener('beforeunload', saveGame);
        
        updateUI();
        setTimeout(drawLines, 200);
    }

    function tick() {
        try {
            const now = Date.now();
            const dt = Math.max(0, now - lastTickTime); // æ™‚é–“é€†è¡Œé˜²æ­¢
            lastTickTime = now;
            
            const isOffline = dt > 5000; // 5ç§’ä»¥ä¸Šåˆ¤å®š
            let offlineActionCount = 0;

            if (hasAutoRoll) {
                const interval = Math.max(500, AUTO_BASE_TIME - (upgState.speed.lv * 200));
                for (let i = 0; i < fieldCount; i++) {
                    const btn = document.getElementById(`b-${i}`);
                    
                    if (btn && !btn.disabled) {
                        fieldTimers[i] = (fieldTimers[i] || 0) + dt;
                        
                        if (isOffline) {
                            if (fieldTimers[i] >= interval) {
                                let rolls = Math.floor(fieldTimers[i] / interval);
                                if (rolls > 2000) rolls = 2000; // ä¸Šé™
                                for(let r=0; r<rolls; r++) instantRoll(i);
                                offlineActionCount += rolls;
                                fieldTimers[i] %= interval; 
                            }
                        } else {
                            if (fieldTimers[i] >= interval) {
                                fieldTimers[i] = 0; 
                                playGame(i);        
                            }
                        }
                    }
                    const prog = document.getElementById(`prog-${i}`);
                    if (prog) prog.style.strokeDashoffset = 100 - (Math.min(fieldTimers[i], interval) / interval * 100);
                }
            }
            
            if (isOffline && offlineActionCount > 0) {
                 updateUI();
                 renderHistory();
                 const notice = document.getElementById('offline-notice');
                 notice.style.opacity = 1; 
                 setTimeout(() => notice.style.opacity = 0, 4000);
            }

            if (expStatus === 'running') {
                expTimeRemaining -= dt;
                const duration = Math.max(20000, EXP_DURATION_BASE - (upgState.exp_speed.lv * 16000));
                
                if (expTimeRemaining <= 0) {
                    expStatus = 'ready';
                    expTimeRemaining = 0;
                    const b = document.getElementById('exp-action-btn');
                    b.disabled = false; b.textContent = "å¸°é‚„ã™ã‚‹";
                    saveGame();
                }
                const p = document.getElementById('exp-prog');
                p.style.strokeDashoffset = (expTimeRemaining / duration) * 100;
                document.getElementById('exp-timer-text').textContent = Math.ceil(expTimeRemaining/1000) + "s";
            }
        } catch(e) {
            console.error("Tick Error", e);
        }
    }
    
    function instantRoll(id) {
        // å®‰å…¨ç­–: ãƒ—ãƒ¼ãƒ«ãŒç©ºãªã‚‰ç·Šæ€¥è£œå……
        if (dicePool.length === 0) initNewGame();

        const baseNum = 3; 
        const num = baseNum + upgState.potential.lv;
        const res = Array.from({length:num}, () => {
            const d = dicePool[Math.floor(Math.random()*dicePool.length)];
            return d || { val: 1, rarity: 'common' };
        });
        processResult(res, id, true);
    }

    // --- æ¢ç´¢ãƒ­ã‚¸ãƒƒã‚¯ ---
    function toggleExpeditionMode() {
        if (expStatus === 'running' || expStatus === 'ready') return;
        
        // ãƒ¢ãƒ¼ãƒ‰ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
        const modes = ['normal'];
        if (upgState.ritual_unlock.lv > 0) modes.push('ritual');
        // ä¿®æ­£: è»¢ç”ŸUGæ¡ä»¶ã‚’å³å¯†ã«ãƒã‚§ãƒƒã‚¯
        if (reincData && reincData.upgrades && reincData.upgrades.fusion_dim > 0 && upgState.fusion_exp.lv > 0) {
             modes.push('fusion');
        }
        
        const currentIdx = modes.indexOf(expMode);
        // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã§ãªã„å ´åˆï¼ˆè»¢ç”Ÿå¾Œãªã©ï¼‰ã¯normalã«æˆ»ã™
        if (currentIdx === -1) {
             expMode = 'normal';
        } else {
             const nextIdx = (currentIdx + 1) % modes.length;
             expMode = modes[nextIdx];
        }
        
        updateUI();
    }

    function handleExpedition() {
        if (expStatus === 'idle') {
            let cost = expNextCost;
            if (expMode === 'ritual') cost = ritualNextCost;
            if (expMode === 'fusion') cost = fusionNextCost;
            
            if (expMode === 'ritual' && dicePool.length <= 10) return alert("ãƒ—ãƒ¼ãƒ«ãŒ10å€‹ä»¥ä¸‹ã®ãŸã‚ã€å„€å¼æ¢ç´¢ã‚’è¡Œãˆã¾ã›ã‚“ã€‚");
            if (expMode === 'fusion' && dicePool.length <= 10) return alert("ãƒ—ãƒ¼ãƒ«ãŒ10å€‹ä»¥ä¸‹ã®ãŸã‚ã€èåˆæ¢ç´¢ã‚’è¡Œãˆã¾ã›ã‚“ã€‚");
            
            if (score < cost) return alert("ã‚¹ã‚³ã‚¢ãŒè¶³ã‚Šã¾ã›ã‚“");
            score -= cost;
            expStatus = 'running';
            expTimeRemaining = Math.max(20000, EXP_DURATION_BASE - (upgState.exp_speed.lv * 16000));
            
            const b = document.getElementById('exp-action-btn');
            b.disabled = true; b.textContent = "æ¢ç´¢ä¸­...";
            updateUI();
            saveGame();
        } else if (expStatus === 'ready') {
            showRewards();
        }
    }

    function showRewards() {
        const list = document.getElementById('reward-list');
        list.innerHTML = '';
        currentRewards = [];
        const fusionArea = document.getElementById('fusion-action-area');
        fusionArea.style.display = 'none';

        const title = document.getElementById('reward-title');
        const desc = document.getElementById('reward-desc');
        const cancelBtn = document.getElementById('reward-cancel-btn');
        const countMsg = document.getElementById('reward-count-msg');

        if (expMode === 'normal') {
            title.textContent = "æ¢ç´¢ã‹ã‚‰å¸°é‚„ï¼";
            title.style.color = "var(--accent)";
            desc.innerHTML = "æŒã¡å¸°ã‚‹å‡ºç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br><span style='font-size:0.8rem; color:#aaa;'>â€»é¸æŠã™ã‚‹ã¨æ¬¡å›ã®æ¢ç´¢ã‚³ã‚¹ãƒˆãŒå€ã«ãªã‚Šã¾ã™</span>";
            cancelBtn.textContent = "çµ‚äº†";
            
            // å®‰å…¨ç­–: undefinedå¯¾ç­–
            rewardSelectCount = 1 + (reincData.upgrades.greedy_exp || 0);
            const choiceNum = 2 + upgState.exp_amount.lv + (reincData.upgrades.greedy_exp || 0);
            
            for(let i=0; i<choiceNum; i++) currentRewards.push({ die: genDie(), selected: false });

            currentRewards.forEach((item, i) => {
                const card = createCard(item.die, false);
                card.id = `reward-card-${i}`;
                card.onclick = () => selectReward(i);
                list.appendChild(card);
            });

        } else if (expMode === 'ritual') {
            title.textContent = "å„€å¼ã®åˆ»";
            title.style.color = "#9b59b6";
            desc.innerHTML = "æ¶ˆæ»…ã•ã›ã‚‹å‡ºç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br><span style='font-size:0.8rem; color:#aaa;'>â€»å‰Šé™¤ã™ã‚‹ã¨æ¬¡å›ã®å„€å¼ã‚³ã‚¹ãƒˆãŒå€ã«ãªã‚Šã¾ã™</span>";
            cancelBtn.textContent = "çµ‚äº†";

            rewardSelectCount = 1 + (reincData.upgrades.greedy_rit || 0);
            const count = 2 + upgState.ritual_amount.lv + (reincData.upgrades.greedy_rit || 0);
            const indices = [];
            while(indices.length < count && indices.length < dicePool.length) {
                const r = Math.floor(Math.random() * dicePool.length);
                if(!indices.includes(r)) indices.push(r);
            }
            
            indices.forEach(idx => {
                currentRewards.push({ die: dicePool[idx], poolIndex: idx, selected: false });
            });

            currentRewards.forEach((item, i) => {
                const card = createCard(item.die, true);
                card.id = `reward-card-${i}`;
                card.onclick = () => selectReward(i);
                list.appendChild(card);
            });
        } else if (expMode === 'fusion') {
            title.textContent = "èåˆã®å„€";
            title.style.color = "var(--mode-fusion)";
            desc.innerHTML = "èåˆã™ã‚‹å‡ºç›®ã‚’2ã¤é¸æŠã—ã¦ãã ã•ã„ã€‚<br><span style='font-size:0.8rem; color:#aaa;'>â€»èåˆã™ã‚‹ã¨å…ƒã®2ã¤ã¯æ¶ˆæ»…ã—ã€æ–°ãŸãª1ã¤ãŒç”Ÿã¾ã‚Œã¾ã™</span>";
            cancelBtn.textContent = "ä¸­æ­¢";
            
            rewardSelectCount = 2;
            const count = 5 + upgState.fusion_exp_amount.lv;
            
            const indices = [];
            while(indices.length < count && indices.length < dicePool.length) {
                const r = Math.floor(Math.random() * dicePool.length);
                if(!indices.includes(r)) indices.push(r);
            }
            
            indices.forEach(idx => {
                currentRewards.push({ die: dicePool[idx], poolIndex: idx, selected: false });
            });

            currentRewards.forEach((item, i) => {
                const card = createCard(item.die, false, true); 
                card.id = `reward-card-${i}`;
                card.onclick = () => selectFusionReward(i);
                list.appendChild(card);
            });
            
            fusionArea.style.display = 'block';
        }
        
        updateRewardCountMsg();
        document.getElementById('reward-modal').style.display = 'flex';
    }
    
    function updateRewardCountMsg() {
        if(expMode === 'fusion') {
            document.getElementById('reward-count-msg').textContent = `é¸æŠä¸­: ${2 - rewardSelectCount} / 2`;
        } else {
            document.getElementById('reward-count-msg').textContent = `æ®‹ã‚Šé¸æŠå¯èƒ½æ•°: ${rewardSelectCount}`;
        }
    }

    function createCard(d, isRemove, isFusion) {
        const card = document.createElement('div'); 
        let className = 'reward-card';
        if(isRemove) className += ' remove-mode';
        if(isFusion) className += ' fusion-mode';
        card.className = className;
        
        const dieContent = getDieContent(d.val);
        const dieClass = typeof d.val === 'number' && d.val > 6 ? 'die is-number' : 'die';
        
        let faceColor = RARITIES[d.rarity].color;
        if (d.rarity === 'common') {
            faceColor = '#333333'; 
        }

        card.innerHTML = `
            <div class="${dieClass}" style="width:60px; height:60px; font-size:2rem; color:${faceColor}; border:1px solid #ccc;">${dieContent}</div>
            <div style="color:${RARITIES[d.rarity].color}; font-size:0.7rem; font-weight:bold;">${RARITIES[d.rarity].name}</div>
            <div style="font-size:0.6rem; color:#888;">å€ç‡: x${RARITIES[d.rarity].mult}</div>
            <div style="font-size:0.6rem; color:#aaa;">${d.val > 6 ? 'Value: '+d.val : ''}</div>
        `;
        return card;
    }
    
    function getDieContent(val) {
        if(val <= 6) return ["","âš€","âš","âš‚","âšƒ","âš„","âš…"][val];
        return val;
    }

    function selectReward(index) {
        if (currentRewards[index].selected) return; 
        if (rewardSelectCount <= 0) return;

        currentRewards[index].selected = true;
        document.getElementById(`reward-card-${index}`).classList.add('selected');
        rewardSelectCount--;
        updateRewardCountMsg();

        if (expMode === 'normal') {
            dicePool.push(currentRewards[index].die);
            expNextCost *= 2; 
        } else {
            dicePool[currentRewards[index].poolIndex] = null; // nullåŒ–
            ritualNextCost *= 2;
        }

        if (rewardSelectCount <= 0) {
            setTimeout(() => discardRewards(), 500);
        }
        saveGame();
    }
    
    function selectFusionReward(index) {
        const item = currentRewards[index];
        const el = document.getElementById(`reward-card-${index}`);
        
        if (item.selected) {
            item.selected = false;
            el.classList.remove('selected');
            rewardSelectCount++;
        } else {
            if (rewardSelectCount <= 0) return; 
            item.selected = true;
            el.classList.add('selected');
            rewardSelectCount--;
        }
        
        updateRewardCountMsg();
        
        document.getElementById('btn-do-fuse').disabled = (rewardSelectCount !== 0);
        document.getElementById('btn-do-fuse').style.opacity = (rewardSelectCount !== 0) ? 0.5 : 1;
        document.getElementById('btn-do-fuse').style.cursor = (rewardSelectCount !== 0) ? 'not-allowed' : 'pointer';
    }
    
    function executeFusion() {
        const selected = currentRewards.filter(r => r.selected);
        if(selected.length !== 2) return;
        
        const d1 = selected[0].die;
        const d2 = selected[1].die;
        
        const limit = 20 + ((reincData.upgrades.fusion_limit || 0) * 3);
        let newVal = d1.val + d2.val;
        if(newVal > limit) newVal = limit;
        
        let newRarityKey = 'common';
        const r1Idx = RARITY_ORDER.indexOf(d1.rarity);
        const r2Idx = RARITY_ORDER.indexOf(d2.rarity);
        
        if (r1Idx > r2Idx) {
            newRarityKey = d1.rarity;
        } else if (r2Idx > r1Idx) {
            newRarityKey = d2.rarity;
        } else {
            const nextIdx = r1Idx + 1;
            if (nextIdx < RARITY_ORDER.length) {
                const nextKey = RARITY_ORDER[nextIdx];
                if (RARITIES[nextKey]) {
                    newRarityKey = nextKey;
                } else {
                    newRarityKey = d1.rarity; 
                }
            } else {
                newRarityKey = d1.rarity; 
            }
        }
        
        const newDie = { val: newVal, rarity: newRarityKey };
        
        dicePool[selected[0].poolIndex] = null;
        dicePool[selected[1].poolIndex] = null;
        
        dicePool.push(newDie);
        
        fusionNextCost *= 2;
        
        alert(`èåˆæˆåŠŸï¼\nå€¤: ${newVal} (ä¸Šé™${limit})\nãƒ¬ã‚¢ãƒªãƒ†ã‚£: ${RARITIES[newRarityKey].name}`);
        
        dicePool = dicePool.filter(d => d !== null);
        document.getElementById('reward-modal').style.display = 'none';
        closeExpeditionModal(true);
        saveGame();
    }

    function discardRewards() {
        if (expMode === 'ritual') {
            dicePool = dicePool.filter(d => d !== null);
        }
        
        let acted = currentRewards.some(r => r.selected);
        closeExpeditionModal(acted);
    }

    function closeExpeditionModal(acted) {
        document.getElementById('reward-modal').style.display = 'none';
        expStatus = 'idle';
        expTimeRemaining = 0;
        
        const b = document.getElementById('exp-action-btn');
        b.disabled = false;
        b.textContent = "æ¢ç´¢é–‹å§‹";
        
        const p = document.getElementById('exp-prog');
        p.style.strokeDashoffset = 100;
        document.getElementById('exp-timer-text').textContent = "READY";
        
        let actionName = "";
        if (expMode === 'normal') actionName = acted ? "åŠ ãˆã¾ã—ãŸï¼" : "æŒã¡å¸°ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        else if (expMode === 'ritual') actionName = acted ? "æ¶ˆæ»…ã•ã›ã¾ã—ãŸ..." : "å„€å¼ã‚’ä¸­æ–­ã—ã¾ã—ãŸã€‚";
        else if (expMode === 'fusion') actionName = acted ? "èåˆã—ã¾ã—ãŸï¼" : "èåˆã—ã¾ã›ã‚“ã§ã—ãŸã€‚";
        
        document.getElementById('exp-msg').textContent = acted || !acted ? `çµæœ: ${actionName}` : "";
        
        updateUI();
    }

    function genDie() {
        const v = Math.floor(Math.random()*6)+1;
        const weights = Object.entries(RARITIES);
        const totalWeight = weights.reduce((a,b)=>a+b[1].weight, 0);
        let r = Math.random() * totalWeight;
        for(let [k, d] of weights) { if(r < d.weight) return {val:v, rarity:k}; r -= d.weight; }
        return {val:v, rarity:'common'};
    }

    // --- ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ ---
    function buyUpgrade(type) {
        const upg = upgState[type];
        const reqs = Array.isArray(upg.req) ? upg.req : (upg.req ? [upg.req] : []);
        
        // ä¿®æ­£: è»¢ç”ŸUGæ¡ä»¶ã®ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ  (ä¸æ­£è³¼å…¥é˜²æ­¢)
        if (upg.reincReq && (reincData.upgrades[upg.reincReq] || 0) <= 0) return;

        const canBuy = reqs.every(r => upgState[r].lv > 0);
        if (reqs.length > 0 && !canBuy) return;

        if (score >= upg.costs[upg.lv] && upg.lv < upg.max) {
            score -= upg.costs[upg.lv];
            upg.lv++;
            if (type === 'finger') multiplier = 1 + upg.lv;
            if (type === 'auto') { hasAutoRoll = true; document.querySelectorAll('.timer-container').forEach(e => e.style.display='block'); }
            if (type === 'field' || type === 'potential') {
                fieldCount = 1 + upgState.field.lv;
                document.getElementById('game-fields').innerHTML = '';
                for(let i=0; i<fieldCount; i++) addField(i);
            }
            if (type === 'history') document.getElementById('panel-history').style.display = 'block';
            if (type === 'digital_history') document.getElementById('btn-pool-detail').style.display = 'block';
            if (type === 'ritual_unlock' || type === 'fusion_exp') document.getElementById('btn-mode-toggle').style.display = 'block';
            
            saveGame();
            updateUI(); drawLines();
        }
    }

    function addField(id) {
        const div = document.createElement('div');
        div.className = 'field';
        const num = 3 + upgState.potential.lv;
        let dHtml = ''; for(let i=0; i<num; i++) dHtml += `<div class="die" id="d-${id}-${i}">?</div>`;
        div.innerHTML = `<div class="timer-container" style="display:${hasAutoRoll?'block':'none'}"><svg class="timer-svg" viewBox="0 0 36 36"><circle class="timer-bg" cx="18" cy="18" r="16"></circle><circle id="prog-${id}" class="timer-progress" cx="18" cy="18" r="16"></circle></svg></div><div id="m-${id}" style="font-size:0.8rem; font-weight:bold; height:1rem; margin-bottom:5px;"></div><div class="dice-row">${dHtml}</div><button class="roll-btn" id="b-${id}" onclick="playGame(${id})">ãƒ­ãƒ¼ãƒ«</button>`;
        document.getElementById('game-fields').appendChild(div);
    }

    function playGame(idString) {
        const id = typeof idString === 'string' ? parseInt(idString.split('-')[1]) : idString;
        const btn = document.getElementById(`b-${id}`); if(!btn || btn.disabled) return;
        btn.disabled = true;
        const num = 3 + upgState.potential.lv;
        let c = 0, wait = Math.max(2, 10 - upgState.throw.lv);
        const iv = setInterval(() => {
            for(let i=0; i<num; i++) {
                const d = document.getElementById(`d-${id}-${i}`);
                if(d) {
                    d.textContent = ["âš€","âš","âš‚","âšƒ","âš„","âš…"][Math.floor(Math.random()*6)];
                    d.className = "die rolling";
                }
            }
            if(++c > wait) {
                clearInterval(iv);
                
                // å®‰å…¨ç­–: ãƒ—ãƒ¼ãƒ«ãŒç©ºãªã‚‰ç·Šæ€¥è£œå……
                if (dicePool.length === 0) initNewGame();

                const res = Array.from({length:num}, () => {
                    const d = dicePool[Math.floor(Math.random()*dicePool.length)];
                    return d || { val: 1, rarity: 'common' };
                });

                res.forEach((d, i) => {
                    const el = document.getElementById(`d-${id}-${i}`);
                    if(el) {
                        el.textContent = getDieContent(d.val);
                        el.className = "die " + (RARITIES[d.rarity].class || "");
                        if(d.val > 6) el.classList.add('is-number');
                    }
                });
                processResult(res, id, false); 
                btn.disabled = false;
            }
        }, 100);
    }

    function processResult(dice, id, isSilent) {
        let best = { val: -1, yaku: "ç›®ãªã—", base: 10, idx: [0,1,2], b: 1 };
        const diceWithIdx = dice.map((d, i) => ({...d, origIdx: i}));

        // 5æšå½¹ãƒã‚§ãƒƒã‚¯
        if (dice.length >= 5 && (reincData.upgrades.straight5 > 0 || reincData.upgrades.arashi5 > 0)) {
            const combos = getCombinations(diceWithIdx, 5);
            for (let c of combos) {
                const [base, yaku, scoreVal] = calcScore(c.map(d=>d.val));
                let rarityMult = c.reduce((acc, d) => acc * RARITIES[d.rarity].mult, 1);
                let totalVal = scoreVal * rarityMult;
                if (totalVal > best.val) {
                    best = { val: totalVal, yaku: yaku, base: base, b: rarityMult, idx: c.map(d=>d.origIdx) };
                }
            }
        }

        // 4æšå½¹ãƒã‚§ãƒƒã‚¯
        if (dice.length >= 4 && (reincData.upgrades.straight4 > 0 || reincData.upgrades.arashi4 > 0)) {
             const combos = getCombinations(diceWithIdx, 4);
             for (let c of combos) {
                const [base, yaku, scoreVal] = calcScore(c.map(d=>d.val));
                let rarityMult = c.reduce((acc, d) => acc * RARITIES[d.rarity].mult, 1);
                let totalVal = scoreVal * rarityMult;
                if (totalVal > best.val) {
                    best = { val: totalVal, yaku: yaku, base: base, b: rarityMult, idx: c.map(d=>d.origIdx) };
                }
            }
        }

        // 3æšå½¹ãƒã‚§ãƒƒã‚¯
        if (true) {
            const combos = getCombinations(diceWithIdx, 3);
            for (let c of combos) {
                const [base, yaku, scoreVal] = calcScore(c.map(d=>d.val));
                let rarityMult = 1;
                if (yaku !== "ç›®ãªã—" && yaku !== "ãƒ’ãƒ•ãƒŸ") {
                    rarityMult = c.reduce((acc, d) => acc * RARITIES[d.rarity].mult, 1);
                }
                let totalVal = scoreVal * rarityMult;
                if (totalVal > best.val) {
                    best = { val: totalVal, yaku: yaku, base: base, b: rarityMult, idx: c.map(d=>d.origIdx) };
                }
            }
        }
        
        if (!isSilent) {
            for(let i=0; i<dice.length; i++) {
                const dieEl = document.getElementById(`d-${id}-${i}`);
                if(dieEl) {
                    if(!best.idx.includes(i)) dieEl.classList.add('unused');
                    else dieEl.classList.remove('unused');
                }
            }
        }
        
        const reincMult = Math.max(1, reincData.maxReachedRP * 0.2);
        
        const gain = best.val * multiplier * reincMult;
        score += gain; totalScore += gain;
        
        const bonusText = best.b > 1 ? ` (x${best.b})` : "";
        if (!isSilent) {
            const msgEl = document.getElementById(`m-${id}`);
            if(msgEl) msgEl.textContent = `${best.yaku}${bonusText} (+${formatScore(gain)})`;
        }

        if (upgState.history.lv > 0 && gain > 0) {
            scoreHistory.push({n: best.yaku + bonusText, p: gain});
            scoreHistory.sort((a,b)=>b.p-a.p); 
            scoreHistory = scoreHistory.slice(0,5);
            if (!isSilent) renderHistory();
        }
        
        if (!isSilent) updateUI();
    }
    
    function renderHistory() {
        document.getElementById('history-list').innerHTML = scoreHistory.map(h=>`<li><span>${h.n}</span><b>${formatScore(h.p)}</b></li>`).join('');
    }

    function calcScore(d) {
        const vals = [...d].sort((x,y)=>x-y); 
        const len = vals.length;
        const sum = vals.reduce((a,c)=>a+c, 0);
        
        const m = [
            1, 
            upgState.yaku_none.lv, 
            upgState.yaku_normal.lv, 
            upgState.yaku_456.lv, 
            upgState.yaku_arashi.lv, 
            upgState.yaku_pin.lv,
            upgState.yaku_straight4.lv, 
            upgState.yaku_arashi4.lv,   
            upgState.yaku_straight5.lv, 
            upgState.yaku_arashi5.lv    
        ].map(l => 1+(l*4));

        if (len === 5) {
            if (reincData.upgrades.arashi5 > 0 && vals[0] === vals[4]) return [sum*100000*m[9], "ã‚¢ãƒ©ã‚·ï¼•", sum*100000];
            if (reincData.upgrades.straight5 > 0 && isStraight(vals)) return [sum*50000*m[8], "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼•", sum*50000];
            return [0, "ä¸æˆç«‹", 0];
        }

        if (len === 4) {
            if (reincData.upgrades.arashi4 > 0 && vals[0] === vals[3]) return [sum*20000*m[7], "ã‚¢ãƒ©ã‚·ï¼”", sum*20000];
            if (reincData.upgrades.straight4 > 0 && isStraight(vals)) return [sum*10000*m[6], "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼”", sum*10000];
            return [0, "ä¸æˆç«‹", 0];
        }

        const [a,b,c] = vals;
        
        if (a===1 && b===1 && c===1) return [10000*m[5], "ãƒ”ãƒ³ã‚¾ãƒ­", 100000];
        
        if (a===b && b===c) {
            if (reincData.upgrades.privatize > 0) {
                const baseVal = sum * 200;
                return [baseVal * m[4], "ã‚¢ãƒ©ã‚·", baseVal];
            }
            return [2000*m[4], "ã‚¢ãƒ©ã‚·", 2000+a];
        }

        if (a===1 && b===2 && c===3) return [0, "ãƒ’ãƒ•ãƒŸ", -1];

        if (a===4 && b===5 && c===6) {
             if (reincData.upgrades.privatize > 0) {
                const sum = 15;
                const baseVal = sum * 100;
                return [baseVal * m[3], "ã‚·ã‚´ãƒ­", baseVal];
            }
            return [1000*m[3], "ã‚·ã‚´ãƒ­", 1000];
        }

        if (reincData.upgrades.straight > 0 && reincData.upgrades.privatize > 0) {
            if (isStraight(vals)) {
                const baseVal = sum * 100; 
                return [baseVal * m[3], "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ", baseVal];
            }
        }

        if (a===b) return [c*50*m[2], c+"ã®ç›®", c*50];
        if (b===c) return [a*50*m[2], a+"ã®ç›®", a*50];
        if (a===c) return [b*50*m[2], b+"ã®ç›®", b*50];
        return [10*m[1], "ç›®ãªã—", 10];
    }

    function isStraight(arr) {
        for(let i=0; i<arr.length-1; i++) {
            if (arr[i+1] !== arr[i]+1) return false;
        }
        return true;
    }

    function openPoolDetail() {
        const container = document.getElementById('pool-detail-content');
        container.innerHTML = '';
        for (let v = 1; v <= 6; v++) {
            const dieDiv = document.createElement('div');
            dieDiv.className = 'pool-detail-item';
            let html = `<div style="font-size:1.5rem; margin-bottom:5px;">${["","âš€","âš","âš‚","âšƒ","âš„","âš…"][v]}</div>`;
            Object.keys(RARITIES).forEach(rKey => {
                const count = dicePool.filter(d => d.val === v && d.rarity === rKey).length;
                if (count > 0) { html += `<div style="color:${RARITIES[rKey].color}; font-size:0.6rem;">${RARITIES[rKey].name}: ${count}</div>`; }
            });
            dieDiv.innerHTML = html;
            container.appendChild(dieDiv);
        }
        document.getElementById('pool-detail-modal').style.display = 'flex';
    }

    function updateUI() {
        document.getElementById('score-board').textContent = formatScore(score);
        document.getElementById('total-score-display').textContent = formatScore(totalScore);
        document.getElementById('modal-score').textContent = formatScore(score);
        
        const reincMult = Math.max(1, reincData.maxReachedRP * 0.2);
        document.getElementById('mult-val').textContent = (multiplier * reincMult).toFixed(1);

        const rpPanel = document.getElementById('rp-display-panel');
        if (reincData.maxReachedRP > 0) {
            rpPanel.style.display = 'block';
            document.getElementById('rp-val').textContent = reincData.points;
            document.getElementById('rp-mult').textContent = reincMult.toFixed(1);
        }
        
        const reincBtn = document.getElementById('reinc-btn');
        if (totalScore >= REINC_THRESHOLD) {
            reincBtn.style.display = 'block';
            reincBtn.textContent = "âœ¦ è»¢ç”Ÿå¯èƒ½";
            reincBtn.classList.add('reinc-available');
        } else if (reincData.maxReachedRP > 0) {
            reincBtn.style.display = 'block';
            reincBtn.textContent = "âœ¦ è»¢ç”Ÿãƒ¡ãƒ‹ãƒ¥ãƒ¼";
            reincBtn.classList.remove('reinc-available');
        } else {
            reincBtn.style.display = 'none';
        }

        const expPanel = document.getElementById('expedition-panel');
        expPanel.style.display = upgState.expedition.lv > 0 ? 'block' : 'none';
        
        const toggleBtn = document.getElementById('btn-mode-toggle');
        if (upgState.ritual_unlock.lv > 0 || upgState.fusion_exp.lv > 0) {
            toggleBtn.style.display = 'block';
        }
        
        const title = document.getElementById('exp-title');
        const costDisp = document.getElementById('exp-cost-display');
        const msg = document.getElementById('exp-msg');
        const btn = document.getElementById('exp-action-btn');

        if (expMode === 'normal') {
            expPanel.className = 'mode-normal';
            title.textContent = "ğŸ§­ é€šå¸¸æ¢ç´¢";
            title.style.color = "var(--mode-normal)";
            costDisp.textContent = "ã‚³ã‚¹ãƒˆ: " + formatScore(expNextCost) + " pts";
            if(expStatus !== 'running' && expStatus !== 'ready') {
                msg.textContent = "æ–°ãŸãªå‡ºç›®ã‚’æ±‚ã‚ã¦æ¢ç´¢ã—ã¾ã™";
                btn.style.background = "var(--mode-normal)";
            }
        } else if (expMode === 'ritual') {
            expPanel.className = 'mode-ritual';
            title.textContent = "ğŸ”® å„€å¼æ¢ç´¢";
            title.style.color = "var(--mode-ritual)";
            costDisp.textContent = "ã‚³ã‚¹ãƒˆ: " + formatScore(ritualNextCost) + " pts";
            if(expStatus !== 'running' && expStatus !== 'ready') {
                msg.textContent = "ä¸è¦ãªå‡ºç›®ã‚’æ¶ˆæ»…ã•ã›ã‚‹å„€å¼ã‚’è¡Œã„ã¾ã™";
                btn.style.background = "var(--mode-ritual)";
            }
        } else if (expMode === 'fusion') {
            expPanel.className = 'mode-fusion';
            title.textContent = "ğŸ”¥ èåˆæ¢ç´¢";
            title.style.color = "var(--mode-fusion)";
            costDisp.textContent = "ã‚³ã‚¹ãƒˆ: " + formatScore(fusionNextCost) + " pts";
            if(expStatus !== 'running' && expStatus !== 'ready') {
                msg.textContent = "å‡ºç›®ã‚’èåˆã—ã€å¼·åŠ›ãªå‡ºç›®ã‚’ä½œæˆã—ã¾ã™";
                btn.style.background = "var(--mode-fusion)";
            }
        }

        const counts = {}; dicePool.forEach(d=>counts[d.rarity]=(counts[d.rarity]||0)+1);
        document.getElementById('pool-stats').innerHTML = Object.entries(RARITIES).map(([k,v])=>`<span style="color:${v.color}">${v.name}: ${counts[k]||0}</span>`).join('<br>');
        
        let upgradeCount = 0;
        for(let k in upgState) {
            const u = upgState[k], n = document.getElementById('node-'+k);
            if (!n) continue;

            if (u.reincReq && (reincData.upgrades[u.reincReq] || 0) <= 0) {
                n.style.display = 'none';
                continue;
            } else {
                n.style.display = 'flex';
            }

            const reqs = Array.isArray(u.req) ? u.req : (u.req ? [u.req] : []);
            const open = reqs.length === 0 || reqs.every(r => upgState[r].lv > 0);
            
            const canBuy = open && u.lv < u.max && score >= u.costs[u.lv];
            if (canBuy) upgradeCount++;
            
            n.className = `skill-node ${open?(u.lv>0?'unlocked':'available'):'locked'} ${u.lv>=u.max?'is-max':''} ${canBuy?'can-buy':''}`;
            document.getElementById('lv-'+k).textContent = `Lv ${u.lv}/${u.max}`;
            
            let tooltipHTML = `<strong>${u.name}</strong><br>${u.desc}<br>ã‚³ã‚¹ãƒˆ: ${u.lv>=u.max?'MAX':formatScore(u.costs[u.lv])}`;
            if (!open) {
                const reqNames = reqs.map(r => upgState[r].name).join(', ');
                tooltipHTML += `<br><span style="color:#e74c3c; font-size:0.7rem;">(å‰æ: ${reqNames})</span>`;
            }
            document.getElementById('tip-'+k).innerHTML = tooltipHTML;
        }
        
        // é…å½“è¡¨ã®è¡¨ç¤ºåˆ¶å¾¡
        if (reincData.upgrades.straight4 > 0) document.getElementById('row-payout-s4').style.display = 'table-row';
        if (reincData.upgrades.arashi4 > 0) document.getElementById('row-payout-a4').style.display = 'table-row';
        if (reincData.upgrades.straight5 > 0) document.getElementById('row-payout-s5').style.display = 'table-row';
        if (reincData.upgrades.arashi5 > 0) document.getElementById('row-payout-a5').style.display = 'table-row';

        const badge = document.getElementById('shop-badge');
        if (upgradeCount > 0) {
            badge.style.display = 'flex';
            badge.textContent = upgradeCount;
        } else {
            badge.style.display = 'none';
        }
    }

    function toggleModal(s) { document.getElementById('upgrade-modal').style.display = s?'flex':'none'; if(s) { updateUI(); setTimeout(drawLines, 50); } }

    function drawLines() {
        try {
            const svg = document.getElementById('tree-svg');
            const rootEl = document.getElementById('tree-root');
            if (!svg || !rootEl) return;
            const root = rootEl.getBoundingClientRect();
            svg.innerHTML = '';
            
            const conn = [
                ['finger','auto'], ['finger','field'],            
                ['auto','expedition'], ['auto','history'], ['auto','speed'], ['auto','yaku_none'],
                ['field','potential'],                            
                ['speed','throw'],                                
                ['expedition','digital_history'], ['expedition', 'exp_speed'], ['expedition', 'exp_amount'], ['expedition', 'ritual_unlock'],
                ['history','digital_history'],
                ['ritual_unlock', 'ritual_amount'], ['ritual_amount', 'fusion_exp'],
                ['fusion_exp', 'fusion_exp_amount'],
                ['yaku_none','yaku_normal'], ['yaku_normal','yaku_456'],
                ['yaku_456','yaku_arashi'], ['yaku_arashi','yaku_pin'],
                ['yaku_pin', 'yaku_straight4'], ['yaku_straight4', 'yaku_arashi4'],
                ['yaku_arashi4', 'yaku_straight5'], ['yaku_arashi4', 'yaku_arashi5']
            ];
            
            conn.forEach(([p,c])=>{
                const pe = document.getElementById('node-'+p), ce = document.getElementById('node-'+c);
                if(!pe || !ce || pe.style.display === 'none' || ce.style.display === 'none') return;
                const pr = pe.getBoundingClientRect(), cr = ce.getBoundingClientRect();
                
                // åº§æ¨™ãŒå–å¾—ã§ãã¦ã„ãªã„å ´åˆã‚¹ã‚­ãƒƒãƒ—
                if (pr.width === 0 || cr.width === 0) return;

                const l = document.createElementNS("http://www.w3.org/2000/svg","line");
                l.setAttribute("x1", pr.left+pr.width/2-root.left);
                l.setAttribute("y1", pr.top+pr.height/2-root.top);
                l.setAttribute("x2", cr.left+cr.width/2-root.left);
                l.setAttribute("y2", cr.top+cr.height/2-root.top);
                l.className.baseVal = "skill-line " + (upgState[p].lv>0?'active':'');
                svg.appendChild(l);
            });
        } catch(e) {
            console.error("Lines Error", e);
        }
    }

    init();
</script>
</body>
</html>