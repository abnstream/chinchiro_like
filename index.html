
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280">
    <title>„ÉÅ„É≥„ÉÅ„É≠„ÉªPIT</title>
    <style>
        :root {
            --bg-color: #1a472a;
            --panel-bg: rgba(0, 0, 0, 0.6);
            --text-main: #ffffff;
            --accent-gold: #f1c40f;
            --accent-red: #e74c3c;
            --btn-blue: #3498db;
            --btn-green: #2ecc71;
            --dice-bg: #ecf0f1;
            
            --rarity-common: #ffffff;
            --rarity-uncommon: #2ecc71;
            --rarity-rare: #00d2ff;
            --rarity-sr: #ffd700;
            --rarity-legendary: #9b59b6;

            --stat-ticket-bg: rgba(241, 196, 15, 0.2);
            --stat-ticket-border: var(--accent-gold);
            --stat-luck-bg: rgba(155, 89, 182, 0.2);
            --stat-luck-border: #9b59b6;
            --stat-luck-text: #d2b4de;
            --stat-rate-bg: rgba(231, 76, 60, 0.2);
            --stat-rate-border: #e74c3c;
            --stat-rate-text: #ec7063;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        .game-wrapper {
            display: grid;
            grid-template-columns: 360px 1fr 320px;
            grid-template-rows: auto 1fr;
            gap: 20px;
            width: 95%;
            max-width: 1400px;
            height: 90vh;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº„Ç®„É™„Ç¢ */
        .header-area {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent-gold);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        h1 { margin: 0; color: var(--accent-gold); font-size: 2rem; }
        .stage-info { font-size: 1.5rem; font-weight: bold; }

        /* Â∑¶„Çµ„Ç§„ÉâÔºö„É´„Éº„É´Ë°® */
        .left-panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }
        .rule-card h3 {
            margin-top: 0;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 5px;
            color: var(--accent-gold);
            font-size: 1.1rem;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 8px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(0,0,0,0.3); }
        
        .prob-col { font-family: monospace; color: #fff; font-weight: bold; }
        .prob-high { color: var(--btn-green); }
        .prob-low { color: var(--accent-red); }
        
        .val-up { color: #2ecc71; font-weight: bold; animation: pulse 1s infinite; }
        .val-gain { color: #2ecc71; font-weight: bold; animation: pop 0.3s ease-out; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* ‰∏≠Â§ÆÔºö„É°„Ç§„É≥„Éë„Éç„É´ */
        .main-panel {
            position: relative;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            overflow: hidden;
        }

        /* „Ç≤„Éº„É†„Éì„É•„Éº */
        .game-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
        }
        .game-view.hidden { display: none; }

        .pool-container {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(0,0,0,0.4);
            padding: 15px 40px;
            border-radius: 50px;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .pool-label { font-size: 0.9rem; opacity: 0.8; }
        .pool-value { font-size: 3rem; font-weight: bold; color: var(--accent-gold); line-height: 1; }

        .dice-area {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            height: 120px;
        }
        .die {
            width: 100px;
            height: 100px;
            background: var(--dice-bg);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: #333;
            box-shadow: 0 8px 0 #bdc3c7;
            font-weight: bold;
            position: relative;
        }
        .die[data-value="1"] { color: #c0392b; }

        /* „É≠„Ç∞„Ç®„É™„Ç¢ */
        .message-area {
            min-height: 90px;
            height: auto;
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 90%;
        }
        .main-msg { font-size: 2rem; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); line-height: 1.2; }
        .sub-msg { font-size: 1.1rem; opacity: 0.9; margin-bottom: 5px; }
        
        .effect-log { 
            font-size: 0.85rem; 
            margin-top: 5px;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
        }
        .log-tag {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 3px 10px;
            border-radius: 15px;
            color: #fff;
            animation: fadeIn 0.3s ease-out;
            white-space: nowrap;
        }
        .log-luck { border-color: #9b59b6; color: #d2b4de; background: rgba(155, 89, 182, 0.2); }
        .log-ticket { border-color: #2ecc71; color: #a3e4d7; background: rgba(46, 204, 113, 0.2); }
        .log-buff { border-color: #f39c12; color: #f9e79f; background: rgba(243, 156, 18, 0.2); }
        .log-rate { border-color: #e74c3c; color: #ec7063; background: rgba(231, 76, 60, 0.2); }
        .log-bad  { border-color: #7f8c8d; color: #95a5a6; background: rgba(0,0,0,0.5); }
        .log-hifumi { border-color: #e74c3c; color: #e74c3c; background: rgba(231, 76, 60, 0.1); font-weight: bold; }

        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            min-height: 70px;
        }

        button {
            border: none;
            border-radius: 50px;
            cursor: pointer;
            color: #fff;
            font-weight: bold;
            transition: transform 0.1s, box-shadow 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.1;
        }
        button:active { transform: translateY(4px); box-shadow: none !important; }
        button:disabled { background: #7f8c8d !important; color: #bdc3c7 !important; box-shadow: none !important; cursor: not-allowed; }

        .btn-roll {
            background: var(--accent-gold);
            color: #333;
            padding: 15px 50px;
            font-size: 1.5rem;
            box-shadow: 0 6px 0 #d35400;
            min-width: 180px;
        }
        .btn-roll:active { box-shadow: 0 2px 0 #d35400 !important; }

        .btn-shop {
            background: var(--btn-blue);
            padding: 15px 30px;
            font-size: 1.1rem;
            box-shadow: 0 6px 0 #2980b9;
        }
        .btn-shop:active { box-shadow: 0 2px 0 #2980b9 !important; }

        .btn-clear {
            background: var(--btn-green);
            padding: 10px 30px;
            font-size: 1rem;
            box-shadow: 0 6px 0 #27ae60;
            display: none;
        }
        .btn-clear:active { box-shadow: 0 2px 0 #27ae60 !important; }
        .btn-clear.visible { display: flex; animation: bounceIn 0.5s; }
        .clear-sub { font-size: 0.8rem; opacity: 0.9; }

        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        .hidden-el { display: none !important; }

        /* „Ç∑„Éß„ÉÉ„Éó„Éì„É•„Éº */
        .shop-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            display: none;
        }
        .shop-view.active { display: flex; }

        .shop-header {
            font-size: 2rem;
            color: var(--accent-gold);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--accent-gold);
            width: 100%;
            text-align: center;
        }

        .shop-shelves {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            margin-bottom: 20px;
            flex-grow: 1;
        }

        .shop-item {
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            text-align: center;
            transition: transform 0.2s;
            position: relative;
        }
        .shop-item:hover { transform: translateY(-2px); background: rgba(255,255,255,0.1); }
        .shop-item.sold-out { opacity: 0.5; pointer-events: none; background: rgba(0,0,0,0.5); }

        .rarity-common { border-color: var(--rarity-common); } .rarity-common .item-name { color: var(--rarity-common); }
        .rarity-uncommon { border-color: var(--rarity-uncommon); } .rarity-uncommon .item-name { color: var(--rarity-uncommon); }
        .rarity-rare { border-color: var(--rarity-rare); } .rarity-rare .item-name { color: var(--rarity-rare); }
        .rarity-sr { border-color: var(--rarity-sr); } .rarity-sr .item-name { color: var(--rarity-sr); }
        .rarity-legendary { border-color: var(--rarity-legendary); } .rarity-legendary .item-name { color: var(--rarity-legendary); }

        .item-name { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; }
        .item-desc { font-size: 0.8rem; height: 3.6em; display: flex; align-items: center; justify-content: center; line-height: 1.3; }
        .item-price { margin-top: 10px; font-weight: bold; color: #fff; }

        .btn-buy {
            background: #fff;
            color: #333;
            border: none;
            padding: 5px 20px;
            border-radius: 20px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: none;
        }
        .btn-buy:hover { background: #ddd; }

        .shop-controls {
            display: flex;
            gap: 20px;
            margin-top: auto;
        }
        .btn-reroll {
            background: var(--accent-red);
            padding: 10px 30px;
            font-size: 1rem;
            box-shadow: 0 4px 0 #c0392b;
        }
        .btn-back {
            background: #95a5a6;
            color: #333;
            padding: 10px 30px;
            font-size: 1rem;
            box-shadow: 0 4px 0 #7f8c8d;
        }

        /* „Éó„É¨„Çπ„ÉÜ„Éº„Ç∏„Éì„É•„Éº */
        .prestige-view {
            width: 100%; height: 100%;
            display: none;
            flex-direction: column; align-items: center; padding: 20px;
            box-sizing: border-box;
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.9), rgba(0, 0, 0, 0.9));
        }
        .prestige-view.active { display: flex; }
        
        .prestige-header {
            font-size: 2.5rem; color: var(--accent-gold); margin-bottom: 10px;
            text-shadow: 0 0 10px var(--accent-gold);
        }
        .prestige-sub { font-size: 1rem; margin-bottom: 30px; color: #bdc3c7; }

        .prestige-container {
            display: flex; gap: 20px; width: 100%; justify-content: center;
            flex-wrap: wrap; margin-bottom: 30px;
        }
        .prestige-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--accent-gold);
            border-radius: 15px; padding: 20px;
            width: 200px; text-align: center; cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            display: flex; flex-direction: column; justify-content: center; height: 200px;
        }
        .prestige-card:hover { transform: scale(1.05); background: rgba(241, 196, 15, 0.15); }
        .p-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        .p-desc { font-size: 1rem; line-height: 1.4; font-weight: bold; }

        /* Âè≥„Çµ„Ç§„Éâ */
        .right-panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow: hidden; /* „É¨„Ç§„Ç¢„Ç¶„ÉàÂ¥©„ÇåÈò≤Ê≠¢ */
            min-height: 0;    /* GridÂÜÖ„Åß„ÅÆ„Çµ„Ç§„Ç∫ÁàÜÁô∫Èò≤Ê≠¢ */
        }
        .score-box {
            text-align: center;
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
        }
        .score-label { display: block; font-size: 0.8rem; opacity: 0.8; margin-bottom: 3px; }
        .score-num { font-size: 1.8rem; font-weight: bold; }
        .target-num { color: #f39c12; }
        
        .stat-row { display: flex; gap: 10px; }
        .stat-item { flex: 1; }
        .ticket-box { background: var(--stat-ticket-bg); border: 1px solid var(--stat-ticket-border); color: var(--stat-ticket-border); }
        .luck-box { background: var(--stat-luck-bg); border: 1px solid var(--stat-luck-border); color: var(--stat-luck-text); }
        .rate-box { background: var(--stat-rate-bg); border: 1px solid var(--stat-rate-border); color: var(--stat-rate-text); }

        .round-info { text-align: center; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; }

        .inventory-section {
            flex-grow: 1;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto; /* „Çπ„ÇØ„É≠„Éº„É´ÊúâÂäπÂåñ */
            min-height: 0;
        }
        .inventory-header {
            font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between;
        }
        .inventory-list { display: flex; flex-direction: column; gap: 8px; }
        .inv-item {
            padding: 8px; border-radius: 5px; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; cursor: help;
            border-left: 4px solid;
            background: rgba(255,255,255,0.1);
        }
        /* Â£≤Âç¥„Éú„Çø„É≥ */
        .btn-inv-sell {
            background: #c0392b;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.8rem;
            cursor: pointer;
            box-shadow: 0 2px 0 #96281b;
            font-weight: bold;
        }
        .btn-inv-sell:active { transform: translateY(2px); box-shadow: none; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes shock {
            0% { transform: scale(1); background-color: rgba(231, 76, 60, 0); }
            10% { transform: scale(1.1); background-color: rgba(231, 76, 60, 0.5); }
            100% { transform: scale(1); background-color: rgba(231, 76, 60, 0); }
        }
        .shock-effect { animation: shock 0.6s ease-out; }
        .hifumi-text { color: var(--accent-red); font-size: 3rem; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center;
            visibility: hidden; opacity: 0; transition: 0.3s; z-index: 999;
        }
        .modal-overlay.show { visibility: visible; opacity: 1; }
        .modal-box {
            background: #fff; color: #333; padding: 40px;
            border-radius: 20px; text-align: center; width: 500px;
        }
        .modal-btn {
            background: #27ae60; color: #fff; border: none;
            padding: 15px 40px; font-size: 1.2rem; border-radius: 10px;
            cursor: pointer; margin-top: 20px;
            box-shadow: 0 4px 0 #219150;
        }
    </style>
</head>
<body>

<div class="game-wrapper">
    <div class="header-area">
        <h1>üé≤ „ÉÅ„É≥„ÉÅ„É≠„ÉªPIT</h1>
        <div class="stage-info">STAGE <span id="ui-stage">1</span></div>
    </div>

    <div class="left-panel">
        <div class="rule-card">
            <h3>üßÆ Âá∫ÁõÆÁÇπ / Á¢∫Áéá</h3>
            <table id="table-faces">
                </table>
        </div>
        <div class="rule-card">
            <h3>üèÜ ÂΩπÂÄçÁéá (‰πóÁÆó)</h3>
            <table id="table-yaku">
                </table>
        </div>
    </div>

    <div class="main-panel" id="main-panel">
        
        <div class="game-view" id="game-view">
            <div class="pool-container" id="pool-box">
                <div class="pool-label">ROUND POOL</div>
                <div>
                    <span class="pool-value" id="ui-pool">0</span>
                    <span style="font-size:1.5rem">pt</span>
                </div>
            </div>

            <div class="dice-area" id="dice-container">
                <div class="die">?</div>
                <div class="die">?</div>
                <div class="die">?</div>
            </div>

            <div class="message-area">
                <div class="main-msg" id="msg-main">GAME START</div>
                <div class="sub-msg" id="msg-sub">ROLL„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶ÈñãÂßã</div>
                <div class="effect-log" id="msg-log"></div>
            </div>

            <div class="action-buttons">
                <button class="btn-roll" id="btn-roll" onclick="game.roll()">ROLL</button>
                <button class="btn-clear" id="btn-clear" onclick="game.stageWin()">
                    STAGE CLEAR
                    <span class="clear-sub" id="clear-sub">(+2 üé´)</span>
                </button>
                <button class="btn-shop" id="btn-shop" onclick="game.openShop()">SHOP</button>
            </div>
        </div>

        <div class="shop-view" id="shop-view">
            <div class="shop-header">ITEM SHOP</div>
            <div class="shop-shelves" id="shop-shelves">
                </div>
            <div class="shop-controls">
                <button class="btn-reroll" id="btn-reroll" onclick="game.rerollShop()">ÂÜçÂÖ•Ëç∑ (Cost: 1)</button>
                <button class="btn-back" onclick="game.closeShop()">Êàª„Çã</button>
            </div>
        </div>

        <div class="prestige-view" id="prestige-view">
            <div class="prestige-header">‚ú® PRESTIGE ‚ú®</div>
            <div class="prestige-sub">Ê¨°„Çπ„ÉÜ„Éº„Ç∏„Å∏„ÅÆÊ∞∏Á∂öÂº∑Âåñ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            <div class="prestige-container" id="prestige-container">
            </div>
            <button class="btn-reroll" id="btn-prestige-reroll" onclick="game.rerollPrestige()">ÈÅ∏ÊäûËÇ¢Â§âÊõ¥ (Cost: 1)</button>
        </div>

    </div>

    <div class="right-panel">
        <div class="score-section">
            <div class="score-box">
                <span class="score-label">TARGET SCORE</span>
                <div class="score-num target-num" id="ui-target">1,500</div>
            </div>
            <div class="score-box">
                <span class="score-label">TOTAL SCORE</span>
                <div class="score-num" id="ui-total">0</div>
            </div>
            
            <div class="stat-row">
                <div class="score-box ticket-box stat-item">
                    <span class="score-label">TICKETS</span>
                    <div class="score-num" id="ui-tickets">4</div>
                </div>
                <div class="score-box luck-box stat-item">
                    <span class="score-label">LUCK</span>
                    <div class="score-num" id="ui-luck">100</div>
                </div>
                <div class="score-box rate-box stat-item">
                    <span class="score-label">RATE</span>
                    <div class="score-num" id="ui-rate">x1.0</div>
                </div>
            </div>
        </div>

        <div class="round-info">
            <div>ROUND: <span id="ui-round">1</span> / 3</div>
            <div>ROLL: <span id="ui-roll">7</span> / 7</div>
        </div>

        <div class="inventory-section">
            <div class="inventory-header">
                <span>INVENTORY</span>
                <span id="ui-inv-count">0/7</span>
            </div>
            <div class="inventory-list" id="ui-inventory">
                <div style="opacity:0.5; text-align:center; padding:10px;">Empty</div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal">
    <div class="modal-box">
        <h2 id="modal-title">TITLE</h2>
        <p id="modal-msg">Message</p>
        <button class="modal-btn" onclick="game.nextPhase()">NEXT</button>
    </div>
</div>

<script>
// --- ÂÆöÊï∞ÂÆöÁæ© ---

const RARITY = {
    COMMON:    { id: 'common',    name: '„Ç≥„É¢„É≥',       color: 'var(--rarity-common)',    price: 1,  weight: 60 },
    UNCOMMON:  { id: 'uncommon',  name: '„Ç¢„É≥„Ç≥„É¢„É≥',     color: 'var(--rarity-uncommon)',  price: 2,  weight: 30 },
    RARE:      { id: 'rare',      name: '„É¨„Ç¢',        color: 'var(--rarity-rare)',      price: 4,  weight: 7 },
    SR:        { id: 'sr',        name: '„Çπ„Éº„Éë„Éº„É¨„Ç¢',   color: 'var(--rarity-sr)',        price: 8,  weight: 2.5 },
    LEGENDARY: { id: 'legendary', name: '„É¨„Ç∏„Çß„É≥„ÉÄ„É™„Éº', color: 'var(--rarity-legendary)', price: 16, weight: 0.5 }
};

// „Ç¢„Ç§„ÉÜ„É†„Éá„Éº„Çø„ÅÆÁîüÊàê
const ITEM_DATA = [];

// Èáë„ÅÆ„Äá„Äá (Common)
const GOLD_PROBS = [0.50, 0.45, 0.40, 0.35, 0.30, 0.25];
['Â£±','Âºê','ÂèÇ','ËÇÜ','‰ºç','Èô∏'].forEach((kanji, idx) => {
    const face = idx + 1;
    const prob = GOLD_PROBS[idx];
    ITEM_DATA.push({
        id: `gold_${face}`,
        name: `Èáë„ÅÆ${kanji}`,
        rarity: 'common',
        desc: `${kanji}„ÅÆÁõÆ„ÅåÂá∫„ÅüÊôÇ„ÄÅ${Math.floor(prob*100)}%„ÅÆÁ¢∫Áéá„Åß„ÄÅ${kanji}„ÅÆÂá∫ÁõÆÁÇπ„Åå${face}ÁÇπÂàÜ„ÄÅÊ∞∏Á∂öÁöÑ„Å´Âº∑Âåñ„Åï„Çå„Çã`,
        price: RARITY.COMMON.price,
        effectType: 'gold',
        targetFace: face,
        prob: prob
    });
});

// Âπ∏Á¶è„ÅÆ„Äá„Äá (Uncommon)
const HAPPY_PROBS = [0.30, 0.25, 0.20, 0.15, 0.10, 0.05];
['Â£±','Âºê','ÂèÇ','ËÇÜ','‰ºç','Èô∏'].forEach((kanji, idx) => {
    const face = idx + 1;
    const prob = HAPPY_PROBS[idx];
    ITEM_DATA.push({
        id: `happy_${face}`,
        name: `Âπ∏Á¶è„ÅÆ${kanji}`,
        rarity: 'uncommon',
        desc: `${kanji}„ÅÆÁõÆ„ÅåÂá∫„ÅüÊôÇ„ÄÅ${Math.floor(prob*100)}%„ÅÆÁ¢∫Áéá„Åß„ÉÅ„Ç±„ÉÉ„Éà„Çí1ÊûöÁç≤Âæó„Åô„Çã`,
        price: RARITY.UNCOMMON.price,
        effectType: 'happy',
        targetFace: face,
        prob: prob
    });
});

// Á¢∫ÁéáÊìç‰ΩúÁ≥ª„Ç¢„Ç§„ÉÜ„É† (Uncommon)
['Â£±','Âºê','ÂèÇ','ËÇÜ','‰ºç','Èô∏'].forEach((kanji, idx) => {
    const face = idx + 1;
    ITEM_DATA.push({
        id: `charm_fixed_${face}`,
        name: `${kanji}„ÅÆ„ÅäÂÆà„Çä`,
        rarity: 'uncommon',
        desc: `Â∏∏„Å´${kanji}„ÅÆÁõÆ„ÅåÂá∫„ÇãÁ¢∫Áéá„ÅÆÈáç„Åø„ÅåÂ¢óÂä†(+5)„Åó„ÄÅÂá∫„ÇÑ„Åô„Åè„Å™„Çã`,
        price: RARITY.UNCOMMON.price,
        effectType: 'weight_fixed',
        targetFace: face,
        value: 5
    });
});

ITEM_DATA.push({ id: 'charm_odd', name: 'Â•áÊï∞„ÅÆ„ÅäÂÆà„Çä', rarity: 'uncommon', desc: 'Â•áÊï∞(1,3,5)„ÅÆÁõÆ„ÅÆÂá∫„ÇÑ„Åô„Åï„Åå„ÄÅÂÖ®„Å¶‰∏äÊòá(+3)„Åô„Çã', price: RARITY.UNCOMMON.price, effectType: 'weight_parity', targetParity: 1, value: 3 });
ITEM_DATA.push({ id: 'charm_even', name: 'ÂÅ∂Êï∞„ÅÆ„ÅäÂÆà„Çä', rarity: 'uncommon', desc: 'ÂÅ∂Êï∞(2,4,6)„ÅÆÁõÆ„ÅÆÂá∫„ÇÑ„Åô„Åï„Åå„ÄÅÂÖ®„Å¶‰∏äÊòá(+3)„Åô„Çã', price: RARITY.UNCOMMON.price, effectType: 'weight_parity', targetParity: 0, value: 3 });
ITEM_DATA.push({ id: 'charm_cursed', name: 'Âë™„Çè„Çå„Åü„ÅäÂÆà„Çä', rarity: 'uncommon', desc: 'ÊúÄ„ÇÇÁÇπÊï∞„ÅÆÈ´ò„ÅÑÁõÆ„ÅåÂá∫Áèæ„Åó„Å™„Åè„Å™„ÇãÔºàÈáç„Åø„Åå0„Å´„Å™„ÇãÔºâ', price: RARITY.UNCOMMON.price, effectType: 'weight_curse' });

// LUCKÁ≥ª
ITEM_DATA.push({ id: 'luck_1', name: 'Êòü„ÅÆÊ¨†Áâá', rarity: 'common', desc: 'Âπ∏ÈÅã„Çπ„ÉÜ„Éº„Çø„Çπ„Åå50‰∏äÊòá„Åô„Çã', price: 1, effectType: 'luck_static', value: 50 });
ITEM_DATA.push({ id: 'luck_2', name: 'ÊúàÂÖâ„ÅÆÊåáËº™', rarity: 'uncommon', desc: 'Âπ∏ÈÅã„Çπ„ÉÜ„Éº„Çø„Çπ„Åå100‰∏äÊòá„Åô„Çã', price: 2, effectType: 'luck_static', value: 100 });
ITEM_DATA.push({ id: 'luck_3', name: 'Â§™ÈôΩ„ÅÆ„Çø„É™„Çπ„Éû„É≥', rarity: 'rare', desc: 'Âπ∏ÈÅã„Çπ„ÉÜ„Éº„Çø„Çπ„Åå200‰∏äÊòá„Åô„Çã', price: 4, effectType: 'luck_static', value: 200 });
ITEM_DATA.push({ id: 'luck_4', name: 'ÈÅãÂëΩ„ÅÆÊ≠ØËªä', rarity: 'sr', desc: 'Âπ∏ÈÅã„Çπ„ÉÜ„Éº„Çø„Çπ„Åå400‰∏äÊòá„Åô„Çã', price: 8, effectType: 'luck_static', value: 400 });
ITEM_DATA.push({ id: 'luck_5', name: 'Â•áË∑°„ÅÆËÅñÊùØ', rarity: 'legendary', desc: 'Âπ∏ÈÅã„Çπ„ÉÜ„Éº„Çø„Çπ„Åå1000‰∏äÊòá„Åô„Çã', price: 16, effectType: 'luck_static', value: 1000 });

ITEM_DATA.push({ id: 'luck_cond_menashi', name: 'Ê≥•Ê≤º„Åã„Çâ„ÅÆÂÖâ', rarity: 'common', desc: 'ÁõÆ„Å™„Åó„Åå2ÂõûÈÄ£Á∂ö„ÅßÁô∫Áîü„Åó„ÅüÊôÇ„ÄÅÊ¨°„ÅÆ„É≠„Éº„É´„ÅßÂπ∏ÈÅã„Åå‰∏ÄÊôÇÁöÑ„Å´+200„Åï„Çå„Çã', price: 1, effectType: 'luck_cond_menashi', value: 200 });
ITEM_DATA.push({ id: 'luck_chance_50', name: '„Ç≥„Ç§„É≥„ÅÆË°®Ë£è', rarity: 'common', desc: '„É≠„Éº„É´ÈñãÂßãÊôÇ„ÄÅ50%„ÅÆÁ¢∫Áéá„Åß„Åù„ÅÆ„É≠„Éº„É´‰∏≠„ÅÆÂπ∏ÈÅã„Åå+100„Åï„Çå„Çã', price: 1, effectType: 'luck_chance', prob: 0.5, value: 100 });
ITEM_DATA.push({ id: 'luck_chance_25', name: 'ÂõõÂàÜ„ÅÆ‰∏Ä„ÅÆË≥≠„Åë', rarity: 'common', desc: '„É≠„Éº„É´ÈñãÂßãÊôÇ„ÄÅ25%„ÅÆÁ¢∫Áéá„Åß„Åù„ÅÆ„É≠„Éº„É´‰∏≠„ÅÆÂπ∏ÈÅã„Åå+400„Åï„Çå„Çã', price: 1, effectType: 'luck_chance', prob: 0.25, value: 400 });
ITEM_DATA.push({ id: 'inv_expand', name: 'È≠îÊ≥ï„ÅÆÈûÑ', rarity: 'uncommon', desc: '„Ç¢„Ç§„ÉÜ„É†„ÅÆÊúÄÂ§ßÊâÄÊåÅÊï∞„Åå2„Å§Â¢óÂä†„Åô„Çã', price: 2, effectType: 'inv_expand', value: 2 });
ITEM_DATA.push({ id: 'buff_streak_win', name: 'Êòá„ÇäÈæç„ÅÆÂÉè', rarity: 'uncommon', desc: '„ÄåÁõÆ„ÅÇ„Çä„Äç‰ª•‰∏ä„ÅÆÂΩπ„Åå3ÈÄ£Á∂ö„ÅßÁ∂ö„ÅÑ„ÅüÊôÇ„ÄÅÂÖ®„Å¶„ÅÆ„Çµ„Ç§„Ç≥„É≠„ÅÆÂá∫ÁõÆÁÇπ„ÅåÂàùÊúüÂÄ§ÂàÜ„Å†„ÅëÊ∞∏Á∂öÁöÑ„Å´Âº∑Âåñ„Åï„Çå„Çã', price: 2, effectType: 'buff_streak_win' });

// ÁâπÊÆäÂäπÊûú
ITEM_DATA.push({ id: 'rate_ticket', name: '„ÉÅ„Ç±„ÉÉ„Éà„Éª„Çø„ÉÉ„ÇØ„Çπ', rarity: 'uncommon', desc: 'ÊâÄÊåÅ„Åó„Å¶„ÅÑ„Çã„ÉÅ„Ç±„ÉÉ„Éà10Êûö„Åî„Å®„Å´„ÄÅ„Çπ„Ç≥„Ç¢Ë®àÁÆóÊôÇ„ÅÆÂÖ®‰ΩìÂÄçÁéá„Åå+0.3Âä†ÁÆó„Åï„Çå„Çã', price: 2, effectType: 'rate_ticket', value: 0.3 });
ITEM_DATA.push({ id: 'nerf_low', name: 'Èáç„Çä', rarity: 'uncommon', desc: '1ÔΩû3„ÅÆÁõÆ„ÅÆÂá∫„ÇÑ„Åô„Åï„ÅåÊ∏õÂ∞ë(-2)„Åô„Çã', price: 2, effectType: 'weight_nerf_low', value: 2 });
ITEM_DATA.push({ id: 'nerf_high', name: 'ËªΩÁü≥', rarity: 'uncommon', desc: '4ÔΩû6„ÅÆÁõÆ„ÅÆÂá∫„ÇÑ„Åô„Åï„ÅåÊ∏õÂ∞ë(-3)„Åô„Çã', price: 2, effectType: 'weight_nerf_high', value: 3 });
ITEM_DATA.push({ id: 'ticket_interest', name: 'Âà©Â≠ê', rarity: 'uncommon', desc: '„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÊôÇ„ÄÅÊâÄÊåÅ„ÉÅ„Ç±„ÉÉ„Éà5Êûö„Å´„Å§„Åç+1Êûö„ÅÆ„ÉÅ„Ç±„ÉÉ„Éà„ÇíËøΩÂä†„ÅßÁç≤Âæó„Åô„Çã', price: 2, effectType: 'ticket_interest', value: 1 });
ITEM_DATA.push({ id: 'rate_streak', name: '„Ç≥„É≥„Éú„Éú„Éº„Éä„Çπ', rarity: 'common', desc: '„ÄåÁõÆ„ÅÇ„Çä„Äç‰ª•‰∏ä„ÅÆÂΩπ„ÅåÁ∂ö„ÅèÈôê„Çä„ÄÅÈÄ£ÂãùÊï∞„Å´Âøú„Åò„Å¶ÂÖ®‰ΩìÂÄçÁéá„Åå+0.2„Åö„Å§Âä†ÁÆó„Åï„Çå„ÇãÔºàÁõÆ„Å™„Åó„Éª„Éí„Éï„Éü„Åß„É™„Çª„ÉÉ„ÉàÔºâ', price: 1, effectType: 'rate_streak', value: 0.2 });
ITEM_DATA.push({ id: 'roll_add', name: '„Ç¢„É≥„Ç≥„Éº„É´', rarity: 'common', desc: '„É≠„Éº„É´„ÇíË°å„Å£„ÅüÈöõ„ÄÅ15%„ÅÆÁ¢∫Áéá„Åß„É≠„Éº„É´ÂõûÊï∞„Åå1ÂõûÂàÜÂõûÂæ©„Åô„Çã', price: 1, effectType: 'roll_add', prob: 0.15 });
ITEM_DATA.push({ id: 'prob_boost', name: 'Âπ∏ÈÅã„ÅÆ„ÇØ„É≠„Éº„Éê„Éº', rarity: 'common', desc: 'Á¢∫Áéá„ÅßÁô∫Âãï„Åô„Çã„Ç¢„Ç§„ÉÜ„É†„ÅÆÂà§ÂÆöÊàêÂäüÁéá„Åå2ÂÄç„Å´„Å™„Çã', price: 1, effectType: 'prob_boost' });
ITEM_DATA.push({ id: 'score_odd_2x', name: 'Â•áÊï∞„ÅÆÊ•µÊÑè', rarity: 'common', desc: '„Çµ„Ç§„Ç≥„É≠„ÅÆÂá∫ÁõÆ„ÅåÂ•áÊï∞„ÅÆÂ†¥Âêà„ÄÅ„Åù„ÅÆÂá∫ÁõÆ„Å´„Åã„Åã„ÇãË®àÁÆó‰∏ä„ÅÆ„Çπ„Ç≥„Ç¢„Åå2ÂÄç„Å´„Å™„Çã', price: 1, effectType: 'score_odd', value: 2 });
ITEM_DATA.push({ id: 'score_even_2x', name: 'ÂÅ∂Êï∞„ÅÆÊ•µÊÑè', rarity: 'common', desc: '„Çµ„Ç§„Ç≥„É≠„ÅÆÂá∫ÁõÆ„ÅåÂÅ∂Êï∞„ÅÆÂ†¥Âêà„ÄÅ„Åù„ÅÆÂá∫ÁõÆ„Å´„Åã„Åã„ÇãË®àÁÆó‰∏ä„ÅÆ„Çπ„Ç≥„Ç¢„Åå2ÂÄç„Å´„Å™„Çã', price: 1, effectType: 'score_even', value: 2 });
ITEM_DATA.push({ id: 'score_odd_focus', name: 'Â•áÊï∞„ÅÆÂë™Á∏õ', rarity: 'uncommon', desc: '„Çµ„Ç§„Ç≥„É≠„ÅÆÂá∫ÁõÆ„ÅåÂ•áÊï∞„ÅÆÂ†¥Âêà„Çπ„Ç≥„Ç¢„Åå4ÂÄç„Å´„Å™„Çã„Åå„ÄÅÂÅ∂Êï∞„ÅÆÂ†¥Âêà„ÅØ0.5ÂÄç„Å´„Å™„Çã', price: 2, effectType: 'score_focus_odd' });
ITEM_DATA.push({ id: 'score_even_focus', name: 'ÂÅ∂Êï∞„ÅÆÂë™Á∏õ', rarity: 'uncommon', desc: '„Çµ„Ç§„Ç≥„É≠„ÅÆÂá∫ÁõÆ„ÅåÂÅ∂Êï∞„ÅÆÂ†¥Âêà„Çπ„Ç≥„Ç¢„Åå4ÂÄç„Å´„Å™„Çã„Åå„ÄÅÂ•áÊï∞„ÅÆÂ†¥Âêà„ÅØ0.5ÂÄç„Å´„Å™„Çã', price: 2, effectType: 'score_focus_even' });

// „Éí„Éï„ÉüÁ≥ª
ITEM_DATA.push({ id: 'hifumi_act_roll', name: 'ÈÄÜÂ¢É„ÅÆÁ≥ß', rarity: 'uncommon', desc: 'ÂΩπ„Äå„Éí„Éï„Éü„Äç„ÅåÊàêÁ´ã„Åó„ÅüÊôÇ„ÄÅ„É≠„Éº„É´ÂõûÊï∞„Åå3ÂõûÂàÜÂõûÂæ©„Åô„ÇãÔºà1„É©„Ç¶„É≥„Éâ„Å´„Å§„Åç3Âõû„Åæ„ÅßÁô∫ÂãïÔºâ', price: 2, effectType: 'hifumi_act_roll' });
ITEM_DATA.push({ id: 'hifumi_act_pin', name: 'Ëµ∑Ê≠ªÂõûÁîü', rarity: 'uncommon', desc: 'ÂΩπ„Äå„Éí„Éï„Éü„Äç„ÅåÊàêÁ´ã„Åó„ÅüÊôÇ„ÄÅÊ¨°Âõû„ÅÆ„É≠„Éº„É´ÁµêÊûú„ÅåÁ¢∫ÂÆö„Åß„Äå„Éî„É≥„Çæ„É≠„Äç„Å´„Å™„Çã', price: 2, effectType: 'hifumi_act_pin' });
ITEM_DATA.push({ id: 'hifumi_guard', name: 'Ë∫´‰ª£„Çè„Çä„ÅÆ‰∫∫ÂΩ¢', rarity: 'uncommon', desc: 'ÂΩπ„Äå„Éí„Éï„Éü„Äç„ÅåÊàêÁ´ã„Åó„ÅüÈöõ„Å´Áô∫Áîü„Åô„Çã„ÄÅ„Éó„Éº„É´„Çπ„Ç≥„Ç¢Ê≤°Âèé„ÅÆ„Éö„Éä„É´„ÉÜ„Ç£„ÇíÁÑ°ÂäπÂåñ„Åô„Çã', price: 2, effectType: 'hifumi_guard' });
ITEM_DATA.push({ id: 'hifumi_buff_rate', name: 'ÁãÇÊà¶Â£´„ÅÆÈ≠Ç', rarity: 'rare', desc: 'ÂΩπ„Äå„Éí„Éï„Éü„Äç„ÅåÊàêÁ´ã„Åó„ÅüÊôÇ„ÄÅ„Åù„ÅÆ„É©„Ç¶„É≥„Éâ„ÅåÁµÇ‰∫Ü„Åô„Çã„Åæ„ÅßÂÖ®‰ΩìÂÄçÁéá„Å´+4.0„ÇíÂä†ÁÆó„Åô„Çã', price: 4, effectType: 'hifumi_buff_rate' });
ITEM_DATA.push({ id: 'hifumi_buff_face', name: 'Ê∑∑Ê≤å„ÅÆÂäõ', rarity: 'rare', desc: 'ÂΩπ„Äå„Éí„Éï„Éü„Äç„ÅåÊàêÁ´ã„Åó„ÅüÊôÇ„ÄÅÂÖ®„Å¶„ÅÆ„Çµ„Ç§„Ç≥„É≠„ÅÆÂá∫ÁõÆÁÇπ„ÅåÊ∞∏Á∂öÁöÑ„Å´2ÂÄç„Å´„Å™„Çã', price: 4, effectType: 'hifumi_buff_face' });
ITEM_DATA.push({ id: 'hifumi_gain_ticket', name: '‰øùÈô∫Èáë', rarity: 'rare', desc: 'ÂΩπ„Äå„Éí„Éï„Éü„Äç„ÅåÊàêÁ´ã„Åó„ÅüÊôÇ„ÄÅ‰øùÈô∫Èáë„Å®„Åó„Å¶„ÉÅ„Ç±„ÉÉ„Éà„Çí20ÊûöÁç≤Âæó„Åô„Çã', price: 4, effectType: 'hifumi_gain_ticket' });
ITEM_DATA.push({ id: 'start_fixed_hifumi', name: 'Á†¥ÊªÖ„ÅÆÂ•ëÁ¥ÑÊõ∏', rarity: 'sr', desc: 'ÂêÑ„É©„Ç¶„É≥„Éâ„ÅÆÊúÄÂàù„ÅÆ„É≠„Éº„É´ÁµêÊûú„Åå„ÄÅÂõûÈÅø‰∏çËÉΩ„Å™Á¢∫ÂÆö„ÅÆ„Äå„Éí„Éï„Éü„Äç„Å´„Å™„Çã', price: 8, effectType: 'start_fixed_hifumi' });

// === Êñ∞Ë¶èËøΩÂä†„Ç¢„Ç§„ÉÜ„É† (ÁÑ°ÊñôÂÜçÂÖ•Ëç∑Á≥ª) ===
ITEM_DATA.push({ id: 'reroll_c_1', name: 'ÂïÜ‰∫∫„ÅÆ‰ºöÂì°Ë®º', rarity: 'common', desc: 'Êñ∞„Åó„ÅÑ„Çπ„ÉÜ„Éº„Ç∏„ÅåÈñãÂßã„Åï„Çå„Çã„Åü„Å≥„ÄÅ„Ç∑„Éß„ÉÉ„Éó„ÅÆÁÑ°ÊñôÂÜçÂÖ•Ëç∑ÂõûÊï∞„Åå2ÂõûÂàÜËøΩÂä†„Åï„Çå„Çã', price: 1, effectType: 'reroll_stage', value: 2 });
ITEM_DATA.push({ id: 'reroll_r_1', name: 'Ë≤¥Êóè„ÅÆÁ¥π‰ªãÁä∂', rarity: 'rare', desc: 'ÂêÑ„É©„Ç¶„É≥„Éâ„ÅåÁµÇ‰∫Ü„Åô„Çã„Åü„Å≥„ÄÅ„Ç∑„Éß„ÉÉ„Éó„ÅÆÁÑ°ÊñôÂÜçÂÖ•Ëç∑ÂõûÊï∞„Åå1ÂõûÂàÜËøΩÂä†„Åï„Çå„Çã', price: 4, effectType: 'reroll_round', value: 1 });

// --- „Éó„É¨„Çπ„ÉÜ„Éº„Ç∏„Éá„Éº„ÇøÂÆöÁæ© ---
const PRESTIGE_OPTIONS = [
    // Âá∫ÁõÆÁ¢∫Áéá„Ç¢„ÉÉ„Éó
    { type: 'weight', target: 1, text: 'Â£±„ÅÆÁõÆ„ÅÆÂá∫„ÇãÁ¢∫Áéá„ÅÆÈáç„Åø„Åå+3Ê∞∏Á∂öÁöÑ„Å´Â¢óÂä†„Åô„Çã', icon: '‚öÄ' },
    { type: 'weight', target: 2, text: 'Âºê„ÅÆÁõÆ„ÅÆÂá∫„ÇãÁ¢∫Áéá„ÅÆÈáç„Åø„Åå+3Ê∞∏Á∂öÁöÑ„Å´Â¢óÂä†„Åô„Çã', icon: '‚öÅ' },
    { type: 'weight', target: 3, text: 'ÂèÇ„ÅÆÁõÆ„ÅÆÂá∫„ÇãÁ¢∫Áéá„ÅÆÈáç„Åø„Åå+3Ê∞∏Á∂öÁöÑ„Å´Â¢óÂä†„Åô„Çã', icon: '‚öÇ' },
    { type: 'weight', target: 4, text: 'ËÇÜ„ÅÆÁõÆ„ÅÆÂá∫„ÇãÁ¢∫Áéá„ÅÆÈáç„Åø„Åå+3Ê∞∏Á∂öÁöÑ„Å´Â¢óÂä†„Åô„Çã', icon: '‚öÉ' },
    { type: 'weight', target: 5, text: '‰ºç„ÅÆÁõÆ„ÅÆÂá∫„ÇãÁ¢∫Áéá„ÅÆÈáç„Åø„Åå+3Ê∞∏Á∂öÁöÑ„Å´Â¢óÂä†„Åô„Çã', icon: '‚öÑ' },
    { type: 'weight', target: 6, text: 'Èô∏„ÅÆÁõÆ„ÅÆÂá∫„ÇãÁ¢∫Áéá„ÅÆÈáç„Åø„Åå+3Ê∞∏Á∂öÁöÑ„Å´Â¢óÂä†„Åô„Çã', icon: '‚öÖ' },
    // ÂΩπÂÄçÁéá2ÂÄç (BaseÊõ¥Êñ∞)
    { type: 'multi', target: 'pinzoro', text: 'ÂΩπ„Äå„Éî„É≥„Çæ„É≠„Äç„ÅÆÁèæÂú®„ÅÆÂÄçÁéá„Åå2ÂÄç„Å´„Å™„ÇãÔºàÂü∫Á§éÁÇπÊõ¥Êñ∞Ôºâ', icon: 'üëë' },
    { type: 'multi', target: 'arashi', text: 'ÂΩπ„Äå„Ç¢„É©„Ç∑„Äç„ÅÆÁèæÂú®„ÅÆÂÄçÁéá„Åå2ÂÄç„Å´„Å™„ÇãÔºàÂü∫Á§éÁÇπÊõ¥Êñ∞Ôºâ', icon: 'üåÄ' },
    { type: 'multi', target: '456', text: 'ÂΩπ„Äå„Ç∑„Ç¥„É≠„Äç„ÅÆÁèæÂú®„ÅÆÂÄçÁéá„Åå2ÂÄç„Å´„Å™„ÇãÔºàÂü∫Á§éÁÇπÊõ¥Êñ∞Ôºâ', icon: 'üî•' },
    { type: 'multi', target: 'meari', text: 'ÂΩπ„ÄåÁõÆ„ÅÇ„Çä„Äç„ÅÆÁèæÂú®„ÅÆÂÄçÁéá„Åå2ÂÄç„Å´„Å™„ÇãÔºàÂü∫Á§éÁÇπÊõ¥Êñ∞Ôºâ', icon: 'üëÄ' },
    { type: 'multi', target: 'menashi', text: 'ÂΩπ„ÄåÁõÆ„Å™„Åó„Äç„ÅÆÁèæÂú®„ÅÆÂÄçÁéá„Åå2ÂÄç„Å´„Å™„ÇãÔºàÂü∫Á§éÁÇπÊõ¥Êñ∞Ôºâ', icon: '‚ò†Ô∏è' },
    // „ÉÅ„Ç±„ÉÉ„ÉàÁç≤Âæó
    { type: 'ticket', val: 5, text: '„ÉÅ„Ç±„ÉÉ„Éà„Çí5ÊûöÁç≤Âæó„Åô„Çã', icon: 'üé´' },
    // „Ç§„É≥„Éô„É≥„Éà„É™ÊúÄÂ§ßÊï∞
    { type: 'inv_max', text: '„Ç§„É≥„Éô„É≥„Éà„É™„ÅÆÊúÄÂ§ßÊï∞„ÅåÊ∞∏Á∂öÁöÑ„Å´1„Å§Â¢óÂä†„Åô„Çã', icon: 'üéí' }
];


// --- „Ç≤„Éº„É†„ÇØ„É©„Çπ ---

class Game {
    constructor() {
        this.diceChars = ['?', '‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
        this.stage = 1;
        this.round = 1;
        this.rollCount = 7;
        this.initialRollCount = 7; // ÂàùÊúü„É≠„Éº„É´Êï∞ÔºàÂà§ÂÆöÁî®Ôºâ
        this.pool = 0;
        this.totalScore = 0;
        this.targetScore = 1500;
        
        // Áä∂ÊÖãÂ§âÊï∞
        this.diceWeights = [0, 5, 5, 5, 5, 5, 5];
        this.faceValues = [0, 1, 2, 3, 4, 5, 6]; 
        this.baseMultipliers = {
            'pinzoro': 500, 'arashi': 100, '456': 20, 'meari': 5, 'menashi': 1, 'hifumi': 0
        };
        this.yakuMultipliers = { ...this.baseMultipliers };

        this.tickets = 4;
        this.freeRerolls = 0; 
        this.baseLuck = 50;
        this.currentLuck = 50;
        this.globalMultiplier = 1.0; 
        this.inventory = [];
        this.shopItems = []; 
        this.rerollCost = 1;
        this.maxInventory = 7;

        // ÈÄ£Èéñ„Éª‰∏ÄÊôÇÂäπÊûúÁÆ°ÁêÜ
        this.streakMenashi = 0;
        this.streakWin = 0;
        this.tempLuckBoost = 0;
        
        // Êñ∞Ë¶èËøΩÂä†Áä∂ÊÖã
        this.tempRateBoost = 0; // „Éí„Éï„ÉüRate+4.0Áî®
        this.hifumiTriggerCount = 0; // „Éí„Éï„ÉüRollÂõûÂæ©„ÅÆÂõûÊï∞Âà∂ÈôêÁî®
        this.nextRollFixedDice = null; // Ê¨°ÂõûÁ¢∫ÂÆöÂá∫ÁõÆ (ÈÖçÂàó)
        this.forcedDice = null; // rollÂÜÖ„Åß‰ΩøÁî®„Åô„Çã‰∏ÄÊôÇÂ§âÊï∞
        
        // „Éó„É¨„Çπ„ÉÜ„Éº„Ç∏Èñ¢ÈÄ£Áä∂ÊÖã
        this.prestigeState = {
            weights: [0, 0, 0, 0, 0, 0, 0], // ÂêÑÂá∫ÁõÆ„ÅÆËøΩÂä†„Ç¶„Çß„Ç§„Éà
            extraInv: 0 // „Ç§„É≥„Éô„É≥„Éà„É™ËøΩÂä†ÂàÜ
        };
        this.prestigeRerollCost = 1;
        this.currentPrestigeOptions = [];

        // „Ç∑„Éß„ÉÉ„ÉóÈñãÈñâ„Éï„É©„Ç∞
        this.isShopOpen = false;

        this.roundGains = { faces: [0,0,0,0,0,0,0], yakus: {} };

        // UIÂèÇÁÖß
        this.ui = {
            stage: document.getElementById('ui-stage'),
            round: document.getElementById('ui-round'),
            roll: document.getElementById('ui-roll'),
            pool: document.getElementById('ui-pool'),
            target: document.getElementById('ui-target'),
            total: document.getElementById('ui-total'),
            tickets: document.getElementById('ui-tickets'),
            luck: document.getElementById('ui-luck'),
            rate: document.getElementById('ui-rate'), 
            invList: document.getElementById('ui-inventory'),
            invCount: document.getElementById('ui-inv-count'),
            diceCont: document.getElementById('dice-container'),
            msgMain: document.getElementById('msg-main'),
            msgSub: document.getElementById('msg-sub'),
            msgLog: document.getElementById('msg-log'),
            btnRoll: document.getElementById('btn-roll'),
            btnShop: document.getElementById('btn-shop'),
            btnClear: document.getElementById('btn-clear'),
            clearSub: document.getElementById('clear-sub'),
            mainPanel: document.getElementById('main-panel'),
            gameView: document.getElementById('game-view'),
            shopView: document.getElementById('shop-view'),
            shopShelves: document.getElementById('shop-shelves'),
            btnReroll: document.getElementById('btn-reroll'),
            
            prestigeView: document.getElementById('prestige-view'),
            prestigeCont: document.getElementById('prestige-container'),
            btnPrestigeReroll: document.getElementById('btn-prestige-reroll'),

            modal: document.getElementById('modal'),
            mTitle: document.getElementById('modal-title'),
            mMsg: document.getElementById('modal-msg'),
            tableFaces: document.getElementById('table-faces'),
            tableYaku: document.getElementById('table-yaku')
        };
        
        this.initStage();
    }

    initStage() {
        this.round = 1;
        this.pool = 0;
        this.rollCount = this.initialRollCount;
        this.targetScore = Math.floor(1000 * Math.pow(3.0, this.stage - 1));
        
        this.nextRollFixedDice = null;
        this.tempRateBoost = 0;
        this.hifumiTriggerCount = 0;

        // „Çπ„ÉÜ„Éº„Ç∏ÈñãÂßãÊôÇ„ÅÆÁÑ°ÊñôÂÜçÂÖ•Ëç∑‰ªò‰∏é
        this.inventory.forEach(item => {
            if (item.effectType === 'reroll_stage') {
                this.freeRerolls += item.value;
            }
        });

        this.recalcStats();
        this.rerollCost = 1;
        this.generateShopItems();

        this.updateUI();
        this.updateTables();
        this.updateClearButton();
        
        this.ui.msgMain.textContent = `STAGE ${this.stage}`;
        this.ui.msgMain.classList.remove('hifumi-text');
        this.ui.msgSub.textContent = `ÁõÆÊ®ô: ${this.targetScore.toLocaleString()}pt`;
        this.ui.btnShop.classList.remove('hidden-el');
        this.ui.btnShop.disabled = false;
        this.ui.btnRoll.disabled = false;
        
        this.ui.msgLog.innerHTML = "";

        // „Ç≤„Éº„É†ÈñãÂßãÊôÇÔºà„Çπ„ÉÜ„Éº„Ç∏1Ôºâ„ÅÆ„ÅøËá™Âãï„Åß„Ç∑„Éß„ÉÉ„Éó„ÇíÈñã„Åè
        if (this.stage === 1) {
            this.openShop();
        } else {
            this.closeShop();
        }
    }

    clearLogs() {
        this.ui.msgLog.innerHTML = "";
    }

    addLog(text, type) {
        const span = document.createElement('span');
        span.className = `log-tag ${type || ''}`;
        span.textContent = text;
        this.ui.msgLog.appendChild(span);
    }

    checkProb(baseProb) {
        let prob = baseProb;
        const hasBoost = this.inventory.some(i => i.effectType === 'prob_boost');
        if (hasBoost) prob *= 2;
        return Math.random() < prob;
    }

    recalcStats() {
        // 1. „Ç¶„Çß„Ç§„ÉàË®àÁÆó
        let w = [0, 5, 5, 5, 5, 5, 5];
        this.inventory.forEach(item => {
            if (item.effectType === 'weight_fixed') w[item.targetFace] += item.value;
            if (item.effectType === 'weight_parity') {
                for(let i=1; i<=6; i++) if (i % 2 === item.targetParity) w[i] += item.value;
            }
            if (item.effectType === 'weight_bless') {
                let minVal = Infinity;
                for(let i=1; i<=6; i++) if(this.faceValues[i] < minVal) minVal = this.faceValues[i];
                let targets = [];
                for(let i=1; i<=6; i++) if(this.faceValues[i] === minVal) targets.push(i);
                targets.forEach(t => w[t] += item.value);
            }
            if (item.effectType === 'weight_nerf_low') {
                for(let i=1; i<=3; i++) w[i] -= item.value;
            }
            if (item.effectType === 'weight_nerf_high') {
                for(let i=4; i<=6; i++) w[i] -= item.value;
            }
        });
        
        // „Éó„É¨„Çπ„ÉÜ„Éº„Ç∏ÂäπÊûúÔºà„Ç¶„Çß„Ç§„ÉàÔºâ„ÇíÂä†ÁÆó
        for(let i=1; i<=6; i++) {
            w[i] += this.prestigeState.weights[i];
        }

        for(let i=1; i<=6; i++) if(w[i] < 0) w[i] = 0;

        this.inventory.forEach(item => {
            if (item.effectType === 'weight_curse') {
                let maxVal = -Infinity;
                for(let i=1; i<=6; i++) if(this.faceValues[i] > maxVal) maxVal = this.faceValues[i];
                let targets = [];
                for(let i=1; i<=6; i++) if(this.faceValues[i] === maxVal) targets.push(i);
                targets.forEach(t => w[t] = 0);
            }
        });
        this.diceWeights = w;

        // 2. Âü∫Êú¨LuckË®àÁÆó
        let l = 50;
        this.inventory.forEach(item => {
            if (item.effectType === 'luck_static') l += item.value;
        });
        this.baseLuck = l;
        this.currentLuck = l; 

        // 3. „Ç§„É≥„Éô„É≥„Éà„É™ÊúÄÂ§ßÊï∞
        let maxInv = 7 + this.prestigeState.extraInv; // „Éó„É¨„Çπ„ÉÜ„Éº„Ç∏ÂàÜ„ÇíÂä†ÁÆó
        this.inventory.forEach(item => {
            if (item.effectType === 'inv_expand') maxInv += item.value;
        });
        this.maxInventory = maxInv;

        // 4. ÂÖ®‰ΩìÂÄçÁéáË®àÁÆó
        let rate = 1.0;
        this.inventory.forEach(item => {
            if (item.effectType === 'rate_ticket') {
                rate += Math.floor(this.tickets / 10) * item.value;
            }
            if (item.effectType === 'rate_streak') {
                rate += this.streakWin * item.value;
            }
        });
        rate += this.tempRateBoost; 
        this.globalMultiplier = rate;

        this.updateTables();
    }

    roll() {
        if (this.rollCount <= 0) return;
        
        this.resetGains();
        this.recalcStats();
        this.updateTables();
        this.clearLogs();

        // Á¢∫ÂÆöÂá∫ÁõÆ„ÅÆÂà§ÂÆö
        this.forcedDice = null;
        
        if (this.rollCount === this.initialRollCount) {
            const starter = this.inventory.find(i => i.effectType === 'start_fixed_hifumi');
            if (starter) {
                this.forcedDice = [1, 2, 3];
                this.addLog(`üìú${starter.name}`, 'log-hifumi');
            }
        }
        
        if (!this.forcedDice && this.nextRollFixedDice) {
            this.forcedDice = [...this.nextRollFixedDice];
            this.nextRollFixedDice = null;
            this.addLog(`üî•Á¢∫ÂÆöÊºîÂá∫`, 'log-buff');
        }

        // ‰∏ÄÊôÇLUCKË®àÁÆó
        let rollLuck = this.baseLuck + this.tempLuckBoost;
        this.tempLuckBoost = 0; 

        this.inventory.forEach(item => {
            if (item.effectType === 'luck_chance') {
                if (this.checkProb(item.prob)) { 
                    rollLuck += item.value;
                    this.addLog(`‚ú®${item.name}`, 'log-luck');
                }
            }
        });
        this.currentLuck = rollLuck;

        this.ui.btnRoll.disabled = true;
        this.ui.btnShop.classList.add('hidden-el');
        this.ui.btnClear.classList.remove('visible'); 
        document.getElementById('pool-box').classList.remove('shock-effect');

        // ÊºîÂá∫Áî®
        let count = 0;
        const interval = setInterval(() => {
            const dummyDice = [this.rand(), this.rand(), this.rand()];
            this.renderDice(dummyDice);
            count++;
            if (count > 8) {
                clearInterval(interval);
                this.resolveRoll();
            }
        }, 60);
    }

    resetGains() {
        this.roundGains = { faces: [0,0,0,0,0,0,0], yakus: {} };
    }

    rand() { return Math.floor(Math.random()*6)+1; }

    getWeightedRandom() {
        const total = this.diceWeights.reduce((a, b) => a + b, 0);
        if (total <= 0) return Math.floor(Math.random()*6)+1;

        let r = Math.random() * total;
        for (let i = 1; i <= 6; i++) {
            if (r < this.diceWeights[i]) return i;
            r -= this.diceWeights[i];
        }
        return 6;
    }

    resolveRoll() {
        let dice, res;
        let rollAttempts = [];
        
        if (this.forcedDice) {
            dice = this.forcedDice;
            res = this.calc(dice);
            rollAttempts.push({ dice, res });
            this.forcedDice = null;
        } else {
            // Luck„Å´„Çà„ÇãË§áÊï∞Âõû„É≠„Éº„É´„Å®„Éô„Çπ„ÉàÈÅ∏Êäû
            let activeLuck = this.currentLuck;
            
            do {
                let d = [this.getWeightedRandom(), this.getWeightedRandom(), this.getWeightedRandom()];
                let r = this.calc(d);
                rollAttempts.push({ dice: d, res: r });

                if (Math.random() * 100 < activeLuck) {
                    activeLuck /= 2;
                } else {
                    break;
                }
            } while (true);
        }

        rollAttempts.sort((a, b) => b.res.score - a.res.score);
        const best = rollAttempts[0];
        dice = best.dice;
        res = best.res;

        const luckTriggerCount = rollAttempts.length - 1;
        if (luckTriggerCount > 0) {
             this.addLog(`LUCKÁô∫Âãï x${luckTriggerCount}`, 'log-luck');
        }

        if (res.yakuKey === 'menashi') {
            this.streakMenashi++;
            this.streakWin = 0;
        } else if (res.yakuKey !== 'hifumi') { 
            this.streakWin++;
            this.streakMenashi = 0;
        } else {
            this.streakMenashi = 0;
            this.streakWin = 0;
        }

        this.inventory.forEach(item => {
            if (item.effectType === 'luck_cond_menashi') {
                if (this.streakMenashi >= 2) this.tempLuckBoost += item.value;
            }
        });

        if (this.streakWin >= 3) {
            let dragonFired = false;
            this.inventory.forEach(item => {
                if (item.effectType === 'buff_streak_win') {
                    for(let i=1; i<=6; i++) {
                        this.faceValues[i] += i; 
                        this.roundGains.faces[i] += i;
                    }
                    dragonFired = true;
                    this.addLog(`üê≤${item.name}`, 'log-buff');
                }
            });
            if(dragonFired) {
                this.recalcStats();
                res = this.calc(dice);
            }
        }

        this.renderDice(dice);
        this.checkPreCalcEffects(dice);
        
        this.ui.msgMain.classList.remove('hifumi-text');
        
        if (res.isHifumi) {
            this.ui.msgMain.textContent = "„Éí„Éï„ÉüÔºÅÔºÅÔºÅ";
            this.ui.msgMain.classList.add('hifumi-text');
            
            const guardItem = this.inventory.find(i => i.effectType === 'hifumi_guard');
            
            if (guardItem) {
                this.addLog(`üõ°Ô∏è${guardItem.name}`, 'log-buff');
                this.ui.msgSub.innerHTML = "<span style='color:#2ecc71'>„Éö„Éä„É´„ÉÜ„Ç£ÁÑ°ÂäπÂåñÔºÅ</span>";
            } else {
                this.pool = 0;
                this.ui.msgSub.innerHTML = "<span style='color:#e74c3c; font-weight:bold;'>„Éö„Éä„É´„ÉÜ„Ç£Áô∫ÂãïÔºÅ„Éó„Éº„É´Ê≤°ÂèéÔºÅ</span>";
                document.getElementById('pool-box').classList.add('shock-effect');
            }

            this.triggerHifumiEffects();

        } else {
            this.pool += res.score;
            this.ui.msgMain.textContent = res.yakuName;
            this.ui.msgSub.textContent = `Âá∫ÁõÆ(${res.sum}) √ó ÂÄçÁéá(${res.mul}) = +${res.score.toLocaleString()}pt`;
            this.checkPostCalcEffects(dice, res.yakuKey);
        }

        this.rollCount--;

        this.inventory.forEach(item => {
            if (item.effectType === 'roll_add') {
                if (this.checkProb(item.prob)) {
                    this.rollCount++;
                    this.addLog(`üéµ${item.name}`, 'log-luck');
                }
            }
        });

        this.currentLuck = this.baseLuck; 
        
        this.updateUI();
        this.updateTables();

        if (this.rollCount <= 0) {
            this.ui.btnRoll.disabled = true;
            setTimeout(() => this.endRound(), 1500);
        } else {
            this.ui.btnRoll.disabled = false;
        }
    }

    triggerHifumiEffects() {
        let recalcNeeded = false;

        this.inventory.forEach(item => {
            if (item.effectType === 'hifumi_act_roll') {
                if (this.hifumiTriggerCount < 3) {
                    this.rollCount += 3;
                    this.hifumiTriggerCount++;
                    this.addLog(`ü•ñ${item.name}(+3 Roll)`, 'log-buff');
                } else {
                    this.addLog(`(‰∏äÈôê)${item.name}`, 'log-bad');
                }
            }
            if (item.effectType === 'hifumi_act_pin') {
                this.nextRollFixedDice = [1, 1, 1];
                this.addLog(`‚öîÔ∏è${item.name}`, 'log-buff');
            }
            if (item.effectType === 'hifumi_buff_rate') {
                this.tempRateBoost += 4.0;
                this.addLog(`üò°${item.name}`, 'log-rate');
                recalcNeeded = true;
            }
            if (item.effectType === 'hifumi_buff_face') {
                for(let i=1; i<=6; i++) {
                    this.faceValues[i] *= 2;
                    this.roundGains.faces[i] += this.faceValues[i] / 2;
                }
                this.addLog(`üåÄ${item.name}`, 'log-buff');
            }
            if (item.effectType === 'hifumi_gain_ticket') {
                this.tickets += 20;
                this.addLog(`üí∞${item.name}`, 'log-ticket');
            }
        });
        
        if (recalcNeeded) this.recalcStats();
    }

    calc(dice) {
        const sorted = [...dice].sort((a,b)=>a-b);
        
        let sum = 0;
        dice.forEach(d => {
            let val = this.faceValues[d];
            let multiplier = 1.0;
            const isOdd = (d % 2 !== 0);

            this.inventory.forEach(item => {
                if (item.effectType === 'score_odd' && isOdd) multiplier *= item.value;
                if (item.effectType === 'score_even' && !isOdd) multiplier *= item.value;
                if (item.effectType === 'score_focus_odd') {
                    if (isOdd) multiplier *= 4; else multiplier *= 0.5;
                }
                if (item.effectType === 'score_focus_even') {
                    if (!isOdd) multiplier *= 4; else multiplier *= 0.5;
                }
            });
            sum += val * multiplier;
        });
        sum = Math.floor(sum);

        let yakuKey = 'menashi';
        let yakuName = "ÁõÆ„Å™„Åó";
        let isHifumi = false;

        if (sorted[0]===1 && sorted[1]===1 && sorted[2]===1) { yakuKey='pinzoro'; yakuName="„Éî„É≥„Çæ„É≠"; }
        else if (sorted[0]===sorted[1] && sorted[1]===sorted[2]) { yakuKey='arashi'; yakuName="„Ç¢„É©„Ç∑"; }
        else if (sorted[0]===4 && sorted[1]===5 && sorted[2]===6) { yakuKey='456'; yakuName="„Ç∑„Ç¥„É≠"; }
        else if (sorted[0]===1 && sorted[1]===2 && sorted[2]===3) { yakuKey='hifumi'; yakuName="„Éí„Éï„Éü"; isHifumi=true; }
        else if (sorted[0]===sorted[1] || sorted[1]===sorted[2] || sorted[0]===sorted[2]) { yakuKey='meari'; yakuName="ÁõÆ„ÅÇ„Çä"; }

        let mul = this.yakuMultipliers[yakuKey];
        // „Éó„É¨„Çπ„ÉÜ„Éº„Ç∏ÂäπÊûúÔºàÂΩπÂÄçÁéáÂ§âÊõ¥Ôºâ„ÅØBase„Å´Áµ±Âêà„Åï„Çå„Åü„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØÂçòÁ¥îÂèñÂæó

        const finalScore = Math.floor(sum * mul * this.globalMultiplier);

        return { sum, mul, score: finalScore, yakuName, yakuKey, isHifumi };
    }

    checkPreCalcEffects(dice) {
        this.inventory.forEach(item => {
            if (item.effectType === 'happy') {
                const count = dice.filter(d => d === item.targetFace).length;
                for(let i=0; i<count; i++) {
                    if (Math.random() < item.prob) { 
                        this.tickets++;
                        this.addLog(`üé´${item.name}`, 'log-ticket');
                    }
                }
            }
        });
    }

    checkPostCalcEffects(dice, yakuKey) {
        let changed = false;
        this.inventory.forEach(item => {
            if (item.effectType === 'gold') {
                const count = dice.filter(d => d === item.targetFace).length;
                for(let i=0; i<count; i++) {
                    if (this.checkProb(item.prob)) { 
                        this.faceValues[item.targetFace] += item.targetFace;
                        this.roundGains.faces[item.targetFace] += item.targetFace;
                        this.addLog(`üí™${item.name}`, 'log-buff');
                        changed = true;
                    }
                }
            }
        });
        if(changed) this.recalcStats();
    }

    endRound() {
        this.totalScore += this.pool;
        const earned = this.pool;
        this.pool = 0;
        
        // ‰∏ÄÊôÇÂäπÊûú„É™„Çª„ÉÉ„Éà
        this.tempRateBoost = 0;
        this.hifumiTriggerCount = 0;

        // „É©„Ç¶„É≥„ÉâÁµÇ‰∫ÜÊôÇ„ÅÆÁÑ°ÊñôÂÜçÂÖ•Ëç∑‰ªò‰∏é
        this.inventory.forEach(item => {
            if (item.effectType === 'reroll_round') {
                this.freeRerolls += item.value;
            }
        });
        
        this.ui.btnClear.classList.remove('visible'); 

        this.ui.msgMain.textContent = "ROUND FINISH";
        this.ui.msgMain.classList.remove('hifumi-text');
        this.ui.msgSub.textContent = `Áç≤Âæó: ${earned.toLocaleString()}pt / ÂêàË®à: ${this.totalScore.toLocaleString()}pt`;
        document.getElementById('pool-box').classList.remove('shock-effect');
        
        this.updateUI();
        
        this.round++;
        this.rollCount = this.initialRollCount;

        if (this.round > 3) {
            setTimeout(() => this.checkStageClear(), 1500);
        } else {
            setTimeout(() => {
                this.ui.msgMain.textContent = `ROUND ${this.round}`;
                this.ui.msgSub.textContent = "„Ç∑„Éß„ÉÉ„ÉóÂà©Áî®ÂèØËÉΩ";
                this.ui.btnRoll.disabled = false;
                this.ui.btnShop.classList.remove('hidden-el');
                this.ui.btnShop.disabled = false;
                this.clearLogs(); 
                this.recalcStats(); // „É¨„Éº„Éà„É™„Çª„ÉÉ„ÉàÂèçÊò†„ÅÆ„Åü„ÇÅ
                this.updateUI();
                this.updateClearButton(); 
            }, 1500);
        }
    }

    calculateReward() {
        let roundsLeft = Math.max(0, 4 - this.round);
        let bonus = 0;
        this.inventory.forEach(item => {
            if (item.effectType === 'ticket_interest') {
                bonus += Math.floor(this.tickets / 5) * item.value;
            }
        });
        
        return 2 + (roundsLeft * 2) + bonus;
    }

    updateClearButton() {
        if (this.totalScore >= this.targetScore && this.round <= 3) {
            const reward = this.calculateReward();
            this.ui.clearSub.textContent = `(+${reward} üé´)`;
            this.ui.btnClear.classList.add('visible');
        } else {
            this.ui.btnClear.classList.remove('visible');
        }
    }

    stageWin() {
        const reward = this.calculateReward();
        const roundsLeft = Math.max(0, 4 - this.round);
        
        this.tickets += reward;
        // „Çπ„Ç≥„Ç¢ÊîØÊâï„ÅÑÂá¶ÁêÜ
        const paid = this.targetScore;
        this.totalScore -= this.targetScore;
        this.updateUI();

        this.showModal("STAGE CLEAR! üéâ", 
            `ÁõÆÊ®ô„Çπ„Ç≥„Ç¢ÈÅîÊàêÔºÅ<br>
             ÊîØÊâï„ÅÑ: -${paid.toLocaleString()}pt<br>
             ÊÆã„Çä„Çπ„Ç≥„Ç¢: ${this.totalScore.toLocaleString()}pt<br>
             <div style="margin-top:10px; font-size:0.9em; background:#eee; padding:10px; border-radius:5px; color:#333;">
                Áç≤Âæó: ${reward}Êûö<br>
                (Âü∫Êú¨2 + ÊÆãR${roundsLeft}x2 + „Ç¢„Ç§„ÉÜ„É†Á≠â)
             </div>`, 
            true);
    }

    checkStageClear() {
        if (this.totalScore >= this.targetScore) {
            const reward = this.calculateReward(); 
            this.tickets += reward;
            // „Çπ„Ç≥„Ç¢ÊîØÊâï„ÅÑÂá¶ÁêÜ
            const paid = this.targetScore;
            this.totalScore -= this.targetScore;
            this.updateUI();

            this.showModal("STAGE CLEAR! üéâ", 
            `ÁõÆÊ®ô„Çπ„Ç≥„Ç¢ÈÅîÊàêÔºÅ<br>
             ÊîØÊâï„ÅÑ: -${paid.toLocaleString()}pt<br>
             ÊÆã„Çä„Çπ„Ç≥„Ç¢: ${this.totalScore.toLocaleString()}pt<br>
             <div style="margin-top:10px; font-size:0.9em; background:#eee; padding:10px; border-radius:5px; color:#333;">
                Áç≤Âæó: ${reward}Êûö
             </div>`, 
            true);
        } else {
            this.showModal("GAME OVER", `SCORE: ${this.totalScore.toLocaleString()}<br>ÁõÆÊ®ô(${this.targetScore.toLocaleString()})„Å´Â±ä„Åã„Åö...`, false);
        }
    }

    updateTables() {
        let htmlFaces = `<tr><th>Âá∫ÁõÆ</th><th>ÁÇπÊï∞</th><th>Á¢∫Áéá</th></tr>`;
        const totalWeight = this.diceWeights.reduce((a,b)=>a+b,0);
        
        for(let i=1; i<=6; i++) {
            const w = this.diceWeights[i];
            const prob = totalWeight > 0 ? (w / totalWeight) : 0;
            const standardProb = 1/6;
            const val = this.faceValues[i];
            
            const gain = this.roundGains.faces[i];
            const gainHtml = gain > 0 ? `<span class="val-gain">(+${gain})</span>` : '';

            let probClass = 'prob-col';
            if (Math.abs(prob - standardProb) < 0.0001) {
            } else if (prob > standardProb) {
                probClass += ' prob-high';
            } else {
                probClass += ' prob-low';
            }

            htmlFaces += `<tr>
                <td>${i}</td>
                <td>${val}ÁÇπ ${gainHtml}</td>
                <td class="${probClass}">${(prob*100).toFixed(1)}%</td>
            </tr>`;
        }
        this.ui.tableFaces.innerHTML = htmlFaces;

        let htmlYaku = `<tr><th>ÂΩπÂêç</th><th>ÂÄçÁéá</th></tr>`;
        const yakus = [
            {k:'pinzoro', n:'„Éî„É≥„Çæ„É≠'}, {k:'arashi', n:'„Ç¢„É©„Ç∑'}, 
            {k:'456', n:'„Ç∑„Ç¥„É≠'}, {k:'meari', n:'ÁõÆ„ÅÇ„Çä'}, {k:'menashi', n:'ÁõÆ„Å™„Åó'}
        ];
        yakus.forEach(y => {
            let curr = this.yakuMultipliers[y.k];
            const gain = this.roundGains.yakus[y.k] || 0;
            const gainHtml = gain > 0 ? `<span class="val-gain">(+${gain})</span>` : '';

            htmlYaku += `<tr>
                <td>${y.n}</td>
                <td>x${curr} ${gainHtml}</td>
            </tr>`;
        });
        this.ui.tableYaku.innerHTML = htmlYaku;
    }

    renderDice(dice) {
        this.ui.diceCont.innerHTML = '';
        dice.forEach(v => {
            const d = document.createElement('div');
            d.className = 'die';
            d.textContent = this.diceChars[v];
            if (v === 1) d.dataset.value = "1";
            this.ui.diceCont.appendChild(d);
        });
    }

    updateUI() {
        this.ui.stage.textContent = this.stage;
        this.ui.round.textContent = Math.min(this.round, 3);
        this.ui.roll.textContent = Math.max(0, this.rollCount);
        this.ui.pool.textContent = this.pool.toLocaleString();
        this.ui.target.textContent = this.targetScore.toLocaleString();
        this.ui.total.textContent = this.totalScore.toLocaleString();
        this.ui.tickets.textContent = this.tickets;
        this.ui.luck.textContent = this.currentLuck; 
        this.ui.rate.textContent = 'x' + this.globalMultiplier.toFixed(1);

        this.ui.invCount.textContent = `${this.inventory.length}/${this.maxInventory}`;
        this.ui.invList.innerHTML = '';
        if (this.inventory.length === 0) {
            this.ui.invList.innerHTML = '<div style="opacity:0.5; text-align:center; padding:10px;">Empty</div>';
        } else {
            this.inventory.forEach(item => {
                const div = document.createElement('div');
                div.className = `inv-item inv-${item.rarity}`;
                div.innerHTML = `<span>${item.name}</span>`;
                div.title = item.desc;
                
                let actionHtml = '';
                if (this.isShopOpen) {
                    const sellPrice = Math.floor(item.price / 2);
                    actionHtml = `<button class="btn-inv-sell" onclick="game.sellItem(${this.inventory.indexOf(item)})">Â£≤Âç¥(${sellPrice})</button>`;
                }
                div.innerHTML += actionHtml;
                this.ui.invList.appendChild(div);
            });
        }
    }

    openShop() {
        this.ui.gameView.classList.add('hidden');
        this.ui.shopView.classList.add('active');
        this.isShopOpen = true;
        this.updateUI();
        this.updateShopUI();
    }

    closeShop() {
        this.ui.shopView.classList.remove('active');
        this.ui.gameView.classList.remove('hidden');
        this.isShopOpen = false;
        this.updateUI();
    }

    generateShopItems() {
        this.shopItems = [];
        const ownedIds = this.inventory.map(i => i.id);
        
        let candidates = ITEM_DATA.filter(it => !ownedIds.includes(it.id));

        for(let i=0; i<4; i++) {
            if (candidates.length === 0) {
                this.shopItems.push(null);
                continue;
            }

            const weightedCandidates = candidates.map(it => {
                const rInfo = Object.values(RARITY).find(r => r.id === it.rarity);
                return { item: it, weight: rInfo.weight };
            });

            const totalWeight = weightedCandidates.reduce((sum, c) => sum + c.weight, 0);
            let r = Math.random() * totalWeight;
            let selected = null;
            
            for (let c of weightedCandidates) {
                if (r < c.weight) {
                    selected = c.item;
                    break;
                }
                r -= c.weight;
            }
            
            if (!selected) selected = weightedCandidates[weightedCandidates.length - 1].item;

            this.shopItems.push({ item: selected, sold: false });
            candidates = candidates.filter(c => c.id !== selected.id);
        }
        this.updateShopUI();
    }

    isStartupFreeReroll() {
        return this.stage === 1 && this.round === 1 && this.rollCount === this.initialRollCount;
    }

    rerollShop() {
        if (this.isStartupFreeReroll()) {
            this.generateShopItems();
            this.updateUI(); 
            return;
        }
        if (this.freeRerolls > 0) {
            this.freeRerolls--;
            this.generateShopItems();
            this.updateUI(); 
        } else if (this.tickets >= this.rerollCost) {
            this.tickets -= this.rerollCost;
            this.rerollCost *= 2;
            this.generateShopItems();
            this.updateUI();
        }
    }

    buyItem(shopIndex) {
        const slot = this.shopItems[shopIndex];
        if (!slot || slot.sold) return;

        if (this.inventory.length >= this.maxInventory) {
            alert("„Ç¢„Ç§„ÉÜ„É†„Åå„ÅÑ„Å£„Å±„ÅÑ„Åß„ÅôÔºÅ");
            return;
        }

        if (this.tickets >= slot.item.price) {
            this.tickets -= slot.item.price;
            this.inventory.push(slot.item);
            slot.sold = true;

            this.inventory.forEach(invItem => {
                if (invItem.effectType === 'reroll_buy_chance') {
                    if (this.checkProb(invItem.prob)) {
                        this.freeRerolls += invItem.value;
                    }
                }
            });

            this.recalcStats(); 
            this.updateUI();
            this.updateShopUI();
        } else {
            alert("„ÉÅ„Ç±„ÉÉ„Éà„ÅåË∂≥„Çä„Åæ„Åõ„Çì");
        }
    }
    
    sellItem(index) {
        const item = this.inventory[index];
        const sellPrice = Math.floor(item.price / 2);
        if(confirm(`${item.name} „Çí„ÉÅ„Ç±„ÉÉ„Éà ${sellPrice} Êûö„ÅßÂ£≤Âç¥„Åó„Åæ„Åô„ÅãÔºü`)) {
            this.tickets += sellPrice;
            this.inventory.splice(index, 1);
            this.recalcStats();
            this.updateUI();
            this.updateShopUI();
        }
    }

    updateShopUI() {
        this.ui.shopShelves.innerHTML = '';
        
        for(let i=0; i<4; i++) {
            const slot = this.shopItems[i];
            const div = document.createElement('div');
            
            if (slot) {
                const item = slot.item;
                div.className = `shop-item rarity-${item.rarity} ${slot.sold ? 'sold-out' : ''}`;
                div.innerHTML = `
                    <div class="item-name">${item.name}</div>
                    <div class="item-desc">${item.desc}</div>
                    <div class="item-price">‰æ°Ê†º: ${item.price}Êûö</div>
                    <button class="btn-buy" onclick="game.buyItem(${i})">
                        ${slot.sold ? 'SOLD' : 'Ë≥ºÂÖ•'}
                    </button>
                `;
            } else {
                div.className = 'shop-item sold-out';
                div.innerHTML = `<div class="item-name">Empty</div><div class="item-desc">Âú®Â∫´„Å™„Åó</div>`;
            }
            this.ui.shopShelves.appendChild(div);
        }

        const btn = this.ui.btnReroll;
        
        if (this.isStartupFreeReroll()) {
            btn.textContent = `ÂÜçÂÖ•Ëç∑ (ÁÑ°Êñô: „Çπ„Çø„Éº„Éà„Éú„Éº„Éä„Çπ)`;
            btn.style.background = '#2ecc71'; 
            btn.style.boxShadow = '0 4px 0 #27ae60';
            btn.disabled = false;
        } else if (this.freeRerolls > 0) {
            btn.textContent = `ÂÜçÂÖ•Ëç∑ (ÁÑ°Êñô: ${this.freeRerolls}Âõû)`;
            btn.style.background = '#2ecc71'; 
            btn.style.boxShadow = '0 4px 0 #27ae60';
            btn.disabled = false;
        } else {
            btn.textContent = `ÂÜçÂÖ•Ëç∑ (Cost: ${this.rerollCost})`;
            btn.style.background = ''; // „Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô
            btn.style.boxShadow = '';
            btn.disabled = (this.tickets < this.rerollCost);
        }
    }

    showModal(title, msg, isClear) {
        this.ui.mTitle.textContent = title;
        this.ui.mMsg.innerHTML = msg;
        this.ui.modal.classList.add('show');
        this.ui.modal.dataset.isClear = isClear;
    }

    nextPhase() {
        this.ui.modal.classList.remove('show');
        const isClear = this.ui.modal.dataset.isClear === "true";
        
        if (isClear) {
            this.openPrestige();
        } else {
            this.stage = 1;
            this.totalScore = 0;
            this.inventory = [];
            this.tickets = 4;
            this.freeRerolls = 0; // „É™„Çª„ÉÉ„Éà
            this.streakMenashi = 0; 
            this.streakWin = 0;
            this.faceValues = [0,1,2,3,4,5,6];
            this.yakuMultipliers = { ...this.baseMultipliers };
            this.prestigeState.weights = [0,0,0,0,0,0,0];
            this.prestigeState.extraInv = 0;
            this.initStage();
        }
    }

    // --- „Éó„É¨„Çπ„ÉÜ„Éº„Ç∏Âá¶ÁêÜ ---
    openPrestige() {
        this.ui.gameView.classList.add('hidden');
        this.ui.shopView.classList.remove('active');
        this.ui.prestigeView.classList.add('active');
        this.prestigeRerollCost = 1;
        this.generatePrestigeOptions();
    }

    generatePrestigeOptions() {
        this.ui.prestigeCont.innerHTML = '';
        this.ui.btnPrestigeReroll.textContent = `ÈÅ∏ÊäûËÇ¢Â§âÊõ¥ (Cost: ${this.prestigeRerollCost})`;
        this.ui.btnPrestigeReroll.disabled = (this.tickets < this.prestigeRerollCost);

        this.currentPrestigeOptions = [];
        let pool = [...PRESTIGE_OPTIONS];
        
        for(let i=0; i<3; i++) {
            if(pool.length === 0) break;
            const idx = Math.floor(Math.random() * pool.length);
            const opt = pool[idx];
            pool.splice(idx, 1);
            this.currentPrestigeOptions.push(opt);

            const div = document.createElement('div');
            div.className = 'prestige-card';
            div.innerHTML = `
                <div class="p-icon">${opt.icon}</div>
                <div class="p-desc">${opt.text}</div>
            `;
            div.onclick = () => this.selectPrestige(i);
            this.ui.prestigeCont.appendChild(div);
        }
    }

    rerollPrestige() {
        if(this.tickets >= this.prestigeRerollCost) {
            this.tickets -= this.prestigeRerollCost;
            this.prestigeRerollCost *= 2;
            this.updateUI();
            this.generatePrestigeOptions();
        }
    }

    selectPrestige(index) {
        const opt = this.currentPrestigeOptions[index];
        
        if (opt.type === 'weight') {
            this.prestigeState.weights[opt.target] += 3;
        } else if (opt.type === 'multi') {
            // ‰πóÁÆó„Åß„ÅØ„Å™„ÅèÂü∫Á§éÂÄ§„ÇíÂÄç„Å´„Åô„Çã
            this.baseMultipliers[opt.target] *= 2;
        } else if (opt.type === 'ticket') {
            this.tickets += opt.val;
        } else if (opt.type === 'inv_max') {
            this.prestigeState.extraInv += 1;
        }

        this.ui.prestigeView.classList.remove('active');
        this.ui.gameView.classList.remove('hidden');
        this.stage++;
        this.initStage();
    }
}

const game = new Game();
</script>
</body>
</html>
